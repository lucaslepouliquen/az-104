## 2.6 Shared Access Signatures (SAS)

**Concept Clé pour AZ-104 : Les Shared Access Signatures (SAS) fournissent un accès délégué sécurisé aux ressources de stockage Azure sans partager les clés du compte**

**Définition :**
- **Shared Access Signature (SAS)** : URI qui accorde des droits d'accès restreints aux ressources Azure Storage
- **Objectif** : Délégation d'accès granulaire avec contrôle précis des permissions et de la durée
- **Avantage Principal** : Partage sécurisé sans exposer les clés du compte de stockage

**Principe de Fonctionnement :**

```
┌────────────────────────────────────────────────────┐
│            Storage Account                         │
│  ┌──────────────────────────────────────────┐      │
│  │       Account Key (Ne JAMAIS partager)   │      │
│  └────────────────┬─────────────────────────┘      │
│                   │                                │
│                   ▼ Signe le SAS Token             │
│  ┌──────────────────────────────────────────┐      │
│  │      SAS Token Généré                    │      │
│  │  ?sv=2021-06-08&ss=b&srt=sco&sp=rwdlacx  │      │
│  │  &se=2024-12-31T23:59:59Z&st=...&sig=... │      │
│  └────────────────┬─────────────────────────┘      │
└───────────────────┼────────────────────────────────┘
                    │
                    ▼ Partagé avec
         ┌───────────────────────┐
         │   Application Tierce  │
         │   ou Utilisateur      │
         └──────────┬────────────┘
                    │
                    ▼ Accès limité aux ressources
         ┌───────────────────────┐
         │   Blob / Container    │
         │   (lecture seule, etc)│
         └───────────────────────┘
```

### Types de SAS

**Il existe 3 types principaux de SAS - Chacun avec des use cases spécifiques**

**1. User Delegation SAS (Recommandé - Plus Sécurisé)**

**Caractéristiques :**
- **Authentification** : Basée sur Azure AD credentials (OAuth 2.0)
- **Signature** : Utilise une User Delegation Key obtenue d'Azure AD
- **Avantage** : NE nécessite PAS les clés du compte de stockage
- **Scope** : Blob Storage et Data Lake Storage Gen2 uniquement
- **Sécurité** : Meilleure pratique recommandée par Microsoft

**Création - User Delegation SAS :**

```bash
# Prérequis : Utilisateur doit avoir le rôle "Storage Blob Data Contributor" ou supérieur

# Étape 1 : Se connecter avec Azure AD
az login

# Étape 2 : Générer User Delegation SAS
az storage blob generate-sas \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name myblob.txt \
  --permissions r \
  --expiry 2024-12-31T23:59:59Z \<>
  --auth-mode login \
  --as-user

# Output : SAS Token
# ?sv=2021-06-08&st=2024-01-01T00:00:00Z&se=2024-12-31T23:59:59Z&sr=b&sp=r&sig=...

# Construire URL complète
https://mystorageaccount.blob.core.windows.net/mycontainer/myblob.txt?sv=2021-06-08&st=...&sig=...
```

**Via PowerShell avec Azure AD :**

```powershell
# Se connecter avec Azure AD
Connect-AzAccount

# Obtenir le contexte du Storage Account
$ctx = New-AzStorageContext -StorageAccountName "mystorageaccount" -UseConnectedAccount

# Générer User Delegation SAS pour un blob
$sasToken = New-AzStorageBlobSASToken `
  -Context $ctx `
  -Container "mycontainer" `
  -Blob "myblob.txt" `
  -Permission r `
  -ExpiryTime (Get-Date).AddDays(7)

# URL complète
$blobUri = $ctx.BlobEndPoint + "mycontainer/myblob.txt" + $sasToken
Write-Output $blobUri
```

**Avantages User Delegation SAS :**
- **Pas de clés exposées** : N'utilise pas les clés du compte
- **Azure AD integration** : Révocation via Azure AD
- **Audit trail** : Traçabilité complète dans Azure AD logs
- **Rotation automatique** : User Delegation Key rotée automatiquement
- **Least privilege** : Basé sur RBAC Azure AD

**2. Service SAS**

**Caractéristiques :**
- **Authentification** : Signée avec la clé du compte de stockage
- **Scope** : Ressource spécifique dans UN seul service (Blob, Queue, Table, File)
- **Granularité** : Accès Ã  un blob, container, file share, queue, ou table
- **Use Case** : Délégation d'accès Ã  des ressources spécifiques

**Création - Service SAS :**

```bash
# Service SAS pour un blob spécifique
az storage blob generate-sas \
  --account-name mystorageaccount \
  --account-key "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" \
  --container-name mycontainer \
  --name myblob.txt \
  --permissions rw \
  --expiry 2024-12-31T23:59:59Z \
  --https-only

# Service SAS pour un container entier
az storage container generate-sas \
  --account-name mystorageaccount \
  --account-key "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" \
  --name mycontainer \
  --permissions rl \
  --expiry 2024-12-31T23:59:59Z

# Service SAS pour Azure File Share
az storage share generate-sas \
  --account-name mystorageaccount \
  --account-key "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" \
  --name myfileshare \
  --permissions rl \
  --expiry 2024-12-31T23:59:59Z
```

**Via PowerShell :**

```powershell
# Obtenir le contexte avec la clé du compte
$ctx = New-AzStorageContext -StorageAccountName "mystorageaccount" -StorageAccountKey "xxxx"

# Service SAS pour blob
$blobSAS = New-AzStorageBlobSASToken `
  -Context $ctx `
  -Container "mycontainer" `
  -Blob "myblob.txt" `
  -Permission rwd `
  -ExpiryTime (Get-Date).AddHours(24) `
  -Protocol HttpsOnly

# Service SAS pour container
$containerSAS = New-AzStorageContainerSASToken `
  -Context $ctx `
  -Name "mycontainer" `
  -Permission rl `
  -ExpiryTime (Get-Date).AddDays(7)
```

**3. Account SAS**

**Caractéristiques :**
- **Authentification** : Signée avec la clé du compte de stockage
- **Scope** : Accès à  PLUSIEURS services (Blob, Queue, Table, File)
- **Granularité** : Opérations au niveau du service ET de la ressource
- **Use Case** : Applications nécessitant accès multi-services

**Création - Account SAS :**

```bash
# Account SAS donnant accès Ã  Blob et File Services
az storage account generate-sas \
  --account-name mystorageaccount \
  --account-key "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" \
  --services bf \
  --resource-types sco \
  --permissions rl \
  --expiry 2024-12-31T23:59:59Z \
  --https-only

# Paramètres :
# --services : b=Blob, f=File, q=Queue, t=Table
# --resource-types : s=Service, c=Container, o=Object
```

**Via PowerShell :**

```powershell
# Account SAS avec accès multi-services
$accountSAS = New-AzStorageAccountSASToken `
  -Service Blob,File `
  -ResourceType Service,Container,Object `
  -Permission rl `
  -ExpiryTime (Get-Date).AddMonths(1) `
  -Protocol HttpsOnly `
  -Context $ctx

Write-Output "Account SAS: $accountSAS"
```

**⚠️ Comparaison des 3 Types de SAS :**

| Critère | User Delegation SAS | Service SAS | Account SAS |
|---------|---------------------|-------------|-------------|
| **Authentification** | Azure AD (OAuth) | Account Key | Account Key |
| **Sécurité** | ✅ Meilleure | ❌ Clé exposée | ❌ Clé exposée |
| **Scope Services** | Blob, ADLS Gen2 | 1 service | Plusieurs services |
| **Révocation** | ✅ Via Azure AD | ❌ Rotation clé uniquement | ❌ Rotation clé uniquement |
| **Audit** | ✅ Azure AD logs | ⚠️ Storage logs | ⚠️ Storage logs |
| **Use Case** | Applications modernes | Accès ressource unique | Multi-services legacy |
| **Recommandation** | ✅ Préféré | ⚠️ Si User Delegation impossible | ❌ Éviter si possible |

### SAS Tokens et Permissions

**⚠️ Structure d'un SAS Token :**

```
https://mystorageaccount.blob.core.windows.net/mycontainer/myblob.txt
?sv=2021-06-08           # Storage Service Version
&st=2024-01-01T00:00:00Z # Start Time (optionnel)
&se=2024-12-31T23:59:59Z # Expiry Time (obligatoire)
&sr=b                     # Signed Resource (b=blob, c=container)
&sp=r                     # Signed Permissions (r=read)
&sip=168.1.5.60-168.1.5.70 # Signed IP Range (optionnel)
&spr=https               # Signed Protocol (https only)
&sig=xxxxxxxxxxxxxx      # Signature (HMAC-SHA256)
```

**Paramètres Clés :**

**1. Signed Permissions (sp) :**

**Pour Blobs :**
- **r** : Read (lire contenu, propriétés, métadonnées)
- **a** : Add (ajouter des blocks Ã  un append blob)
- **c** : Create (créer ou upload un blob)
- **w** : Write (écrire ou upload - écrase le blob existant)
- **d** : Delete (supprimer le blob)
- **x** : Delete Version (supprimer une version de blob)
- **y** : Permanent Delete (suppression permanente - soft delete)
- **l** : List (lister les blobs dans un container)
- **t** : Tags (lire/écrire blob tags)
- **m** : Move (rename blob - ADLS Gen2)
- **e** : Execute (ADLS Gen2 - exécution répertoire)

**Pour Containers :**
- **r** : Read
- **a** : Add
- **c** : Create
- **w** : Write
- **d** : Delete
- **l** : List
- **t** : Tags

**Pour File Shares :**
- **r** : Read
- **c** : Create
- **w** : Write
- **d** : Delete
- **l** : List

**Exemples de Permissions Combinées :**

```bash
# Lecture seule
--permissions r

# Lecture et listage
--permissions rl

# Lecture, écriture, suppression (full control)
--permissions rwd

# Toutes les permissions
--permissions rwdlacxtme
```

**2. Signed Resource (sr) :**
- **b** : Blob
- **c** : Container
- **f** : File
- **s** : Share (File Share)
- **d** : Directory (ADLS Gen2)
- **bs** : Blob Service (Account SAS)
- **bfs** : Blob File System (ADLS Gen2)

**3. Start Time (st) et Expiry Time (se) :**

```bash
# Commence maintenant, expire dans 7 jours
--start "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
--expiry "$(date -u -d '+7 days' +%Y-%m-%dT%H:%M:%SZ)"

# Commence dans 1 heure, expire dans 24 heures
--start "$(date -u -d '+1 hour' +%Y-%m-%dT%H:%M:%SZ)" \
--expiry "$(date -u -d '+1 day' +%Y-%m-%dT%H:%M:%SZ)"

# PowerShell équivalent
-StartTime (Get-Date) `
-ExpiryTime (Get-Date).AddDays(7)
```

**⚠️ Important :** 
- **Expiry obligatoire** pour tous les SAS
- **Start time optionnel** (si omis, commence immédiatement)
- **Clock skew** : Azure accepte jusqu'Ã  15 minutes de différence d'horloge

**4. Signed IP Range (sip) - Restriction par IP :**

```bash
# Une seule IP
--ip 203.0.113.5

# Plage d'IPs
--ip 203.0.113.0-203.0.113.255

# Exemple complet
az storage blob generate-sas \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name myblob.txt \
  --permissions r \
  --expiry 2024-12-31T23:59:59Z \
  --ip 203.0.113.5 \
  --https-only \
  --auth-mode login \
  --as-user
```

**5. Signed Protocol (spr) - Forcer HTTPS :**

```bash
# HTTPS uniquement (recommandé)
--https-only

# Ou via paramètre
--protocol https

# PowerShell
-Protocol HttpsOnly
```

### Stored Access Policies

**Concept Clé : Les Stored Access Policies permettent de contrôler et révoquer des SAS après leur émission**

**Définition :**
- **Stored Access Policy** : Politique d'accès stockée sur le container/share/queue/table
- **Avantage Principal** : Possibilité de modifier ou révoquer des SAS sans régénérer les tokens
- **Limitation** : Uniquement pour Service SAS (pas Account SAS ni User Delegation SAS)

**Pourquoi Utiliser Stored Access Policies ?**

**Sans Stored Access Policy :**
```
SAS créé avec expiration 2024-12-31
Impossible de révoquer avant expiration
Pour révoquer : Rotation de la clé du compte (impact global)
```

**Avec Stored Access Policy :**
```
SAS lié à une policy nommée
Modification de la policy -> Impact immédiat sur tous les SAS liés
Suppression de la policy -> Révocation de tous les SAS liés
Pas besoin de rotation de clé
```

**Création d'une Stored Access Policy :**

```bash
# Étape 1 : Créer une Stored Access Policy sur un container
az storage container policy create \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name mypolicy \
  --permissions rl \
  --start 2024-01-01T00:00:00Z \
  --expiry 2024-12-31T23:59:59Z

# Étape 2 : Créer un SAS lié Ã  la policy
az storage blob generate-sas \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name myblob.txt \
  --policy-name mypolicy

# Étape 3 : Modifier la policy (impact immédiat sur tous les SAS)
az storage container policy update \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name mypolicy \
  --permissions r \
  --expiry 2024-06-30T23:59:59Z

# Étape 4 : Révoquer tous les SAS liés Ã  la policy
az storage container policy delete \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name mypolicy
```

**Via PowerShell :**

```powershell
# Obtenir le contexte
$ctx = New-AzStorageContext -StorageAccountName "mystorageaccount" -StorageAccountKey "xxxx"

# Créer Stored Access Policy
$policy = New-AzStorageContainerStoredAccessPolicy `
  -Container "mycontainer" `
  -Policy "mypolicy" `
  -Permission rl `
  -StartTime (Get-Date) `
  -ExpiryTime (Get-Date).AddYears(1) `
  -Context $ctx

# Générer SAS avec policy
$sas = New-AzStorageBlobSASToken `
  -Container "mycontainer" `
  -Blob "myblob.txt" `
  -Policy "mypolicy" `
  -Context $ctx

# Révoquer en supprimant la policy
Remove-AzStorageContainerStoredAccessPolicy `
  -Container "mycontainer" `
  -Policy "mypolicy" `
  -Context $ctx
```

**Limites des Stored Access Policies :**

| Limite | Valeur | Notes |
|--------|--------|-------|
| **Policies par container** | 5 | Maximum 5 policies nommées |
| **Policies par file share** | 5 | Maximum 5 policies nommées |
| **Policies par queue** | 5 | Maximum 5 policies nommées |
| **Policies par table** | 5 | Maximum 5 policies nommées |
| **Nom de policy** | 64 caractères | Alphanumériques uniquement |

**Scénarios d'Utilisation - Pour l'Examen :**

**Scénario 1 : Partage Temporaire avec Client Externe**

```
Problème :
- Besoin de partager des fichiers avec un client
- Accès limité Ã  30 jours
- Lecture seule
- Possibilité de révoquer si nécessaire

Solution :
1. Créer User Delegation SAS (plus sécurisé)
2. Permissions : Read (r)
3. Expiry : +30 jours
4. IP restriction si possible
5. HTTPS uniquement

# Commande
az storage blob generate-sas \
  --account-name mystorageaccount \
  --container-name client-files \
  --name report-Q4.pdf \
  --permissions r \
  --expiry "$(date -u -d '+30 days' +%Y-%m-%dT%H:%M:%SZ)" \
  --https-only \
  --auth-mode login \
  --as-user

Avantages :
Pas de clé de compte exposée
Accès granulaire
Expiration automatique
Révocation via Azure AD si besoin
```

**Scénario 2 : Upload de Fichiers par Application Tierce**

```
Problème :
- Application mobile doit uploader des images
- Chaque utilisateur doit pouvoir écrire uniquement
- Pas de lecture des autres fichiers
- Contrôle par IP du datacenter

Solution :
1. Service SAS par utilisateur
2. Permissions : Create, Write (cw)
3. Expiry : Session utilisateur (2 heures)
4. IP restriction : Datacenter
5. Stored Access Policy pour révocation

# Commande
az storage container policy create \
  --account-name mystorageaccount \
  --container-name user-uploads \
  --name upload-policy \
  --permissions cw \
  --expiry "$(date -u -d '+2 hours' +%Y-%m-%dT%H:%M:%SZ)"

az storage blob generate-sas \
  --account-name mystorageaccount \
  --container-name user-uploads \
  --name user123/image.jpg \
  --policy-name upload-policy \
  --ip 203.0.113.0-203.0.113.255

Avantages :
Write-only (sécurité)
Révocation centralisée via policy
Restriction IP
Expiration courte
```

**Scénario 3 : Application Multitenant avec Account SAS**

```
Problème :
- Application SaaS multi-tenant
- Besoin d'accès Blob ET File Storage
- Différents tenants avec différentes permissions
- Audit trail nécessaire

Solution :
1. User Delegation SAS si possible (Blob uniquement)
2. Sinon Account SAS
3. Générer SAS par tenant avec metadata
4. Monitoring Azure Monitor
5. Rotation régulière des clés

# Commande (Account SAS pour Blob + File)
az storage account generate-sas \
  --account-name mystorageaccount \
  --services bf \
  --resource-types sco \
  --permissions rl \
  --expiry "$(date -u -d '+7 days' +%Y-%m-%dT%H:%M:%SZ)" \
  --https-only

Avantages :
Multi-services
Granularité par tenant
Rotation possible
```

**Scénario 4 : CDN avec SAS pour Contenu Privé**

```
Problème :
- CDN doit servir du contenu privé
- Utilisateurs authentifiés uniquement
- Expiration courte des liens

Solution :
1. Générer SAS à la demande côté serveur
2. Permissions : Read (r)
3. Expiry : 15 minutes
4. Passer SAS Ã  CDN
5. CDN utilise SAS pour fetch depuis Storage

# Application backend génère
$sasToken = New-AzStorageBlobSASToken `
  -Container "private-content" `
  -Blob "video-premium.mp4" `
  -Permission r `
  -ExpiryTime (Get-Date).AddMinutes(15) `
  -Context $ctx

# URL finale
https://cdn.example.com/video-premium.mp4?{$sasToken}

Avantages :
Contenu privé sécurisé
Expiration courte
Performance CDN maintenue
```

### Best Practices et Sécurité

**⚠️ Best Practices pour SAS :**

**1. Choix du Type de SAS**
- ✅ **Toujours préférer User Delegation SAS** pour Blob Storage
- ✅ Utiliser Service SAS pour ressources spécifiques
- ❌ Éviter Account SAS sauf si multi-services requis

**2. Permissions (Principe du Moindre Privilège)**
- ✅ Donner **uniquement** les permissions nécessaires
- ✅ Préférer **Read-only** si possible
- ❌ Éviter permissions "rwdlacx" (trop large)
- ✅ Utiliser **List** uniquement si nécessaire

```bash
# ❌ Mauvais : Trop de permissions
--permissions rwdlacxtme

# ✅ Bon : Permissions minimales
--permissions r  # Si lecture seule suffit
```

**3. Expiration**
- Toujours définir une **expiration courte** (heures/jours, pas mois/années)
- Régénérer SAS si besoin d'accès prolongé
- **15 minutes** : Sessions temporaires (CDN, uploads)
- **24 heures** : Accès quotidien
- **7 jours** : Maximum pour la plupart des cas

```bash
# ✅ Bon : Expiration courte
--expiry "$(date -u -d '+2 hours' +%Y-%m-%dT%H:%M:%SZ)"

# ❌ Mauvais : Expiration trop longue
--expiry "2025-12-31T23:59:59Z"  # Trop loin dans le futur
```

**4. Restrictions Réseau**
- **HTTPS uniquement** : Toujours utiliser `--https-only`
- **IP restrictions** : Si IPs connues et fixes
- **Private Endpoints** : Si accès VNet

```bash
# ✅ Bon : HTTPS + IP restriction
az storage blob generate-sas \
  --permissions r \
  --https-only \
  --ip 203.0.113.5
```

**5. Stored Access Policies**
- ✅ Utiliser pour **contrôle de révocation**
- ✅ Limite de **5 policies** : Planifier les noms
- ✅ **Nommage clair** : upload-policy, read-policy-2024

**6. Monitoring et Audit**
- ✅ Activer **Storage Analytics** pour logs
- ✅ Monitorer **Azure Monitor metrics** pour anomalies
- ✅ Créer **alertes** pour accès suspicieux

```bash
# Activer logging
az storage logging update \
  --account-name mystorageaccount \
  --services b \
  --log rwd \
  --retention 90
```

**7. Rotation des Clés**
- ✅ Rotation régulière (tous les **90 jours**)
- ✅ Utiliser **key2** pendant rotation de **key1**
- ✅ Tester avant basculement complet

**⚠️ Erreurs Courantes QCM :**

| Question | Réponse Incorrecte ❌ | Réponse Correcte ✅ |
|----------|----------------------|---------------------|
| **"Quel SAS est le plus sécurisé ?"** | "Account SAS (multi-services)" | "User Delegation SAS (Azure AD)" |
| **"Peut-on révoquer un SAS sans Stored Policy ?"** | "Oui, via Azure Portal" | "Non, seulement en régénérant la clé du compte" |
| **"User Delegation SAS fonctionne pour Files ?"** | "Oui, tous les services" | "Non, Blob et ADLS Gen2 uniquement" |
| **"Combien de Stored Policies par container ?"** | "Illimité" ou "10" | "5 policies maximum" |
| **"SAS sans expiration est possible ?"** | "Oui, pour Account SAS" | "Non, expiration toujours obligatoire" |

**Problèmes Courants et Solutions :**

| Problème | Cause | Solution |
|----------|-------|----------|
| **403 Forbidden avec SAS** | SAS expiré ou permissions insuffisantes | Vérifier expiry time et permissions |
| **SAS ne fonctionne pas** | Clock skew (différence d'horloge) | Utiliser start time -15 minutes |
| **Impossible de révoquer SAS** | Pas de Stored Access Policy | Créer policy ou régénérer clé compte |
| **SAS trop long (URL)** | Trop de paramètres | Minimaliser permissions et paramètres |
| **Erreur signature invalide** | Clé changée ou SAS mal formé | Régénérer SAS avec bonne clé |

**Comparaison avec Autres Méthodes d'Accès :**

| Méthode | Use Case | Avantages | Inconvénients |
|---------|----------|-----------|---------------|
| **Account Key** | Administration | Accès complet | ❌ Trop de privilèges, pas granulaire |
| **User Delegation SAS** | Applications modernes | ✅ Sécurisé, Azure AD | Blob/ADLS uniquement |
| **Service SAS** | Accès délégué | ✅ Granulaire, contrôlé | Nécessite clé compte |
| **Account SAS** | Multi-services legacy | ✅ Multi-services | ❌ Moins sécurisé |
| **Azure AD (RBAC)** | Identités permanentes | ✅ Gestion centralisée | Pas pour accès anonyme |
| **Anonymous Public Access** | Contenu public | ✅ Simple | ❌ Pas sécurisé |

**⚠️ Points Clés pour l'Examen :**
- ✅ **3 types de SAS** : User Delegation (recommandé), Service, Account
- ✅ **User Delegation SAS** = Plus sécurisé (Azure AD, pas de clés)
- ✅ **Stored Access Policy** = Permet révocation des SAS
- ✅ **5 policies max** par container/share/queue/table
- ✅ **Expiration obligatoire** pour tous les SAS
- ✅ **HTTPS uniquement** = Best practice
- ✅ **Permissions minimales** = Principe du moindre privilège
- ✅ **sp=r** : Read, **sp=w** : Write, **sp=d** : Delete, **sp=l** : List
- ✅ **Révocation** : Supprimer Stored Policy OU régénérer clé compte
- ✅ **IP restriction** possible avec paramètre `--ip`