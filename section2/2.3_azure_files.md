## 2.3 Azure Files (Mise à jour 2024)

### Protocoles Supportés

- **SMB 3.0/3.1** : Windows, Linux, macOS
- **NFS 4.1** : Linux, Premium uniquement
- **REST API** : Accès programmatique
- **Nouveauté 2024** : Chiffrement en transit pour NFS 4.1

**⚠️ Point clé identifié :** Port SMB
- **Port 445 TCP** obligatoire pour accès SMB
- Doit être ouvert sur les firewalls clients
- Nécessaire pour mapper des lecteurs réseau

### Types de File Shares (Mise à jour 2024)

**Standard File Shares**
- **Comptes** : General Purpose v2 (GPv2)
- **Performance** : Standard (HDD)
- **Capacité** : 
  - Par défaut : Jusqu'à 5 TiB par share
  - Avec Large File Shares activé : Jusqu'à 100 TiB par share
- **Usage** : Applications générales, partages basiques
- **⚠️ Important** : Large File Shares doit être activé à la création du compte (irréversible)

**Premium File Shares (SSD)**
- **Comptes** : FileStorage uniquement (compte dédié)
- **Performance** : Premium (SSD)
- **Capacité** : Jusqu'à 100 TiB par share (modèle standard)
- **Usage** : Applications haute performance, bases de données
- **Nouveauté 2024** : Modèle v2 approvisionné permettant jusqu'à 256 TiB avec provisionnement flexible du stockage, IOPS et throughput

### Nouveautés 2024 - Fonctionnalités Avancées

- **Chiffrement en transit NFS** : Sécurité renforcée pour partages NFS 4.1
- **Mise en cache des métadonnées** : Réduction de latence, augmentation IOPS
- **Identités managées** : Authentification sécurisée sans clés partagées
- **Sauvegarde archivée** : Protection contre ransomwares, rétention jusqu'à 10 ans
- **Azure File Sync via Azure Arc** : Gestion simplifiée des agents de synchronisation

### Capacités et Limites (Mise à jour 2024)

- **Standard File Shares** : 
  - Par défaut : Maximum 5 TiB par share
  - Avec Large File Shares activé : Maximum 100 TiB par share
- **Premium File Shares** : 
  - Modèle standard : Maximum 100 TiB par share
  - Modèle v2 approvisionné : Jusqu'à 256 TiB par share
- **Azure Import/Export** : Support Blob Storage et Azure Files
- **Nouveauté** : Support des identités managées pour Azure File Sync

### Méthodes d'Authentification pour Azure Storage

**⚠️ Concept Clé pour AZ-104 : Chaque service de stockage Azure supporte différentes méthodes d'authentification - Comprendre quelle méthode utiliser pour quel service est ESSENTIEL pour l'examen**

**Vue d'Ensemble des Méthodes d'Authentification :**

| Méthode d'Authentification | Type | Azure Files (SMB) | Blob Storage | Queue Storage | Table Storage |
|----------------------------|------|-------------------|--------------|---------------|---------------|
| **Kerberos (Microsoft Entra)** | **IAM** | ✅ **OUI** | ❌ Non | ❌ Non | ❌ Non |
| **Azure AD (OAuth 2.0)** | **IAM** | ⚠️ Via REST API | ✅ Oui | ✅ Oui | ✅ Oui |
| **Shared Key (Account Key)** | **Credential** | ✅ Oui | ✅ Oui | ✅ Oui | ✅ Oui |
| **Shared Access Signature (SAS)** | **Credential** | ✅ Oui | ✅ Oui | ✅ Oui | ✅ Oui |
| **Anonymous Public Access** | **None** | ❌ Non | ✅ Oui | ❌ Non | ❌ Non |

**⚠️ Point Critique pour l'Examen :**

**Question Type Examen :** *"Which storage data service can be configured to use identity-based access?"*

**Réponse : Azure Files (file shares)** ✅

**Pourquoi ?** Azure Files est le SEUL service de stockage qui supporte **Microsoft Entra Kerberos** (anciennement Azure AD Kerberos), qui est une authentification basée sur l'identité (IAM).

---

### 1. Kerberos Authentication (Microsoft Entra) - IDENTITY-BASED (IAM)

**⚠️ Azure Files UNIQUEMENT - Méthode d'Authentification Basée sur l'Identité**

**Définition :**
- **Microsoft Entra Kerberos** : Protocole d'authentification IAM qui permet aux utilisateurs Azure AD d'accéder aux file shares
- **Type** : **Identity and Access Management (IAM)** - Authentification basée sur l'identité
- **Scope** : **Azure Files (SMB) uniquement** - NE fonctionne PAS pour Blobs, Queues, ou Tables
- **Avantage** : Pas besoin de clés de stockage, authentification SSO (Single Sign-On)

**Cas d'Usage :**
- Utilisateurs Azure AD accédant à des file shares
- Migration lift-and-shift depuis AD on-premises
- Scénarios hybrides avec Azure AD Connect

**Configuration Microsoft Entra Kerberos :**

**Prérequis :**
- Azure Files (Standard ou Premium)
- Azure AD tenant
- Utilisateurs/groupes Azure AD
- Optionnel : Azure AD Connect pour synchronisation hybrid

**Étape 1 : Activer l'Authentification Identity-Based**

```bash
# Via Azure CLI
az storage account update \
  --name mystorageaccount \
  --resource-group myResourceGroup \
  --enable-files-aadds false \
  --enable-files-aadkerb true

# Paramètres :
# --enable-files-aadds : Azure AD Domain Services (legacy)
# --enable-files-aadkerb : Microsoft Entra Kerberos (recommandé 2024)
```

**Via PowerShell :**

```powershell
# Activer Microsoft Entra Kerberos
Set-AzStorageAccount `
  -ResourceGroupName "myResourceGroup" `
  -Name "mystorageaccount" `
  -EnableAzureActiveDirectoryKerberosForFile $true
```

**Étape 2 : Configurer les Permissions RBAC sur le File Share**

```bash
# Obtenir l'ID du file share
$fileShareResourceId = (Get-AzStorageShare `
  -Context (New-AzStorageContext -StorageAccountName "mystorageaccount" -UseConnectedAccount) `
  -Name "myfileshare").Id

# Assigner le rôle "Storage File Data SMB Share Contributor"
az role assignment create \
  --assignee user@contoso.com \
  --role "Storage File Data SMB Share Contributor" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Storage/storageAccounts/mystorageaccount/fileServices/default/fileshares/myfileshare"
```

**Rôles RBAC pour Azure Files (SMB) :**

| Rôle | Permissions | Use Case |
|------|------------|----------|
| **Storage File Data SMB Share Reader** | Lecture seule | Consultation, audits |
| **Storage File Data SMB Share Contributor** | Lecture, écriture, modification | Utilisateurs standard |
| **Storage File Data SMB Share Elevated Contributor** | Lecture, écriture, modification, changement ACLs | Administrateurs de données |

**Étape 3 : Configurer les ACLs Windows (NTFS Permissions)**

```powershell
# Monter le file share avec identité Azure AD
$connectTestResult = Test-NetConnection -ComputerName mystorageaccount.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
    # Mapper le lecteur réseau
    New-PSDrive -Name Z -PSProvider FileSystem `
      -Root "\\mystorageaccount.file.core.windows.net\myfileshare" `
      -Persist
    
    # Configurer NTFS permissions (comme Windows traditionnel)
    icacls Z:\ /grant "user@contoso.com:(OI)(CI)M"
}
```

**Étape 4 : Accès depuis les Clients**

```powershell
# Windows 10/11 - Connexion avec identité Azure AD
net use Z: \\mystorageaccount.file.core.windows.net\myfileshare /user:Azure\user@contoso.com

# Ou avec cmdkey (SSO)
cmdkey /add:mystorageaccount.file.core.windows.net /user:Azure\user@contoso.com /pass:<password>
net use Z: \\mystorageaccount.file.core.windows.net\myfileshare
```

**⚠️ Types d'Identity-Based Access pour Azure Files :**

**1. Microsoft Entra Kerberos (Recommandé 2024)**
- **Scenario** : Cloud-only ou hybrid identity
- **Prérequis** : Azure AD tenant
- **Avantage** : Pas besoin de Azure AD Domain Services (AADDS)
- **Limitation** : SMB uniquement

**2. Azure AD Domain Services (AADDS) - Legacy**
- **Scenario** : Environnements entièrement cloud
- **Prérequis** : AADDS déployé (coût supplémentaire ~$100/mois)
- **Avantage** : Émulation complète d'AD Domain Controller
- **Limitation** : Complexité et coût

**3. On-Premises AD DS avec Azure AD Connect**
- **Scenario** : Environnements hybrides
- **Prérequis** : AD on-premises + Azure AD Connect + connectivité
- **Avantage** : Intégration complète avec AD existant
- **Limitation** : Infrastructure on-premises requise

**Comparaison des Méthodes Identity-Based :**

| Critère | Microsoft Entra Kerberos | Azure AD DS | On-Premises AD DS |
|---------|-------------------------|-------------|-------------------|
| **Coût** | ✅ Gratuit | ❌ ~$100/mois | ⚠️ Infrastructure existante |
| **Complexité** | ✅ Simple | ⚠️ Moyenne | ❌ Complexe |
| **Cloud-Only** | ✅ Oui | ✅ Oui | ❌ Non (hybrid) |
| **Prérequis** | Azure AD | AADDS déployé | AD + Azure AD Connect |
| **Recommandation 2024** | ✅ Préféré | ⚠️ Legacy | ⚠️ Si hybrid requis |

**⚠️ Scénario d'Examen - Identity-Based Access :**

```
Question : Which storage data service can be configured to use identity-based access?
A) containers (Blob Storage)
B) file shares (Azure Files)  ✅ CORRECT
C) queues
D) tables

Explication :
- Azure Files supporte Microsoft Entra Kerberos (IAM)
- Les utilisateurs s'authentifient avec leurs identités Azure AD
- RBAC + NTFS permissions pour contrôle d'accès granulaire
- Blob, Queue, Table utilisent Azure AD OAuth mais PAS Kerberos
```

---

### 2. Authentification Azure AD (OAuth 2.0) - IAM pour Blobs, Queues, Tables

**Définition :**
- **Azure AD OAuth 2.0** : Authentification IAM basée sur tokens pour accès programmatique
- **Type** : **Identity and Access Management (IAM)**
- **Scope** : Blob, Queue, Table Storage (pas SMB pour Files)
- **Méthode** : Utilisée par applications, service principals, managed identities

**⚠️ Différence Kerberos vs OAuth pour Identity-Based :**

| Aspect | Kerberos (Azure Files SMB) | OAuth 2.0 (Blob/Queue/Table) |
|--------|---------------------------|------------------------------|
| **Protocol** | Kerberos (SMB) | OAuth 2.0 (REST API) |
| **Usage** | Mappage réseau, utilisateurs finaux | Applications, services, APIs |
| **SSO** | ✅ Oui (Windows integrated) | ⚠️ Via managed identities |
| **Permissions** | RBAC + NTFS ACLs | RBAC uniquement |
| **Exam Focus** | ✅ Identity-based access | ⚠️ Programmatic access |

**Utilisation Azure AD pour Blob Storage :**

```bash
# Authentification avec Azure AD (pas de clés)
az login

# Accès à un blob avec identité
az storage blob download \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name myblob.txt \
  --file ./myblob.txt \
  --auth-mode login

# Via Managed Identity dans une application
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient

credential = DefaultAzureCredential()
blob_service_client = BlobServiceClient(
    account_url="https://mystorageaccount.blob.core.windows.net",
    credential=credential
)
```

**Rôles RBAC pour Blob Storage :**
- **Storage Blob Data Reader** : Lecture seule
- **Storage Blob Data Contributor** : Lecture + écriture
- **Storage Blob Data Owner** : Full control + ACLs (ADLS Gen2)

---

### 3. Shared Key (Account Key) - CREDENTIAL-BASED

**Définition :**
- **Shared Key** : Clé secrète du compte de stockage (512-bit)
- **Type** : **Credential-based** (NOT IAM)
- **Scope** : Tous les services (Blob, File, Queue, Table)
- **Permissions** : Accès COMPLET au compte de stockage

**⚠️ Important :**
- ❌ **PAS de l'IAM** : C'est une clé partagée, pas basé sur l'identité
- ❌ **Trop de privilèges** : Accès complet à toutes les ressources
- ⚠️ **À éviter** : Utiliser Azure AD ou SAS quand possible

**Utilisation :**

```bash
# Via Azure CLI
az storage blob download \
  --account-name mystorageaccount \
  --account-key "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" \
  --container-name mycontainer \
  --name myblob.txt \
  --file ./myblob.txt
```

**Rotation des Clés :**

```bash
# Régénérer key1
az storage account keys renew \
  --account-name mystorageaccount \
  --resource-group myResourceGroup \
  --key key1

# Processus recommandé :
# 1. Applications utilisent key1
# 2. Régénérer key2
# 3. Basculer applications vers key2
# 4. Régénérer key1
# 5. Répéter tous les 90 jours
```

---

### 4. Shared Access Signature (SAS) - CREDENTIAL-BASED avec Délégation

**Définition :**
- **SAS** : Token d'accès délégué avec permissions limitées
- **Type** : **Credential-based** (sauf User Delegation SAS qui est IAM)
- **Scope** : Granulaire (ressource spécifique)
- **Avantage** : Délégation sécurisée sans partager clés du compte

**⚠️ 3 Types de SAS et leur Relation avec IAM :**

| Type SAS | Basé sur | IAM ou Credential | Scope |
|----------|----------|-------------------|-------|
| **User Delegation SAS** | Azure AD (OAuth) | ✅ **IAM** | Blob, ADLS Gen2 |
| **Service SAS** | Account Key | ❌ Credential | 1 service |
| **Account SAS** | Account Key | ❌ Credential | Multi-services |

**Paramètres Obligatoires vs Optionnels :**

**Pour Account SAS :**
- ✅ **ss (SignedServices)** : OBLIGATOIRE
- ✅ **srt (SignedResourceTypes)** : OBLIGATOIRE
- ✅ **se (Expiry)** : OBLIGATOIRE
- ⚠️ **st (Start)** : Optionnel
- ⚠️ **sip (IP)** : Optionnel

**Pour Service SAS :**
- ✅ **sr (SignedResource)** : OBLIGATOIRE
- ✅ **se (Expiry)** : OBLIGATOIRE
- ⚠️ **st (Start)** : Optionnel

**⚠️ Seul User Delegation SAS est considéré IAM !**

```bash
# User Delegation SAS (IAM) - Recommandé
az storage blob generate-sas \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --name myblob.txt \
  --permissions r \
  --expiry 2024-12-31T23:59:59Z \
  --auth-mode login \
  --as-user

# Service SAS (Credential-based)
az storage blob generate-sas \
  --account-name mystorageaccount \
  --account-key "xxxx" \
  --container-name mycontainer \
  --name myblob.txt \
  --permissions r \
  --expiry 2024-12-31T23:59:59Z
```

---

### 5. Anonymous Public Access - NO AUTHENTICATION

**Définition :**
- **Anonymous Public Access** : Accès public sans authentification
- **Type** : **Aucune authentification**
- **Scope** : Blob Storage uniquement (containers et blobs)
- **Use Case** : Contenu public (images, CSS, JS pour websites)

**Configuration :**

```bash
# Activer anonymous access sur le storage account
az storage account update \
  --name mystorageaccount \
  --resource-group myResourceGroup \
  --allow-blob-public-access true

# Configurer anonymous access sur un container
az storage container set-permission \
  --name mycontainer \
  --account-name mystorageaccount \
  --public-access blob

# Niveaux :
# --public-access off : Pas d'accès anonyme
# --public-access blob : Accès blob individuel
# --public-access container : Accès container + blobs
```

**⚠️ Sécurité :**
- ❌ **Risque** : Données accessibles publiquement
- ✅ **Best Practice** : Désactiver par défaut au niveau compte
- ✅ **Audit** : Vérifier régulièrement les containers publics

---

### Tableau Récapitulatif - Méthodes d'Authentification par Service

**⚠️ À CONNAÎTRE PAR CŒUR pour l'Examen AZ-104 :**

| Service | Kerberos (IAM) | Azure AD OAuth (IAM) | Shared Key | SAS | Anonymous |
|---------|----------------|----------------------|------------|-----|-----------|
| **Azure Files (SMB)** | ✅ **SEUL service avec Kerberos** | ⚠️ REST API uniquement | ✅ Oui | ✅ Oui | ❌ Non |
| **Blob Storage** | ❌ Non | ✅ Oui (REST) | ✅ Oui | ✅ Oui | ✅ Oui |
| **Queue Storage** | ❌ Non | ✅ Oui (REST) | ✅ Oui | ✅ Oui | ❌ Non |
| **Table Storage** | ❌ Non | ✅ Oui (REST) | ✅ Oui | ✅ Oui | ❌ Non |

**⚠️ Scénarios d'Examen par Méthode :**

**Scénario 1 : Utilisateurs Finaux Accédant à File Shares**

```
Requirement : Les employés doivent accéder à des file shares avec leurs identités Azure AD
Question : Quelle méthode utiliser ?

Réponse : Microsoft Entra Kerberos ✅

Configuration :
1. Activer Microsoft Entra Kerberos sur storage account
2. Assigner RBAC (Storage File Data SMB Share Contributor)
3. Configurer NTFS permissions
4. Utilisateurs mappent le lecteur avec Azure\user@contoso.com

Type : IAM (Identity-Based Access)
```

**Scénario 2 : Application Azure VM Accédant à Blob Storage**

```
Requirement : VM doit lire/écrire des blobs sans clés dans le code
Question : Quelle méthode utiliser ?

Réponse : Managed Identity + Azure AD RBAC ✅

Configuration :
1. Activer System-Assigned Managed Identity sur VM
2. Assigner RBAC (Storage Blob Data Contributor)
3. Application utilise DefaultAzureCredential()

Type : IAM (Identity-Based Access via OAuth)
```

**Scénario 3 : Partage Temporaire avec Client Externe**

```
Requirement : Partager un fichier avec un partenaire externe pour 7 jours
Question : Quelle méthode utiliser ?

Réponse : User Delegation SAS ✅ (si Blob) ou Service SAS (si File)

Configuration :
1. User Delegation SAS pour Blobs (IAM)
2. Service SAS pour Files (Credential)
3. Expiration 7 jours
4. HTTPS uniquement

Type : IAM (User Delegation) ou Credential (Service SAS)
```

**Scénario 4 : Website Statique Public**

```
Requirement : Images et CSS doivent être accessibles publiquement
Question : Quelle méthode utiliser ?

Réponse : Anonymous Public Access ✅

Configuration :
1. Activer anonymous access sur storage account
2. Container public-access level = blob
3. Uploader images dans container

Type : Aucune authentification
```

**⚠️ Erreurs Courantes QCM :**

| Question | Réponse Incorrecte ❌ | Réponse Correcte ✅ |
|----------|----------------------|---------------------|
| **"Quel service supporte Kerberos identity-based access ?"** | "Blob Storage" | "Azure Files (SMB) uniquement" |
| **"User Delegation SAS est IAM ?"** | "Non, c'est credential-based" | "Oui, basé sur Azure AD (IAM)" |
| **"Account Key est identity-based ?"** | "Oui, lié à l'account" | "Non, c'est credential-based (clé partagée)" |
| **"Blob Storage supporte identity-based access ?"** | "Non, seulement clés" | "Oui, via Azure AD OAuth (mais pas Kerberos)" |
| **"Peut-on utiliser Kerberos pour Queues ?"** | "Oui, comme Files" | "Non, Kerberos = Azure Files SMB uniquement" |

**⚠️ Différence IAM vs Credential - Points Clés :**

**Identity-Based (IAM) :**
- ✅ Authentification basée sur QUI vous êtes (identité)
- ✅ Pas de secrets dans le code
- ✅ Révocation via Azure AD
- ✅ Audit trail complet
- ✅ **Exemples** : Kerberos (Files SMB), Azure AD OAuth, User Delegation SAS, Managed Identities

**Credential-Based :**
- ⚠️ Authentification basée sur CE QUE vous avez (secret)
- ❌ Secrets/clés à gérer
- ⚠️ Révocation = rotation clés
- ⚠️ Moins d'audit trail
- ⚠️ **Exemples** : Account Key, Service SAS, Account SAS

**⚠️ Points Clés pour l'Examen :**
- ✅ **Kerberos = IAM = Azure Files SMB UNIQUEMENT**
- ✅ **Identity-based access** dans questions d'examen = Chercher **Kerberos** ou **Azure Files**
- ✅ **User Delegation SAS** = Seul SAS qui est IAM (Blob/ADLS Gen2)
- ✅ **OAuth 2.0** = IAM mais via REST API (pas mappage réseau)
- ✅ **Account Key** = PAS IAM (credential-based)
- ✅ **RBAC requis** pour toutes les méthodes IAM
- ✅ **Microsoft Entra Kerberos** = Nouveau nom pour Azure AD Kerberos (2024)
- ✅ **3 niveaux** : RBAC (share-level) + NTFS (file-level) + Azure AD (tenant-level)

### Azure File Sync

**⚠️ Concept Clé pour AZ-104 : Azure File Sync centralise vos partages de fichiers dans Azure Files tout en conservant la flexibilité, la performance et la compatibilité de Windows Server**

**Définition :**
- **Azure File Sync** : Service qui synchronise les fichiers entre des serveurs Windows on-premises et Azure Files
- **Objectif** : Cache distribué d'Azure Files sur site, avec tiering cloud optionnel
- **Use Case Principal** : Migration hybride, disaster recovery, consolidation de file servers

**Architecture Azure File Sync :**

```
┌─────────────────────────────────────────────────────────┐
│                     Azure (Cloud)                       │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Storage Sync Service                     │   │
│  │    (Orchestration et gestion centrale)           │   │
│  └──────────────┬───────────────────────────────────┘   │
│                 │                                       │
│  ┌──────────────▼───────────────────────────────────┐   │
│  │        Azure File Share (Cloud Endpoint)         │   │
│  │     ─────────────────────────────────────────    │   │
│  │          Source centrale de vérité               │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                         ▲ ▼ Sync
┌─────────────────────────────────────────────────────────┐
│              On-Premises / Branch Offices               │
│  ┌─────────────────┐  ┌─────────────────┐               │
│  │  Windows Server │  │  Windows Server │               │
│  │   (HQ Office)   │  │ (Branch Office) │               │
│  │  ┌───────────┐  │  │  ┌───────────┐  │               │
│  │  │Azure File │  │  │  │Azure File │  │               │
│  │  │Sync Agent │  │  │  │Sync Agent │  │               │
│  │  └─────┬─────┘  │  │  └─────┬─────┘  │               │
│  │  ┌─────▼─────┐  │  │  ┌─────▼─────┐  │               │
│  │  │ Registered│  │  │  │ Registered│  │               │
│  │  │  Servers  │  │  │  │  Servers  │  │               │
│  │  └───────────┘  │  │  └───────────┘  │               │
│  └─────────────────┘  └─────────────────┘               │
│     Server Endpoint       Server Endpoint               │
└─────────────────────────────────────────────────────────┘
```

**Composants Principaux :**

**1. Storage Sync Service**
- **Rôle** : Ressource Azure de niveau supérieur pour orchestrer la synchronisation
- **Création** : Via Azure Portal, PowerShell ou CLI
- **Région** : Doit être dans la même région que le Storage Account
- **Gestion** : Point central pour tous les sync groups et registered servers

**2. Sync Group**
- **Définition** : Définit la topologie de synchronisation pour un ensemble de fichiers
- **Contenu** : 1 Cloud Endpoint + 1 ou plusieurs Server Endpoints
- **Limites** : Jusqu'à 100 sync groups par Storage Sync Service

**3. Cloud Endpoint**
- **Définition** : Azure File Share dans le cloud
- **Limite** : Un seul cloud endpoint par sync group
- **Requis** : Azure File Share doit être vide ou contenir uniquement des données à synchroniser

**4. Server Endpoint**
- **Définition** : Chemin spécifique sur un Windows Server enregistré (ex: D:\Shares\Finance)
- **Limite** : Jusqu'à 100 server endpoints par sync group
- **Contrainte** : Un seul server endpoint par volume (disque) sur un serveur

**5. Registered Server**
- **Définition** : Windows Server avec l'agent Azure File Sync installé
- **Limite** : Jusqu'à 99 registered servers par Storage Sync Service
- **Prérequis** : Windows Server 2016 ou supérieur (2019/2022 recommandé)

**Installation et Configuration - Étapes Détaillées :**

**Étape 1 : Prérequis**

```powershell
# Vérifier la version de Windows Server
Get-ComputerInfo | Select-Object WindowsProductName, OSDisplayVersion

# Versions supportées :
# - Windows Server 2016 (minimum)
# - Windows Server 2019 (recommandé)
# - Windows Server 2022
# - Azure Virtual Machines supportées

# Vérifier la connectivité réseau
Test-NetConnection -ComputerName file.core.windows.net -Port 443
Test-NetConnection -ComputerName kailani-afs.one.microsoft.com -Port 443
```

**Étape 2 : Créer Storage Sync Service**

```bash
# Via Azure CLI
az resource create \
  --resource-group myResourceGroup \
  --name myStorageSyncService \
  --resource-type "Microsoft.StorageSync/storageSyncServices" \
  --location "westeurope" \
  --properties '{}'

# Via PowerShell
New-AzStorageSyncService `
  -ResourceGroupName "myResourceGroup" `
  -Name "myStorageSyncService" `
  -Location "westeurope"
```

**Étape 3 : Installer Azure File Sync Agent sur Windows Server**

```powershell
# Télécharger et installer l'agent (PowerShell sur le serveur Windows)
# Lien : https://go.microsoft.com/fwlink/?linkid=858257

# Installation silencieuse
Start-Process -FilePath "StorageSyncAgent.msi" -ArgumentList "/quiet /qn" -Wait

# Vérifier l'installation
Get-Module -ListAvailable -Name StorageSync
```

**Étape 4 : Enregistrer le Windows Server**

```powershell
# Se connecter à Azure
Connect-AzAccount

# Enregistrer le serveur
Register-AzStorageSyncServer `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService"

# Vérifier l'enregistrement
Get-AzStorageSyncServer `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService"
```

**Étape 5 : Créer Sync Group**

```powershell
# Via PowerShell
New-AzStorageSyncGroup `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService" `
  -SyncGroupName "SyncGroup01"
```

**Étape 6 : Créer Cloud Endpoint**

```powershell
# Obtenir l'ID du Storage Account et File Share
$storageAccount = Get-AzStorageAccount `
  -ResourceGroupName "myResourceGroup" `
  -Name "mystorageaccount"

# Créer le cloud endpoint
New-AzStorageSyncCloudEndpoint `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService" `
  -SyncGroupName "SyncGroup01" `
  -StorageAccountResourceId $storageAccount.Id `
  -AzureFileShareName "myfileshare"
```

**Étape 7 : Créer Server Endpoint**

```powershell
# Obtenir le Registered Server ID
$registeredServer = Get-AzStorageSyncServer `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService"

# Créer le server endpoint
New-AzStorageSyncServerEndpoint `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService" `
  -SyncGroupName "SyncGroup01" `
  -ServerId $registeredServer.ResourceId `
  -ServerLocalPath "D:\Shares\Finance" `
  -CloudTiering `
  -VolumeFreeSpacePercent 20 `
  -TierFilesOlderThanDays 30
```

**⚠️ Cloud Tiering - Fonctionnalité Clé :**

**Définition :**
- **Cloud Tiering** : Fonctionnalité optionnelle qui garde les fichiers fréquemment accédés en local et "tiers" les fichiers froids vers Azure
- **Avantage** : Libère de l'espace disque local tout en maintenant l'accès transparent
- **Fonctionnement** : Remplace les fichiers par des "reparse points" (pointeurs)

**Politiques de Tiering :**

**1. Volume Free Space Policy**
```powershell
# Conserver 20% d'espace libre sur le volume
-VolumeFreeSpacePercent 20
```
- **Comportement** : Tiers automatiquement les fichiers les moins récemment accédés jusqu'à atteindre 20% d'espace libre
- **Recommandé** : 20-30% pour équilibrer performance et capacité

**2. Date Policy**
```powershell
# Tier les fichiers non accédés depuis 30 jours
-TierFilesOlderThanDays 30
```
- **Comportement** : Les fichiers non accédés pendant X jours sont tiered vers le cloud
- **Recommandé** : 7-60 jours selon les patterns d'accès

**Fonctionnement du Tiering :**

```
Fichier Initial (Local)
├── Taille : 100 MB
└── Accès : Dernier accès il y a 45 jours

     ▼ Tiering Policy Applied (TierFilesOlderThanDays 30)

Fichier Tiered (Reparse Point Local)
├── Taille locale : ~1 KB (métadonnées)
├── Taille cloud : 100 MB (dans Azure File Share)
└── Comportement : Transparent pour l'utilisateur

Utilisateur ouvre le fichier
     ▼ Automatic Recall

Fichier Recalled (Local à nouveau)
├── Téléchargement depuis Azure
├── Fichier complet disponible localement
└── Prochains accès instantanés
```

**Recall de Fichiers :**

```powershell
# Recall manuel d'un fichier spécifique
Invoke-StorageSyncFileRecall -Path "D:\Shares\Finance\ImportantDoc.pdf"

# Recall d'un dossier entier
Invoke-StorageSyncFileRecall -Path "D:\Shares\Finance\Q4Reports" -Recurse

# Vérifier l'état du tiering
Get-StorageSyncFileTieringResult -Path "D:\Shares\Finance"
```

**⚠️ Limites et Contraintes Azure File Sync :**

| Limite | Valeur | Notes |
|--------|--------|-------|
| **Storage Sync Services par subscription** | 100 | Par région Azure |
| **Sync Groups par Storage Sync Service** | 200 | Anciennement 100, augmenté en 2024 |
| **Cloud Endpoints par Sync Group** | 1 | Un seul Azure File Share |
| **Server Endpoints par Sync Group** | 100 | Plusieurs serveurs possibles |
| **Registered Servers par Storage Sync Service** | 99 | Windows Servers enregistrés |
| **Taille maximale fichier** | 100 TiB | Pour Premium File Shares |
| **Nombre de fichiers par volume** | ~100 millions | Dépend de la taille namespace |
| **Longueur chemin maximum** | 2048 caractères | Limitation Windows |

**⚠️ Scénarios d'Utilisation - Pour l'Examen :**

**Scénario 1 : Consolidation de File Servers de Branches**

```
Problème : 
- 20 bureaux régionaux avec leurs propres file servers
- Données dupliquées et non synchronisées
- Coût de maintenance élevé

Solution Azure File Sync :
1. Créer Azure File Share central (cloud endpoint)
2. Installer agents sur les 20 serveurs locaux
3. Créer 20 server endpoints dans le même sync group
4. Activer cloud tiering pour optimiser l'espace disque local
5. Résultat : Source de vérité unique dans Azure, accès local rapide

Avantages :
✅ Données centralisées dans Azure
✅ Cache local pour performance
✅ Synchronisation multi-sites automatique
✅ Réduction coûts infrastructure
```

**Scénario 2 : Disaster Recovery**

```
Problème :
- File server critique on-premises sans HA
- RTO/RPO élevés en cas de panne
- Backups traditionnels lents à restaurer

Solution Azure File Sync :
1. Synchroniser file server vers Azure Files
2. En cas de panne du serveur :
   - Monter Azure File Share directement depuis Azure VMs
   - Ou restaurer sur nouveau serveur avec sync
3. RTO < 1 heure au lieu de plusieurs heures

Avantages :
✅ Copie cloud automatique et continue
✅ Récupération rapide
✅ Pas besoin de restauration backup complète
```

**Scénario 3 : Lift and Shift avec Cache Local**

```
Problème :
- Migration d'applications vers Azure
- Applications nécessitent accès fichiers local rapide
- Bande passante WAN limitée vers Azure

Solution Azure File Sync :
1. Azure File Share comme stockage primaire
2. Azure File Sync sur Azure VMs pour cache local
3. Cloud tiering pour optimiser stockage VM
4. Fichiers fréquents en local (performance)
5. Fichiers froids dans le cloud (coût)

Avantages :
✅ Performance locale maintenue
✅ Capacité illimitée (Azure)
✅ Coûts optimisés
```

**⚠️ Monitoring et Troubleshooting :**

**Vérifier l'État de Synchronisation :**

```powershell
# Statut général du sync
Get-AzStorageSyncServerEndpoint `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService" `
  -SyncGroupName "SyncGroup01"

# Activité de synchronisation récente
Get-AzStorageSyncSyncSessionStatus `
  -ResourceGroupName "myResourceGroup" `
  -StorageSyncServiceName "myStorageSyncService" `
  -SyncGroupName "SyncGroup01"

# Fichiers non synchronisés (erreurs)
Get-StorageSyncFileSyncActivity -ServerEndpointPath "D:\Shares\Finance"
```

**Logs de Diagnostic :**

```
Event Viewer (Windows Server) :
- Applications and Services Logs
  └── Microsoft
      └── FileSync
          └── Agent
              ├── FileSyncEventLog
              ├── FileSyncTelemetryLog
              └── FileSyncRecallLog
```

**Métriques Azure Monitor :**

```bash
# Via Azure Portal
Storage Sync Service → Monitoring → Metrics

Métriques Clés :
- Sync session result (success/failure)
- Files synced
- Bytes synced
- Cloud tiering recall size
- Cloud tiering recall throughput
- Server online/offline status
```

**Problèmes Courants et Solutions :**

| Problème | Cause | Solution |
|----------|-------|----------|
| **Sync ne démarre pas** | Firewall bloque port 443 | Ouvrir ports 443 vers *.afs.azure.net |
| **Fichiers ne sont pas tiered** | Cloud tiering désactivé | Vérifier `-CloudTiering` paramètre |
| **Recall très lent** | Bande passante limitée | Augmenter QoS, vérifier throttling |
| **Erreur "ECS_E_SYNC_METADATA_KNOWLEDGE_SOFT_LIMIT_REACHED"** | Trop de fichiers modifiés | Augmenter sync session, planifier syncs |
| **Server endpoint health "No Activity"** | Agent non démarré | Redémarrer service FileSyncSvc |

**⚠️ Erreurs Courantes QCM :**

| Question | Réponse Incorrecte ❌ | Réponse Correcte ✅ |
|----------|----------------------|---------------------|
| **"Peut-on synchroniser entre 2 Azure File Shares directement ?"** | "Oui, avec Azure File Sync" | "Non, Azure File Sync synchronise serveurs Windows vers Azure Files" |
| **"Cloud Tiering supprime les fichiers du cloud ?"** | "Oui, pour libérer espace" | "Non, garde fichiers dans Azure et libère espace local" |
| **"Combien de cloud endpoints par sync group ?"** | "Illimité" ou "10" | "1 seul cloud endpoint par sync group" |
| **"Azure File Sync fonctionne sur Linux ?"** | "Oui, avec agent Linux" | "Non, Windows Server uniquement" |
| **"Peut-on avoir 2 server endpoints sur le même volume ?"** | "Oui, dans des dossiers différents" | "Non, un seul server endpoint par volume" |

**Comparaison avec Alternatives :**

| Solution | Use Case | Différence avec File Sync |
|----------|----------|---------------------------|
| **Azure Files Direct Mount** | Accès SMB simple sans cache | Pas de cache local, latence WAN complète |
| **Azure File Sync** | Cache distribué + synchronisation | Cache local, sync multi-sites, cloud tiering |
| **Storage Account Replication (GRS)** | Disaster Recovery stockage | Réplication au niveau stockage, pas de cache applicatif |
| **DFS Replication** | Synchronisation on-premises uniquement | Pas de cloud, maintenance complexe |

**Coûts Azure File Sync :**

```
Composants de Coût :
1. Azure File Share stockage (selon tier et taille)
2. Transactions de synchronisation (lectures/écritures)
3. Egress data (recall depuis cloud)
4. Storage Sync Service : GRATUIT
5. Agent Azure File Sync : GRATUIT

Optimisation :
- Utiliser Cool tier pour fichiers rarement accédés
- Activer cloud tiering pour réduire stockage local
- Monitorer recall patterns pour ajuster policies
```

**⚠️ Best Practices :**

**1. Planification**
- ✅ Évaluer patterns d'accès fichiers avant déploiement
- ✅ Dimensionner bande passante réseau (100 Mbps minimum recommandé)
- ✅ Tester avec pilot group avant déploiement complet

**2. Configuration**
- ✅ Activer cloud tiering pour serveurs avec espace limité
- ✅ Utiliser Date Policy (30-60 jours) ET Volume Free Space (20-30%)
- ✅ Créer server endpoints au niveau racine de volume si possible

**3. Sécurité**
- ✅ Utiliser HTTPS uniquement (port 443)
- ✅ Activer Azure AD authentication pour Azure Files
- ✅ Appliquer RBAC sur Storage Sync Service
- ✅ Activer encryption at rest et in transit

**4. Monitoring**
- ✅ Configurer alertes Azure Monitor pour sync failures
- ✅ Vérifier health status quotidiennement
- ✅ Monitorer métriques de tiering et recall

**5. Maintenance**
- ✅ Maintenir agents à jour (auto-update recommandé)
- ✅ Vérifier espace disque régulièrement
- ✅ Tester disaster recovery procedures

**⚠️ Points Clés pour l'Examen :**
- ✅ Azure File Sync = **Cache distribué** d'Azure Files sur Windows Server
- ✅ **1 cloud endpoint** (Azure File Share) par sync group
- ✅ **Jusqu'à 100 server endpoints** (serveurs Windows) par sync group
- ✅ **Cloud Tiering** : Libère espace local, garde fichiers dans Azure
- ✅ **Recall automatique** : Fichiers téléchargés à la demande depuis Azure
- ✅ **Windows Server uniquement** : Pas de support Linux
- ✅ **1 server endpoint par volume** : Contrainte importante
- ✅ **Synchronisation bidirectionnelle** : Modifications synchronisées dans les deux sens
- ✅ **Registered Server** : Windows Server avec agent installé
- ✅ **Use Cases** : Consolidation file servers, DR, migration hybride

---

