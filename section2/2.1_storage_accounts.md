## 2.1 Storage Accounts

### Types de Storage Accounts (Mise à jour 2024)

**General Purpose v2 (GPv2) - Standard**
- **Services** : Blobs, Files (Standard uniquement), Queues, Tables
- **Performance** : Standard (HDD)
- **Réplication** : Toutes les options (LRS, ZRS, GRS, GZRS, RA-GRS, RA-GZRS)
- **Usage** : Polyvalent, recommandé pour la plupart des cas
- **⚠️ Important** : GPv2 supporte uniquement les Standard File Shares (HDD). Pour Premium File Shares, utilisez un compte FileStorage.

**Premium Block Blobs (BlockBlobStorage)**
- **Services** : Block Blobs uniquement
- **Performance** : Premium (SSD) uniquement
- **Réplication** : LRS, ZRS uniquement
- **Usage** : Applications haute performance, bases de données, workloads IoT
- **Avantage** : IOPS élevées, latence faible (<10ms)
- **⚠️ Note** : Ne pas confondre avec "BlobStorage" (ancien type de compte deprecated)

**Premium File Shares (FileStorage)**
- **Services** : Files uniquement
- **Performance** : Premium (SSD) uniquement
- **Réplication** : LRS, ZRS uniquement
- **Usage** : Partages de fichiers haute performance
- **Nouveauté 2024** : Support NFS 4.1 avec chiffrement en transit

**⚠️ Erreur fréquente identifiée :** Confusion entre types de Storage Accounts pour Azure Files

**Types de Storage Accounts et support Azure Files :**

**FileStorage Accounts**
- **Support** : Premium File Shares uniquement (SSD, haute performance)
- **Usage** : Applications nécessitant des performances élevées
- **Limitation** : Ne supporte PAS les Standard File Shares

**General Purpose v2 (StorageV2)**
- **Support** : Standard File Shares uniquement (HDD, performance standard)
- **Usage** : Applications générales, partages de fichiers basiques
- **Limitation** : Ne supporte PAS les Premium File Shares

**BlobStorage Accounts**
- **Support** : Aucun support d'Azure Files
- **Usage** : Stockage de blobs uniquement
- **Limitation** : Pas de file shares du tout

**Piège d'examen courant :**
- **Erreur** : Essayer de créer des Premium File Shares sur un compte StorageV2
- **Correct** : Utiliser un FileStorage account pour les Premium File Shares
- **Règle** : Type de compte = Type de file share supporté

### Services de Stockage Azure - Différences Clés

**Comparaison des 4 services de stockage principaux :**

**1. Blob Storage (Binary Large Objects)**
- **Usage** : Stockage de fichiers non structurés (documents, images, vidéos, backups)
- **Types de blobs** : Block, Page, Append
- **Accès** : REST API, SDK, Azure Storage Explorer
- **Cas d'usage** : Sites web statiques, archives, médias, sauvegardes
- **Niveaux** : Hot, Cool, Cold, Archive (optimisation des coûts)

**2. Azure Files (File Shares)**
- **Usage** : Partages de fichiers réseau (comme un NAS/SAN cloud)
- **Protocoles** : SMB 3.0/3.1, NFS 4.1 (Premium uniquement)
- **Accès** : Mappage de lecteurs réseau, montage Linux
- **Cas d'usage** : Migration d'applications on-premises, partage de fichiers entre VMs
- **Port requis** : 445 TCP pour SMB

**3. Azure Queues (Message Queuing)**
- **Usage** : Messaging asynchrone entre composants d'application
- **Fonctionnalités** : FIFO, TTL, visibility timeout
- **Accès** : REST API, SDK
- **Cas d'usage** : Découplage d'applications, traitement asynchrone, workflows
- **Limite** : Messages jusqu'à 64 KB

**4. Azure Tables (NoSQL Database)**
- **Usage** : Base de données NoSQL pour données structurées
- **Structure** : Entités avec propriétés (clé-valeur)
- **Accès** : REST API, SDK, OData
- **Cas d'usage** : Logs d'application, métadonnées, données de configuration
- **Limite** : Entités jusqu'à 1 MB

1. Block Storage (type d'architecture de stockage)
C'est une architecture/catégorie de stockage qui fonctionne par blocs de données fixes :

Les Azure Managed Disks sont du block storage
Fonctionne comme un disque dur : données organisées en blocs de taille fixe
Utilisé pour les disques de VMs, volumes Kubernetes
Interface : montage comme volume (/dev/sda, C:\)

2. Block Blob (type d'objet dans Blob Storage)
C'est un type d'objet dans Azure Blob Storage :

C'est du object storage, pas du block storage
"Block" ici fait référence à la façon dont le blob est uploadé (par blocs/chunks)
Utilisé pour stocker des fichiers via API REST
Interface : HTTP/HTTPS (GET/PUT/DELETE)

**Matrice de décision rapide :**

| Besoin | Service | Raison |
|--------|---------|--------|
| Stocker des fichiers (images, docs) | **Blob Storage** | Optimisé pour fichiers non structurés |
| Partager des fichiers entre VMs | **Azure Files** | Protocoles SMB/NFS natifs |
| Communication asynchrone | **Azure Queues** | Messaging découplé |
| Stocker des données structurées | **Azure Tables** | Base NoSQL simple |
| Site web statique | **Blob Storage** | Hébergement web statique |
| Migration d'applications | **Azure Files** | Compatibilité SMB |
| Workflow de traitement | **Azure Queues** | Orchestration asynchrone |
| Logs et métadonnées | **Azure Tables** | Stockage clé-valeur |

**Points d'attention pour l'examen :**
- **Blob Storage** : Le plus polyvalent, supporte tous les types de fichiers
- **Azure Files** : Seul service avec protocoles réseau natifs (SMB/NFS)
- **Azure Queues** : Seul service de messaging asynchrone
- **Azure Tables** : Seule base de données NoSQL intégrée
- **Performance** : Premium uniquement pour Blobs et Files
- **Réplication** : Tous supportent LRS, certains limités pour ZRS/GRS

Le protocole NFS (Network File System) est un système de fichiers distribué qui permet de partager des fichiers sur un réseau comme s’ils étaient stockés localement.

### Réplication et Durabilité

**Local Redundant Storage (LRS)**
- 3 copies dans le même datacenter
- Durabilité : 99.999 999 999% (11 nines)
- Protection : Pannes matérielles

**Zone Redundant Storage (ZRS)**
- 3 copies dans 3 zones de disponibilité
- Durabilité : 99.9999999999% (12 nines)
- Protection : Panne d'un datacenter entier
- **Limitation** : Pas disponible dans toutes les régions

**Geo-Redundant Storage (GRS)**
- LRS dans région primaire + 3 copies dans région secondaire
- Durabilité : 99.99999999999999% (16 nines)
- Protection : Panne régionale

**Geo-Zone-Redundant Storage (GZRS)**
- ZRS dans région primaire + 3 copies dans région secondaire
- Durabilité : 99.99999999999999% (16 nines)
- Protection : Panne régionale + panne de zone
- **Limitation** : Pas disponible dans toutes les régions

**Read-Access GRS (RA-GRS)**
- Comme GRS + accès lecture sur région secondaire
- Useful pour applications nécessitant haute disponibilité lecture

**Read-Access GZRS (RA-GZRS)**
- Comme GZRS + accès lecture sur région secondaire
- Combinaison de haute disponibilité et résilience géographique

### Changement de Type de Réplication (Upgrade/Downgrade)

**Upgrade LRS → GRS**

**Vous pouvez **upgrader directement** le type de réplication sans migration

**Conversions de Réplication Supportées :**

| De | Vers | Supporté | Méthode |
|----|------|----------|---------|
| **LRS** | GRS, ZRS, GZRS, RA-GRS, RA-GZRS | ✅ Oui | Portal, CLI, PowerShell |
| **GRS** | LRS, RA-GRS | ✅ Oui | Portal, CLI, PowerShell |
| **ZRS** | GZRS, RA-GZRS | ✅ Oui | Portal, CLI, PowerShell |
| **Premium_LRS** | GRS, ZRS | ❌ Non | Conversion directe non supportée - Migration manuelle requise vers nouveau compte |

**Méthodes d'Upgrade - Exemples Pratiques :**

**1. Via Azure Portal :**
```
Storage Account → Configuration → Replication
→ Sélectionner GRS ou RA-GRS
→ Save
```

**2. Via Azure CLI :**
```bash
# Upgrade LRS → GRS
az storage account update \
  --name mystorageaccount \
  --resource-group myRG \
  --sku Standard_GRS

# Upgrade LRS → RA-GRS
az storage account update \
  --name mystorageaccount \
  --resource-group myRG \
  --sku Standard_RAGRS

# Upgrade LRS → ZRS
az storage account update \
  --name mystorageaccount \
  --resource-group myRG \
  --sku Standard_ZRS
```

**3. Via PowerShell :**
```powershell
# Upgrade LRS → GRS
Set-AzStorageAccount `
  -ResourceGroupName "myRG" `
  -Name "mystorageaccount" `
  -SkuName "Standard_GRS"

# Upgrade LRS → RA-GRS
Set-AzStorageAccount `
  -ResourceGroupName "myRG" `
  -Name "mystorageaccount" `
  -SkuName "Standard_RAGRS"
```

**⚠️ Points Importants :**

**Limitations :**
- ❌ **Premium Storage** (Premium_LRS pour Page Blobs) ne peut PAS être converti en GRS
- ❌ **FileStorage** et **BlockBlobStorage** limités à LRS/ZRS
- ✅ **General Purpose v2** supporte toutes les options

**Timing et Impact :**
- **Durée** : Peut prendre jusqu'à 24-72 heures pour la réplication initiale
- **Downtime** : ✅ **AUCUN** downtime pendant la conversion
- **Données** : Les données existantes sont automatiquement répliquées
- **Coût** : Augmentation du coût mensuel selon le type choisi

**Vérifier le statut de réplication :**
```bash
# Vérifier le SKU actuel
az storage account show \
  --name mystorageaccount \
  --resource-group myRG \
  --query "sku.name" \
  --output tsv

# Vérifier le statut de geo-replication
az storage account show \
  --name mystorageaccount \
  --resource-group myRG \
  --query "statusOfPrimary" \
  --output tsv
```

**Scénarios d'examen :**
- **"How to enable geo-redundancy?"** → Upgrade to GRS
- **"Minimal downtime during replication change?"** → Direct upgrade (zero downtime)
- **"Can Premium storage use GRS?"** → No, only LRS/ZRS
- **"Read access to secondary region?"** → Use RA-GRS or RA-GZRS

### Storage Account Firewall et Sécurité Réseau

**⚠️ Erreur Courante QCM : Autoriser les Services Azure via Firewall**

**Scénario :** Vous activez le firewall sur un Storage Account. Comment autoriser Azure Backup ou autres services Azure à accéder ?
*** Utiliser **Trusted Microsoft Services** ou **Service Endpoints**

**Par défaut :**
- Storage Account = **Ouvert à Internet** ("Allow all networks")
- Après activation firewall = **Tout est BLOQUÉ** sauf autorisations explicites

**Solutions pour Autoriser les Services Azure :**

**Solution 1 : Trusted Microsoft Services (Recommandé)**

```bash
# Activer le firewall et autoriser les services Microsoft de confiance
az storage account update \
  --name mystorageaccount \
  --resource-group myRG \
  --default-action Deny \
  --bypass AzureServices
```

**Via Azure Portal :**
```
Storage Account → Networking → Firewalls and virtual networks
→ Sélectionner "Enabled from selected virtual networks and IP addresses"
→ ✅ Cocher "Allow trusted Microsoft services to access this storage account"
```

**Services Concernés (Trusted Microsoft Services) :**
- ✅ **Azure Backup** - Sauvegarde de VMs et données
- ✅ **Azure Site Recovery** - Réplication et DR
- ✅ **Azure File Sync** - Synchronisation de fichiers
- ✅ **Azure Import/Export** - Migration de données
- ✅ **Azure Networking (logs)** - Logs diagnostiques
- ✅ **Azure DevOps** - Pipelines et artefacts
- ✅ **Azure Monitor** - Métriques et logs

**Solution 2 : Service Endpoints (Accès depuis VNet)**

```bash
# 1. Activer le service endpoint sur le subnet
az network vnet subnet update \
  --vnet-name myVNet \
  --name mySubnet \
  --resource-group myRG \
  --service-endpoints Microsoft.Storage

# 2. Ajouter une règle réseau au Storage Account
az storage account network-rule add \
  --account-name mystorageaccount \
  --resource-group myRG \
  --vnet-name myVNet \
  --subnet mySubnet
```

**Avantages Service Endpoints :**
- 🔒 Le trafic reste sur le backbone Azure (pas Internet)
- 🚀 Performance améliorée et latence réduite
- 💰 Pas de frais de transfert de données sortantes
- 🎯 Accès depuis VNet spécifiques uniquement

**Solution 3 : Private Endpoint (Sécurité Maximale)**

```bash
# Créer un Private Endpoint pour le Blob Storage
az network private-endpoint create \
  --name myPrivateEndpoint \
  --resource-group myRG \
  --vnet-name myVNet \
  --subnet mySubnet \
  --private-connection-resource-id "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Storage/storageAccounts/mystorageaccount" \
  --group-id blob \
  --connection-name myConnection
```

**Avantages Private Endpoint :**
- 🔒 Storage Account obtient une IP **privée** dans votre VNet
- ❌ **Jamais exposé** à Internet
- 🎯 Accès via IP privée uniquement (ex: 10.0.1.10)
- ✅ Compatible avec on-premises via ExpressRoute/VPN

**Solution 4 : Autoriser des IPs Publiques Spécifiques**

```bash
# Autoriser une IP publique spécifique
az storage account network-rule add \
  --account-name mystorageaccount \
  --resource-group myRG \
  --ip-address 203.0.113.50

# Autoriser une plage d'IPs (CIDR)
az storage account network-rule add \
  --account-name mystorageaccount \
  --resource-group myRG \
  --ip-address 203.0.113.0/24
```

**Configuration PowerShell :**
```powershell
# Activer le firewall avec Trusted Services
Update-AzStorageAccountNetworkRuleSet `
  -ResourceGroupName "myRG" `
  -Name "mystorageaccount" `
  -DefaultAction Deny `
  -Bypass AzureServices

# Ajouter une Virtual Network Rule
Add-AzStorageAccountNetworkRule `
  -ResourceGroupName "myRG" `
  -Name "mystorageaccount" `
  -VirtualNetworkResourceId "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Network/virtualNetworks/myVNet/subnets/mySubnet"
```

**⚠️ Points Critiques :**

**Bypass Options :**
- `AzureServices` - Autorise les services Microsoft de confiance
- `Logging` - Autorise les logs Storage Analytics
- `Metrics` - Autorise les métriques Storage Analytics
- `None` - Aucun bypass (tout bloqué)

**Ordre de Priorité des Règles :**
1. **Allow rules** (IP ou VNet) sont évaluées en premier
2. **Default action** (Allow ou Deny) s'applique si aucune règle ne match

**Scénarios d'Examen :**

| Besoin | Solution | Raison |
|--------|----------|--------|
| Azure Backup doit accéder au Storage | **Trusted Services** | Azure Backup est un service de confiance |
| VMs dans VNet doivent accéder | **Service Endpoint** | Accès depuis subnet spécifique |
| Aucun accès Internet nécessaire | **Private Endpoint** | IP privée uniquement |
| Admin depuis bureau doit accéder | **IP Whitelist** | Autoriser IP publique spécifique |

**Vérification et Troubleshooting :**

```bash
# Lister les règles réseau
az storage account network-rule list \
  --account-name mystorageaccount \
  --resource-group myRG

# Vérifier la configuration actuelle
az storage account show \
  --name mystorageaccount \
  --resource-group myRG \
  --query "networkRuleSet"

# Tester l'accès depuis une VM
# (Depuis la VM)
nslookup mystorageaccount.blob.core.windows.net
curl -I https://mystorageaccount.blob.core.windows.net/mycontainer
```

**⚠️ ATTENTION - Pièges Courants :**

1. **Après activation du firewall, pensez à autoriser VOTRE IP** pour continuer à accéder via le Portal !
2. **Service Endpoints** ne fonctionnent QUE pour le trafic depuis Azure (pas on-premises)
3. **Private Endpoints** nécessitent une configuration DNS spécifique
4. **Trusted Services** ne couvre PAS tous les services Azure (vérifier la liste)

**Best Practices :**
- ✅ Utiliser **Trusted Services** pour les services Azure intégrés
- ✅ Utiliser **Service Endpoints** pour les VMs/Apps dans VNets
- ✅ Utiliser **Private Endpoints** pour sécurité maximale
- ❌ **Éviter** "Allow all networks" en production
- ✅ **Toujours** autoriser votre IP admin pour gestion
---
