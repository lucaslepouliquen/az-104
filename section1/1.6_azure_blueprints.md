## 1.6 Azure Blueprints

**âš ï¸ Concept ClÃ© pour AZ-104 : Azure Blueprints permet de dÃ©finir un ensemble rÃ©pÃ©table de ressources Azure conforme aux standards et patterns de l'organisation**

**DÃ©finition :**
- **Azure Blueprints** : Service de gouvernance qui orchestre le dÃ©ploiement de plusieurs modÃ¨les de ressources et autres artefacts (RBAC, Policies, ARM templates)
- **Objectif** : DÃ©ploiement standardisÃ© et reproductible d'environnements Azure conformes
- **DiffÃ©rence clÃ©** : Contrairement Ã  ARM templates seuls, Blueprints maintient une relation vivante entre la dÃ©finition et le dÃ©ploiement

### Concepts et Architecture

**Architecture d'un Blueprint :**

```
Blueprint Definition (Reusable Template)
    â”œâ”€â”€ Artifacts (Components)
    â”‚   â”œâ”€â”€ Role Assignments (RBAC)
    â”‚   â”œâ”€â”€ Policy Assignments
    â”‚   â”œâ”€â”€ ARM Templates (Resources)
    â”‚   â””â”€â”€ Resource Groups
    â†“
Blueprint Assignment (Deployment to Subscription/MG)
    â”œâ”€â”€ Tracking
    â”œâ”€â”€ Versioning
    â””â”€â”€ Auditing
```

**Composants Principaux :**

**1. Blueprint Definition**
- **Template rÃ©utilisable** : Contient tous les artefacts Ã  dÃ©ployer
- **Stockage** : Management Group ou Subscription
- **Versioning** : Support des versions (v1.0, v2.0, etc.)
- **Publication** : Doit Ãªtre publiÃ© avant assignation

**2. Blueprint Assignment**
- **DÃ©ploiement actif** : Blueprint appliquÃ© Ã  une subscription ou management group
- **Parameters** : Valeurs spÃ©cifiques pour le dÃ©ploiement
- **Lock Modes** : Protection des ressources dÃ©ployÃ©es
- **Tracking** : Relation maintenue entre blueprint et ressources

**3. Artifacts (Artefacts)**
- **Role Assignments** : Assignations RBAC
- **Policy Assignments** : Policies Azure
- **ARM Templates** : DÃ©ploiement de ressources (VMs, Storage, VNets, etc.)
- **Resource Groups** : CrÃ©ation de Resource Groups

### Composants d'un Blueprint

**âš ï¸ Types d'Artefacts SupportÃ©s :**

**1. Role Assignments**
- **Usage** : Assigner des rÃ´les RBAC aux identitÃ©s
- **Scope** : Subscription ou Resource Group level
- **Exemple** : Assigner "Contributor" Ã  un groupe sur la subscription

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "roleAssignment",
  "properties": {
    "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
    "principalIds": "[parameters('contributors')]"
  }
}
```

**2. Policy Assignments**
- **Usage** : Appliquer Azure Policies pour conformitÃ©
- **Scope** : Subscription ou Resource Group level
- **Exemple** : Exiger tags sur toutes les ressources

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "policyAssignment",
  "properties": {
    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/1e30110a-5ceb-460c-a204-c1c3969c6d62",
    "parameters": {
      "tagName": {
        "value": "Environment"
      }
    }
  }
}
```

**3. ARM Templates**
- **Usage** : DÃ©ployer ressources Azure (VMs, Storage, Networks)
- **FlexibilitÃ©** : Support de tous les types de ressources ARM
- **Exemple** : DÃ©ployer VNet avec NSG et subnets

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "template",
  "properties": {
    "template": {
      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "resources": [
        {
          "type": "Microsoft.Network/virtualNetworks",
          "apiVersion": "2021-02-01",
          "name": "[parameters('vnetName')]",
          "location": "[parameters('location')]",
          "properties": {
            "addressSpace": {
              "addressPrefixes": ["10.0.0.0/16"]
            }
          }
        }
      ]
    },
    "parameters": {
      "vnetName": {
        "value": "[parameters('vnetName')]"
      }
    }
  }
}
```

**4. Resource Groups**
- **Usage** : DÃ©finir Resource Groups Ã  crÃ©er
- **Placeholders** : Peuvent Ãªtre rÃ©fÃ©rencÃ©s par d'autres artefacts
- **Exemple** : CrÃ©er "NetworkingRG" et "StorageRG"

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "resourceGroup",
  "name": "NetworkingRG",
  "properties": {
    "displayName": "Networking Resource Group"
  }
}
```

**âš ï¸ Ordre de DÃ©ploiement des Artefacts :**

Les artefacts sont dÃ©ployÃ©s dans un ordre spÃ©cifique :

```
1. Resource Groups
   â†“
2. Role Assignments (au niveau Subscription)
   â†“
3. Policy Assignments (au niveau Subscription)
   â†“
4. ARM Templates dÃ©ployant ressources dans RGs
   â†“
5. Role Assignments (au niveau Resource Group)
   â†“
6. Policy Assignments (au niveau Resource Group)
```

**DÃ©pendances Explicites :**

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "template",
  "properties": {
    "dependsOn": ["NetworkingRG", "nsgTemplate"],
    "template": { }
  }
}
```

### Lifecycle et Versioning

**âš ï¸ Cycle de Vie d'un Blueprint :**

**1. CrÃ©ation (Draft)**

```bash
# Via Azure CLI
az blueprint create \
  --name "CorporateStandard" \
  --description "Corporate standard environment" \
  --target-subscription "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# Via PowerShell
New-AzBlueprint -Name "CorporateStandard" `
  -SubscriptionId "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" `
  -Description "Corporate standard environment"
```

**2. Ajout d'Artefacts**

```bash
# Ajouter un artifact Policy
az blueprint artifact policy create \
  --blueprint-name "CorporateStandard" \
  --artifact-name "requireTags" \
  --policy-definition-id "/providers/Microsoft.Authorization/policyDefinitions/xxx" \
  --parameters '{"tagName": {"value": "Environment"}}'

# Ajouter un artifact ARM Template
az blueprint artifact template create \
  --blueprint-name "CorporateStandard" \
  --artifact-name "vnetTemplate" \
  --template @vnet-template.json \
  --parameters @vnet-parameters.json
```

**3. Publication**

```bash
# Publier une version
az blueprint publish \
  --blueprint-name "CorporateStandard" \
  --version "1.0" \
  --change-notes "Initial release"

# Via PowerShell
Publish-AzBlueprint -Blueprint $blueprint -Version "1.0"
```

**âš ï¸ Important :** Un Blueprint doit Ãªtre **publiÃ©** avant de pouvoir Ãªtre assignÃ©.

**4. Assignation (DÃ©ploiement)**

```bash
# Assigner le blueprint Ã  une subscription
az blueprint assignment create \
  --name "ProdEnvironment" \
  --location "eastus" \
  --identity-type "SystemAssigned" \
  --blueprint-version "/providers/Microsoft.Management/managementGroups/ContosoRoot/providers/Microsoft.Blueprint/blueprints/CorporateStandard/versions/1.0" \
  --resource-group-value artifact_name=NetworkingRG name=Networking-RG location=eastus \
  --parameters @assignment-parameters.json

# Via PowerShell
New-AzBlueprintAssignment -Name "ProdEnvironment" `
  -Blueprint $blueprint `
  -Location "eastus" `
  -SubscriptionId "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" `
  -Lock AllResourcesDoNotDelete
```

**5. Mise Ã  Jour**

```bash
# Modifier et publier nouvelle version
az blueprint publish \
  --blueprint-name "CorporateStandard" \
  --version "2.0" \
  --change-notes "Added NSG rules"

# Mettre Ã  jour l'assignation existante
az blueprint assignment update \
  --name "ProdEnvironment" \
  --blueprint-version "/providers/Microsoft.Management/managementGroups/ContosoRoot/providers/Microsoft.Blueprint/blueprints/CorporateStandard/versions/2.0"
```

**âš ï¸ Versioning - Concepts ClÃ©s :**

**Versions de Blueprint :**
- **Draft** : Version non publiÃ©e, modifiable
- **Published** : Version immuable, assignable
- **Format** : SÃ©mantique recommandÃ©e (v1.0, v1.1, v2.0)
- **Change Notes** : Documentation des modifications

**Gestion des Versions :**

| Ã‰tat | Modifiable | Assignable | Use Case |
|------|-----------|-----------|----------|
| **Draft** | âœ… Oui | âŒ Non | DÃ©veloppement, tests |
| **Published v1.0** | âŒ Non | âœ… Oui | Production, stable |
| **Published v2.0** | âŒ Non | âœ… Oui | Nouvelle version |

**StratÃ©gies de Mise Ã  Jour :**

```bash
# StratÃ©gie 1: Mise Ã  jour en place (risquÃ©)
az blueprint assignment update --name "ProdEnv" --blueprint-version "2.0"

# StratÃ©gie 2: Blue-Green (recommandÃ©)
# 1. Assigner v2.0 Ã  nouvelle subscription de test
az blueprint assignment create --name "ProdEnv-v2-Test" --blueprint-version "2.0"
# 2. Valider
# 3. Mettre Ã  jour production
az blueprint assignment update --name "ProdEnv" --blueprint-version "2.0"
```

**âš ï¸ Lock Modes (Protection des Ressources) :**

Les blueprints peuvent protÃ©ger les ressources dÃ©ployÃ©es contre les modifications :

**1. None (Par dÃ©faut)**
- **Protection** : Aucune
- **Modifications** : AutorisÃ©es
- **Use Case** : Environnements de dÃ©veloppement

**2. DoNotDelete**
- **Protection** : EmpÃªche suppression
- **Modifications** : AutorisÃ©es
- **Use Case** : Ressources critiques mais configurables

**3. AllResourcesReadOnly**
- **Protection** : Lecture seule complÃ¨te
- **Modifications** : BloquÃ©es (sauf via blueprint update)
- **Use Case** : ConformitÃ© stricte, audit

**4. AllResourcesDoNotDelete**
- **Protection** : EmpÃªche suppression de toutes les ressources
- **Modifications** : AutorisÃ©es
- **Use Case** : Production avec flexibilitÃ©

```bash
# Assigner avec lock mode
az blueprint assignment create \
  --name "ProdEnv" \
  --lock-mode "AllResourcesDoNotDelete" \
  --blueprint-version "1.0"
```

**âš ï¸ Important :** Les locks de blueprint sont **plus forts** que les resource locks standards et peuvent uniquement Ãªtre modifiÃ©s via mise Ã  jour du blueprint.

### Blueprints vs ARM Templates vs Policy

**âš ï¸ Comparaison DÃ©taillÃ©e - Pour l'Examen :**

| CritÃ¨re | ARM Templates | Azure Policy | Azure Blueprints |
|---------|--------------|--------------|------------------|
| **Objectif** | DÃ©ployer ressources | ConformitÃ© governance | Orchestration complÃ¨te |
| **Contenu** | Ressources uniquement | RÃ¨gles de conformitÃ© | RBAC + Policies + Templates + RGs |
| **Tracking** | âŒ Aucun lien aprÃ¨s dÃ©ploiement | âœ… Ã‰valuation continue | âœ… Relation vivante maintenue |
| **Versioning** | âŒ Manuelle (Git, etc.) | âŒ Non supportÃ© | âœ… Natif (v1.0, v2.0) |
| **RBAC** | âŒ SÃ©parÃ© | âŒ SÃ©parÃ© | âœ… Inclus dans artifacts |
| **Policies** | âŒ SÃ©parÃ© | âœ… Core functionality | âœ… Inclus dans artifacts |
| **Auditing** | âŒ LimitÃ© | âœ… Compliance reports | âœ… Complet (qui, quand, quelle version) |
| **Scope** | Resource Group ou Subscription | MG, Subscription, RG, Resource | Subscription ou MG assignment |
| **Update Management** | âŒ RedÃ©ploiement manuel | âœ… Remediation tasks | âœ… Blueprint update propagation |

**Quand utiliser quoi ?**

**Utiliser ARM Templates quand :**
- âœ… **DÃ©ploiement simple** : Ressources uniquement, pas de governance
- âœ… **FlexibilitÃ© maximale** : Besoin de contrÃ´le total sur le dÃ©ploiement
- âœ… **CI/CD pipeline** : IntÃ©gration DevOps standard
- âœ… **One-time deployment** : Pas besoin de tracking

**Exemple :** DÃ©ployer une application web avec base de donnÃ©es

**Utiliser Azure Policy quand :**
- âœ… **ConformitÃ© uniquement** : Pas de dÃ©ploiement de ressources
- âœ… **Audit et enforcement** : VÃ©rifier configurations existantes
- âœ… **Standards organisationnels** : Appliquer rÃ¨gles (tags, rÃ©gions, SKUs)
- âœ… **Remediation** : Corriger automatiquement non-conformitÃ©s

**Exemple :** Exiger encryption sur tous les Storage Accounts

**Utiliser Azure Blueprints quand :**
- âœ… **DÃ©ploiement complet d'environnements** : Ressources + Governance
- âœ… **Standardisation** : Templates rÃ©utilisables pour subscriptions
- âœ… **Tracking requis** : Besoin de savoir ce qui a Ã©tÃ© dÃ©ployÃ© et par qui
- âœ… **ConformitÃ© stricte** : Combinaison RBAC + Policies + Resources
- âœ… **Versioning important** : Gestion de versions multiples

**Exemple :** DÃ©ployer un environnement de production standardisÃ© avec networking, RBAC, policies de sÃ©curitÃ©, et ressources compute

**ScÃ©narios Pratiques - Pour l'Examen :**

**ScÃ©nario 1 - Environnement de Production StandardisÃ© :**

```
Requirement: DÃ©ployer 10 subscriptions identiques pour diffÃ©rentes BU
- VNet avec subnets standardisÃ©s
- NSG avec rÃ¨gles de sÃ©curitÃ©
- Storage Account avec encryption obligatoire
- RBAC: Contributor pour Ã©quipe BU, Reader pour security team
- Policies: Require tags, allowed locations, allowed VM SKUs

Solution: Azure Blueprints
1. CrÃ©er blueprint avec artifacts:
   - ARM template pour VNet et NSG
   - ARM template pour Storage
   - Policy assignments (tags, locations, SKUs)
   - Role assignments (Contributor, Reader)
2. Publier version 1.0
3. Assigner Ã  chaque subscription avec lock mode DoNotDelete
4. Tracking automatique, versioning, audit complet
```

**ScÃ©nario 2 - Landing Zone Azure :**

```
Requirement: CrÃ©er landing zone pour nouvelles subscriptions
- Management Groups hierarchy
- Logging et monitoring (Log Analytics)
- Security baseline (Microsoft Defender for Cloud)
- Networking hub-and-spoke
- RBAC standardisÃ©

Solution: Azure Blueprints (CAF Landing Zone)
- Utiliser Microsoft Cloud Adoption Framework (CAF) blueprints
- Personnaliser artifacts pour organisation
- DÃ©ployer via blueprint assignment
```

**ScÃ©nario 3 - ConformitÃ© ISO 27001 :**

```
Requirement: Subscription conforme ISO 27001
- 50+ Azure Policies pour conformitÃ©
- RBAC avec least privilege
- Logging et auditing activÃ©s
- Encryption partout

Solution: Azure Blueprints (ISO 27001 sample)
- Utiliser blueprint sample Microsoft
- Assigner Ã  subscription avec lock mode ReadOnly
- Automatic compliance reporting
```

**âš ï¸ Blueprint Samples Microsoft :**

Microsoft fournit des blueprints prÃªts Ã  l'emploi :

**Compliance :**
- **ISO 27001** : ConformitÃ© ISO 27001
- **NIST SP 800-53** : Standards fÃ©dÃ©raux US
- **PCI-DSS v3.2.1** : Payment Card Industry
- **HIPAA HITRUST** : Healthcare compliance
- **UK OFFICIAL / UK NHS** : UK Government standards
- **Canada Federal PBMM** : Canadian government

**Foundation :**
- **CAF Foundation** : Cloud Adoption Framework base
- **CAF Migration Landing Zone** : Migration-ready environment

**CrÃ©ation et Gestion via Portal :**

```
Azure Portal Navigation:
1. Search "Blueprints"
2. Blueprint definitions â†’ Create
3. Choisir template (blank ou sample)
4. Ajouter artifacts
5. Publish
6. Assignments â†’ Create assignment
```

**âš ï¸ Permissions Requises :**

**Pour crÃ©er/modifier blueprints :**
- **Owner** sur Management Group ou Subscription (stockage du blueprint)
- Ou rÃ´le custom avec : `Microsoft.Blueprint/blueprints/write`

**Pour assigner blueprints :**
- **Owner** sur target subscription
- **Blueprint Operator** (rÃ´le built-in) : Peut assigner blueprints existants
- âš ï¸ Note : Blueprint assignment utilise System-Assigned Managed Identity qui nÃ©cessite permissions sur target resources

**Assigner permissions Ã  Managed Identity du Blueprint :**

```bash
# Le blueprint assignment crÃ©e automatiquement une System-Assigned MI
# Cette MI nÃ©cessite des permissions pour dÃ©ployer les ressources

# Exemple: Si blueprint dÃ©ploie VMs et Storage
# La MI a besoin de "Contributor" sur la subscription

# Cela est gÃ©rÃ© automatiquement si vous avez Owner
# Sinon, assigner manuellement:
principalId=$(az blueprint assignment show --name "ProdEnv" --query identity.principalId -o tsv)
az role assignment create \
  --assignee $principalId \
  --role "Contributor" \
  --scope "/subscriptions/xxx"
```

**âš ï¸ Erreurs Courantes QCM :**

| Question | RÃ©ponse Incorrecte âŒ | RÃ©ponse Correcte âœ… |
|----------|----------------------|---------------------|
| **"DiffÃ©rence Blueprint vs ARM template ?"** | "Blueprint est plus rapide" | "Blueprint maintient relation + versioning + includes RBAC/Policies" |
| **"Peut-on modifier un blueprint publiÃ© ?"** | "Oui, Ã  tout moment" | "Non, doit crÃ©er nouvelle version" |
| **"Blueprint peut dÃ©ployer sur Management Group ?"** | "Oui, dÃ©ploiement direct" | "Non, assignation Ã  subscription uniquement" |
| **"Lock mode ReadOnly empÃªche blueprint update ?"** | "Oui, aucune modification possible" | "Non, blueprint update contourne le lock" |
| **"ARM template suffit pour RBAC + Policies ?"** | "Oui, tout dans ARM" | "Non, utiliser Blueprint pour orchestration complÃ¨te" |

**Monitoring et Troubleshooting :**

```bash
# Lister les blueprints
az blueprint list --subscription "xxx"

# Voir dÃ©tails d'un blueprint
az blueprint show --name "CorporateStandard"

# Lister les assignments
az blueprint assignment list

# Voir statut d'un assignment
az blueprint assignment show --name "ProdEnv"

# Voir l'historique de dÃ©ploiement
az blueprint assignment operation list --name "ProdEnv"

# Logs dans Azure Portal
# Blueprints â†’ Assigned blueprints â†’ Select assignment â†’ Deployment history
```

**âš ï¸ Points ClÃ©s pour l'Examen :**
- âœ… Blueprint = **Orchestration** de RBAC + Policies + ARM Templates + Resource Groups
- âœ… **Tracking vivant** : Relation maintenue entre definition et deployment
- âœ… **Versioning natif** : Published versions immuables
- âœ… **Lock modes** : Protection des ressources dÃ©ployÃ©es
- âœ… **Doit Ãªtre publiÃ©** avant assignation
- âœ… **Managed Identity** : System-Assigned MI crÃ©Ã©e automatiquement pour deployment
- âœ… **Artifacts** : 4 types (Role, Policy, Template, Resource Group)
- âœ… **Scope** : Blueprint definition au MG/Subscription, assignment Ã  Subscription uniquement
- âœ… **Use Case Principal** : DÃ©ploiements standardisÃ©s d'environnements conformes
- âœ… **Samples** : Microsoft fournit blueprints ISO, NIST, PCI-DSS, CAF

