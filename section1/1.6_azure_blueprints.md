## 1.6 Azure Blueprints

**⚠️ Concept Clé pour AZ-104 : Azure Blueprints permet de définir un ensemble répétable de ressources Azure conforme aux standards et patterns de l'organisation**

**Définition :**
- **Azure Blueprints** : Service de gouvernance qui orchestre le déploiement de plusieurs modèles de ressources et autres artefacts (RBAC, Policies, ARM templates)
- **Objectif** : Déploiement standardisé et reproductible d'environnements Azure conformes
- **Différence clé** : Contrairement à ARM templates seuls, Blueprints maintient une relation vivante entre la définition et le déploiement

### Concepts et Architecture

**Architecture d'un Blueprint :**

```
Blueprint Definition (Reusable Template)
    ├── Artifacts (Components)
    │   ├── Role Assignments (RBAC)
    │   ├── Policy Assignments
    │   ├── ARM Templates (Resources)
    │   └── Resource Groups
    ↓
Blueprint Assignment (Deployment to Subscription/MG)
    ├── Tracking
    ├── Versioning
    └── Auditing
```

**Composants Principaux :**

**1. Blueprint Definition**
- **Template réutilisable** : Contient tous les artefacts à déployer
- **Stockage** : Management Group ou Subscription
- **Versioning** : Support des versions (v1.0, v2.0, etc.)
- **Publication** : Doit être publié avant assignation

**2. Blueprint Assignment**
- **Déploiement actif** : Blueprint appliqué à une subscription ou management group
- **Parameters** : Valeurs spécifiques pour le déploiement
- **Lock Modes** : Protection des ressources déployées
- **Tracking** : Relation maintenue entre blueprint et ressources

**3. Artifacts (Artefacts)**
- **Role Assignments** : Assignations RBAC
- **Policy Assignments** : Policies Azure
- **ARM Templates** : Déploiement de ressources (VMs, Storage, VNets, etc.)
- **Resource Groups** : Création de Resource Groups

### Composants d'un Blueprint

**⚠️ Types d'Artefacts Supportés :**

**1. Role Assignments**
- **Usage** : Assigner des rôles RBAC aux identités
- **Scope** : Subscription ou Resource Group level
- **Exemple** : Assigner "Contributor" à un groupe sur la subscription

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "roleAssignment",
  "properties": {
    "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
    "principalIds": "[parameters('contributors')]"
  }
}
```

**2. Policy Assignments**
- **Usage** : Appliquer Azure Policies pour conformité
- **Scope** : Subscription ou Resource Group level
- **Exemple** : Exiger tags sur toutes les ressources

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "policyAssignment",
  "properties": {
    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/1e30110a-5ceb-460c-a204-c1c3969c6d62",
    "parameters": {
      "tagName": {
        "value": "Environment"
      }
    }
  }
}
```

**3. ARM Templates**
- **Usage** : Déployer ressources Azure (VMs, Storage, Networks)
- **Flexibilité** : Support de tous les types de ressources ARM
- **Exemple** : Déployer VNet avec NSG et subnets

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "template",
  "properties": {
    "template": {
      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "resources": [
        {
          "type": "Microsoft.Network/virtualNetworks",
          "apiVersion": "2021-02-01",
          "name": "[parameters('vnetName')]",
          "location": "[parameters('location')]",
          "properties": {
            "addressSpace": {
              "addressPrefixes": ["10.0.0.0/16"]
            }
          }
        }
      ]
    },
    "parameters": {
      "vnetName": {
        "value": "[parameters('vnetName')]"
      }
    }
  }
}
```

**4. Resource Groups**
- **Usage** : Définir Resource Groups à créer
- **Placeholders** : Peuvent être référencés par d'autres artefacts
- **Exemple** : Créer "NetworkingRG" et "StorageRG"

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "resourceGroup",
  "name": "NetworkingRG",
  "properties": {
    "displayName": "Networking Resource Group"
  }
}
```

**⚠️ Ordre de Déploiement des Artefacts :**

Les artefacts sont déployés dans un ordre spécifique :

```
1. Resource Groups
   ↓
2. Role Assignments (au niveau Subscription)
   ↓
3. Policy Assignments (au niveau Subscription)
   ↓
4. ARM Templates déployant ressources dans RGs
   ↓
5. Role Assignments (au niveau Resource Group)
   ↓
6. Policy Assignments (au niveau Resource Group)
```

**Dépendances Explicites :**

```json
{
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "kind": "template",
  "properties": {
    "dependsOn": ["NetworkingRG", "nsgTemplate"],
    "template": { }
  }
}
```

### Lifecycle et Versioning

**⚠️ Cycle de Vie d'un Blueprint :**

**1. Création (Draft)**

```bash
# Via Azure CLI
az blueprint create \
  --name "CorporateStandard" \
  --description "Corporate standard environment" \
  --target-subscription "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# Via PowerShell
New-AzBlueprint -Name "CorporateStandard" `
  -SubscriptionId "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" `
  -Description "Corporate standard environment"
```

**2. Ajout d'Artefacts**

```bash
# Ajouter un artifact Policy
az blueprint artifact policy create \
  --blueprint-name "CorporateStandard" \
  --artifact-name "requireTags" \
  --policy-definition-id "/providers/Microsoft.Authorization/policyDefinitions/xxx" \
  --parameters '{"tagName": {"value": "Environment"}}'

# Ajouter un artifact ARM Template
az blueprint artifact template create \
  --blueprint-name "CorporateStandard" \
  --artifact-name "vnetTemplate" \
  --template @vnet-template.json \
  --parameters @vnet-parameters.json
```

**3. Publication**

```bash
# Publier une version
az blueprint publish \
  --blueprint-name "CorporateStandard" \
  --version "1.0" \
  --change-notes "Initial release"

# Via PowerShell
Publish-AzBlueprint -Blueprint $blueprint -Version "1.0"
```

**⚠️ Important :** Un Blueprint doit être **publié** avant de pouvoir être assigné.

**4. Assignation (Déploiement)**

```bash
# Assigner le blueprint à une subscription
az blueprint assignment create \
  --name "ProdEnvironment" \
  --location "eastus" \
  --identity-type "SystemAssigned" \
  --blueprint-version "/providers/Microsoft.Management/managementGroups/ContosoRoot/providers/Microsoft.Blueprint/blueprints/CorporateStandard/versions/1.0" \
  --resource-group-value artifact_name=NetworkingRG name=Networking-RG location=eastus \
  --parameters @assignment-parameters.json

# Via PowerShell
New-AzBlueprintAssignment -Name "ProdEnvironment" `
  -Blueprint $blueprint `
  -Location "eastus" `
  -SubscriptionId "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" `
  -Lock AllResourcesDoNotDelete
```

**5. Mise à Jour**

```bash
# Modifier et publier nouvelle version
az blueprint publish \
  --blueprint-name "CorporateStandard" \
  --version "2.0" \
  --change-notes "Added NSG rules"

# Mettre à jour l'assignation existante
az blueprint assignment update \
  --name "ProdEnvironment" \
  --blueprint-version "/providers/Microsoft.Management/managementGroups/ContosoRoot/providers/Microsoft.Blueprint/blueprints/CorporateStandard/versions/2.0"
```

**⚠️ Versioning - Concepts Clés :**

**Versions de Blueprint :**
- **Draft** : Version non publiée, modifiable
- **Published** : Version immuable, assignable
- **Format** : Sémantique recommandée (v1.0, v1.1, v2.0)
- **Change Notes** : Documentation des modifications

**Gestion des Versions :**

| à‰tat | Modifiable | Assignable | Use Case |
|------|-----------|-----------|----------|
| **Draft** | ✅ Oui | ❌ Non | Développement, tests |
| **Published v1.0** | ❌ Non | ✅ Oui | Production, stable |
| **Published v2.0** | ❌ Non | ✅ Oui | Nouvelle version |

**Stratégies de Mise à Jour :**

```bash
# Stratégie 1: Mise à jour en place (risqué)
az blueprint assignment update --name "ProdEnv" --blueprint-version "2.0"

# Stratégie 2: Blue-Green (recommandé)
# 1. Assigner v2.0 à nouvelle subscription de test
az blueprint assignment create --name "ProdEnv-v2-Test" --blueprint-version "2.0"
# 2. Valider
# 3. Mettre à jour production
az blueprint assignment update --name "ProdEnv" --blueprint-version "2.0"
```

**⚠️ Lock Modes (Protection des Ressources) :**

Les blueprints peuvent protéger les ressources déployées contre les modifications :

**1. None (Par défaut)**
- **Protection** : Aucune
- **Modifications** : Autorisées
- **Use Case** : Environnements de développement

**2. DoNotDelete**
- **Protection** : Empêche suppression
- **Modifications** : Autorisées
- **Use Case** : Ressources critiques mais configurables

**3. AllResourcesReadOnly**
- **Protection** : Lecture seule complète
- **Modifications** : Bloquées (sauf via blueprint update)
- **Use Case** : Conformité stricte, audit

**4. AllResourcesDoNotDelete**
- **Protection** : Empêche suppression de toutes les ressources
- **Modifications** : Autorisées
- **Use Case** : Production avec flexibilité

```bash
# Assigner avec lock mode
az blueprint assignment create \
  --name "ProdEnv" \
  --lock-mode "AllResourcesDoNotDelete" \
  --blueprint-version "1.0"
```

**⚠️ Important :** Les locks de blueprint sont **plus forts** que les resource locks standards et peuvent uniquement être modifiés via mise à jour du blueprint.

### Blueprints vs ARM Templates vs Policy

**⚠️ Comparaison Détaillée - Pour l'Examen :**

| Critère | ARM Templates | Azure Policy | Azure Blueprints |
|---------|--------------|--------------|------------------|
| **Objectif** | Déployer ressources | Conformité governance | Orchestration complète |
| **Contenu** | Ressources uniquement | Règles de conformité | RBAC + Policies + Templates + RGs |
| **Tracking** | ❌ Aucun lien après déploiement | ✅ à‰valuation continue | ✅ Relation vivante maintenue |
| **Versioning** | ❌ Manuelle (Git, etc.) | ❌ Non supporté | ✅ Natif (v1.0, v2.0) |
| **RBAC** | ❌ Séparé | ❌ Séparé | ✅ Inclus dans artifacts |
| **Policies** | ❌ Séparé | ✅ Core functionality | ✅ Inclus dans artifacts |
| **Auditing** | ❌ Limité | ✅ Compliance reports | ✅ Complet (qui, quand, quelle version) |
| **Scope** | Resource Group ou Subscription | MG, Subscription, RG, Resource | Subscription ou MG assignment |
| **Update Management** | ❌ Redéploiement manuel | ✅ Remediation tasks | ✅ Blueprint update propagation |

**Quand utiliser quoi ?**

**Utiliser ARM Templates quand :**
- ✅ **Déploiement simple** : Ressources uniquement, pas de governance
- ✅ **Flexibilité maximale** : Besoin de contrôle total sur le déploiement
- ✅ **CI/CD pipeline** : Intégration DevOps standard
- ✅ **One-time deployment** : Pas besoin de tracking

**Exemple :** Déployer une application web avec base de données

**Utiliser Azure Policy quand :**
- ✅ **Conformité uniquement** : Pas de déploiement de ressources
- ✅ **Audit et enforcement** : Vérifier configurations existantes
- ✅ **Standards organisationnels** : Appliquer règles (tags, régions, SKUs)
- ✅ **Remediation** : Corriger automatiquement non-conformités

**Exemple :** Exiger encryption sur tous les Storage Accounts

**Utiliser Azure Blueprints quand :**
- ✅ **Déploiement complet d'environnements** : Ressources + Governance
- ✅ **Standardisation** : Templates réutilisables pour subscriptions
- ✅ **Tracking requis** : Besoin de savoir ce qui a été déployé et par qui
- ✅ **Conformité stricte** : Combinaison RBAC + Policies + Resources
- ✅ **Versioning important** : Gestion de versions multiples

**Exemple :** Déployer un environnement de production standardisé avec networking, RBAC, policies de sécurité, et ressources compute

**Scénarios Pratiques - Pour l'Examen :**

**Scénario 1 - Environnement de Production Standardisé :**

```
Requirement: Déployer 10 subscriptions identiques pour différentes BU
- VNet avec subnets standardisés
- NSG avec règles de sécurité
- Storage Account avec encryption obligatoire
- RBAC: Contributor pour équipe BU, Reader pour security team
- Policies: Require tags, allowed locations, allowed VM SKUs

Solution: Azure Blueprints
1. Créer blueprint avec artifacts:
   - ARM template pour VNet et NSG
   - ARM template pour Storage
   - Policy assignments (tags, locations, SKUs)
   - Role assignments (Contributor, Reader)
2. Publier version 1.0
3. Assigner à chaque subscription avec lock mode DoNotDelete
4. Tracking automatique, versioning, audit complet
```

**Scénario 2 - Landing Zone Azure :**

```
Requirement: Créer landing zone pour nouvelles subscriptions
- Management Groups hierarchy
- Logging et monitoring (Log Analytics)
- Security baseline (Microsoft Defender for Cloud)
- Networking hub-and-spoke
- RBAC standardisé

Solution: Azure Blueprints (CAF Landing Zone)
- Utiliser Microsoft Cloud Adoption Framework (CAF) blueprints
- Personnaliser artifacts pour organisation
- Déployer via blueprint assignment
```

**Scénario 3 - Conformité ISO 27001 :**

```
Requirement: Subscription conforme ISO 27001
- 50+ Azure Policies pour conformité
- RBAC avec least privilege
- Logging et auditing activés
- Encryption partout

Solution: Azure Blueprints (ISO 27001 sample)
- Utiliser blueprint sample Microsoft
- Assigner à subscription avec lock mode ReadOnly
- Automatic compliance reporting
```

**⚠️ Blueprint Samples Microsoft :**

Microsoft fournit des blueprints prêts à l'emploi :

**Compliance :**
- **ISO 27001** : Conformité ISO 27001
- **NIST SP 800-53** : Standards fédéraux US
- **PCI-DSS v3.2.1** : Payment Card Industry
- **HIPAA HITRUST** : Healthcare compliance
- **UK OFFICIAL / UK NHS** : UK Government standards
- **Canada Federal PBMM** : Canadian government

**Foundation :**
- **CAF Foundation** : Cloud Adoption Framework base
- **CAF Migration Landing Zone** : Migration-ready environment

**Création et Gestion via Portal :**

```
Azure Portal Navigation:
1. Search "Blueprints"
2. Blueprint definitions → Create
3. Choisir template (blank ou sample)
4. Ajouter artifacts
5. Publish
6. Assignments → Create assignment
```

**⚠️ Permissions Requises :**

**Pour créer/modifier blueprints :**
- **Owner** sur Management Group ou Subscription (stockage du blueprint)
- Ou rôle custom avec : `Microsoft.Blueprint/blueprints/write`

**Pour assigner blueprints :**
- **Owner** sur target subscription
- **Blueprint Operator** (rôle built-in) : Peut assigner blueprints existants
- ⚠️ Note : Blueprint assignment utilise System-Assigned Managed Identity qui nécessite permissions sur target resources

**Assigner permissions à Managed Identity du Blueprint :**

```bash
# Le blueprint assignment crée automatiquement une System-Assigned MI
# Cette MI nécessite des permissions pour déployer les ressources

# Exemple: Si blueprint déploie VMs et Storage
# La MI a besoin de "Contributor" sur la subscription

# Cela est géré automatiquement si vous avez Owner
# Sinon, assigner manuellement:
principalId=$(az blueprint assignment show --name "ProdEnv" --query identity.principalId -o tsv)
az role assignment create \
  --assignee $principalId \
  --role "Contributor" \
  --scope "/subscriptions/xxx"
```

**⚠️ Erreurs Courantes QCM :**

| Question | Réponse Incorrecte ❌ | Réponse Correcte ✅ |
|----------|----------------------|---------------------|
| **"Différence Blueprint vs ARM template ?"** | "Blueprint est plus rapide" | "Blueprint maintient relation + versioning + includes RBAC/Policies" |
| **"Peut-on modifier un blueprint publié ?"** | "Oui, à tout moment" | "Non, doit créer nouvelle version" |
| **"Blueprint peut déployer sur Management Group ?"** | "Oui, déploiement direct" | "Non, assignation à subscription uniquement" |
| **"Lock mode ReadOnly empêche blueprint update ?"** | "Oui, aucune modification possible" | "Non, blueprint update contourne le lock" |
| **"ARM template suffit pour RBAC + Policies ?"** | "Oui, tout dans ARM" | "Non, utiliser Blueprint pour orchestration complète" |

**Monitoring et Troubleshooting :**

```bash
# Lister les blueprints
az blueprint list --subscription "xxx"

# Voir détails d'un blueprint
az blueprint show --name "CorporateStandard"

# Lister les assignments
az blueprint assignment list

# Voir statut d'un assignment
az blueprint assignment show --name "ProdEnv"

# Voir l'historique de déploiement
az blueprint assignment operation list --name "ProdEnv"

# Logs dans Azure Portal
# Blueprints → Assigned blueprints → Select assignment → Deployment history
```

**⚠️ Points Clés pour l'Examen :**
- ✅ Blueprint = **Orchestration** de RBAC + Policies + ARM Templates + Resource Groups
- ✅ **Tracking vivant** : Relation maintenue entre definition et deployment
- ✅ **Versioning natif** : Published versions immuables
- ✅ **Lock modes** : Protection des ressources déployées
- ✅ **Doit être publié** avant assignation
- ✅ **Managed Identity** : System-Assigned MI créée automatiquement pour deployment
- ✅ **Artifacts** : 4 types (Role, Policy, Template, Resource Group)
- ✅ **Scope** : Blueprint definition au MG/Subscription, assignment à Subscription uniquement
- ✅ **Use Case Principal** : Déploiements standardisés d'environnements conformes
- ✅ **Samples** : Microsoft fournit blueprints ISO, NIST, PCI-DSS, CAF