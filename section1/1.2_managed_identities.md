## 1.2 Managed Identities

**Concept Clé pour AZ-104 : Managed Identities permettent aux ressources Azure de s'authentifier auprès d'autres services sans gérer de credentials**

**Définition :**
- **Managed Identity** : Identité Azure AD automatiquement gérée par Azure
- **Avantage Principal** : Pas de credentials dans le code, rotation automatique des secrets
- **Cas d'usage** : VMs, App Services, Functions accédant à Key Vault, Storage, SQL, etc.

**Principe de Fonctionnement :**

```
Application avec Managed Identity
    → (demande token via IMDS/Azure Instance Metadata Service)
Azure AD
    → (fournit token d'accès)
Azure Resource (Key Vault, Storage, SQL)
    → (valide token et autorise accès via RBAC)
Accès accordé
```

### System-Assigned Managed Identity

**Caractéristiques :**
- **Lifecycle** : Lié à la ressource Azure (VM, App Service, etc.)
- **Création** : Automatique lors de l'activation sur la ressource
- **Suppression** : Automatique lors de la suppression de la ressource
- **1:1 Mapping** : Une identité par ressource uniquement
- **Scope** : Limitée à une seule ressource

**Activation - System-Assigned :**

```bash
# Via Azure CLI - Activer sur une VM
az vm identity assign \
  --resource-group myResourceGroup \
  --name myVM

# Output:
# {
#   "systemAssignedIdentity": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
#   "type": "SystemAssigned"
# }

# Via Azure CLI - Activer sur App Service
az webapp identity assign \
  --resource-group myResourceGroup \
  --name myWebApp

# Via PowerShell - Activer sur une VM
Update-AzVM -ResourceGroupName myResourceGroup \
  -VM (Get-AzVM -ResourceGroupName myResourceGroup -Name myVM) \
  -IdentityType SystemAssigned
```

**Utilisation dans le code - System-Assigned :**

```python
# Python - Accéder à Key Vault avec System-Assigned MI
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient

# DefaultAzureCredential détecte automatiquement la Managed Identity
credential = DefaultAzureCredential()
client = SecretClient(vault_url="https://myvault.vault.azure.net", credential=credential)

secret = client.get_secret("mySecret")
print(secret.value)
```

```csharp
// C# - Accéder à Azure SQL avec System-Assigned MI
using Azure.Identity;
using Microsoft.Data.SqlClient;

var credential = new DefaultAzureCredential();
var token = await credential.GetTokenAsync(
    new Azure.Core.TokenRequestContext(new[] { "https://database.windows.net/.default" }));

using var connection = new SqlConnection("Server=myserver.database.windows.net;Database=mydb;");
connection.AccessToken = token.Token;
await connection.OpenAsync();
```

**Assigner des permissions RBAC - System-Assigned :**

```bash
# 1. Récupérer le Principal ID de la VM
principalId=$(az vm identity show \
  --resource-group myResourceGroup \
  --name myVM \
  --query principalId --output tsv)

# 2. Assigner le rôle "Key Vault Secrets User" à la Managed Identity
az role assignment create \
  --assignee $principalId \
  --role "Key Vault Secrets User" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.KeyVault/vaults/myVault"

# 3. Assigner accès à un Storage Account
az role assignment create \
  --assignee $principalId \
  --role "Storage Blob Data Contributor" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Storage/storageAccounts/myStorage"
```

**Avantages System-Assigned :**
- **Simple** : Activer en un clic/commande
- **Lifecycle automatique** : Créé/supprimé avec la ressource
- **Sécurisé** : Pas de credentials à gérer
- **Audit** : Identity intégrée à la ressource

**Limitations System-Assigned :**
- **1:1 uniquement** : Ne peut pas être partagée entre ressources
- **Suppression** : Identity supprimée si ressource supprimée
- **Réutilisation impossible** : Nouvelle identity à chaque recréation

### User-Assigned Managed Identity

**Caractéristiques :**
- **Lifecycle** : Indépendant des ressources Azure
- **Création** : Ressource Azure standalone (comme une VM ou Storage Account)
- **Suppression** : Manuelle, survit à la suppression des ressources
- **1:N Mapping** : Peut être partagée entre plusieurs ressources
- **Scope** : Peut être utilisée par plusieurs VMs, App Services, etc.

**Création - User-Assigned :**

```bash
# 1. Créer une User-Assigned Managed Identity
az identity create \
  --resource-group myResourceGroup \
  --name myUserAssignedIdentity

# Output: Noter le 'id' et 'principalId'
# {
#   "id": "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myUserAssignedIdentity",
#   "principalId": "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy",
#   "clientId": "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz"
# }

# 2. Récupérer l'ID de la Managed Identity
identityId=$(az identity show \
  --resource-group myResourceGroup \
  --name myUserAssignedIdentity \
  --query id --output tsv)
```

**Assignation à des ressources - User-Assigned :**

```bash
# Assigner à une VM
az vm identity assign \
  --resource-group myResourceGroup \
  --name myVM \
  --identities $identityId

# Assigner à une autre VM (réutilisation de la même identity)
az vm identity assign \
  --resource-group myResourceGroup \
  --name myVM2 \
  --identities $identityId

# Assigner à un App Service
az webapp identity assign \
  --resource-group myResourceGroup \
  --name myWebApp \
  --identities $identityId

# Assigner à Azure Container Instances
az container create \
  --resource-group myResourceGroup \
  --name myContainer \
  --image myimage:latest \
  --assign-identity $identityId
```

**Assigner des permissions RBAC - User-Assigned :**

```bash
# Récupérer le Principal ID de la User-Assigned MI
principalId=$(az identity show \
  --resource-group myResourceGroup \
  --name myUserAssignedIdentity \
  --query principalId --output tsv)

# Assigner rôle Key Vault
az role assignment create \
  --assignee $principalId \
  --role "Key Vault Secrets User" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.KeyVault/vaults/myVault"

# Assigner rôle Storage Blob
az role assignment create \
  --assignee $principalId \
  --role "Storage Blob Data Reader" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Storage/storageAccounts/myStorage"
```

**Utilisation dans le code - User-Assigned :**

```python
# Python - Spécifier explicitement User-Assigned MI par Client ID
from azure.identity import ManagedIdentityCredential
from azure.keyvault.secrets import SecretClient

# Utiliser le Client ID de la User-Assigned MI
credential = ManagedIdentityCredential(client_id="zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz")
client = SecretClient(vault_url="https://myvault.vault.azure.net", credential=credential)

secret = client.get_secret("mySecret")
```

```csharp
// C# - Spécifier User-Assigned MI
using Azure.Identity;

var credential = new ManagedIdentityCredential(clientId: "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz");
var client = new SecretClient(new Uri("https://myvault.vault.azure.net"), credential);
```

**⚠️ Avantages User-Assigned :**
- ✅ **Réutilisable** : Partagée entre plusieurs ressources (VMs, App Services, Functions)
- ✅ **Lifecycle indépendant** : Survit à la suppression des ressources
- ✅ **Centralisation** : Une seule identity avec permissions centralisées
- ✅ **Flexibilité** : Peut être détachée/réassignée

**❌ Limitations User-Assigned :**
- ❌ **Gestion manuelle** : Doit être créée et supprimée manuellement
- ❌ **Complexité** : Nécessite de gérer le lifecycle séparément
- ❌ **Client ID requis** : Doit être spécifié dans le code si plusieurs identities

### Comparaison et Use Cases

**⚠️ Tableau Comparatif - System vs User-Assigned :**

| Critère | System-Assigned | User-Assigned |
|---------|----------------|---------------|
| **Lifecycle** | ❌ Lié à la ressource | ✅ Indépendant |
| **Partage** | ❌ 1:1 (une ressource) | ✅ 1:N (plusieurs ressources) |
| **Création** | ✅ Automatique | ❌ Manuelle |
| **Suppression** | ✅ Automatique | ❌ Manuelle |
| **Gestion** | ✅ Simple | ❌ Plus complexe |
| **Coût** | ✅ Gratuit | ✅ Gratuit |
| **Use Case** | Single resource, simple | Shared across multiple resources |

**Scénarios d'Examen - Quand utiliser quoi ?**

**Utiliser System-Assigned quand :**
- ✅ **Une seule ressource** : VM unique, App Service unique
- ✅ **Lifecycle couplé** : Identity doit être supprimée avec la ressource
- ✅ **Simplicité** : Pas besoin de partage d'identity
- ✅ **Prototype/Dev** : Configuration rapide

**Exemple :** Une VM qui accède à Key Vault pour récupérer ses propres secrets

**Utiliser User-Assigned quand :**
- ✅ **Plusieurs ressources** : 10 VMs accédant au même Key Vault
- ✅ **Lifecycle indépendant** : Resources recréées fréquemment (scaling)
- ✅ **Centralisation** : Gestion des permissions centralisée
- ✅ **Infrastructure as Code** : Terraform, Bicep avec réutilisation

**Exemple :** Fleet de VMs dans un VMSS accédant au même Storage Account

**Scénarios Pratiques - Pour l'Examen :**

**Scénario 1 - VM accédant à Key Vault :**
```
Requirement: Une VM doit lire un secret dans Key Vault
Solution: 
1. Activer System-Assigned MI sur la VM
2. Assigner le rôle "Key Vault Secrets User" à la MI
3. Utiliser DefaultAzureCredential dans le code
```

**Scénario 2 - App Service accédant à SQL Database :**
```
Requirement: App Service doit se connecter à Azure SQL
Solution:
1. Activer System-Assigned MI sur App Service
2. Créer un SQL User pour la Managed Identity
3. Utiliser connection string avec "Authentication=Active Directory Managed Identity"

# SQL Command pour créer l'utilisateur
CREATE USER [myAppService] FROM EXTERNAL PROVIDER;
ALTER ROLE db_datareader ADD MEMBER [myAppService];
ALTER ROLE db_datawriter ADD MEMBER [myAppService];
```

**Scénario 3 - Multiple VMs accédant au même Storage :**
```
Requirement: 20 VMs doivent écrire dans le même Storage Account
Solution:
1. Créer User-Assigned MI
2. Assigner rôle "Storage Blob Data Contributor" à la MI
3. Assigner la MI aux 20 VMs
4. Utiliser ManagedIdentityCredential(client_id=...) dans le code

Avantage: Un seul role assignment au lieu de 20
```

**Scénario 4 - Container Instances avec secrets :**
```
Requirement: ACI doit récupérer secrets au démarrage
Solution:
1. Créer User-Assigned MI (car ACI peut être recréé)
2. Assigner rôle Key Vault à la MI
3. Assigner MI au container
4. Fetch secrets via REST API ou SDK

# Via Azure CLI
az container create \
  --resource-group myRG \
  --name myContainer \
  --image myimage:latest \
  --assign-identity $userAssignedIdentityId \
  --environment-variables 'KEY_VAULT_URL=https://myvault.vault.azure.net'
```

**⚠️ Services Azure Supportant Managed Identities :**

**✅ Services avec Support Complet (System + User-Assigned) :**
- Virtual Machines
- Virtual Machine Scale Sets
- App Service / Functions
- Azure Container Instances
- Azure Kubernetes Service (AKS)
- Logic Apps
- Data Factory
- API Management
- Azure Container Registry Tasks

**✅ Services avec Support Partiel (System-Assigned uniquement) :**
- Azure SQL Managed Instance
- Azure Databricks
- Azure Cognitive Services

**❌ Services SANS Support Managed Identity :**
- Classic VMs (ARM requis)
- Azure AD B2C

**⚠️ Erreurs Courantes QCM :**

| Question | Réponse Incorrecte ❌ | Réponse Correcte ✅ |
|----------|----------------------|---------------------|
| **"10 VMs doivent accéder à Key Vault, quelle MI ?"** | "System-Assigned pour chaque VM" | "User-Assigned partagée entre les 10 VMs" |
| **"Managed Identity coûte combien ?"** | "5â‚¬ par mois par identity" | "Gratuit, aucun coût" |
| **"Peut-on assigner 2 System-Assigned MI à une VM ?"** | "Oui, jusqu'à 10" | "Non, une seule System-Assigned par ressource" |
| **"User-Assigned MI est supprimée si VM supprimée ?"** | "Oui, lifecycle lié" | "Non, lifecycle indépendant" |

**Monitoring et Troubleshooting :**

```bash
# Vérifier Managed Identity sur une VM
az vm identity show \
  --resource-group myResourceGroup \
  --name myVM

# Vérifier les role assignments d'une Managed Identity
principalId=$(az identity show --resource-group myRG --name myUserMI --query principalId -o tsv)
az role assignment list --assignee $principalId --output table

# Tester l'accès depuis la VM (via SSH/RDP)
# Obtenir un token depuis la VM
curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net' \
  -H Metadata:true

# Logs d'authentification
# Azure Portal â†’ Azure AD â†’ Sign-in logs â†’ Filter by "Service Principal Sign-ins"
```

**⚠️ Points Clés pour l'Examen :**
- ✅ Managed Identity = **Pas de credentials** dans le code
- ✅ **System-Assigned** : 1:1, lifecycle couplé à la ressource
- ✅ **User-Assigned** : 1:N, lifecycle indépendant, réutilisable
- ✅ **RBAC requis** : Assigner rôles appropriés (Key Vault Secrets User, Storage Blob Contributor, etc.)
- ✅ **DefaultAzureCredential** : Détecte automatiquement Managed Identity
- ✅ **Gratuit** : Aucun coût pour l'utilisation
- ✅ **IMDS Endpoint** : `http://169.254.169.254/metadata/identity/oauth2/token`
- ✅ **Multiple User-Assigned** : Une VM peut avoir plusieurs User-Assigned MI