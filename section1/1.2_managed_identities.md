## 1.2 Managed Identities

**âš ï¸ Concept ClÃ© pour AZ-104 : Managed Identities permettent aux ressources Azure de s'authentifier auprÃ¨s d'autres services sans gÃ©rer de credentials**

**DÃ©finition :**
- **Managed Identity** : IdentitÃ© Azure AD automatiquement gÃ©rÃ©e par Azure
- **Avantage Principal** : Pas de credentials dans le code, rotation automatique des secrets
- **Cas d'usage** : VMs, App Services, Functions accÃ©dant Ã  Key Vault, Storage, SQL, etc.

**Principe de Fonctionnement :**

```
Application avec Managed Identity
    â†“ (demande token via IMDS/Azure Instance Metadata Service)
Azure AD
    â†“ (fournit token d'accÃ¨s)
Azure Resource (Key Vault, Storage, SQL)
    â†“ (valide token et autorise accÃ¨s via RBAC)
AccÃ¨s accordÃ©
```

### System-Assigned Managed Identity

**CaractÃ©ristiques :**
- **Lifecycle** : LiÃ© Ã  la ressource Azure (VM, App Service, etc.)
- **CrÃ©ation** : Automatique lors de l'activation sur la ressource
- **Suppression** : Automatique lors de la suppression de la ressource
- **1:1 Mapping** : Une identitÃ© par ressource uniquement
- **Scope** : LimitÃ©e Ã  une seule ressource

**Activation - System-Assigned :**

```bash
# Via Azure CLI - Activer sur une VM
az vm identity assign \
  --resource-group myResourceGroup \
  --name myVM

# Output:
# {
#   "systemAssignedIdentity": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
#   "type": "SystemAssigned"
# }

# Via Azure CLI - Activer sur App Service
az webapp identity assign \
  --resource-group myResourceGroup \
  --name myWebApp

# Via PowerShell - Activer sur une VM
Update-AzVM -ResourceGroupName myResourceGroup \
  -VM (Get-AzVM -ResourceGroupName myResourceGroup -Name myVM) \
  -IdentityType SystemAssigned
```

**Utilisation dans le code - System-Assigned :**

```python
# Python - AccÃ©der Ã  Key Vault avec System-Assigned MI
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient

# DefaultAzureCredential dÃ©tecte automatiquement la Managed Identity
credential = DefaultAzureCredential()
client = SecretClient(vault_url="https://myvault.vault.azure.net", credential=credential)

secret = client.get_secret("mySecret")
print(secret.value)
```

```csharp
// C# - AccÃ©der Ã  Azure SQL avec System-Assigned MI
using Azure.Identity;
using Microsoft.Data.SqlClient;

var credential = new DefaultAzureCredential();
var token = await credential.GetTokenAsync(
    new Azure.Core.TokenRequestContext(new[] { "https://database.windows.net/.default" }));

using var connection = new SqlConnection("Server=myserver.database.windows.net;Database=mydb;");
connection.AccessToken = token.Token;
await connection.OpenAsync();
```

**Assigner des permissions RBAC - System-Assigned :**

```bash
# 1. RÃ©cupÃ©rer le Principal ID de la VM
principalId=$(az vm identity show \
  --resource-group myResourceGroup \
  --name myVM \
  --query principalId --output tsv)

# 2. Assigner le rÃ´le "Key Vault Secrets User" Ã  la Managed Identity
az role assignment create \
  --assignee $principalId \
  --role "Key Vault Secrets User" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.KeyVault/vaults/myVault"

# 3. Assigner accÃ¨s Ã  un Storage Account
az role assignment create \
  --assignee $principalId \
  --role "Storage Blob Data Contributor" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Storage/storageAccounts/myStorage"
```

**âš ï¸ Avantages System-Assigned :**
- âœ… **Simple** : Activer en un clic/commande
- âœ… **Lifecycle automatique** : CrÃ©Ã©/supprimÃ© avec la ressource
- âœ… **SÃ©curisÃ©** : Pas de credentials Ã  gÃ©rer
- âœ… **Audit** : Identity intÃ©grÃ©e Ã  la ressource

**âŒ Limitations System-Assigned :**
- âŒ **1:1 uniquement** : Ne peut pas Ãªtre partagÃ©e entre ressources
- âŒ **Suppression** : Identity supprimÃ©e si ressource supprimÃ©e
- âŒ **RÃ©utilisation impossible** : Nouvelle identity Ã  chaque recrÃ©ation

### User-Assigned Managed Identity

**CaractÃ©ristiques :**
- **Lifecycle** : IndÃ©pendant des ressources Azure
- **CrÃ©ation** : Ressource Azure standalone (comme une VM ou Storage Account)
- **Suppression** : Manuelle, survit Ã  la suppression des ressources
- **1:N Mapping** : Peut Ãªtre partagÃ©e entre plusieurs ressources
- **Scope** : Peut Ãªtre utilisÃ©e par plusieurs VMs, App Services, etc.

**CrÃ©ation - User-Assigned :**

```bash
# 1. CrÃ©er une User-Assigned Managed Identity
az identity create \
  --resource-group myResourceGroup \
  --name myUserAssignedIdentity

# Output: Noter le 'id' et 'principalId'
# {
#   "id": "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myUserAssignedIdentity",
#   "principalId": "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy",
#   "clientId": "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz"
# }

# 2. RÃ©cupÃ©rer l'ID de la Managed Identity
identityId=$(az identity show \
  --resource-group myResourceGroup \
  --name myUserAssignedIdentity \
  --query id --output tsv)
```

**Assignation Ã  des ressources - User-Assigned :**

```bash
# Assigner Ã  une VM
az vm identity assign \
  --resource-group myResourceGroup \
  --name myVM \
  --identities $identityId

# Assigner Ã  une autre VM (rÃ©utilisation de la mÃªme identity)
az vm identity assign \
  --resource-group myResourceGroup \
  --name myVM2 \
  --identities $identityId

# Assigner Ã  un App Service
az webapp identity assign \
  --resource-group myResourceGroup \
  --name myWebApp \
  --identities $identityId

# Assigner Ã  Azure Container Instances
az container create \
  --resource-group myResourceGroup \
  --name myContainer \
  --image myimage:latest \
  --assign-identity $identityId
```

**Assigner des permissions RBAC - User-Assigned :**

```bash
# RÃ©cupÃ©rer le Principal ID de la User-Assigned MI
principalId=$(az identity show \
  --resource-group myResourceGroup \
  --name myUserAssignedIdentity \
  --query principalId --output tsv)

# Assigner rÃ´le Key Vault
az role assignment create \
  --assignee $principalId \
  --role "Key Vault Secrets User" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.KeyVault/vaults/myVault"

# Assigner rÃ´le Storage Blob
az role assignment create \
  --assignee $principalId \
  --role "Storage Blob Data Reader" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Storage/storageAccounts/myStorage"
```

**Utilisation dans le code - User-Assigned :**

```python
# Python - SpÃ©cifier explicitement User-Assigned MI par Client ID
from azure.identity import ManagedIdentityCredential
from azure.keyvault.secrets import SecretClient

# Utiliser le Client ID de la User-Assigned MI
credential = ManagedIdentityCredential(client_id="zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz")
client = SecretClient(vault_url="https://myvault.vault.azure.net", credential=credential)

secret = client.get_secret("mySecret")
```

```csharp
// C# - SpÃ©cifier User-Assigned MI
using Azure.Identity;

var credential = new ManagedIdentityCredential(clientId: "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz");
var client = new SecretClient(new Uri("https://myvault.vault.azure.net"), credential);
```

**âš ï¸ Avantages User-Assigned :**
- âœ… **RÃ©utilisable** : PartagÃ©e entre plusieurs ressources (VMs, App Services, Functions)
- âœ… **Lifecycle indÃ©pendant** : Survit Ã  la suppression des ressources
- âœ… **Centralisation** : Une seule identity avec permissions centralisÃ©es
- âœ… **FlexibilitÃ©** : Peut Ãªtre dÃ©tachÃ©e/rÃ©assignÃ©e

**âŒ Limitations User-Assigned :**
- âŒ **Gestion manuelle** : Doit Ãªtre crÃ©Ã©e et supprimÃ©e manuellement
- âŒ **ComplexitÃ©** : NÃ©cessite de gÃ©rer le lifecycle sÃ©parÃ©ment
- âŒ **Client ID requis** : Doit Ãªtre spÃ©cifiÃ© dans le code si plusieurs identities

### Comparaison et Use Cases

**âš ï¸ Tableau Comparatif - System vs User-Assigned :**

| CritÃ¨re | System-Assigned | User-Assigned |
|---------|----------------|---------------|
| **Lifecycle** | âŒ LiÃ© Ã  la ressource | âœ… IndÃ©pendant |
| **Partage** | âŒ 1:1 (une ressource) | âœ… 1:N (plusieurs ressources) |
| **CrÃ©ation** | âœ… Automatique | âŒ Manuelle |
| **Suppression** | âœ… Automatique | âŒ Manuelle |
| **Gestion** | âœ… Simple | âŒ Plus complexe |
| **CoÃ»t** | âœ… Gratuit | âœ… Gratuit |
| **Use Case** | Single resource, simple | Shared across multiple resources |

**ScÃ©narios d'Examen - Quand utiliser quoi ?**

**Utiliser System-Assigned quand :**
- âœ… **Une seule ressource** : VM unique, App Service unique
- âœ… **Lifecycle couplÃ©** : Identity doit Ãªtre supprimÃ©e avec la ressource
- âœ… **SimplicitÃ©** : Pas besoin de partage d'identity
- âœ… **Prototype/Dev** : Configuration rapide

**Exemple :** Une VM qui accÃ¨de Ã  Key Vault pour rÃ©cupÃ©rer ses propres secrets

**Utiliser User-Assigned quand :**
- âœ… **Plusieurs ressources** : 10 VMs accÃ©dant au mÃªme Key Vault
- âœ… **Lifecycle indÃ©pendant** : Resources recrÃ©Ã©es frÃ©quemment (scaling)
- âœ… **Centralisation** : Gestion des permissions centralisÃ©e
- âœ… **Infrastructure as Code** : Terraform, Bicep avec rÃ©utilisation

**Exemple :** Fleet de VMs dans un VMSS accÃ©dant au mÃªme Storage Account

**ScÃ©narios Pratiques - Pour l'Examen :**

**ScÃ©nario 1 - VM accÃ©dant Ã  Key Vault :**
```
Requirement: Une VM doit lire un secret dans Key Vault
Solution: 
1. Activer System-Assigned MI sur la VM
2. Assigner le rÃ´le "Key Vault Secrets User" Ã  la MI
3. Utiliser DefaultAzureCredential dans le code
```

**ScÃ©nario 2 - App Service accÃ©dant Ã  SQL Database :**
```
Requirement: App Service doit se connecter Ã  Azure SQL
Solution:
1. Activer System-Assigned MI sur App Service
2. CrÃ©er un SQL User pour la Managed Identity
3. Utiliser connection string avec "Authentication=Active Directory Managed Identity"

# SQL Command pour crÃ©er l'utilisateur
CREATE USER [myAppService] FROM EXTERNAL PROVIDER;
ALTER ROLE db_datareader ADD MEMBER [myAppService];
ALTER ROLE db_datawriter ADD MEMBER [myAppService];
```

**ScÃ©nario 3 - Multiple VMs accÃ©dant au mÃªme Storage :**
```
Requirement: 20 VMs doivent Ã©crire dans le mÃªme Storage Account
Solution:
1. CrÃ©er User-Assigned MI
2. Assigner rÃ´le "Storage Blob Data Contributor" Ã  la MI
3. Assigner la MI aux 20 VMs
4. Utiliser ManagedIdentityCredential(client_id=...) dans le code

Avantage: Un seul role assignment au lieu de 20
```

**ScÃ©nario 4 - Container Instances avec secrets :**
```
Requirement: ACI doit rÃ©cupÃ©rer secrets au dÃ©marrage
Solution:
1. CrÃ©er User-Assigned MI (car ACI peut Ãªtre recrÃ©Ã©)
2. Assigner rÃ´le Key Vault Ã  la MI
3. Assigner MI au container
4. Fetch secrets via REST API ou SDK

# Via Azure CLI
az container create \
  --resource-group myRG \
  --name myContainer \
  --image myimage:latest \
  --assign-identity $userAssignedIdentityId \
  --environment-variables 'KEY_VAULT_URL=https://myvault.vault.azure.net'
```

**âš ï¸ Services Azure Supportant Managed Identities :**

**âœ… Services avec Support Complet (System + User-Assigned) :**
- Virtual Machines
- Virtual Machine Scale Sets
- App Service / Functions
- Azure Container Instances
- Azure Kubernetes Service (AKS)
- Logic Apps
- Data Factory
- API Management
- Azure Container Registry Tasks

**âœ… Services avec Support Partiel (System-Assigned uniquement) :**
- Azure SQL Managed Instance
- Azure Databricks
- Azure Cognitive Services

**âŒ Services SANS Support Managed Identity :**
- Classic VMs (ARM requis)
- Azure AD B2C

**âš ï¸ Erreurs Courantes QCM :**

| Question | RÃ©ponse Incorrecte âŒ | RÃ©ponse Correcte âœ… |
|----------|----------------------|---------------------|
| **"10 VMs doivent accÃ©der Ã  Key Vault, quelle MI ?"** | "System-Assigned pour chaque VM" | "User-Assigned partagÃ©e entre les 10 VMs" |
| **"Managed Identity coÃ»te combien ?"** | "5â‚¬ par mois par identity" | "Gratuit, aucun coÃ»t" |
| **"Peut-on assigner 2 System-Assigned MI Ã  une VM ?"** | "Oui, jusqu'Ã  10" | "Non, une seule System-Assigned par ressource" |
| **"User-Assigned MI est supprimÃ©e si VM supprimÃ©e ?"** | "Oui, lifecycle liÃ©" | "Non, lifecycle indÃ©pendant" |

**Monitoring et Troubleshooting :**

```bash
# VÃ©rifier Managed Identity sur une VM
az vm identity show \
  --resource-group myResourceGroup \
  --name myVM

# VÃ©rifier les role assignments d'une Managed Identity
principalId=$(az identity show --resource-group myRG --name myUserMI --query principalId -o tsv)
az role assignment list --assignee $principalId --output table

# Tester l'accÃ¨s depuis la VM (via SSH/RDP)
# Obtenir un token depuis la VM
curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net' \
  -H Metadata:true

# Logs d'authentification
# Azure Portal â†’ Azure AD â†’ Sign-in logs â†’ Filter by "Service Principal Sign-ins"
```

**âš ï¸ Points ClÃ©s pour l'Examen :**
- âœ… Managed Identity = **Pas de credentials** dans le code
- âœ… **System-Assigned** : 1:1, lifecycle couplÃ© Ã  la ressource
- âœ… **User-Assigned** : 1:N, lifecycle indÃ©pendant, rÃ©utilisable
- âœ… **RBAC requis** : Assigner rÃ´les appropriÃ©s (Key Vault Secrets User, Storage Blob Contributor, etc.)
- âœ… **DefaultAzureCredential** : DÃ©tecte automatiquement Managed Identity
- âœ… **Gratuit** : Aucun coÃ»t pour l'utilisation
- âœ… **IMDS Endpoint** : `http://169.254.169.254/metadata/identity/oauth2/token`
- âœ… **Multiple User-Assigned** : Une VM peut avoir plusieurs User-Assigned MI

