## 1.1 Azure Active Directory (Azure AD)

### Concepts Fondamentaux
- **Tenant** : Instance Azure AD pour une organisation
- **Subscription** : Conteneur de facturation liÃ© Ã  un tenant
- **Directory** : Synonyme de tenant Azure AD

### Utilisateurs et Groupes

**Types d'utilisateurs :**
- **Cloud Identity** : CrÃ©Ã© directement dans Azure AD
- **Directory Synchronized** : SynchronisÃ© depuis AD on-premises
- **Guest User** : Utilisateur externe (Azure AD B2B)

**Types de groupes :**

**1. Security Groups**
- **Gestion** : Azure AD Portal
- **Usage** : Gestion des permissions RBAC, accÃ¨s aux ressources Azure
- **Membres** : Utilisateurs, devices, service principals, autres groupes
- **Membership** : Assigned ou Dynamic

**2. Microsoft 365 Groups**
- **Gestion** : Azure AD Portal, Microsoft 365 Admin Center
- **Usage** : Collaboration (Teams, SharePoint, Outlook, Planner)
- **Membres** : Utilisateurs uniquement
- **Membership** : Assigned ou Dynamic
- **CaractÃ©ristiques** : BoÃ®te mail partagÃ©e, calendrier, SharePoint site

**3. Distribution Groups (Mail-Enabled Groups)**
- **Gestion** : **Exchange Admin Center** (Exchange Online)
- **âš ï¸ Important** : NE sont PAS gÃ©rÃ©s directement dans Azure AD Portal
- **Usage** : Listes de diffusion email uniquement
- **Membres** : Utilisateurs avec adresses email
- **Membership** : Assigned uniquement (pas de dynamic)
- **Limitation** : Ne peuvent PAS Ãªtre utilisÃ©s pour les permissions Azure

**âš ï¸ Point de Confusion FrÃ©quent :**

| Type | GÃ©rÃ© dans Azure AD Portal? | Usage Permissions? | Usage Email? |
|------|---------------------------|-------------------|-------------|
| **Security Group** | âœ… Oui | âœ… Oui | âŒ Non* |
| **Microsoft 365 Group** | âœ… Oui | âœ… Oui | âœ… Oui |
| **Distribution Group** | âŒ Non (Exchange Admin) | âŒ Non | âœ… Oui |

\*Peut Ãªtre mail-enabled si configurÃ© dans Exchange

**AccÃ¨s aux Distribution Groups :**
```
Exchange Admin Center â†’ Recipients â†’ Groups â†’ Distribution list
OU
Microsoft 365 Admin Center â†’ Teams & groups â†’ Distribution lists
```

**âš ï¸ Pour l'examen AZ-104 :**
- Distribution Groups = **Exchange Online**, pas Azure AD
- Pour permissions Azure = Utiliser **Security Groups**
- Pour collaboration + email = Utiliser **Microsoft 365 Groups**

### Membership Types
- **Assigned** : Ajout manuel des membres
- **Dynamic User** : RÃ¨gles basÃ©es sur les attributs utilisateur
- **Dynamic Device** : RÃ¨gles basÃ©es sur les attributs d'appareil

** Erreur frÃ©quente identifiÃ©e :** Syntaxe des rÃ¨gles dynamiques
```
// Correct
(user.department -eq "Marketing") and (user.country -eq "France")

// PropriÃ©tÃ©s utilisateur courantes
user.department, user.country, user.city, user.jobTitle, user.userPrincipalName
```

### Custom Domains

**Processus d'ajout :**
1. Ajouter le domaine dans Azure AD
2. CrÃ©er un enregistrement DNS pour vÃ©rification
3. VÃ©rifier la propriÃ©tÃ© du domaine

** Point d'attention identifiÃ© :** Types d'enregistrements DNS acceptÃ©s
- **TXT** : MÃ©thode recommandÃ©e (plus flexible)
- **MX** : Alternative acceptable
- Exemple : `MS=ms12345678` dans un enregistrement TXT

### B2B Collaboration

** Configuration des paramÃ¨tres de collaboration externe :**
- **External collaboration settings** : ContrÃ´lent qui peut inviter des utilisateurs externes
- **Domain restrictions** : Autoriser/bloquer des domaines spÃ©cifiques
- **Guest user visibility** : ContrÃ´ler ce que voient les invitÃ©s dans l'annuaire
- **Conditional Access** : Renforcer l'authentification et bloquer l'accÃ¨s depuis des emplacements inconnus
- **Cross-tenant access** : Configuration de collaboration avec des organisations Microsoft Entra spÃ©cifiques

** Format UPN des utilisateurs invitÃ©s :**
- **Guest users** : `bsmith_contoso.com#EXT#@fabrikam.com`
- **Regular users** : `user@fabrikam.com`
- **Access reviews** : Non utilisÃ©es pour contrÃ´ler les invitations d'invitÃ©s

** PrÃ©requis pour assignation de licences :**
- **Usage location** : Obligatoire avant assignation de licence
- **Not all Microsoft 365 services** disponibles dans tous les emplacements
- **First name, Last name, Other email, User type** : Non obligatoires pour assignation de licence

### Azure AD Connect - Synchronisation Hybrid

**âš ï¸ Erreur Courante QCM : Synchronisation des Licences Microsoft 365**

**âŒ FAUX :** Azure AD Connect synchronise les licences Microsoft 365
**âœ… CORRECT :** Azure AD Connect synchronise UNIQUEMENT les objets utilisateur et leurs attributs, **PAS les licences**

**Ce qui est synchronisÃ© par Azure AD Connect :**
- Utilisateurs (User objects)
- Groupes (Groups)
- Attributs utilisateur (UPN, displayName, email, etc.)
- Mots de passe (Password Hash Sync ou Pass-through Authentication)
- Objets d'appareil (si configurÃ©)

**Ce qui N'EST PAS synchronisÃ© :**
- âŒ Licences Microsoft 365
- âŒ ParamÃ¨tres Exchange Online
- âŒ Permissions SharePoint
- âŒ RÃ´les Azure AD (ils doivent Ãªtre rÃ©assignÃ©s)

**Gestion des Licences aprÃ¨s Synchronisation :**

**âš ï¸ Important :** Les licences doivent Ãªtre assignÃ©es manuellement ou automatiquement aprÃ¨s synchronisation.

**MÃ©thode 1 - Assignation Manuelle :**
```powershell
# Via PowerShell
Connect-MsolService
Set-MsolUser -UserPrincipalName "user@contoso.com" -UsageLocation "FR"
Set-MsolUserLicense -UserPrincipalName "user@contoso.com" -AddLicenses "contoso:ENTERPRISEPACK"

# Ou via Azure Portal
# Azure AD â†’ Users â†’ Select user â†’ Licenses â†’ Add assignments

# Ou via Microsoft 365 Admin Center
# Users â†’ Active users â†’ Select user â†’ Manage product licenses
```

**MÃ©thode 2 - Assignation Automatique (RecommandÃ©e) :**

**Processus d'assignation automatique de licences :**
1. **CrÃ©er un groupe de sÃ©curitÃ© dynamique** basÃ© sur des attributs personnalisÃ©s
2. **Configurer les rÃ¨gles** du groupe dynamique
3. **Assigner des licences au groupe** (Group-based licensing)
4. **Les nouveaux utilisateurs synchronisÃ©s** reÃ§oivent automatiquement les licences

```powershell
# Exemple de rÃ¨gle de groupe dynamique
(user.department -eq "Sales") -and (user.usageLocation -eq "FR")
```

**Points clÃ©s :**
- **Dynamic security groups** : Obligatoires pour assignation automatique
- **Custom attributes** : Base des rÃ¨gles de groupe
- **Group-based licensing** : Synchronisation automatique
- **Usage Location** : Doit Ãªtre dÃ©fini avant assignation de licence

### Conditional Access

**âš ï¸ Concept ClÃ© pour AZ-104 : Conditional Access permet de contrÃ´ler l'accÃ¨s aux ressources cloud en fonction de conditions spÃ©cifiques**

**DÃ©finition :**
- **Conditional Access** : Outil de sÃ©curitÃ© Azure AD qui Ã©value les signaux (utilisateur, localisation, appareil) pour prendre des dÃ©cisions d'accÃ¨s automatisÃ©es
- **FonctionnalitÃ©** : Azure AD Premium P1 ou P2 requis
- **Application** : AppliquÃ© AVANT l'accÃ¨s aux applications cloud

**Architecture des Politiques Conditional Access :**

```
Signal (IF) â†’ Decision (THEN) â†’ Enforcement
   â†“              â†“                â†“
Qui/OÃ¹/Quoi â†’ Ã‰valuation â†’ Bloquer/MFA/Autoriser
```

**Composants d'une Politique Conditional Access :**

**1. Assignments (Qui et OÃ¹) - Conditions "IF"**

**Users and Groups :**
- âœ… Utilisateurs spÃ©cifiques
- âœ… Groupes (Security Groups)
- âœ… RÃ´les d'annuaire (Directory roles)
- âœ… Guest users
- âŒ **Exclude** : Comptes d'urgence (break-glass accounts)

**Cloud apps or actions :**
- âœ… Toutes les applications cloud
- âœ… Applications spÃ©cifiques (Office 365, Azure Portal, etc.)
- âœ… Actions utilisateur (Register security info)

**Conditions :**
- **Sign-in risk** : BasÃ© sur Azure AD Identity Protection (P2)
- **Device platforms** : Windows, iOS, Android, macOS
- **Locations** : Pays, rÃ©gions, adresses IP
- **Client apps** : Browser, mobile apps, desktop clients
- **Device state** : Compliant, Hybrid Azure AD joined

**2. Access Controls (Que faire) - Actions "THEN"**

**Grant Controls (Accorder l'accÃ¨s) :**
- âœ… **Require multi-factor authentication** : MFA obligatoire
- âœ… **Require device to be marked as compliant** : Intune compliance
- âœ… **Require Hybrid Azure AD joined device** : Appareil joint au domaine
- âœ… **Require approved client app** : Applications mobiles approuvÃ©es
- âœ… **Require app protection policy** : Intune App Protection
- âŒ **Block access** : Bloquer complÃ¨tement

**Session Controls :**
- **Sign-in frequency** : Forcer rÃ©authentification (ex: toutes les 4h)
- **Persistent browser session** : Rester connectÃ©
- **App enforced restrictions** : Limiter fonctionnalitÃ©s (ex: SharePoint read-only)
- **Conditional Access App Control** : Microsoft Cloud App Security monitoring

**ScÃ©narios Pratiques - Pour l'Examen :**

**ScÃ©nario 1 - Bloquer accÃ¨s hors du rÃ©seau d'entreprise :**
```
IF:
- Users: All users
- Cloud apps: Office 365
- Locations: Any location EXCEPT Corporate Network

THEN:
- Grant: Block access
```

**ScÃ©nario 2 - Exiger MFA pour administrateurs :**
```
IF:
- Users: Directory role = Global Administrator
- Cloud apps: All cloud apps
- Locations: Any location

THEN:
- Grant: Require multi-factor authentication
```

**ScÃ©nario 3 - Exiger appareil compliant pour accÃ¨s mobile :**
```
IF:
- Users: All users
- Cloud apps: Office 365
- Device platforms: iOS, Android

THEN:
- Grant: Require device to be marked as compliant
```

**ScÃ©nario 4 - Bloquer accÃ¨s depuis certains pays :**
```
IF:
- Users: All users
- Cloud apps: Azure Portal
- Locations: High-risk countries (ex: pays X, Y, Z)

THEN:
- Grant: Block access
```

**âš ï¸ Configuration via Azure Portal :**

```bash
# Navigation dans le portail
Azure AD â†’ Security â†’ Conditional Access â†’ New policy

# Ou via PowerShell (Azure AD Premium P1/P2 requis)
# Note: Conditional Access nÃ©cessite le module AzureAD
Connect-AzureAD

# CrÃ©er une politique (exemple conceptuel - syntaxe simplifiÃ©e)
New-AzureADMSConditionalAccessPolicy -DisplayName "Require MFA for Admins" `
  -State "Enabled" `
  -Conditions @{
    Users = @{
      IncludeRoles = @("62e90394-69f5-4237-9190-012177145e10") # Global Admin
    }
  } `
  -GrantControls @{
    BuiltInControls = @("mfa")
  }
```

**âš ï¸ Best Practices Conditional Access :**

**1. Report-Only Mode (RecommandÃ© pour test) :**
- **Tester AVANT** de mettre en production
- **Ã‰viter** de bloquer accidentellement les utilisateurs
- **Analyser** les logs avant activation

```
Policy State Options:
- Report-only: Log uniquement, pas d'enforcement
- On: Actif, enforcement complet
- Off: DÃ©sactivÃ©
```

**2. Exclude Break-Glass Accounts :**
- **Toujours exclure** au moins 2 comptes d'urgence
- **Ã‰viter** de se verrouiller hors du tenant
- **Utiliser** des comptes sÃ©parÃ©s avec MFA alternatif

**3. Require Multiple Controls :**
```
Grant Controls Options:
- Require ALL the selected controls (AND logic)
- Require ONE of the selected controls (OR logic)
```

**âš ï¸ Erreurs Courantes QCM :**

| Question | RÃ©ponse Incorrecte âŒ | RÃ©ponse Correcte âœ… |
|----------|----------------------|---------------------|
| **"Comment bloquer accÃ¨s hors du bureau ?"** | "CrÃ©er une policy avec Grant: MFA" | "CrÃ©er une policy avec Locations + Block access" |
| **"Conditional Access est gratuit ?"** | "Oui, inclus dans Azure AD Free" | "Non, nÃ©cessite Azure AD Premium P1" |
| **"Peut-on utiliser distribution groups ?"** | "Oui, tous les types de groupes" | "Non, uniquement Security Groups et M365 Groups" |
| **"MFA suffit pour appareil non compliant ?"** | "Oui, MFA = sÃ©curitÃ© suffisante" | "Non, utiliser 'Require compliant device'" |

**PrÃ©requis Techniques :**

| FonctionnalitÃ© | License Requise | Notes |
|---------------|----------------|-------|
| **Conditional Access basics** | Azure AD Premium P1 | Policies, MFA, device compliance |
| **Sign-in risk-based policies** | Azure AD Premium P2 | Identity Protection requis |
| **User risk-based policies** | Azure AD Premium P2 | Identity Protection requis |
| **Report-only mode** | Azure AD Premium P1 | Test sans enforcement |

**Monitoring et Troubleshooting :**

```bash
# VÃ©rifier les sign-ins avec Conditional Access
# Azure Portal â†’ Azure AD â†’ Sign-in logs â†’ Filter by Conditional Access

# Colonnes importantes :
# - Conditional Access: Success/Failure/Not Applied
# - Applied policies: Liste des policies Ã©valuÃ©es
# - Result: Grant/Block/Require MFA
```

**IntÃ©gration avec d'autres services :**
- **Azure AD Identity Protection** : Risk-based policies (P2)
- **Microsoft Intune** : Device compliance
- **Microsoft Defender for Cloud Apps** : Session monitoring
- **Azure AD Privileged Identity Management (PIM)** : Protection des rÃ´les privilÃ©giÃ©s

**âš ï¸ Points ClÃ©s pour l'Examen :**
- âœ… Conditional Access = **"IF-THEN" policies**
- âœ… NÃ©cessite **Azure AD Premium P1 minimum**
- âœ… Toujours utiliser **Report-only mode** avant activation
- âœ… **Exclure break-glass accounts** de toutes les policies
- âœ… **Locations** peuvent Ãªtre Named Locations (IP ranges)
- âœ… **MFA** est un Grant Control, pas un Session Control
- âœ… **Block access** empÃªche complÃ¨tement l'accÃ¨s

