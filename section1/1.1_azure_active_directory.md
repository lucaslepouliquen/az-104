## 1.1 Azure Active Directory (Azure AD)

### Concepts Fondamentaux
- **Tenant** : Instance Azure AD pour une organisation
- **Subscription** : Conteneur de facturation lié à un tenant
- **Directory** : Synonyme de tenant Azure AD

### Utilisateurs et Groupes

**Types d'utilisateurs :**
- **Cloud Identity** : Créé directement dans Azure AD
- **Directory Synchronized** : Synchronisé depuis AD on-premises
- **Guest User** : Utilisateur externe (Azure AD B2B)

**Types de groupes :**

**1. Security Groups**
- **Gestion** : Azure AD Portal
- **Usage** : Gestion des permissions RBAC, accès aux ressources Azure
- **Membres** : Utilisateurs, devices, service principals, autres groupes
- **Membership** : Assigned ou Dynamic

**2. Microsoft 365 Groups**
- **Gestion** : Azure AD Portal, Microsoft 365 Admin Center
- **Usage** : Collaboration (Teams, SharePoint, Outlook, Planner)
- **Membres** : Utilisateurs uniquement
- **Membership** : Assigned ou Dynamic
- **Caractéristiques** : Boîte mail partagée, calendrier, SharePoint site

**3. Distribution Groups (Mail-Enabled Groups)**
- **Gestion** : **Exchange Admin Center** (Exchange Online)
- **Important** : NE sont PAS gérés directement dans Azure AD Portal
- **Usage** : Listes de diffusion email uniquement
- **Membres** : Utilisateurs avec adresses email
- **Membership** : Assigned uniquement (pas de dynamic)
- **Limitation** : Ne peuvent PAS être utilisés pour les permissions Azure

**Point de Confusion Fréquent :**

| Type | Géré dans Azure AD Portal? | Usage Permissions? | Usage Email? |
|------|---------------------------|-------------------|-------------|
| **Security Group** | ✅ Oui | ✅ Oui | ❌ Non* |
| **Microsoft 365 Group** | ✅ Oui | ✅ Oui | ✅ Oui |
| **Distribution Group** | ❌ Non (Exchange Admin) | ❌ Non | ✅ Oui |

\*Peut être mail-enabled si configuré dans Exchange

**Accès aux Distribution Groups :**
```
Exchange Admin Center → Recipients → Groups → Distribution list
OU
Microsoft 365 Admin Center → Teams & groups → Distribution lists
```

**Pour l'examen AZ-104 :**
- Distribution Groups = **Exchange Online**, pas Azure AD
- Pour permissions Azure = Utiliser **Security Groups**
- Pour collaboration + email = Utiliser **Microsoft 365 Groups**

### Membership Types
- **Assigned** : Ajout manuel des membres
- **Dynamic User** : Règles basées sur les attributs utilisateur
- **Dynamic Device** : Règles basées sur les attributs d'appareil

** Erreur fréquente identifiée :** Syntaxe des règles dynamiques
```
// Correct
(user.department -eq "Marketing") and (user.country -eq "France")

// Propriétés utilisateur courantes
user.department, user.country, user.city, user.jobTitle, user.userPrincipalName
```

### Custom Domains

**Processus d'ajout :**
1. Ajouter le domaine dans Azure AD
2. Créer un enregistrement DNS pour vérification
3. Vérifier la propriété du domaine

** Point d'attention identifié :** Types d'enregistrements DNS acceptés
- **TXT** : Méthode recommandée (plus flexible)
- **MX** : Alternative acceptable
- Exemple : `MS=ms12345678` dans un enregistrement TXT

### B2B Collaboration

** Configuration des paramètres de collaboration externe :**
- **External collaboration settings** : Contrôlent qui peut inviter des utilisateurs externes
- **Domain restrictions** : Autoriser/bloquer des domaines spécifiques
- **Guest user visibility** : Contrôler ce que voient les invités dans l'annuaire
- **Conditional Access** : Renforcer l'authentification et bloquer l'accès depuis des emplacements inconnus
- **Cross-tenant access** : Configuration de collaboration avec des organisations Microsoft Entra spécifiques

** Format UPN des utilisateurs invités :**
- **Guest users** : `bsmith_contoso.com#EXT#@fabrikam.com`
- **Regular users** : `user@fabrikam.com`
- **Access reviews** : Non utilisées pour contrôler les invitations d'invités

** Prérequis pour assignation de licences :**
- **Usage location** : Obligatoire avant assignation de licence
- **Not all Microsoft 365 services** disponibles dans tous les emplacements
- **First name, Last name, Other email, User type** : Non obligatoires pour assignation de licence

### Self-Service Password Reset (SSPR)

**Concepts Clés pour l'Examen AZ-104**

**Définition :**
- **SSPR** : Fonctionnalité permettant aux utilisateurs de réinitialiser leur propre mot de passe sans intervention du help desk
- **License** : Azure AD Premium P1 ou P2 requis pour les utilisateurs cloud + hybrides
- **Azure AD Free** : SSPR disponible uniquement pour les administrateurs

**Support Utilisateurs - Question Fréquente à l'Examen :**

| Type d'utilisateur | SSPR supporté ? | Détails |
|-------------------|-----------------|---------|
| **Cloud-only users** | ✅ Oui | Utilisateurs créés directement dans Azure AD |
| **Hybrid users** | ✅ Oui | Utilisateurs synchronisés depuis AD on-premises (avec Password Writeback) |
| **Guest users (B2B)** | ✅ Oui | Invités externes peuvent réinitialiser leur mot de passe |
| **All users** | ✅ Oui | SSPR supporté pour TOUS les types d'utilisateurs |

**Configuration SSPR - Ciblage :**

**ERREUR COURANTE QCM : Configuration par Utilisateur Individuel**

**Question typique :** "You can configure SSPR registration for all domain users, by group, or by individual user."
**Réponse : NO**

**Options de configuration disponibles :**
1. **None** : SSPR désactivé (sauf administrateurs)
2. **Selected** : SSPR activé pour des **groupes spécifiques** (Security Groups ou Microsoft 365 Groups)
3. **All** : SSPR activé pour **tous les utilisateurs du tenant**

**Configuration par utilisateur individuel : NON SUPPORTÉE**

```
Azure AD → Password reset → Properties
├── None (Disabled)
├── Selected (Choose security groups)
└── All (All users in tenant)
```

**⚠️ Point Clé pour l'Examen :**
- **Par groupe** : ✅ Oui (Selected)
- **Pour tous les domain users** : ✅ Oui (All)
- **Par utilisateur individuel** : ❌ Non (pas d'option)

**Méthodes d'Authentification SSPR :**

**⚠️ ERREUR COURANTE QCM : Méthodes d'Authentification Supportées**

**Question typique :** "Supported authentication methods include mobile phone text messages and voice calls."
**Réponse : YES ✅**

**Méthodes d'authentification supportées :**
1. ✅ **Mobile phone** : SMS text messages ET voice calls
2. ✅ **Email address** : Email vers adresse externe
3. ✅ **Security questions** : Questions/réponses personnalisées
4. ✅ **Microsoft Authenticator app** : Notification push ou code
5. ✅ **OATH hardware tokens** : Tokens physiques
6. ✅ **Office phone** : Appel vocal vers numéro bureau

**Configuration Recommandée :**
```
Nombre de méthodes requises pour reset : 2 (minimum recommandé)

Méthodes disponibles aux utilisateurs :
☑ Mobile phone (text message) ← Inclus
☑ Mobile phone (voice call)   ← Inclus
☑ Email address
☑ Microsoft Authenticator app
☑ Security questions (3-5 questions minimum)
```

**⚠️ Best Practice - Microsoft recommande :**
- **Au moins 2 méthodes** d'authentification requises
- **Security questions** : Toujours combiner avec au moins une autre méthode
- **Mobile phone (SMS + Voice)** : Méthodes les plus couramment utilisées

**Password Writeback - Configuration Hybride**

**Pour environnements hybrides (Azure AD + on-premises AD) :**
1. ✅ **Azure AD Connect** doit être configuré
2. ✅ **Password Writeback** activé dans Azure AD Connect
3. ✅ **Azure AD Premium P1/P2** requis
4. ✅ Permissions appropriées sur AD on-premises

**Activation Password Writeback via Azure AD Connect :**
```powershell
# Dans l'assistant Azure AD Connect
Optional Features → Password writeback ✓

# Ou via PowerShell (après installation Azure AD Connect)
Set-ADSyncPasswordWritebackConfiguration -Enable $true
```

**Fonctionnement Password Writeback :**
```
Utilisateur réinitialise mot de passe dans Azure AD
    ↓
SSPR valide identité (2 méthodes auth)
    ↓
Nouveau mot de passe créé dans Azure AD
    ↓
Azure AD Connect écrit le mot de passe vers AD on-premises
    ↓
Utilisateur peut se connecter avec nouveau mot de passe (cloud + on-prem)
```

**Configuration SSPR via Azure Portal :**
```bash
# Navigation
Azure AD → Password reset → Properties
    ├── Self service password reset enabled: Selected/All
    ├── Authentication methods: Configuration des méthodes
    ├── Registration: Forcer enregistrement à la connexion
    ├── Notifications: Alertes email aux utilisateurs/admins
    └── On-premises integration: Password writeback

# Example configuration:
Selected: Group "Sales-Users" (Security Group)
Number of methods required to reset: 2
Methods available: Mobile phone, Email, Authenticator app
Registration required: Yes (force registration at next sign-in)
Password writeback: Enabled (pour hybrid)
```

**Notifications SSPR :**
- ✅ **Notify users on password resets** : Email de confirmation à l'utilisateur
- ✅ **Notify all admins when other admins reset their password** : Alerte sécurité

**Monitoring et Reporting :**
```bash
# Audit logs pour SSPR
Azure AD → Monitoring → Audit logs
    Filter: Service = Self-service Password Management
    
# Sign-in logs pour tentatives SSPR
Azure AD → Monitoring → Sign-in logs
    Filter: Authentication method = SSPR

# Usage & insights
Azure AD → Password reset → Usage & insights
    - Registration activity (qui s'est enregistré)
    - Reset activity (qui a utilisé SSPR)
```

**Scénarios d'Examen - SSPR :**

| Scénario | Solution | Justification |
|----------|----------|---------------|
| **Activer SSPR pour département Marketing uniquement** | Selected + Security Group "Marketing" | Configuration par groupe uniquement |
| **Activer SSPR pour utilisateur spécifique John** | ❌ Impossible directement / Créer groupe avec John | Pas de configuration par utilisateur individuel |
| **SSPR pour cloud-only users** | ✅ Supporté (Azure AD Premium P1/P2) | SSPR fonctionne pour tous types d'utilisateurs |
| **Utilisateur hybride réinitialise mot de passe** | Activer Password Writeback dans Azure AD Connect | Écriture du mot de passe vers AD on-prem |
| **Méthodes d'auth : SMS + Voice calls** | ✅ Supportées (Mobile phone) | SMS et voice calls inclus dans "Mobile phone" |
| **Bloquer security questions seules** | Configurer "2 methods required" | Toujours combiner security questions avec autre méthode |

**⚠️ Points Clés pour l'Examen :**
1. ✅ **SSPR supporté pour TOUS les utilisateurs** (cloud-only, hybrid, guests)
2. ❌ **Configuration par utilisateur individuel NON supportée** (uniquement groupes ou "all")
3. ✅ **Mobile phone inclut SMS text messages ET voice calls**
4. ✅ **Méthodes d'auth supportées** : Mobile (SMS/voice), Email, Security questions, Authenticator, OATH tokens
5. ✅ **Password Writeback requis** pour environnements hybrides
6. ✅ **Azure AD Premium P1/P2** requis pour utilisateurs non-administrateurs
7. ✅ **Minimum 2 méthodes** d'authentification recommandées

### Azure AD Connect - Synchronisation Hybrid

**⚠️ Erreur Courante QCM : Synchronisation des Licences Microsoft 365**

**❌ FAUX :** Azure AD Connect synchronise les licences Microsoft 365
**✅ CORRECT :** Azure AD Connect synchronise UNIQUEMENT les objets utilisateur et leurs attributs, **PAS les licences**

**Ce qui est synchronisé par Azure AD Connect :**
- Utilisateurs (User objects)
- Groupes (Groups)
- Attributs utilisateur (UPN, displayName, email, etc.)
- Mots de passe (Password Hash Sync ou Pass-through Authentication)
- Objets d'appareil (si configuré)

**Ce qui N'EST PAS synchronisé :**
- ❌ Licences Microsoft 365
- ❌ Paramètres Exchange Online
- ❌ Permissions SharePoint
- ❌ Rôles Azure AD (ils doivent être réassignés)

**Gestion des Licences après Synchronisation :**

**⚠️ Important :** Les licences doivent être assignées manuellement ou automatiquement après synchronisation.

**Méthode 1 - Assignation Manuelle :**
```powershell
# Via PowerShell
Connect-MsolService
Set-MsolUser -UserPrincipalName "user@contoso.com" -UsageLocation "FR"
Set-MsolUserLicense -UserPrincipalName "user@contoso.com" -AddLicenses "contoso:ENTERPRISEPACK"

# Ou via Azure Portal
# Azure AD → Users → Select user → Licenses → Add assignments

# Ou via Microsoft 365 Admin Center
# Users → Active users → Select user → Manage product licenses
```

**Méthode 2 - Assignation Automatique (Recommandée) :**

**Processus d'assignation automatique de licences :**
1. **Créer un groupe de sécurité dynamique** basé sur des attributs personnalisés
2. **Configurer les règles** du groupe dynamique
3. **Assigner des licences au groupe** (Group-based licensing)
4. **Les nouveaux utilisateurs synchronisés** reçoivent automatiquement les licences

```powershell
# Exemple de règle de groupe dynamique
(user.department -eq "Sales") -and (user.usageLocation -eq "FR")
```

**Points clés :**
- **Dynamic security groups** : Obligatoires pour assignation automatique
- **Custom attributes** : Base des règles de groupe
- **Group-based licensing** : Synchronisation automatique
- **Usage Location** : Doit être défini avant assignation de licence

### Conditional Access

**⚠️ Concept Clé pour AZ-104 : Conditional Access permet de contrôler l'accès aux ressources cloud en fonction de conditions spécifiques**

**Définition :**
- **Conditional Access** : Outil de sécurité Azure AD qui évalue les signaux (utilisateur, localisation, appareil) pour prendre des décisions d'accès automatisées
- **Fonctionnalité** : Azure AD Premium P1 ou P2 requis
- **Application** : Appliqué AVANT l'accès aux applications cloud

**Architecture des Politiques Conditional Access :**

```
Signal (IF) → Decision (THEN) → Enforcement
   ↓              ↓                ↓
Qui/Où/Quoi → Évaluation → Bloquer/MFA/Autoriser
```

**Composants d'une Politique Conditional Access :**

**1. Assignments (Qui et Où) - Conditions "IF"**

**Users and Groups :**
- ✅ Utilisateurs spécifiques
- ✅ Groupes (Security Groups)
- ✅ Rôles d'annuaire (Directory roles)
- ✅ Guest users
- ❌ **Exclude** : Comptes d'urgence (break-glass accounts)

**Cloud apps or actions :**
- ✅ Toutes les applications cloud
- ✅ Applications spécifiques (Office 365, Azure Portal, etc.)
- ✅ Actions utilisateur (Register security info)

**Conditions :**
- **Sign-in risk** : Basé sur Azure AD Identity Protection (P2)
- **Device platforms** : Windows, iOS, Android, macOS
- **Locations** : Pays, régions, adresses IP
- **Client apps** : Browser, mobile apps, desktop clients
- **Device state** : Compliant, Hybrid Azure AD joined

**2. Access Controls (Que faire) - Actions "THEN"**

**Grant Controls (Accorder l'accès) :**
- ✅ **Require multi-factor authentication** : MFA obligatoire
- ✅ **Require device to be marked as compliant** : Intune compliance
- ✅ **Require Hybrid Azure AD joined device** : Appareil joint au domaine
- ✅ **Require approved client app** : Applications mobiles approuvées
- ✅ **Require app protection policy** : Intune App Protection
- ❌ **Block access** : Bloquer complètement

**Session Controls :**
- **Sign-in frequency** : Forcer réauthentification (ex: toutes les 4h)
- **Persistent browser session** : Rester connecté
- **App enforced restrictions** : Limiter fonctionnalités (ex: SharePoint read-only)
- **Conditional Access App Control** : Microsoft Cloud App Security monitoring

**Scénarios Pratiques - Pour l'Examen :**

**Scénario 1 - Bloquer accès hors du réseau d'entreprise :**
```
IF:
- Users: All users
- Cloud apps: Office 365
- Locations: Any location EXCEPT Corporate Network

THEN:
- Grant: Block access
```

**Scénario 2 - Exiger MFA pour administrateurs :**
```
IF:
- Users: Directory role = Global Administrator
- Cloud apps: All cloud apps
- Locations: Any location

THEN:
- Grant: Require multi-factor authentication
```

**Scénario 3 - Exiger appareil compliant pour accès mobile :**
```
IF:
- Users: All users
- Cloud apps: Office 365
- Device platforms: iOS, Android

THEN:
- Grant: Require device to be marked as compliant
```

**Scénario 4 - Bloquer accès depuis certains pays :**
```
IF:
- Users: All users
- Cloud apps: Azure Portal
- Locations: High-risk countries (ex: pays X, Y, Z)

THEN:
- Grant: Block access
```

**⚠️ Configuration via Azure Portal :**

```bash
# Navigation dans le portail
Azure AD â†’ Security â†’ Conditional Access â†’ New policy

# Ou via PowerShell (Azure AD Premium P1/P2 requis)
# Note: Conditional Access nécessite le module AzureAD
Connect-AzureAD

# Créer une politique (exemple conceptuel - syntaxe simplifiée)
New-AzureADMSConditionalAccessPolicy -DisplayName "Require MFA for Admins" `
  -State "Enabled" `
  -Conditions @{
    Users = @{
      IncludeRoles = @("62e90394-69f5-4237-9190-012177145e10") # Global Admin
    }
  } `
  -GrantControls @{
    BuiltInControls = @("mfa")
  }
```

**⚠️ Best Practices Conditional Access :**

**1. Report-Only Mode (Recommandé pour test) :**
- **Tester AVANT** de mettre en production
- **àviter** de bloquer accidentellement les utilisateurs
- **Analyser** les logs avant activation

```
Policy State Options:
- Report-only: Log uniquement, pas d'enforcement
- On: Actif, enforcement complet
- Off: Désactivé
```

**2. Exclude Break-Glass Accounts :**
- **Toujours exclure** au moins 2 comptes d'urgence
- **àviter** de se verrouiller hors du tenant
- **Utiliser** des comptes séparés avec MFA alternatif

**3. Require Multiple Controls :**
```
Grant Controls Options:
- Require ALL the selected controls (AND logic)
- Require ONE of the selected controls (OR logic)
```

**⚠️ Erreurs Courantes QCM :**

| Question | Réponse Incorrecte ❌ | Réponse Correcte ✅ |
|----------|----------------------|---------------------|
| **"Comment bloquer accès hors du bureau ?"** | "Créer une policy avec Grant: MFA" | "Créer une policy avec Locations + Block access" |
| **"Conditional Access est gratuit ?"** | "Oui, inclus dans Azure AD Free" | "Non, nécessite Azure AD Premium P1" |
| **"Peut-on utiliser distribution groups ?"** | "Oui, tous les types de groupes" | "Non, uniquement Security Groups et M365 Groups" |
| **"MFA suffit pour appareil non compliant ?"** | "Oui, MFA = sécurité suffisante" | "Non, utiliser 'Require compliant device'" |

**Prérequis Techniques :**

| Fonctionnalité | License Requise | Notes |
|---------------|----------------|-------|
| **Conditional Access basics** | Azure AD Premium P1 | Policies, MFA, device compliance |
| **Sign-in risk-based policies** | Azure AD Premium P2 | Identity Protection requis |
| **User risk-based policies** | Azure AD Premium P2 | Identity Protection requis |
| **Report-only mode** | Azure AD Premium P1 | Test sans enforcement |

**Monitoring et Troubleshooting :**

```bash
# Vérifier les sign-ins avec Conditional Access
# Azure Portal → Azure AD → Sign-in logs → Filter by Conditional Access

# Colonnes importantes :
# - Conditional Access: Success/Failure/Not Applied
# - Applied policies: Liste des policies évaluées
# - Result: Grant/Block/Require MFA
```

**Intégration avec d'autres services :**
- **Azure AD Identity Protection** : Risk-based policies (P2)
- **Microsoft Intune** : Device compliance
- **Microsoft Defender for Cloud Apps** : Session monitoring
- **Azure AD Privileged Identity Management (PIM)** : Protection des rôles privilégiés

**⚠️ Points Clés pour l'Examen :**
- ✅ Conditional Access = **"IF-THEN" policies**
- ✅ Nécessite **Azure AD Premium P1 minimum**
- ✅ Toujours utiliser **Report-only mode** avant activation
- ✅ **Exclure break-glass accounts** de toutes les policies
- ✅ **Locations** peuvent être Named Locations (IP ranges)
- ✅ **MFA** est un Grant Control, pas un Session Control
- ✅ **Block access** empêche complètement l'accès