## 1.4 Azure Policy

### Concepts Clés
- **Policy Definition** : Règle de conformité
- **Policy Assignment** : Application d'une policy à un scope
- **Initiative** : Collection de policies
- **Compliance** : État de conformité des ressources

### Effects Principaux - Détaillé

**⚠️ Erreur Courante QCM : Différence entre Deny et Audit**

| Effet | Action | Quand utiliser |
|-------|--------|----------------|
| **Deny** | ❌ **BLOQUE** la création/modification | Standards stricts, compliance obligatoire |
| **Audit** | ✅ Permet mais **LOG** comme non-compliant | Identifier les ressources non conformes |
| **Append** | Ajoute des propriétés manquantes | Tags automatiques |
| **Modify** | Modifie des propriétés existantes | Corriger configurations |
| **DeployIfNotExists** | Déploie une ressource si absente | Agents de monitoring |
| **AuditIfNotExists** | Audit si ressource absente | Vérifier présence de sécurité |

**Différence Clé Deny vs Audit :**

**Deny - Prévention (Enforcement)**
- ❌ **Bloque AVANT** la création de la ressource
- ✅ **Assure compliance dès le départ**
- **Use case** : Empêcher création de VMs sans tags, bloquer régions non autorisées
- **Impact** : Les utilisateurs ne peuvent PAS créer de ressources non conformes

**Audit - Détection (Visibility)**
- ✅ **Permet la création**, mais log comme non-compliant
- 📊 **Identifie les ressources** à corriger plus tard
- **Use case** : Découvrir les ressources existantes non conformes, phase de test
- **Impact** : Les ressources sont créées, mais marquées pour révision

**Exemple Pratique - Bloquer VMs sans tag "Environment" :**

```json
{
  "mode": "Indexed",
  "policyRule": {
    "if": {
      "allOf": [
        {
          "field": "type",
          "equals": "Microsoft.Compute/virtualMachines"
        },
        {
          "field": "tags['Environment']",
          "exists": "false"
        }
      ]
    },
    "then": {
      "effect": "deny"
    }
  }
}
```

**Assigner une policy avec effet Deny :**
```bash
az policy assignment create \
  --name "require-environment-tag" \
  --policy "/subscriptions/xxx/providers/Microsoft.Authorization/policyDefinitions/xxx" \
  --scope "/subscriptions/xxx" \
  --params '{"effect": {"value": "Deny"}}'
```

**Scénarios d'examen :**
- **"Prevent users from..."** → Utiliser **Deny**
- **"Identify resources that..."** → Utiliser **Audit**
- **"Automatically add tags..."** → Utiliser **Append**
- **"Deploy monitoring agent if missing..."** → Utiliser **DeployIfNotExists**

### Ordre d'Évaluation des Effets

**⚠️ IMPORTANT POUR L'EXAMEN :**

L'ordre dans lequel Azure Policy évalue les effets est **TOUJOURS** :
1. **Disabled** - La policy est ignorée
2. **Append/Modify** - Modifie les propriétés avant validation
3. **Deny** - ❌ **ÉVALUÉ EN PREMIER** parmi les effets actifs - Bloque si non conforme
4. **Audit/AuditIfNotExists** - Log la non-conformité
5. **DeployIfNotExists** - Déploie uniquement si le Resource Provider retourne un succès

**Question d'Examen Typique :**
```
Q: The Deny effect is evaluated first.
A: ✓ TRUE
```

```
Q: The Append effect modifies the value of an existing field in a resource.
A: ✓ TRUE - Append ajoute ou modifie des propriétés
```

```
Q: The Audit effect will create a warning event in the activity log for non-compliant resources.
A: ✗ FALSE - Audit crée un événement dans les logs de conformité, pas dans l'activity log
```

```
Q: The DeployIfNotExists effect is only evaluated if the request executed by the Resource Provider returns a success status code.
A: ✓ TRUE
```

### Policy Modes

| Mode | Description | Utilisation |
|------|-------------|-------------|
| **Indexed** | Évalue uniquement les types de ressources qui supportent tags et location | Ressources standards (VMs, Storage, etc.) |
| **All** | Évalue TOUTES les ressources | Ressources système, sous-ressources |

**Exemple - Mode "All" pour Key Vault :**
```json
{
  "mode": "All",
  "policyRule": {
    "if": {
      "field": "type",
      "equals": "Microsoft.KeyVault/vaults/secrets"
    },
    "then": {
      "effect": "audit"
    }
  }
}
```

### Initiatives (Policy Sets)

**Définition :** Groupe de policy definitions pour simplifier la gestion.

**Exemple - Initiative de sécurité :**
```json
{
  "properties": {
    "displayName": "Security Baseline Initiative",
    "policyDefinitions": [
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/xxx",
        "parameters": {}
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/yyy",
        "parameters": {}
      }
    ]
  }
}
```

**Créer et assigner une initiative :**
```bash
# Créer l'initiative
az policy set-definition create \
  --name "security-baseline" \
  --definitions security-policies.json \
  --description "Baseline security policies"

# Assigner l'initiative
az policy assignment create \
  --name "security-baseline-assignment" \
  --policy-set-definition "security-baseline" \
  --scope "/subscriptions/xxx"
```

### Scopes et Héritages

**Hiérarchie des Scopes :**
```
Management Group (scope le plus large)
    ↓
Subscription
    ↓
Resource Group
    ↓
Resource (scope le plus précis)
```

**Règles d'Héritage :**
- Les policies sont **héritées** des scopes parents
- Une policy assignée à un Management Group s'applique à toutes les subscriptions enfants
- **Exemptions** peuvent être créées à n'importe quel niveau

**Assigner à différents scopes :**
```bash
# Management Group
az policy assignment create \
  --name "mg-policy" \
  --policy "policyDefId" \
  --scope "/providers/Microsoft.Management/managementGroups/myMG"

# Subscription
az policy assignment create \
  --name "sub-policy" \
  --policy "policyDefId" \
  --scope "/subscriptions/xxx"

# Resource Group
az policy assignment create \
  --name "rg-policy" \
  --policy "policyDefId" \
  --scope "/subscriptions/xxx/resourceGroups/myRG"
```

### Exemptions de Policy

**Types d'exemptions :**
| Type | Description |
|------|-------------|
| **Waiver** | Exemption permanente (ressource approuvée) |
| **Mitigated** | Risque mitigé par d'autres contrôles |

**Créer une exemption :**
```bash
az policy exemption create \
  --name "vm-exemption" \
  --policy-assignment "/subscriptions/xxx/providers/Microsoft.Authorization/policyAssignments/require-tags" \
  --exemption-category "Waiver" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM" \
  --description "Legacy VM exempt from tagging requirement"
```

**⚠️ Bonnes Pratiques :**
- Documenter la raison de l'exemption
- Définir une date d'expiration si possible
- Limiter les exemptions au scope minimum nécessaire

### Évaluation de la Conformité

**Déclencheurs d'évaluation :**
- Création/modification d'une ressource
- Assignment ou update d'une policy
- Évaluation standard (toutes les 24h)

**Forcer une évaluation manuelle :**
```bash
# Pour un scope spécifique
az policy state trigger-scan \
  --resource-group "myRG"

# Pour toute la subscription (peut prendre 20-30 min)
az policy state trigger-scan
```

**Consulter l'état de conformité :**
```bash
# Vue d'ensemble
az policy state list \
  --resource-group "myRG"

# Ressources non conformes seulement
az policy state list \
  --filter "ComplianceState eq 'NonCompliant'"

# Pour une policy spécifique
az policy state list \
  --policy-assignment "require-tags"
```

### Remediation Tasks

**Quand utiliser :**
- Pour corriger des ressources **existantes** non conformes
- Fonctionne uniquement avec les effets **DeployIfNotExists** et **Modify**

**Créer une tâche de remediation :**
```bash
az policy remediation create \
  --name "remediate-monitoring" \
  --policy-assignment "deploy-monitoring-agent" \
  --resource-group "myRG"
```

**PowerShell - Remediation avec filtres :**
```powershell
Start-AzPolicyRemediation `
  -Name "remediate-tags" `
  -PolicyAssignmentId "/subscriptions/xxx/providers/Microsoft.Authorization/policyAssignments/require-tags" `
  -ResourceGroupName "myRG" `
  -LocationFilter "westeurope"
```

**Vérifier le statut de remediation :**
```bash
az policy remediation show \
  --name "remediate-monitoring" \
  --resource-group "myRG"
```

### Built-in Policies Courantes

**Sécurité :**
- `Require SSL for storage accounts`
- `Storage accounts should restrict network access`
- `Key Vault should have soft delete enabled`

**Gouvernance :**
- `Require tags on resources`
- `Inherit tags from resource group`
- `Allowed locations`

**Compute :**
- `Allowed virtual machine SKUs`
- `Managed disks should use encryption`
- `VMs should be backed up`

**Networking :**
- `NSG should be associated with subnets`
- `Network interfaces should not have public IPs`

**Lister les built-in policies :**
```bash
# Toutes les policies built-in
az policy definition list --query "[?policyType=='BuiltIn']"

# Rechercher par mot-clé
az policy definition list --query "[?contains(displayName,'tag')]"
```

### Questions d'Examen - Scénarios Pratiques

#### Scénario 1 : Effets de Policy

**Question :**
Vous devez vous assurer qu'aucune VM ne peut être créée sans un tag "CostCenter". Quel effet devez-vous utiliser ?

**Réponse :** `Deny`
- Deny **bloque** la création si le tag est manquant
- Audit permettrait la création mais la marquerait comme non conforme

#### Scénario 2 : Ordre d'Évaluation

**Question :**
Dans quel ordre Azure Policy évalue-t-il les effets ?

**Réponse :**
1. Disabled
2. Append/Modify
3. Deny (évalué en premier parmi les effets actifs)
4. Audit
5. DeployIfNotExists

#### Scénario 3 : Remediation

**Question :**
Vous avez assigné une policy avec effet "DeployIfNotExists" pour déployer l'agent Log Analytics sur toutes les VMs. Les VMs existantes n'ont pas l'agent. Que devez-vous faire ?

**Réponse :** Créer une **Remediation Task**
```bash
az policy remediation create \
  --name "deploy-log-analytics" \
  --policy-assignment "log-analytics-policy"
```

#### Scénario 4 : Initiative vs Policy

**Question :**
Vous devez appliquer 15 policies de sécurité à votre subscription. Quelle est la meilleure approche ?

**Réponse :** Créer une **Initiative** (Policy Set) contenant les 15 policies
- Plus facile à gérer
- Assignment unique
- Paramètres centralisés

### Commandes CLI Essentielles

**Policy Definitions :**
```bash
# Créer une custom policy
az policy definition create \
  --name "my-policy" \
  --display-name "My Custom Policy" \
  --description "Custom policy description" \
  --rules policy-rules.json \
  --params policy-params.json \
  --mode "Indexed"

# Lister les policies
az policy definition list

# Supprimer une policy
az policy definition delete --name "my-policy"
```

**Policy Assignments :**
```bash
# Assigner une policy
az policy assignment create \
  --name "assignment-name" \
  --display-name "Display Name" \
  --policy "policyDefinitionId" \
  --scope "/subscriptions/xxx" \
  --params '{"tagName": {"value": "Environment"}}'

# Lister les assignments
az policy assignment list

# Supprimer un assignment
az policy assignment delete --name "assignment-name"
```

**Compliance :**
```bash
# État de conformité global
az policy state summarize \
  --resource-group "myRG"

# Détails des ressources non conformes
az policy state list \
  --filter "ComplianceState eq 'NonCompliant'" \
  --query "[].{Resource:resourceId, Policy:policyDefinitionName}"
```

### PowerShell - Commandes Équivalentes

```powershell
# Créer une policy definition
New-AzPolicyDefinition `
  -Name "my-policy" `
  -DisplayName "My Custom Policy" `
  -Policy policy-rules.json `
  -Parameter policy-params.json

# Assigner une policy
New-AzPolicyAssignment `
  -Name "assignment-name" `
  -PolicyDefinition $policyDef `
  -Scope "/subscriptions/xxx"

# État de conformité
Get-AzPolicyState | Where-Object {$_.ComplianceState -eq "NonCompliant"}

# Créer une remediation task
Start-AzPolicyRemediation `
  -Name "remediate-task" `
  -PolicyAssignmentId $assignmentId
```

### Best Practices

**1. Stratégie de Déploiement :**
- ✅ Commencer avec effet **Audit** pour évaluer l'impact
- ✅ Tester sur un Resource Group pilote
- ✅ Passer à **Deny** une fois validé

**2. Organisation :**
- ✅ Utiliser des **Initiatives** pour grouper des policies liées
- ✅ Nommer clairement les policies et assignments
- ✅ Documenter les paramètres et exemptions

**3. Scopes :**
- ✅ Assigner au niveau le plus haut approprié (Management Group)
- ✅ Utiliser les exemptions pour les cas particuliers
- ✅ Éviter les assignments redondants

**4. Monitoring :**
- ✅ Configurer des alertes sur les états de conformité
- ✅ Réviser régulièrement les exemptions
- ✅ Utiliser Azure Monitor pour tracker les changements

**5. Performance :**
- ❌ Éviter les policies trop complexes
- ✅ Utiliser le mode approprié (Indexed vs All)
- ✅ Limiter les evaluations fréquentes avec DeployIfNotExists

### Cas d'Usage Avancés

**1. Forcer le chiffrement sur tous les Storage Accounts :**
```json
{
  "if": {
    "allOf": [
      {
        "field": "type",
        "equals": "Microsoft.Storage/storageAccounts"
      },
      {
        "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
        "notEquals": "true"
      }
    ]
  },
  "then": {
    "effect": "deny"
  }
}
```

**2. Hériter automatiquement les tags du Resource Group :**
```json
{
  "if": {
    "allOf": [
      {
        "field": "[concat('tags[', parameters('tagName'), ']')]",
        "exists": "false"
      },
      {
        "value": "[resourceGroup().tags[parameters('tagName')]]",
        "notEquals": ""
      }
    ]
  },
  "then": {
    "effect": "append",
    "details": [
      {
        "field": "[concat('tags[', parameters('tagName'), ']')]",
        "value": "[resourceGroup().tags[parameters('tagName')]]"
      }
    ]
  }
}
```

**3. Déployer l'agent de monitoring automatiquement :**
```json
{
  "if": {
    "field": "type",
    "equals": "Microsoft.Compute/virtualMachines"
  },
  "then": {
    "effect": "deployIfNotExists",
    "details": {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "roleDefinitionIds": [
        "/providers/microsoft.authorization/roleDefinitions/xxx"
      ],
      "deployment": {
        "properties": {
          "mode": "incremental",
          "template": {
            // Template de déploiement de l'extension
          }
        }
      }
    }
  }
}
```

### Dépannage

**Problème : Policy non appliquée**
```bash
# Vérifier l'assignment
az policy assignment show --name "my-assignment"

# Forcer une évaluation
az policy state trigger-scan

# Vérifier les exemptions
az policy exemption list --scope "/subscriptions/xxx"
```

**Problème : Remediation échoue**
```bash
# Vérifier les permissions (Managed Identity requis pour DINE)
az policy assignment identity show --name "my-assignment"

# Assigner les rôles nécessaires
az policy assignment identity assign \
  --name "my-assignment" \
  --role "Contributor" \
  --scope "/subscriptions/xxx"
```

**Problème : Performance lente**
- Réduire le scope des policies
- Utiliser des conditions plus spécifiques
- Éviter les policies "All" quand "Indexed" suffit

### Liens et Ressources

**Documentation officielle :**
- [Azure Policy Overview](https://docs.microsoft.com/azure/governance/policy/overview)
- [Policy Effects](https://docs.microsoft.com/azure/governance/policy/concepts/effects)
- [Policy Samples](https://github.com/Azure/azure-policy)

**Outils :**
- [Azure Policy Extension for VS Code](https://marketplace.visualstudio.com/items?itemName=AzurePolicy.azurepolicyextension)
- [Policy Compliance Dashboard](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyMenuBlade/Compliance)