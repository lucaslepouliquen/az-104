## 1.4 Azure Policy

### Concepts Clés
- **Policy Definition** : Règle de conformité
- **Policy Assignment** : Application d'une policy à un scope
- **Initiative** : Collection de policies
- **Compliance** : État de conformité des ressources

### Effects Principaux - Détaillé

**⚠️ Erreur Courante QCM : Différence entre Deny, Audit et Append**

| Effet | Action | Quand utiliser |
|-------|--------|----------------|
| **Deny** | ❌ **BLOQUE** la création/modification | Standards stricts, compliance obligatoire |
| **Audit** | ✅ Permet mais **LOG** dans activity log | Identifier les ressources non conformes |
| **Append** | Ajoute des champs UNIQUEMENT si absents. Si présents avec valeur différente → **DENY** | Tags automatiques sur nouvelles ressources |
| **Modify** | Modifie des propriétés existantes | Corriger configurations existantes |
| **DeployIfNotExists** | Déploie une ressource si absente | Agents de monitoring |
| **AuditIfNotExists** | Audit si ressource absente | Vérifier présence de sécurité |

---

## ⚠️ APPEND - Comportement Critique pour l'Examen

**RÈGLE FONDAMENTALE :**

L'effet **Append** a un comportement en **DEUX TEMPS** :

### 1. Si le champ N'EXISTE PAS :
✅ **Append ajoute le champ** avec la valeur définie dans la policy

**Exemple :**
```json
Policy Append: tag "Environment" = "Production"
Création VM SANS tag "Environment"
→ ✅ Le tag est AJOUTÉ automatiquement
```

### 2. Si le champ EXISTE DÉJÀ :
❌ **Append vérifie la valeur** :
- Si valeur identique à la policy → ✅ Autorisé
- Si valeur différente de la policy → ❌ **REJETÉ comme un DENY**

**Exemple PIÈGE pour l'examen :**
```json
Policy Append: tag "Environment" = "Production"
Création VM AVEC tag "Environment" = "Development"
→ ❌ REJETÉ (request denied) car valeur différente
```

### Citation Officielle Azure :
> "The Append effect **does not modify** the value of an existing field in a resource. The Append effect adds additional fields during the creation or update of a resource. **If the field already exists in the resource and the values in the resource and the policy are different, then the policy acts as a deny and rejects the request.**"

### Différence Append vs Modify

| Comportement | Append | Modify |
|--------------|--------|--------|
| **Champ absent** | ✅ Ajoute le champ | ✅ Ajoute le champ |
| **Champ présent avec bonne valeur** | ✅ Autorise | ✅ Autorise |
| **Champ présent avec mauvaise valeur** | ❌ **DENY (rejette)** | ✅ **MODIFIE la valeur** |
| **Use case typique** | Forcer tags sur nouvelles ressources | Corriger tags sur ressources existantes |

### Scénario d'Examen Typique - Append

**Question :**
```
You have an Azure Policy with Append effect that sets tag "CostCenter"="Finance".
A user tries to create a VM with tag "CostCenter"="IT".
What happens?
A) The VM is created with tag "CostCenter"="Finance"
B) The VM is created with tag "CostCenter"="IT"
C) The VM creation is denied
D) The VM is created with both tags
```

**Réponse : C) The VM creation is denied**

**Explication :** Append détecte que le champ existe avec une valeur différente → Agit comme un Deny

---

## Différence Clé Deny vs Audit

### Deny - Prévention (Enforcement)
- ❌ **Bloque AVANT** la création de la ressource
- ✅ **Assure compliance dès le départ**
- **Use case** : Empêcher création de VMs sans tags, bloquer régions non autorisées
- **Impact** : Les utilisateurs ne peuvent PAS créer de ressources non conformes

### Audit - Détection (Visibility)
- ✅ **Permet la création**, mais log dans activity log
- 📊 **Identifie les ressources** à corriger plus tard
- **Use case** : Découvrir les ressources existantes non conformes, phase de test
- **Impact** : Les ressources sont créées, mais marquées pour révision

**⚠️ IMPORTANT - Location des Logs Audit :**

Contrairement à ce qu'on pourrait penser, l'effet **Audit crée bien un événement dans l'Activity Log**, pas uniquement dans les compliance reports.

### Citation Officielle Azure :
> "The Audit effect **will create a warning event in the activity log** for non-compliant resources. The audit effect is evaluated last, before the Resource Provider handles a create or update request. You typically use the audit effect when you want to track non-compliant resources."

**Exemple Pratique - Bloquer VMs sans tag "Environment" :**

```json
{
  "mode": "Indexed",
  "policyRule": {
    "if": {
      "allOf": [
        {
          "field": "type",
          "equals": "Microsoft.Compute/virtualMachines"
        },
        {
          "field": "tags['Environment']",
          "exists": "false"
        }
      ]
    },
    "then": {
      "effect": "deny"
    }
  }
}
```

**Assigner une policy avec effet Deny :**
```bash
az policy assignment create \
  --name "require-environment-tag" \
  --policy "/subscriptions/xxx/providers/Microsoft.Authorization/policyDefinitions/xxx" \
  --scope "/subscriptions/xxx" \
  --params '{"effect": {"value": "Deny"}}'
```

**Scénarios d'examen :**
- **"Prevent users from..."** → Utiliser **Deny**
- **"Identify resources that..."** → Utiliser **Audit**
- **"Automatically add tags to new resources..."** → Utiliser **Append**
- **"Fix tags on existing resources..."** → Utiliser **Modify**
- **"Deploy monitoring agent if missing..."** → Utiliser **DeployIfNotExists**

---

## Ordre d'Évaluation des Effets

**⚠️ IMPORTANT POUR L'EXAMEN :**

L'ordre dans lequel Azure Policy évalue les effets est **TOUJOURS** :

### Citation Officielle Azure :
> "The correct order of evaluation of the policy effects is: **Disabled, Append, Deny and Audit.**"

**Ordre complet détaillé :**
1. **Disabled** - La policy est ignorée
2. **Append** - Ajoute des champs avant validation (ou Deny si conflit)
3. **Deny** - Bloque si non conforme
4. **Audit** - Log la non-conformité dans l'activity log
5. **DeployIfNotExists** - Déploie uniquement si le Resource Provider retourne un succès
6. **Modify** - Modifie les propriétés

**Point Critique :**
- **Deny n'est PAS évalué en premier** parmi tous les effets
- **Disabled** est toujours vérifié en premier (pour savoir si la policy s'applique)
- **Append** est évalué AVANT Deny (et peut lui-même agir comme un Deny)

### Questions d'Examen - Ordre d'Évaluation

```
Q: The Deny effect is evaluated first.
A: ✗ FALSE - Disabled est évalué en premier, puis Append, puis Deny
```

```
Q: The correct order of evaluation is: Disabled, Append, Deny, Audit
A: ✓ TRUE
```

```
Q: The Append effect modifies the value of an existing field in a resource.
A: ✗ FALSE - Append N'ajoute QUE si le champ n'existe pas. Si le champ existe avec une valeur différente, Append REJETTE la requête.
```

```
Q: The Audit effect will create a warning event in the activity log for non-compliant resources.
A: ✓ TRUE
```

```
Q: The DeployIfNotExists effect is only evaluated if the request executed by the Resource Provider returns a success status code.
A: ✓ TRUE
```

---

## Policy Modes

| Mode | Description | Utilisation |
|------|-------------|-------------|
| **Indexed** | Évalue uniquement les types de ressources qui supportent tags et location | Ressources standards (VMs, Storage, etc.) |
| **All** | Évalue TOUTES les ressources | Ressources système, sous-ressources |

**Exemple - Mode "All" pour Key Vault :**
```json
{
  "mode": "All",
  "policyRule": {
    "if": {
      "field": "type",
      "equals": "Microsoft.KeyVault/vaults/secrets"
    },
    "then": {
      "effect": "audit"
    }
  }
}
```

---

## Initiatives (Policy Sets)

**Définition :** Groupe de policy definitions pour simplifier la gestion.

**Exemple - Initiative de sécurité :**
```json
{
  "properties": {
    "displayName": "Security Baseline Initiative",
    "policyDefinitions": [
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/xxx",
        "parameters": {}
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/yyy",
        "parameters": {}
      }
    ]
  }
}
```

**Créer et assigner une initiative :**
```bash
# Créer l'initiative
az policy set-definition create \
  --name "security-baseline" \
  --definitions security-policies.json \
  --description "Baseline security policies"

# Assigner l'initiative
az policy assignment create \
  --name "security-baseline-assignment" \
  --policy-set-definition "security-baseline" \
  --scope "/subscriptions/xxx"
```

---

## Scopes et Héritages

**Hiérarchie des Scopes :**
```
Management Group (scope le plus large)
    ↓
Subscription
    ↓
Resource Group
    ↓
Resource (scope le plus précis)
```

**Règles d'Héritage :**
- Les policies sont **héritées** des scopes parents
- Une policy assignée à un Management Group s'applique à toutes les subscriptions enfants
- **Exemptions** peuvent être créées à n'importe quel niveau

**Assigner à différents scopes :**
```bash
# Management Group
az policy assignment create \
  --name "mg-policy" \
  --policy "policyDefId" \
  --scope "/providers/Microsoft.Management/managementGroups/myMG"

# Subscription
az policy assignment create \
  --name "sub-policy" \
  --policy "policyDefId" \
  --scope "/subscriptions/xxx"

# Resource Group
az policy assignment create \
  --name "rg-policy" \
  --policy "policyDefId" \
  --scope "/subscriptions/xxx/resourceGroups/myRG"
```

---

## Exemptions de Policy

**Types d'exemptions :**
| Type | Description |
|------|-------------|
| **Waiver** | Exemption permanente (ressource approuvée) |
| **Mitigated** | Risque mitigé par d'autres contrôles |

**Créer une exemption :**
```bash
az policy exemption create \
  --name "vm-exemption" \
  --policy-assignment "/subscriptions/xxx/providers/Microsoft.Authorization/policyAssignments/require-tags" \
  --exemption-category "Waiver" \
  --scope "/subscriptions/xxx/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM" \
  --description "Legacy VM exempt from tagging requirement"
```

**⚠️ Bonnes Pratiques :**
- Documenter la raison de l'exemption
- Définir une date d'expiration si possible
- Limiter les exemptions au scope minimum nécessaire

---

## Évaluation de la Conformité

**Déclencheurs d'évaluation :**
- Création/modification d'une ressource
- Assignment ou update d'une policy
- Évaluation standard (toutes les 24h)

**Forcer une évaluation manuelle :**
```bash
# Pour un scope spécifique
az policy state trigger-scan \
  --resource-group "myRG"

# Pour toute la subscription (peut prendre 20-30 min)
az policy state trigger-scan
```

**Consulter l'état de conformité :**
```bash
# Vue d'ensemble
az policy state list \
  --resource-group "myRG"

# Ressources non conformes seulement
az policy state list \
  --filter "ComplianceState eq 'NonCompliant'"

# Pour une policy spécifique
az policy state list \
  --policy-assignment "require-tags"
```

---

## Remediation Tasks

**Quand utiliser :**
- Pour corriger des ressources **existantes** non conformes
- Fonctionne uniquement avec les effets **DeployIfNotExists** et **Modify**

**Créer une tâche de remediation :**
```bash
az policy remediation create \
  --name "remediate-monitoring" \
  --policy-assignment "deploy-monitoring-agent" \
  --resource-group "myRG"
```

**PowerShell - Remediation avec filtres :**
```powershell
Start-AzPolicyRemediation `
  -Name "remediate-tags" `
  -PolicyAssignmentId "/subscriptions/xxx/providers/Microsoft.Authorization/policyAssignments/require-tags" `
  -ResourceGroupName "myRG" `
  -LocationFilter "westeurope"
```

**Vérifier le statut de remediation :**
```bash
az policy remediation show \
  --name "remediate-monitoring" \
  --resource-group "myRG"
```

---

## Built-in Policies Courantes

**Sécurité :**
- `Require SSL for storage accounts`
- `Storage accounts should restrict network access`
- `Key Vault should have soft delete enabled`

**Gouvernance :**
- `Require tags on resources`
- `Inherit tags from resource group`
- `Allowed locations`

**Compute :**
- `Allowed virtual machine SKUs`
- `Managed disks should use encryption`
- `VMs should be backed up`

**Networking :**
- `NSG should be associated with subnets`
- `Network interfaces should not have public IPs`

**Lister les built-in policies :**
```bash
# Toutes les policies built-in
az policy definition list --query "[?policyType=='BuiltIn']"

# Rechercher par mot-clé
az policy definition list --query "[?contains(displayName,'tag')]"
```

---

## Questions d'Examen - Scénarios Pratiques

### Scénario 1 : Effets de Policy - Append vs Modify

**Question :**
Vous devez vous assurer que toutes les nouvelles VMs ont un tag "CostCenter"="Finance", mais les VMs existantes avec d'autres valeurs ne doivent pas être bloquées. Quel effet devez-vous utiliser ?

**Réponse :** `Append` pour les nouvelles ressources + `Modify` avec remediation pour les existantes
- Append bloquera les nouvelles VMs avec un mauvais tag
- Modify avec remediation task corrigera les VMs existantes

### Scénario 2 : Append - Cas Piège

**Question :**
Une policy Append force le tag "Environment"="Production". Un utilisateur crée une VM avec "Environment"="Development". Que se passe-t-il ?

**Réponse :** ❌ La création de la VM est **rejetée**
- Append détecte le champ existant avec valeur différente
- Append agit comme un Deny dans ce cas

### Scénario 3 : Ordre d'Évaluation

**Question :**
Dans quel ordre Azure Policy évalue-t-il les effets ?

**Réponse :**
1. Disabled
2. Append
3. Deny
4. Audit

### Scénario 4 : Remediation

**Question :**
Vous avez assigné une policy avec effet "DeployIfNotExists" pour déployer l'agent Log Analytics sur toutes les VMs. Les VMs existantes n'ont pas l'agent. Que devez-vous faire ?

**Réponse :** Créer une **Remediation Task**
```bash
az policy remediation create \
  --name "deploy-log-analytics" \
  --policy-assignment "log-analytics-policy"
```

### Scénario 5 : Initiative vs Policy

**Question :**
Vous devez appliquer 15 policies de sécurité à votre subscription. Quelle est la meilleure approche ?

**Réponse :** Créer une **Initiative** (Policy Set) contenant les 15 policies
- Plus facile à gérer
- Assignment unique
- Paramètres centralisés

---

## Commandes CLI Essentielles

**Policy Definitions :**
```bash
# Créer une custom policy
az policy definition create \
  --name "my-policy" \
  --display-name "My Custom Policy" \
  --description "Custom policy description" \
  --rules policy-rules.json \
  --params policy-params.json \
  --mode "Indexed"

# Lister les policies
az policy definition list

# Supprimer une policy
az policy definition delete --name "my-policy"
```

**Policy Assignments :**
```bash
# Assigner une policy
az policy assignment create \
  --name "assignment-name" \
  --display-name "Display Name" \
  --policy "policyDefinitionId" \
  --scope "/subscriptions/xxx" \
  --params '{"tagName": {"value": "Environment"}}'

# Lister les assignments
az policy assignment list

# Supprimer un assignment
az policy assignment delete --name "assignment-name"
```

**Compliance :**
```bash
# État de conformité global
az policy state summarize \
  --resource-group "myRG"

# Détails des ressources non conformes
az policy state list \
  --filter "ComplianceState eq 'NonCompliant'" \
  --query "[].{Resource:resourceId, Policy:policyDefinitionName}"
```

---

## PowerShell - Commandes Équivalentes

```powershell
# Créer une policy definition
New-AzPolicyDefinition `
  -Name "my-policy" `
  -DisplayName "My Custom Policy" `
  -Policy policy-rules.json `
  -Parameter policy-params.json

# Assigner une policy
New-AzPolicyAssignment `
  -Name "assignment-name" `
  -PolicyDefinition $policyDef `
  -Scope "/subscriptions/xxx"

# État de conformité
Get-AzPolicyState | Where-Object {$_.ComplianceState -eq "NonCompliant"}

# Créer une remediation task
Start-AzPolicyRemediation `
  -Name "remediate-task" `
  -PolicyAssignmentId $assignmentId
```

---

## Best Practices

**1. Stratégie de Déploiement :**
- ✅ Commencer avec effet **Audit** pour évaluer l'impact
- ✅ Tester sur un Resource Group pilote
- ✅ Passer à **Deny** ou **Append** une fois validé

**2. Organisation :**
- ✅ Utiliser des **Initiatives** pour grouper des policies liées
- ✅ Nommer clairement les policies et assignments
- ✅ Documenter les paramètres et exemptions

**3. Scopes :**
- ✅ Assigner au niveau le plus haut approprié (Management Group)
- ✅ Utiliser les exemptions pour les cas particuliers
- ✅ Éviter les assignments redondants

**4. Monitoring :**
- ✅ Configurer des alertes sur les états de conformité
- ✅ Réviser régulièrement les exemptions
- ✅ Utiliser Azure Monitor pour tracker les changements

**5. Performance :**
- ❌ Éviter les policies trop complexes
- ✅ Utiliser le mode approprié (Indexed vs All)
- ✅ Limiter les evaluations fréquentes avec DeployIfNotExists

---

## Cas d'Usage Avancés

**1. Forcer le chiffrement sur tous les Storage Accounts :**
```json
{
  "if": {
    "allOf": [
      {
        "field": "type",
        "equals": "Microsoft.Storage/storageAccounts"
      },
      {
        "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
        "notEquals": "true"
      }
    ]
  },
  "then": {
    "effect": "deny"
  }
}
```

**2. Ajouter automatiquement les tags manquants (Append) :**
```json
{
  "if": {
    "allOf": [
      {
        "field": "tags['Environment']",
        "exists": "false"
      }
    ]
  },
  "then": {
    "effect": "append",
    "details": [
      {
        "field": "tags['Environment']",
        "value": "Production"
      }
    ]
  }
}
```

**Note importante :** Si une ressource a déjà un tag "Environment" avec une valeur différente de "Production", la création sera **rejetée**.

**3. Hériter automatiquement les tags du Resource Group (Modify) :**
```json
{
  "if": {
    "allOf": [
      {
        "field": "[concat('tags[', parameters('tagName'), ']')]",
        "notEquals": "[resourceGroup().tags[parameters('tagName')]]"
      }
    ]
  },
  "then": {
    "effect": "modify",
    "details": {
      "roleDefinitionIds": [
        "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
      ],
      "operations": [
        {
          "operation": "addOrReplace",
          "field": "[concat('tags[', parameters('tagName'), ']')]",
          "value": "[resourceGroup().tags[parameters('tagName')]]"
        }
      ]
    }
  }
}
```

**4. Déployer l'agent de monitoring automatiquement :**
```json
{
  "if": {
    "field": "type",
    "equals": "Microsoft.Compute/virtualMachines"
  },
  "then": {
    "effect": "deployIfNotExists",
    "details": {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "roleDefinitionIds": [
        "/providers/microsoft.authorization/roleDefinitions/xxx"
      ],
      "deployment": {
        "properties": {
          "mode": "incremental",
          "template": {
            // Template de déploiement de l'extension
          }
        }
      }
    }
  }
}
```

---

## Dépannage

**Problème : Policy non appliquée**
```bash
# Vérifier l'assignment
az policy assignment show --name "my-assignment"

# Forcer une évaluation
az policy state trigger-scan

# Vérifier les exemptions
az policy exemption list --scope "/subscriptions/xxx"
```

**Problème : Remediation échoue**
```bash
# Vérifier les permissions (Managed Identity requis pour DINE)
az policy assignment identity show --name "my-assignment"

# Assigner les rôles nécessaires
az policy assignment identity assign \
  --name "my-assignment" \
  --role "Contributor" \
  --scope "/subscriptions/xxx"
```

**Problème : Performance lente**
- Réduire le scope des policies
- Utiliser des conditions plus spécifiques
- Éviter les policies "All" quand "Indexed" suffit

---

## Liens et Ressources

**Documentation officielle :**
- [Azure Policy Overview](https://docs.microsoft.com/azure/governance/policy/overview)
- [Policy Effects](https://docs.microsoft.com/azure/governance/policy/concepts/effects)
- [Policy Samples](https://github.com/Azure/azure-policy)

**Outils :**
- [Azure Policy Extension for VS Code](https://marketplace.visualstudio.com/items?itemName=AzurePolicy.azurepolicyextension)
- [Policy Compliance Dashboard](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyMenuBlade/Compliance)

---

## Checklist AZ-104 : Azure Policy

✅ **Comprendre les effets** :
   - Deny = Bloque la création
   - Audit = Permet mais log dans activity log
   - Append = Ajoute si absent, Deny si présent avec valeur différente
   - Modify = Modifie les valeurs existantes
   - DeployIfNotExists = Déploie ressources manquantes

✅ **Maîtriser l'ordre d'évaluation** :
   - Disabled → Append → Deny → Audit

✅ **Connaître les différences Append vs Modify** :
   - Append : Pour nouvelles ressources (bloque si conflit)
   - Modify : Pour ressources existantes (corrige les valeurs)

✅ **Savoir créer et assigner** :
   - Policy definitions
   - Policy assignments
   - Initiatives (Policy Sets)

✅ **Comprendre les scopes et héritages** :
   - Management Group > Subscription > Resource Group > Resource
   - Exemptions possibles à tous niveaux

✅ **Maîtriser les remediation tasks** :
   - Uniquement pour DeployIfNotExists et Modify
   - Corrigent les ressources existantes

✅ **Connaître les policy modes** :
   - Indexed : Ressources avec tags/location
   - All : Toutes ressources (y compris sous-ressources)