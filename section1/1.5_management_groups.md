## 1.5 Management Groups

### HiÃ©rarchie
```
Root Management Group
â”œâ”€â”€ Production MG
â”‚   â”œâ”€â”€ Prod Subscription 1
â”‚   â””â”€â”€ Prod Subscription 2
â””â”€â”€ Development MG
    â”œâ”€â”€ Dev Subscription 1
    â””â”€â”€ Test Subscription 1
```

### Limites et AccÃ¨s

**âš ï¸ Limites Techniques des Management Groups :**

**HiÃ©rarchie :**
- **6 niveaux** de profondeur maximum (en dessous du root management group)
- **Note** : Le Root Management Group n'est PAS comptÃ© dans les 6 niveaux
- **Exemple** : Root â†’ Level 1 â†’ Level 2 â†’ Level 3 â†’ Level 4 â†’ Level 5 â†’ Level 6 (Subscriptions)

**CapacitÃ© :**
- **10,000 management groups** maximum par tenant Azure AD
- **Note** : Cette limite inclut tous les management groups (root + enfants)

**Contraintes :**
- âœ… **Une subscription** peut appartenir Ã  **un seul** management group
- âœ… **Un management group** peut avoir **plusieurs** enfants (subscriptions ou MG)
- âœ… **Un management group** ne peut avoir **qu'un seul** parent

**âš ï¸ AccÃ¨s au Root Management Group :**
- **Aucun accÃ¨s par dÃ©faut** au root management group
- Seuls les **Global Administrators** peuvent s'Ã©lever pour obtenir l'accÃ¨s
- **Processus** : 
  1. Global Admin â†’ Azure Portal
  2. Azure AD â†’ Properties
  3. "Access management for Azure resources" â†’ Enable
  4. Assign roles au root management group

**âš ï¸ DÃ©lais de Propagation (RBAC et Policies) :**

Ces dÃ©lais concernent **uniquement** les assignations RBAC et Policy, **PAS les Resource Locks**.

| Type d'assignation | DÃ©lai de propagation | Scope |
|-------------------|---------------------|-------|
| **RBAC assignments** | Jusqu'Ã  10 minutes | Management Groups, Subscriptions, Resource Groups |
| **Policy assignments** | Jusqu'Ã  30 minutes | Management Groups, Subscriptions, Resource Groups |
| **Resource Locks** | âœ… **ImmÃ©diat** | Subscriptions, Resource Groups, Resources |

**âš ï¸ Important pour l'examen :**
- **Locks** : Effectifs **immÃ©diatement** aprÃ¨s crÃ©ation
- **RBAC** : Peut prendre jusqu'Ã  **10 minutes** pour que les permissions soient actives
- **Policies** : Peut prendre jusqu'Ã  **30 minutes** pour Ã©valuation de la conformitÃ©

**RÃ©fÃ©rence** : [Azure Management Groups - Limits and recommendations](https://learn.microsoft.com/azure/governance/management-groups/overview)

### Resource Locks

**âš ï¸ Point d'Attention : Comprendre les Niveaux de Protection des Locks**

**Types de Locks :**

**1. Delete Lock (CanNotDelete)**
- **Protection** : EmpÃªche la suppression de la ressource
- **Permet** : Modifications et lecture de la ressource
- **Usage** : Protection contre suppression accidentelle

**2. Read-Only Lock (ReadOnly)**
- **Protection** : EmpÃªche suppression ET modification
- **Permet** : Lecture seule
- **Usage** : Protection maximale (compliance, audit)

**âš ï¸ HÃ©ritage des Locks - Point Critique pour l'Examen :**

Les locks suivent un principe d'**hÃ©ritage hiÃ©rarchique** :

**Delete Lock sur Resource Group :**
```
Resource Group avec Delete Lock
â”œâ”€â”€ âœ… EmpÃªche suppression du Resource Group lui-mÃªme
â”œâ”€â”€ âœ… EmpÃªche AUSSI suppression des ressources enfants (hÃ©ritage)
â””â”€â”€ âœ… PERMET modifications des ressources enfants
```

**Exemple concret :**
```
RG "Production-RG" avec Delete Lock :
âœ… Cannot delete the Resource Group
âœ… Cannot delete VM1 in Production-RG (inherited)
âœ… Cannot delete Storage Account in Production-RG (inherited)
âœ… CAN modify/stop VM1
âœ… CAN upload/delete blobs in Storage Account
âœ… CAN change VM size, add disks, etc.
```

**HiÃ©rarchie d'hÃ©ritage des Locks :**

| Scope Lock | Impact sur Enfants | Exemple |
|-----------|-------------------|---------|
| **Subscription Lock** | âœ… S'applique Ã  **tous** les Resource Groups et ressources | Lock sur Subscription â†’ ProtÃ¨ge toutes les ressources |
| **Resource Group Lock** | âœ… S'applique Ã  **toutes** les ressources du RG | Lock sur RG â†’ ProtÃ¨ge toutes les VMs, Storage, etc. |
| **Resource Lock** | âŒ S'applique **uniquement** Ã  cette ressource | Lock sur VM1 â†’ ProtÃ¨ge uniquement VM1 |

**âš ï¸ PiÃ¨ge d'examen classique :**

| Question | RÃ©ponse Incorrecte âŒ | RÃ©ponse Correcte âœ… |
|----------|----------------------|---------------------|
| "Delete Lock sur RG permet de supprimer les ressources ?" | "Oui, le lock ne concerne que le RG" | "Non, le lock est hÃ©ritÃ© par toutes les ressources enfants" |
| "Delete Lock sur RG empÃªche de modifier les VMs ?" | "Oui, tout est bloquÃ©" | "Non, on peut modifier, juste pas supprimer" |
| "Comment supprimer une VM dans un RG avec Delete Lock ?" | "Impossible" | "Retirer le lock du RG d'abord, puis supprimer" |

**âš ï¸ CLARIFICATION IMPORTANTE : Storage Account Locks**

**Ce que les locks protÃ¨gent :**
- âœ… **Le Storage Account lui-mÃªme** : Ne peut pas Ãªtre supprimÃ© (Delete Lock)
- âœ… **Les propriÃ©tÃ©s du compte** : Configuration, SKU, rÃ©plication

**Ce que les locks NE protÃ¨gent PAS :**
- âŒ **Les donnÃ©es DANS le Storage Account** : Blobs, fichiers, tables, queues
- âŒ **Les opÃ©rations sur les donnÃ©es** : Upload, modification, suppression de blobs
- âŒ **Les containers/shares** : Peuvent Ãªtre crÃ©Ã©s/supprimÃ©s

**Exemple concret :**
```
Storage Account avec Delete Lock :
âœ… Cannot delete the storage account
âŒ CAN delete/modify blobs inside the account
âŒ CAN delete containers
âŒ CAN upload/overwrite files
```

**Pour protÃ©ger les DONNÃ‰ES dans un Storage Account, utilisez :**

**1. Immutable Storage (WORM - Write Once, Read Many)**

**âš ï¸ Note** : La syntaxe CLI peut varier selon la version. VÃ©rifiez toujours avec `az storage container immutability-policy --help`

```bash
# Option 1: CrÃ©er une politique d'immutabilitÃ© time-based (pÃ©riode de rÃ©tention)
az storage container immutability-policy create \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --period 365 \
  --account-key <storage-key>

# Option 2: Verrouiller la politique (mode Locked - irrÃ©versible)
az storage container immutability-policy lock \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --if-match "<etag>" \
  --account-key <storage-key>

# Option 3: Via Account-level (recommandÃ© pour 2024+)
az storage account blob-service-properties update \
  --account-name mystorageaccount \
  --resource-group myRG \
  --enable-versioning true \
  --default-service-version "2021-06-08"
```

**Modes de politique :**
- **Unlocked** : Test mode, peut Ãªtre modifiÃ©/supprimÃ©
- **Locked** : Production mode, **irrÃ©versible**, compliance garantie

**CaractÃ©ristiques :**
- âœ… Blobs ne peuvent pas Ãªtre modifiÃ©s ou supprimÃ©s pendant la pÃ©riode de rÃ©tention
- âœ… Protection contre ransomware et suppression accidentelle
- âœ… Compliance rÃ©glementaire (SEC 17a-4(f), FINRA 4511, CFTC, etc.)
- âœ… Legal Hold disponible pour rÃ©tention indÃ©finie

**2. Soft Delete**
```bash
# Activer soft delete pour blobs
az storage account blob-service-properties update \
  --account-name mystorageaccount \
  --enable-delete-retention true \
  --delete-retention-days 30
```
- âœ… RÃ©cupÃ©ration de blobs supprimÃ©s (7-365 jours)
- âœ… Protection contre suppression accidentelle
- âœ… Snapshots et versions prÃ©servÃ©s

**3. Versioning**
```bash
# Activer versioning
az storage account blob-service-properties update \
  --account-name mystorageaccount \
  --enable-versioning true
```
- âœ… Historique complet des versions
- âœ… RÃ©cupÃ©ration de versions prÃ©cÃ©dentes
- âœ… Protection contre Ã©crasement

**Ressources SupportÃ©es pour Locks :**
- âœ… **Virtual Machines** : EmpÃªche suppression de la VM
- âœ… **Subscriptions** : ProtÃ¨ge toutes les ressources de la souscription
- âœ… **Resource Groups** : ProtÃ¨ge le groupe et toutes ses ressources
- âœ… **Storage Accounts** : ProtÃ¨ge le compte, PAS les donnÃ©es
- âœ… **Networks, Databases, etc.** : Toutes ressources Azure

**Ressources NON SupportÃ©es pour Locks :**
- âŒ **Management Groups** : Cannot add locks to management groups
- âŒ **Data inside resources** : Blobs, SQL rows, files

**ScÃ©narios d'Examen :**

| Besoin | Solution | Raison |
|--------|----------|--------|
| **EmpÃªcher suppression Storage Account** | **Delete Lock** | ProtÃ¨ge la ressource |
| **ProtÃ©ger donnÃ©es (blobs) dans Storage** | **Immutable Storage + Soft Delete** | Locks ne protÃ¨gent pas les donnÃ©es |
| **EmpÃªcher suppression accidentelle VM** | **Delete Lock** | Protection de la ressource VM |
| **Protection contre ransomware** | **Immutable Storage** | Blobs non modifiables |
| **Compliance rÃ©glementaire** | **Immutable Storage (Locked)** | WORM garantit intÃ©gritÃ© |


