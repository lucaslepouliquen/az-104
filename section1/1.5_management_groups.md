## 1.5 Management Groups

### Hiérarchie
```
Root Management Group
├── Production MG
│   ├── Prod Subscription 1
│   └── Prod Subscription 2
└── Development MG
    ├── Dev Subscription 1
    └── Test Subscription 1
```

### Limites et Accès

**⚠️ Limites Techniques des Management Groups :**

**Hiérarchie :**
- **6 niveaux** de profondeur maximum (en dessous du root management group)
- **Note** : Le Root Management Group n'est PAS compté dans les 6 niveaux
- **Exemple** : Root â†’ Level 1 â†’ Level 2 â†’ Level 3 â†’ Level 4 â†’ Level 5 â†’ Level 6 (Subscriptions)

**Capacité :**
- **10,000 management groups** maximum par tenant Azure AD
- **Note** : Cette limite inclut tous les management groups (root + enfants)

**Contraintes :**
- ✅ **Une subscription** peut appartenir à **un seul** management group
- ✅ **Un management group** peut avoir **plusieurs** enfants (subscriptions ou MG)
- ✅ **Un management group** ne peut avoir **qu'un seul** parent

**⚠️ Accès au Root Management Group :**
- **Aucun accès par défaut** au root management group
- Seuls les **Global Administrators** peuvent s'élever pour obtenir l'accès
- **Processus** : 
  1. Global Admin â†’ Azure Portal
  2. Azure AD â†’ Properties
  3. "Access management for Azure resources" → Enable
  4. Assign roles au root management group

**⚠️ Délais de Propagation (RBAC et Policies) :**

Ces délais concernent **uniquement** les assignations RBAC et Policy, **PAS les Resource Locks**.

| Type d'assignation | Délai de propagation | Scope |
|-------------------|---------------------|-------|
| **RBAC assignments** | Jusqu'à 10 minutes | Management Groups, Subscriptions, Resource Groups |
| **Policy assignments** | Jusqu'à 30 minutes | Management Groups, Subscriptions, Resource Groups |
| **Resource Locks** | ✅ **Immédiat** | Subscriptions, Resource Groups, Resources |

**⚠️ Important pour l'examen :**
- **Locks** : Effectifs **immédiatement** après création
- **RBAC** : Peut prendre jusqu'à **10 minutes** pour que les permissions soient actives
- **Policies** : Peut prendre jusqu'à **30 minutes** pour évaluation de la conformité

**Référence** : [Azure Management Groups - Limits and recommendations](https://learn.microsoft.com/azure/governance/management-groups/overview)

### Resource Locks

**⚠️ Point d'Attention : Comprendre les Niveaux de Protection des Locks**

**Types de Locks :**

**1. Delete Lock (CanNotDelete)**
- **Protection** : Empêche la suppression de la ressource
- **Permet** : Modifications et lecture de la ressource
- **Usage** : Protection contre suppression accidentelle

**2. Read-Only Lock (ReadOnly)**
- **Protection** : Empêche suppression ET modification
- **Permet** : Lecture seule
- **Usage** : Protection maximale (compliance, audit)

**⚠️ Héritage des Locks - Point Critique pour l'Examen :**

Les locks suivent un principe d'**héritage hiérarchique** :

**Delete Lock sur Resource Group :**
```
Resource Group avec Delete Lock
├── ✅ Empêche suppression du Resource Group lui-même
├── ✅ Empêche AUSSI suppression des ressources enfants (héritage)
└── ✅ PERMET modifications des ressources enfants
```

**Exemple concret :**
```
RG "Production-RG" avec Delete Lock :
✅ Cannot delete the Resource Group
✅ Cannot delete VM1 in Production-RG (inherited)
✅ Cannot delete Storage Account in Production-RG (inherited)
✅ CAN modify/stop VM1
✅ CAN upload/delete blobs in Storage Account
✅ CAN change VM size, add disks, etc.
```

**Hiérarchie d'héritage des Locks :**

| Scope Lock | Impact sur Enfants | Exemple |
|-----------|-------------------|---------|
| **Subscription Lock** | ✅ S'applique à **tous** les Resource Groups et ressources | Lock sur Subscription â†’ Protège toutes les ressources |
| **Resource Group Lock** | ✅ S'applique à **toutes** les ressources du RG | Lock sur RG → Protège toutes les VMs, Storage, etc. |
| **Resource Lock** | ❌ S'applique **uniquement** à cette ressource | Lock sur VM1 → Protège uniquement VM1 |

**⚠️ Piège d'examen classique :**

| Question | Réponse Incorrecte ❌ | Réponse Correcte ✅ |
|----------|----------------------|---------------------|
| "Delete Lock sur RG permet de supprimer les ressources ?" | "Oui, le lock ne concerne que le RG" | "Non, le lock est hérité par toutes les ressources enfants" |
| "Delete Lock sur RG empêche de modifier les VMs ?" | "Oui, tout est bloqué" | "Non, on peut modifier, juste pas supprimer" |
| "Comment supprimer une VM dans un RG avec Delete Lock ?" | "Impossible" | "Retirer le lock du RG d'abord, puis supprimer" |

**⚠️ CLARIFICATION IMPORTANTE : Storage Account Locks**

**Ce que les locks protègent :**
- ✅ **Le Storage Account lui-même** : Ne peut pas être supprimé (Delete Lock)
- ✅ **Les propriétés du compte** : Configuration, SKU, réplication

**Ce que les locks NE protègent PAS :**
- ❌ **Les données DANS le Storage Account** : Blobs, fichiers, tables, queues
- ❌ **Les opérations sur les données** : Upload, modification, suppression de blobs
- ❌ **Les containers/shares** : Peuvent être créés/supprimés

**Exemple concret :**
```
Storage Account avec Delete Lock :
✅ Cannot delete the storage account
❌ CAN delete/modify blobs inside the account
❌ CAN delete containers
❌ CAN upload/overwrite files
```

**Pour protéger les DONNà‰ES dans un Storage Account, utilisez :**

**1. Immutable Storage (WORM - Write Once, Read Many)**

**⚠️ Note** : La syntaxe CLI peut varier selon la version. Vérifiez toujours avec `az storage container immutability-policy --help`

```bash
# Option 1: Créer une politique d'immutabilité time-based (période de rétention)
az storage container immutability-policy create \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --period 365 \
  --account-key <storage-key>

# Option 2: Verrouiller la politique (mode Locked - irréversible)
az storage container immutability-policy lock \
  --account-name mystorageaccount \
  --container-name mycontainer \
  --if-match "<etag>" \
  --account-key <storage-key>

# Option 3: Via Account-level (recommandé pour 2024+)
az storage account blob-service-properties update \
  --account-name mystorageaccount \
  --resource-group myRG \
  --enable-versioning true \
  --default-service-version "2021-06-08"
```

**Modes de politique :**
- **Unlocked** : Test mode, peut être modifié/supprimé
- **Locked** : Production mode, **irréversible**, compliance garantie

**Caractéristiques :**
- ✅ Blobs ne peuvent pas être modifiés ou supprimés pendant la période de rétention
- ✅ Protection contre ransomware et suppression accidentelle
- ✅ Compliance réglementaire (SEC 17a-4(f), FINRA 4511, CFTC, etc.)
- ✅ Legal Hold disponible pour rétention indéfinie

**2. Soft Delete**
```bash
# Activer soft delete pour blobs
az storage account blob-service-properties update \
  --account-name mystorageaccount \
  --enable-delete-retention true \
  --delete-retention-days 30
```
- ✅ Récupération de blobs supprimés (7-365 jours)
- ✅ Protection contre suppression accidentelle
- ✅ Snapshots et versions préservés

**3. Versioning**
```bash
# Activer versioning
az storage account blob-service-properties update \
  --account-name mystorageaccount \
  --enable-versioning true
```
- ✅ Historique complet des versions
- ✅ Récupération de versions précédentes
- ✅ Protection contre écrasement

**Ressources Supportées pour Locks :**
- ✅ **Virtual Machines** : Empêche suppression de la VM
- ✅ **Subscriptions** : Protège toutes les ressources de la souscription
- ✅ **Resource Groups** : Protège le groupe et toutes ses ressources
- ✅ **Storage Accounts** : Protège le compte, PAS les données
- ✅ **Networks, Databases, etc.** : Toutes ressources Azure

**Ressources NON Supportées pour Locks :**
- ❌ **Management Groups** : Cannot add locks to management groups
- ❌ **Data inside resources** : Blobs, SQL rows, files

**Scénarios d'Examen :**

| Besoin | Solution | Raison |
|--------|----------|--------|
| **Empêcher suppression Storage Account** | **Delete Lock** | Protège la ressource |
| **Protéger données (blobs) dans Storage** | **Immutable Storage + Soft Delete** | Locks ne protègent pas les données |
| **Empêcher suppression accidentelle VM** | **Delete Lock** | Protection de la ressource VM |
| **Protection contre ransomware** | **Immutable Storage** | Blobs non modifiables |
| **Compliance réglementaire** | **Immutable Storage (Locked)** | WORM garantit intégrité |

Pour déplacer un App Service qui a un certificat SSL configuré vers un autre resource group : 
Supprimer le certificat SSL de l'App Service
Déplacer l'App Service vers le nouveau Resource Group
Re-upload/reconfigurer le certificat SSL