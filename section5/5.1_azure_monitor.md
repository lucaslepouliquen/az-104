### 5.1 Azure Monitor

#### Architecture et Fonctionnalités
**Azure Monitor** aide à maximiser la disponibilité et les performances des applications et services

- **Data Collection** : Métriques, logs, traces
- **Storage** : Metrics store, Log Analytics workspace
- **Analysis** : KQL queries, workbooks, dashboards
- **Actions** : Alerts, autoscale, automation

**Différenciation des services de monitoring Azure :**

**Azure Monitor**
- **Fonction** : Maximiser disponibilité et performance des applications
- **Capacités** : Collecte de métriques, logs, alertes, dashboards
- **Usage** : Monitoring complet des ressources Azure
- **API** : HTTP Data Collector API pour envoyer logs vers Log Analytics

**Azure Network Watcher**
- **Fonction** : Monitoring et diagnostic réseau
- **Capacités** : 
  - **IP Flow Verify** : Vérifier si NSG autorise/bloque le trafic
  - **NSG Flow Logs** : Logs de trafic réseau
  - **Packet Capture** : Capture de paquets réseau pour troubleshooting
  - **Connection Monitor** : Monitoring continu de la connectivité et latence réseau (Azure + hybrid)
- **Usage** : Troubleshooting connectivité et diagnostic réseau
- **Scope** : Ressources réseau uniquement (VNets, NSGs, VMs)

**⚠️ Erreur Courante QCM : Connection Monitor vs IP Flow Verify**

| Use Case | Outil Correct | Explication |
|----------|---------------|-------------|
| **Analyser latence entre on-premises et Azure VM** | Connection Monitor | Monitoring continu de connectivité, latence, topologie |
| **Vérifier si NSG bloque le trafic** | IP Flow Verify | Test ponctuel de règles NSG (allow/deny) |
| **Diagnostiquer perte de paquets** | Packet Capture | Capture détaillée pour analyse Wireshark |
| **Monitoring performance réseau** | Connection Monitor | Métriques de latence, perte, topologie |

**Connection Monitor - Configuration :**
```bash
# Créer Connection Monitor pour analyser latence on-premises → Azure
az network watcher connection-monitor create \
  --name OnPremToAzureLatency \
  --location eastus \
  --test-group-name LatencyTest \
  --endpoint-source-name OnPremServer \
  --endpoint-source-address 10.0.0.5 \
  --endpoint-dest-name AzureVM \
  --endpoint-dest-resource-id /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM \
  --test-config-name TCPTest \
  --protocol Tcp \
  --tcp-port 443
```

**Azure Resource Manager**
- **Fonction** : Service de déploiement et gestion Azure
- **Capacités** : Déploiement, gestion du cycle de vie, RBAC
- **Usage** : Infrastructure as Code, gestion des ressources
- **Scope** : Pas un outil de monitoring

**Network Security Groups (NSG)**
- **Fonction** : Sécurité réseau (firewall)
- **Capacités** : Règles de filtrage de trafic
- **Usage** : Contrôle d'accès réseau
- **Limitation** : Sécurité uniquement, pas de monitoring

#### Network Watcher - Packet Capture

**⚠️ Concept Important pour l'Examen**

**Use Cases :**
- Diagnostiquer problèmes de connectivité réseau
- Analyser trafic suspect (sécurité)
- Troubleshooting performance réseau
- Identifier paquets perdus ou corrompus

**Prérequis :**
- **Network Watcher extension** installée sur la VM
- **Storage Account** pour stocker les captures
- **RBAC** : Network Contributor ou équivalent

**Configuration via PowerShell :**
```powershell
# Variables
$rg = "myResourceGroup"
$location = "East US"
$storageAccount = "mystorageaccount"
$vm = "myVM"

# Créer Storage Account si nécessaire
New-AzStorageAccount `
  -ResourceGroupName $rg `
  -Name $storageAccount `
  -Location $location `
  -SkuName Standard_LRS

# Obtenir les détails du Storage Account
$storageAccountContext = (Get-AzStorageAccount `
  -ResourceGroupName $rg `
  -Name $storageAccount).Context

# Démarrer Packet Capture
New-AzNetworkWatcherPacketCapture `
  -NetworkWatcherName "NetworkWatcher_$location" `
  -ResourceGroupName "NetworkWatcherRG" `
  -PacketCaptureName "PacketCapture01" `
  -TargetVirtualMachineId /subscriptions/{sub-id}/resourceGroups/$rg/providers/Microsoft.Compute/virtualMachines/$vm `
  -StorageAccountId /subscriptions/{sub-id}/resourceGroups/$rg/providers/Microsoft.Storage/storageAccounts/$storageAccount `
  -TimeLimitInSeconds 60 `
  -Filter @{
    Protocol = "TCP"
    LocalIPAddress = "10.0.0.0-10.0.0.255"
    LocalPort = "80;443"
  }

# Arrêter Packet Capture
Stop-AzNetworkWatcherPacketCapture `
  -NetworkWatcherName "NetworkWatcher_$location" `
  -ResourceGroupName "NetworkWatcherRG" `
  -PacketCaptureName "PacketCapture01"

# Télécharger le fichier .cap pour analyse Wireshark
```

**Analyse avec Wireshark :**
- Télécharger le fichier .cap depuis Storage Account
- Ouvrir avec Wireshark pour analyse détaillée
- Filtres utiles : `tcp.port == 443`, `ip.addr == 10.0.0.5`

#### Cost Management et Budgets

**Configuration des budgets et actions automatiques :**

**Processus d'édition de budget :**
1. **Cost Management + Billing** → **Budgets**
2. **Éditer le budget** associé aux ressources du groupe de ressources
3. **Créer un nouveau Action Group** de type **Runbook**
4. **Choisir "Stop VM"** comme action

**Points clés identifiés :**
- **Cost analysis** : Ne peut pas arrêter automatiquement les VMs
- **Scale Up VM action group** : Non requis pour arrêter les VMs
- **Runbook type** : Obligatoire pour actions d'automatisation
- **Stop VM action** : Action spécifique pour arrêter les machines virtuelles

**Azure Advisor - Cost Optimization :**
- **Cost blade** : Optimisation et réduction des dépenses Azure
- **Identification** : VMs sous-utilisées
- **Performance blade** : Amélioration de la vitesse des applications
- **High availability** : Non disponible via Azure Advisor
- **Operational Excellence** : Efficacité des processus et workflows, gestion des ressources, meilleures pratiques de déploiement

**🎯 Concept clé identifié :** Target Resource pour alertes
- **VM Events/Syslog** → Target = **Log Analytics Workspace**
- **VM Metrics** → Target = **Virtual Machine**
- Les VMs envoient logs vers Log Analytics pour analyse

#### Diagnostic Settings - Collecte de Données de Diagnostic

**⚠️ Erreur Courante QCM : Destinations disponibles pour Diagnostic Settings**

**Vue d'ensemble :**
Les Diagnostic Settings permettent de collecter les **Platform Logs** et **Platform Metrics** des ressources Azure et de les envoyer vers différentes destinations pour analyse, archivage ou intégration.

**Types de données collectées :**
- **Activity Logs** : Opérations sur les ressources (création, suppression, modification)
- **Resource Logs** : Logs internes des ressources (ex: SQL queries, Storage operations)
- **Metrics** : Métriques de performance (CPU, Memory, Network, Storage)

**Destinations Disponibles - Vue Complète :**

| Destination | Use Case | Rétention | Coût | Requiert |
|-------------|----------|-----------|------|----------|
| **Log Analytics Workspace** | Analyse et requêtes KQL | Configurable (30-730 jours) | Ingestion + Rétention | Log Analytics Workspace |
| **Storage Account** | Archivage long terme | Illimitée | Stockage Blob | Storage Account |
| **Event Hub** | Streaming vers outils externes | Temps réel | Throughput | Event Hub Namespace |
| **Partner Solutions** | SIEM tiers (Splunk, Datadog) | Selon partenaire | Selon partenaire | Integration configurée |

**⚠️ Erreur Courante QCM : Application Insights vs Diagnostic Settings**

**Quand utiliser Application Insights :**
- ✅ **Applications web/API** : App Service, Azure Functions
- ✅ **APM** : Tracing distribué, dependencies, performance
- ✅ **Custom telemetry** : Custom events, metrics applicatifs
- ✅ **User behavior** : Page views, user sessions

**Quand utiliser Diagnostic Settings (Resource Logs) :**
- ✅ **Ressources infrastructure** : IoT Hub, Storage, NSG, VMs
- ✅ **Platform logs** : Activity logs, resource logs
- ✅ **Device telemetry** : IoT Hub telemetry from devices
- ✅ **Conformité/Audit** : Archivage logs long terme

**Exemple QCM - IoT Hub :**
❌ **INCORRECTE** : "Use Application Insights with the LOB application" pour monitorer device telemetry
✅ **CORRECTE** : "Enable Azure Monitor resource diagnostics logs on the IoT Hub"

**Explication :**
- Application Insights est pour **application performance monitoring**
- IoT Hub telemetry se collecte via **Diagnostic Settings** → Log Analytics
- Les données devices sont des **resource logs**, pas des logs applicatifs

**1. Log Analytics Workspace - Analyse et Alertes**

**⚠️ Destination PRINCIPALE pour l'examen AZ-104**

**Use Cases :**
- **Analyse avec KQL** : Requêtes complexes sur logs
- **Alertes** : Créer alertes basées sur logs
- **Dashboards** : Visualisations Azure Monitor
- **Workbooks** : Rapports interactifs
- **Insights** : VM Insights, Container Insights, Application Insights

**Configuration via Azure CLI :**
```bash
# Créer un Log Analytics Workspace
az monitor log-analytics workspace create \
  --resource-group myRG \
  --workspace-name myWorkspace \
  --location eastus \
  --retention-time 90

# Configurer Diagnostic Settings pour une VM
az monitor diagnostic-settings create \
  --name VMDiagnostics \
  --resource /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM \
  --workspace /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.OperationalInsights/workspaces/myWorkspace \
  --logs '[{"category":"Administrative","enabled":true},{"category":"Security","enabled":true}]' \
  --metrics '[{"category":"AllMetrics","enabled":true}]'
```

**Configuration via PowerShell :**
```powershell
# Créer Log Analytics Workspace
New-AzOperationalInsightsWorkspace `
  -ResourceGroupName "myRG" `
  -Name "myWorkspace" `
  -Location "East US" `
  -Sku "PerGB2018" `
  -RetentionInDays 90

# Configurer Diagnostic Settings pour Storage Account
$storageAccount = Get-AzStorageAccount -ResourceGroupName "myRG" -Name "mystorageaccount"
$workspace = Get-AzOperationalInsightsWorkspace -ResourceGroupName "myRG" -Name "myWorkspace"

Set-AzDiagnosticSetting `
  -ResourceId $storageAccount.Id `
  -Name "StorageDiagnostics" `
  -WorkspaceId $workspace.ResourceId `
  -Enabled $true `
  -Category @("StorageWrite", "StorageRead", "StorageDelete")
```

**Requêtes KQL Utiles :**
```kusto
// Toutes les opérations de write sur Storage Account
StorageBlobLogs
| where OperationName == "PutBlob"
| project TimeGenerated, AccountName, Uri, StatusCode, CallerIpAddress

// VMs avec CPU > 80%
Perf
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| where CounterValue > 80
| summarize avg(CounterValue) by Computer, bin(TimeGenerated, 5m)

// Activité administrative
AzureActivity
| where OperationNameValue contains "Microsoft.Compute/virtualMachines"
| where ActivityStatusValue == "Success"
| project TimeGenerated, Caller, OperationNameValue, ResourceGroup
```

**Limites et Coûts :**
- **Ingestion** : ~$2.50/GB (peut varier selon engagement)
- **Rétention** : Incluse jusqu'à 31 jours, puis ~$0.12/GB/mois
- **Requêtes** : Gratuites (incluses)
- **Alertes** : Coût selon fréquence d'évaluation

#### Log Analytics Dashboards - Limitations

**⚠️ Erreur Courante QCM : Limitations des Charts**

**Limitations des Charts dans Log Analytics :**

| Limitation | Valeur | Explication |
|------------|--------|-------------|
| **Colonnes** | Maximum 4 colonnes | Chart affiche jusqu'à 4 colonnes de données |
| **Lignes (rows)** | Top 7 rows | Chart affiche les 7 premières lignes après tri |
| **Format données** | Tabular uniquement | Render operator spécifié dans KQL |
| **Types supportés** | Plusieurs formats | timechart, columnchart, piechart, barchart, etc. |

**❌ ERREUR COURANTE :**
"Data displayed in the chart is limited to no more than 10 rows"

**✅ CORRECT :**
"Data displayed in the chart is limited to up to **four columns** and the **top seven rows**"

**Exemples avec Limitations :**
```kusto
// Ce chart affichera uniquement 4 colonnes et top 7 rows
AzureActivity
| summarize Count = count() by ResourceProvider, OperationNameValue, Caller, ResourceGroup
| top 7 by Count desc
| render columnchart

// Workaround : Agréger données pour limiter colonnes
AzureActivity
| summarize Count = count() by ResourceProvider
| top 7 by Count desc
| render barchart
```

**Best Practices - Dashboards :**
- ✅ Limiter à 4 colonnes max dans les requêtes
- ✅ Utiliser `top N` pour contrôler le nombre de rows
- ✅ Agréger données pour simplifier visualisations
- ✅ Utiliser workbooks pour visualisations complexes
- ❌ Éviter charts avec trop de dimensions

**2. Storage Account - Archivage Long Terme**

**Use Cases :**
- **Archivage** : Logs pour conformité (1-10 ans)
- **Audit** : Historique complet pour forensic
- **Coût réduit** : Alternative économique à Log Analytics
- **Backup logs** : Logs de sauvegarde et restauration

**Configuration via Azure CLI :**
```bash
# Configurer Diagnostic Settings vers Storage Account
az monitor diagnostic-settings create \
  --name VMDiagToStorage \
  --resource /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM \
  --storage-account /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Storage/storageAccounts/mystorageaccount \
  --logs '[{"category":"Administrative","enabled":true,"retentionPolicy":{"enabled":true,"days":365}}]' \
  --metrics '[{"category":"AllMetrics","enabled":true,"retentionPolicy":{"enabled":true,"days":90}}]'
```

**Structure de Stockage :**
```
mystorageaccount
├── insights-logs-administrative/
│   ├── resourceId=/SUBSCRIPTIONS/{sub-id}/RESOURCEGROUPS/{rg}/PROVIDERS/{provider}/{resource}
│   │   ├── y=2025/m=10/d=27/h=12/m=00/
│   │   │   └── PT1H.json
```

**Format des Logs (JSON) :**
```json
{
  "time": "2025-10-27T12:00:00.000Z",
  "resourceId": "/subscriptions/.../resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM",
  "category": "Administrative",
  "operationName": "Microsoft.Compute/virtualMachines/write",
  "resultType": "Success",
  "callerIpAddress": "203.0.113.50",
  "identity": {
    "authorization": {
      "action": "Microsoft.Compute/virtualMachines/write",
      "scope": "/subscriptions/.../resourceGroups/myRG"
    }
  }
}
```

**Lifecycle Management :**
```bash
# Créer lifecycle policy pour archiver après 90 jours
az storage account management-policy create \
  --account-name mystorageaccount \
  --resource-group myRG \
  --policy '{
    "rules": [{
      "name": "ArchiveLogs",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": ["blockBlob"],
          "prefixMatch": ["insights-logs-"]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": {"daysAfterModificationGreaterThan": 30},
            "tierToArchive": {"daysAfterModificationGreaterThan": 90}
          }
        }
      }
    }]
  }'
```

**Limites :**
- **Analyse** : Pas de requêtes KQL (nécessite téléchargement)
- **Alertes** : Pas d'alertes en temps réel
- **Coût** : ~$0.02/GB/mois (Hot), ~$0.01/GB/mois (Cool), ~$0.002/GB/mois (Archive)

**3. Event Hub - Streaming en Temps Réel**

**Use Cases :**
- **SIEM Integration** : Splunk, QRadar, ArcSight
- **Custom Processing** : Azure Functions, Stream Analytics
- **Multi-destination** : Plusieurs consommateurs en parallèle
- **Near real-time** : Latence < 1 minute

**Configuration via Azure CLI :**
```bash
# Créer Event Hub Namespace
az eventhubs namespace create \
  --resource-group myRG \
  --name myEventHubNS \
  --location eastus \
  --sku Standard

# Créer Event Hub
az eventhubs eventhub create \
  --resource-group myRG \
  --namespace-name myEventHubNS \
  --name diagnostics-hub \
  --partition-count 4 \
  --message-retention 7

# Configurer Diagnostic Settings vers Event Hub
az monitor diagnostic-settings create \
  --name VMDiagToEventHub \
  --resource /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM \
  --event-hub myEventHubNS \
  --event-hub-rule /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.EventHub/namespaces/myEventHubNS/authorizationRules/RootManageSharedAccessKey \
  --logs '[{"category":"Administrative","enabled":true}]' \
  --metrics '[{"category":"AllMetrics","enabled":true}]'
```

**Consumer Example (Azure Function) :**
```csharp
[FunctionName("ProcessDiagnosticLogs")]
public static async Task Run(
    [EventHubTrigger("diagnostics-hub", Connection = "EventHubConnection")] EventData[] events,
    ILogger log)
{
    foreach (var eventData in events)
    {
        string messageBody = Encoding.UTF8.GetString(eventData.Body.Array);
        var logEntry = JsonConvert.DeserializeObject<DiagnosticLog>(messageBody);
        
        // Custom processing
        if (logEntry.Category == "Security" && logEntry.ResultType == "Failure")
        {
            await SendAlertToSlack(logEntry);
        }
    }
}
```

**Limites et Coûts :**
- **Throughput** : 1 MB/s par partition (Standard), 20 MB/s (Premium)
- **Rétention** : 1-7 jours (Standard), jusqu'à 90 jours (Premium)
- **Coût** : ~$0.028/million events + $11/throughput unit/mois

**4. Partner Solutions - SIEM Tiers**

**⚠️ Note Importante :** Les Partner Solutions (Datadog, Elastic, Splunk) s'intègrent généralement via **Event Hub** comme intermédiaire ou via des ressources Azure natives spécifiques (ex: `Microsoft.Datadog/monitors`), plutôt que directement via Diagnostic Settings standard.

**Partenaires Disponibles :**
- **Datadog** : APM et infrastructure monitoring
- **Elastic (Elasticsearch)** : Search, analytics, visualization
- **LogRhythm** : SIEM et threat detection
- **Splunk** : Enterprise SIEM
- **Sumo Logic** : Cloud-native SIEM

**Configuration Recommandée - Via Event Hub :**
```bash
# Créer Event Hub pour intégration SIEM
az eventhubs namespace create \
  --resource-group myRG \
  --name mySIEMEventHub \
  --location eastus \
  --sku Standard

az eventhubs eventhub create \
  --resource-group myRG \
  --namespace-name mySIEMEventHub \
  --name diagnostics-to-siem

# Configurer Diagnostic Settings vers Event Hub
az monitor diagnostic-settings create \
  --name VMDiagToSIEM \
  --resource /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM \
  --event-hub mySIEMEventHub \
  --event-hub-rule /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.EventHub/namespaces/mySIEMEventHub/authorizationRules/RootManageSharedAccessKey \
  --logs '[{"category":"Administrative","enabled":true}]' \
  --metrics '[{"category":"AllMetrics","enabled":true}]'

# Configurer le SIEM pour consommer depuis Event Hub
```

**Configuration Alternative - Ressources Natives (Datadog Example) :**
```bash
# Créer ressource Datadog dans Azure
az datadog monitor create \
  --resource-group myRG \
  --name myDatadogMonitor \
  --location eastus \
  --sku-name "Linked"

# L'intégration se configure ensuite dans le portail Datadog
```

**Avantages :**
- **Corrélation multi-cloud** : Logs Azure + AWS + GCP
- **Threat intelligence** : Détection avancée de menaces
- **Compliance** : Rapports de conformité pré-configurés
- **Expertise** : Support spécialisé SIEM

**Configuration Multi-Destinations**

**⚠️ Point Important pour l'Examen :**
Une ressource peut avoir **plusieurs Diagnostic Settings** envoyant vers **différentes destinations simultanément**.

**Exemple - Architecture Complète :**
```bash
# Diagnostic Setting 1 : Analyse temps réel
az monitor diagnostic-settings create \
  --name RealTimeAnalytics \
  --resource $vmId \
  --workspace $logAnalyticsId \
  --logs '[{"category":"Administrative","enabled":true}]'

# Diagnostic Setting 2 : Archivage long terme
az monitor diagnostic-settings create \
  --name LongTermArchive \
  --resource $vmId \
  --storage-account $storageAccountId \
  --logs '[{"category":"Administrative","enabled":true,"retentionPolicy":{"enabled":true,"days":2555}}]'

# Diagnostic Setting 3 : Streaming vers SIEM
az monitor diagnostic-settings create \
  --name SIEMIntegration \
  --resource $vmId \
  --event-hub $eventHubNSId \
  --logs '[{"category":"Security","enabled":true}]'
```

**Architecture Typique - DevOps :**
```
Azure Resource (VM, Storage, NSG, etc.)
├── Diagnostic Setting 1 → Log Analytics Workspace
│   ├── Requêtes KQL
│   ├── Alertes temps réel
│   └── Dashboards Azure Monitor
│
├── Diagnostic Setting 2 → Storage Account
│   ├── Archivage 7 ans (conformité)
│   ├── Lifecycle policy (Cool → Archive)
│   └── Backup des logs
│
├── Diagnostic Setting 3 → Event Hub
│   ├── Azure Function (processing custom)
│   ├── Stream Analytics
│   └── Splunk/Datadog Integration
│
└── Diagnostic Setting 4 → Partner Solution (Datadog)
    ├── APM
    ├── Infrastructure monitoring
    └── Multi-cloud correlation
```

**Scénarios d'Examen - Diagnostic Settings**

| Besoin | Destination | Raison |
|--------|-------------|--------|
| **Créer alertes sur logs VM** | Log Analytics Workspace | Permet requêtes KQL et alertes |
| **Archiver logs 5 ans pour audit** | Storage Account | Coût faible, rétention illimitée |
| **Envoyer logs vers Splunk** | Event Hub OU Partner Solution | Streaming temps réel ou intégration native |
| **Analyser activité administrative** | Log Analytics Workspace | Requêtes et dashboards |
| **Conformité RGPD (7 ans logs)** | Storage Account | Archivage long terme économique |
| **Multi-cloud SIEM** | Partner Solution (Datadog, Splunk) | Corrélation Azure + AWS + on-prem |
| **Monitorer IoT Hub device telemetry** | Log Analytics Workspace via Diagnostic Settings | ❌ PAS Application Insights |

**Catégories de Logs Disponibles par Type de Ressource**

**Virtual Machines :**
- Performance counters (métriques CPU, Memory, Disk, Network)
- Event logs (Windows) / Syslog (Linux)
- IIS logs (si IIS installé)
- Nécessite **VM agent** ou **Azure Monitor Agent**

**Storage Account :**
- StorageRead, StorageWrite, StorageDelete
- Transaction logs (blob, file, queue, table)
- Metrics (availability, latency, capacity)

**Network Security Group (NSG) :**
- NSG Flow Logs (version 1 ou 2)
- Network Watcher requis
- **Destinations disponibles** :
  - **Storage Account** : Archivage des logs (méthode traditionnelle)
  - **Log Analytics Workspace** : Envoi direct sans Storage Account (depuis 2023)
  - **Storage Account + Log Analytics** : Combinaison pour archivage + analyse

**Azure SQL Database :**
- SQLInsights, QueryStoreRuntimeStatistics
- Errors, Timeouts, Deadlocks
- Automatic tuning, Intelligent insights

**App Service :**
- AppServiceHTTPLogs, AppServiceConsoleLogs
- AppServiceAppLogs, AppServiceAuditLogs
- AppServicePlatformLogs

**IoT Hub :**
- Connections, DeviceTelemetry, C2DCommands
- DeviceIdentityOperations, FileUploadOperations
- Routes, D2CTwinOperations
- **⚠️ Important** : Utiliser Diagnostic Settings, PAS Application Insights

**Best Practices - Diagnostic Settings**

✅ **À FAIRE :**
- **Log Analytics** pour toutes les ressources critiques (analyse + alertes)
- **Storage Account** pour archivage conformité (LRS ou GRS selon criticité)
- **Rétention appropriée** : 90 jours Log Analytics, 7 ans Storage
- **Multi-destinations** : Log Analytics (analyse) + Storage (archive)
- **Catégories sélectives** : N'activer que logs nécessaires (coûts)
- **Lifecycle policies** : Archiver logs anciens (Cool/Archive tier)
- **RBAC strict** : Limiter accès aux logs sensibles

❌ **À ÉVITER :**
- Activer tous les logs sans distinction (coûts élevés)
- Oublier la rétention (défaut = 30 jours Log Analytics)
- Storage Account sans lifecycle policy (coûts croissants)
- Event Hub pour archivage (rétention limitée)
- Multiple Diagnostic Settings avec mêmes logs (duplication coûts)
- **Application Insights pour ressources infrastructure** (IoT Hub, Storage)

**PowerShell - Gestion Complète :**
```powershell
# Lister Diagnostic Settings d'une ressource
Get-AzDiagnosticSetting -ResourceId $vmId

# Supprimer un Diagnostic Setting
Remove-AzDiagnosticSetting `
  -ResourceId $vmId `
  -Name "VMDiagnostics"

# Exporter configuration Diagnostic Settings
Get-AzDiagnosticSetting -ResourceId $vmId |
  ConvertTo-Json -Depth 10 |
  Out-File "diagnostic-settings-backup.json"
```

**Troubleshooting Diagnostic Settings**

| Problème | Cause Possible | Solution |
|----------|----------------|----------|
| Logs n'arrivent pas dans Log Analytics | Agent non installé (VM) | Installer Azure Monitor Agent |
| Storage Account ne reçoit pas de logs | Permissions insuffisantes | Vérifier RBAC (Monitoring Contributor) |
| Event Hub sans données | Authorization rule incorrecte | Utiliser RootManageSharedAccessKey |
| Coûts élevés | Tous les logs activés | Sélectionner catégories pertinentes uniquement |
| Rétention trop courte | Défaut 30 jours | Configurer rétention 90-730 jours |
| IoT telemetry non collectée | Application Insights utilisé | Utiliser Diagnostic Settings → Log Analytics |

#### Types d'Alertes

**Metric Alerts**
- **Seuils numériques** : CPU > 80%
- **Near real-time** : Évaluation fréquente
- **Multiple dimensions** : Filtrage par propriétés

**Log Alerts**
- **KQL queries** : Requêtes sur logs
- **Example** : `Event | search "error"`
- **Flexibility** : Logique complexe possible

**Activity Log Alerts**
- **Administrative events** : Création/suppression ressources
- **Service Health** : Incidents Azure
- **Resource Health** : État des ressources

#### Requêtes KQL Essentielles
```kusto
// Rechercher dans une table spécifique
Event | search "error"

// Compter par computer
Event | summarize count() by Computer

// Filtrer par niveau
Event | where EventLevelName == "Error"

// Timeline des événements
Event | where TimeGenerated > ago(1h) | sort by TimeGenerated desc
```

#### Action Groups - Notifications et Actions Automatiques

**⚠️ Concept Important pour l'Examen**

Les **Action Groups** définissent les actions à exécuter lorsqu'une alerte est déclenchée.

**Types d'Actions Disponibles :**

| Type | Description | Use Case |
|------|-------------|----------|
| **Email/SMS/Push/Voice** | Notifications aux personnes | Alertes critiques équipe DevOps |
| **Azure Function** | Exécution code serverless | Processing custom, enrichissement données |
| **Logic App** | Workflows complexes | Intégration ServiceNow, Jira, Teams |
| **Webhook** | Appel HTTP endpoint | Intégration systèmes externes |
| **Automation Runbook** | Scripts PowerShell/Python | Remediation automatique (restart VM) |
| **ITSM** | Incident management | ServiceNow, BMC Remedy |
| **Event Hub** | Streaming événements | Archivage, processing en masse |
| **Secure Webhook** | Webhook avec authentification Azure AD | Sécurité renforcée |

**Configuration via Azure CLI :**
```bash
# Créer Action Group avec email et runbook
az monitor action-group create \
  --name CriticalAlerts \
  --resource-group myRG \
  --short-name CritAlerts \
  --email-receiver admin email=admin@contoso.com \
  --automation-runbook name=StopVM \
    runbookName=Stop-AzureVM \
    webhookResourceId=/subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Automation/automationAccounts/myAutomation/webhooks/stopvm \
    serviceUri=https://s1events.azure-automation.net/webhooks?token=...
```

**Configuration via PowerShell :**
```powershell
# Email Receiver
$emailReceiver = New-AzActionGroupReceiver `
  -Name "AdminEmail" `
  -EmailReceiver `
  -EmailAddress "admin@contoso.com"

# Runbook Receiver pour auto-remediation
$runbookReceiver = New-AzActionGroupReceiver `
  -Name "StopVMRunbook" `
  -AutomationRunbookReceiver `
  -AutomationAccountId "/subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Automation/automationAccounts/myAutomation" `
  -RunbookName "Stop-AzureVM" `
  -WebhookResourceId "/subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Automation/automationAccounts/myAutomation/webhooks/stopvm" `
  -IsGlobalRunbook $false `
  -ServiceUri "https://s1events.azure-automation.net/webhooks?token=..." `
  -UseCommonAlertSchema $true

# Créer Action Group
Set-AzActionGroup `
  -Name "CriticalAlerts" `
  -ResourceGroupName "myRG" `
  -ShortName "CritAlerts" `
  -Receiver $emailReceiver, $runbookReceiver
```

**Common Alert Schema :**
```json
{
  "schemaId": "azureMonitorCommonAlertSchema",
  "data": {
    "essentials": {
      "alertId": "/subscriptions/{sub-id}/providers/Microsoft.AlertsManagement/alerts/{alert-id}",
      "alertRule": "CPU > 80%",
      "severity": "Sev2",
      "signalType": "Metric",
      "monitorCondition": "Fired",
      "monitoringService": "Platform",
      "alertTargetIDs": ["/subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM"],
      "originAlertId": "{guid}",
      "firedDateTime": "2025-10-30T10:00:00.000Z",
      "description": "CPU usage exceeded 80%"
    },
    "alertContext": {
      "properties": null,
      "conditionType": "SingleResourceMultipleMetricCriteria",
      "condition": {
        "allOf": [
          {
            "metricName": "Percentage CPU",
            "metricValue": 85.5,
            "threshold": 80,
            "operator": "GreaterThan",
            "timeAggregation": "Average"
          }
        ]
      }
    }
  }
}
```

**Best Practices - Action Groups :**
✅ **À FAIRE :**
- Un Action Group par criticité (Critical, Warning, Info)
- Common Alert Schema pour uniformité
- Runbooks pour auto-remediation (restart services, scale out)
- Email pour notifications humaines
- ITSM pour tracking incidents
- Tester régulièrement les Action Groups

❌ **À ÉVITER :**
- Trop de notifications (alert fatigue)
- Actions destructives sans confirmation
- Webhooks non sécurisés pour données sensibles

#### Azure Monitor Alerts - Rate Limiting

**⚠️ Information Critique pour l'Examen AZ-104**

**Limites par Action Group et par Destination :**

| Type d'Action | Limite par Heure | Délai Minimum | Scope |
|---------------|------------------|---------------|-------|
| **Email** | 100 emails | Aucun | Par adresse email |
| **SMS** | 12 SMS | 1 toutes les 5 minutes | Par numéro de téléphone |
| **Voice** | 12 appels | 1 toutes les 5 minutes | Par numéro de téléphone |
| **Webhook** | 100 appels | Timeout 10s | Par Action Group |
| **Azure mobile app push** | 100 notifications | Aucun | Par Action Group |
| **Logic Apps / Azure Functions / Automation Runbook** | 100 appels | Aucun | Par Action Group |

**Points Clés pour l'Examen :**

✅ **Email et Webhook** ont les limites les plus élevées (100/h)
✅ **SMS et Voice** sont les plus restrictifs (12/h = 1 toutes les 5 min)
✅ Ces limites s'appliquent **par Action Group**
✅ Il existe aussi une **limite globale par subscription** : 1000 email actions/heure

**⚠️ Erreur Courante QCM : Rate Limiting Scope**

**Par adresse email/numéro** (rate limiting) :
- Email : 100/heure **par adresse email** (même si plusieurs subscriptions)
- SMS : 12/heure **par numéro de téléphone** (même si plusieurs subscriptions)
- Voice : 12/heure **par numéro de téléphone** (même si plusieurs subscriptions)

**Par subscription** :
- Total email actions : 1000/heure pour toute la subscription
- Nombre d'Action Groups : Illimité par subscription

**Exemple Scénario Examen :**

**Situation :**
- Alert1 se déclenche 60 fois par heure
- Action Group avec Email + SMS configurés

**Questions typiques :**
1. Combien d'emails seront envoyés ? **Réponse : 60** (sous la limite de 100)
2. Combien de SMS seront envoyés ? **Réponse : 12** (limité à 1 toutes les 5 min)

**Calcul SMS/Voice :**
- 60 minutes / 5 minutes = 12 notifications maximum par heure

**Configuration pour Éviter Rate Limiting :**
```bash
# Utiliser plusieurs destinations pour répartir les notifications
az monitor action-group create \
  --name HighVolumeAlerts \
  --resource-group myRG \
  --short-name HVAlerts \
  --email-receiver admin1 email=admin1@contoso.com \
  --email-receiver admin2 email=admin2@contoso.com \
  --webhook-receiver webhook1 \
    service-uri=https://myservice.com/webhook \
  --azure-app-push-receiver mobile \
    email-address=mobile@contoso.com
```

**Notification de Rate Limiting :**
Quand une adresse email est rate limited, une notification est envoyée pour communiquer :
- Que le rate limiting a été appliqué
- Quand le rate limiting expire

#### Azure Monitor Agents - Collecte de Données VM

**⚠️ Important pour l'Examen AZ-104**

**Types d'Agents Disponibles :**

| Agent | Plateformes | Use Case | Status |
|-------|-------------|----------|--------|
| **Azure Monitor Agent (AMA)** | Windows, Linux | Agent unifié recommandé | ✅ Recommandé |
| **Log Analytics Agent (MMA/OMS)** | Windows, Linux | Legacy, toujours supporté | ⚠️ Deprecated 2024 |
| **Diagnostics Extension (WAD/LAD)** | Windows, Linux | Métriques vers Storage Account | Legacy |
| **Telegraf Agent** | Linux | Métriques custom | Spécialisé |
| **Dependency Agent** | Windows, Linux | Service Map, VM Insights | Complémentaire |

**Azure Monitor Agent (AMA) - Configuration**

**⚠️ Agent Recommandé pour Nouvelles Implémentations**

**Installation via Azure CLI :**
```bash
# Installer AMA sur VM Windows
az vm extension set \
  --resource-group myRG \
  --vm-name myWindowsVM \
  --name AzureMonitorWindowsAgent \
  --publisher Microsoft.Azure.Monitor \
  --enable-auto-upgrade true

# Installer AMA sur VM Linux
az vm extension set \
  --resource-group myRG \
  --vm-name myLinuxVM \
  --name AzureMonitorLinuxAgent \
  --publisher Microsoft.Azure.Monitor \
  --enable-auto-upgrade true
```

**Installation via PowerShell :**
```powershell
# Windows VM
Set-AzVMExtension `
  -ResourceGroupName "myRG" `
  -VMName "myWindowsVM" `
  -Name "AzureMonitorWindowsAgent" `
  -Publisher "Microsoft.Azure.Monitor" `
  -ExtensionType "AzureMonitorWindowsAgent" `
  -TypeHandlerVersion "1.0" `
  -Location "East US" `
  -EnableAutomaticUpgrade $true

# Linux VM
Set-AzVMExtension `
  -ResourceGroupName "myRG" `
  -VMName "myLinuxVM" `
  -Name "AzureMonitorLinuxAgent" `
  -Publisher "Microsoft.Azure.Monitor" `
  -ExtensionType "AzureMonitorLinuxAgent" `
  -TypeHandlerVersion "1.0" `
  -Location "East US" `
  -EnableAutomaticUpgrade $true
```

**Data Collection Rules (DCR) - Configuration de Collecte**

**⚠️ DCR obligatoires avec Azure Monitor Agent**

```bash
# Créer Data Collection Rule
az monitor data-collection rule create \
  --name myDCR \
  --resource-group myRG \
  --location eastus \
  --rule-file dcr-config.json

# Associer DCR à une VM
az monitor data-collection rule association create \
  --name myDCRAssociation \
  --rule-id /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Insights/dataCollectionRules/myDCR \
  --resource /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/virtualMachines/myVM
```

**Exemple DCR JSON :**
```json
{
  "location": "eastus",
  "properties": {
    "dataSources": {
      "performanceCounters": [
        {
          "name": "perfCounterDataSource",
          "streams": ["Microsoft-Perf"],
          "samplingFrequencyInSeconds": 60,
          "counterSpecifiers": [
            "\\Processor(_Total)\\% Processor Time",
            "\\Memory\\Available Bytes",
            "\\LogicalDisk(_Total)\\% Free Space"
          ]
        }
      ],
      "windowsEventLogs": [
        {
          "name": "eventLogsDataSource",
          "streams": ["Microsoft-Event"],
          "xPathQueries": [
            "Application!*[System[(Level=1 or Level=2 or Level=3)]]",
            "System!*[System[(Level=1 or Level=2 or Level=3)]]"
          ]
        }
      ],
      "syslog": [
        {
          "name": "syslogDataSource",
          "streams": ["Microsoft-Syslog"],
          "facilityNames": ["auth", "authpriv", "cron", "daemon", "kern"],
          "logLevels": ["Debug", "Info", "Notice", "Warning", "Error", "Critical", "Alert", "Emergency"]
        }
      ]
    },
    "destinations": {
      "logAnalytics": [
        {
          "workspaceResourceId": "/subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.OperationalInsights/workspaces/myWorkspace",
          "name": "centralWorkspace"
        }
      ]
    },
    "dataFlows": [
      {
        "streams": ["Microsoft-Perf", "Microsoft-Event", "Microsoft-Syslog"],
        "destinations": ["centralWorkspace"]
      }
    ]
  }
}
```

**Avantages Azure Monitor Agent vs Legacy :**
- ✅ **Data Collection Rules (DCR)** : Configuration centralisée et réutilisable
- ✅ **Multi-homing amélioré** : Plusieurs workspaces facilement
- ✅ **Filtering** : Filtrage données avant envoi (économies)
- ✅ **Security** : Managed Identity support
- ✅ **Performance** : Meilleure efficacité réseau

**Migration MMA → AMA :**
```powershell
# Vérifier si MMA installé
Get-AzVMExtension -ResourceGroupName "myRG" -VMName "myVM" |
  Where-Object {$_.ExtensionType -eq "MicrosoftMonitoringAgent"}

# Installer AMA
Set-AzVMExtension `
  -ResourceGroupName "myRG" `
  -VMName "myVM" `
  -Name "AzureMonitorWindowsAgent" `
  -Publisher "Microsoft.Azure.Monitor" `
  -ExtensionType "AzureMonitorWindowsAgent" `
  -TypeHandlerVersion "1.0"

# Créer et associer DCR (voir exemple ci-dessus)

# Désinstaller MMA après validation
Remove-AzVMExtension `
  -ResourceGroupName "myRG" `
  -VMName "myVM" `
  -Name "MicrosoftMonitoringAgent" `
  -Force
```

#### VM Insights - Monitoring Avancé des VMs

**⚠️ Fonctionnalité Importante pour l'Examen**

VM Insights fournit un monitoring complet des VMs avec métriques de performance, dépendances d'applications et health monitoring.

**Composants Requis :**
1. **Azure Monitor Agent (AMA)** - Recommandé
   - **Avec AMA moderne** : Dependency Agent intégré (pas d'extension séparée nécessaire)
   - **Avec Log Analytics Agent (Legacy)** : Dependency Agent requis comme extension séparée
2. **Log Analytics Workspace**
3. **Data Collection Rule (DCR)** - Si utilisation d'AMA

**⚠️ Note Importante :** Avec Azure Monitor Agent moderne, les fonctionnalités de dépendances (Service Map) sont intégrées directement. L'extension Dependency Agent séparée n'est requise que si vous utilisez encore le Legacy Log Analytics Agent (MMA/OMS).

**Activation via Portal :**
1. VM → **Monitoring** → **Insights**
2. **Enable**
3. Choisir **Log Analytics Workspace**
4. Configuration automatique des agents

**Activation via PowerShell :**
```powershell
# Installer VM Insights avec Azure Monitor Agent
Install-Module -Name Az.MonitoringSolutions

# Enable VM Insights
Set-AzVMExtension `
  -ResourceGroupName "myRG" `
  -VMName "myVM" `
  -Name "DependencyAgentWindows" `
  -Publisher "Microsoft.Azure.Monitoring.DependencyAgent" `
  -ExtensionType "DependencyAgentWindows" `
  -TypeHandlerVersion "9.10"

# Configurer Log Analytics Workspace
$workspace = Get-AzOperationalInsightsWorkspace `
  -ResourceGroupName "myRG" `
  -Name "myWorkspace"

# Activer VM Insights solution
Set-AzOperationalInsightsIntelligencePack `
  -ResourceGroupName "myRG" `
  -WorkspaceName "myWorkspace" `
  -IntelligencePackName "VMInsights" `
  -Enabled $true
```

**Métriques Collectées :**
- **Performance** : CPU, Memory, Disk, Network
- **Processes** : Processus running et connexions
- **Dependencies** : Connexions réseau entre VMs et services externes
- **Logical Disk** : Space, IOPS, throughput
- **Network Adapter** : Bytes sent/received, packets

**Requêtes KQL - VM Insights :**
```kusto
// Top 10 VMs par utilisation CPU
InsightsMetrics
| where Namespace == "Processor" and Name == "UtilizationPercentage"
| summarize avg(Val) by Computer
| top 10 by avg_Val desc

// Connexions réseau actives
VMConnection
| where TimeGenerated > ago(1h)
| summarize count() by Computer, RemoteIp, Direction
| order by count_ desc

// Processus consommant le plus de mémoire
VMProcess
| where TimeGenerated > ago(1h)
| summarize avg(WorkingSetMemory) by ProcessName, Computer
| top 10 by avg_WorkingSetMemory desc

// Services Map - Dépendances
VMBoundPort
| where TimeGenerated > ago(24h)
| where Machine == "myVM"
| summarize count() by Port, ProcessName
| order by count_ desc
```

**Service Map - Visualisation des Dépendances :**
- **Inbound connections** : Clients se connectant à la VM
- **Outbound connections** : Services externes utilisés
- **Ports** : Ports d'écoute et connexions actives
- **Failed connections** : Tentatives de connexion échouées

**Use Cases VM Insights :**
- 🔍 **Troubleshooting performance** : Identifier bottlenecks CPU/Memory/Disk
- 🗺️ **Application mapping** : Comprendre architecture et dépendances
- 📊 **Capacity planning** : Dimensionnement VMs
- 🚨 **Alerting** : Alertes sur seuils performance
- 🔒 **Security** : Détecter connexions non autorisées

#### Application Insights - APM pour Applications

**⚠️ Pour l'Examen : Application Insights fait partie d'Azure Monitor**

**Types d'Applications Supportées :**
- .NET, .NET Core, Java, Node.js, Python, JavaScript
- App Service, Azure Functions, VMs, On-premises, Kubernetes

**⚠️ Erreur Courante : Quand NE PAS utiliser Application Insights**
- ❌ **IoT Hub device telemetry** : Utiliser Diagnostic Settings
- ❌ **Ressources infrastructure** : Storage, NSG, VMs logs
- ❌ **Platform logs** : Activity logs, resource logs
- ✅ **Applications web/API** : App Service, Azure Functions
- ✅ **Custom telemetry** : Events, metrics applicatifs

**Installation - App Service :**
```bash
# Activer Application Insights sur App Service
az webapp config appsettings set \
  --resource-group myRG \
  --name myWebApp \
  --settings APPINSIGHTS_INSTRUMENTATIONKEY={instrumentation-key}

# Ou via connection string (recommandé)
az webapp config appsettings set \
  --resource-group myRG \
  --name myWebApp \
  --settings APPLICATIONINSIGHTS_CONNECTION_STRING="InstrumentationKey={key};IngestionEndpoint=https://eastus-8.in.applicationinsights.azure.com/"
```

**Installation - .NET Application :**
```bash
# NuGet package
dotnet add package Microsoft.ApplicationInsights.AspNetCore
```

**Configuration - appsettings.json :**
```json
{
  "ApplicationInsights": {
    "ConnectionString": "InstrumentationKey={key};IngestionEndpoint=https://eastus-8.in.applicationinsights.azure.com/"
  },
  "Logging": {
    "ApplicationInsights": {
      "LogLevel": {
        "Default": "Information",
        "Microsoft": "Warning"
      }
    }
  }
}
```

**Données Collectées :**
- **Requests** : HTTP requests, response times, URLs
- **Dependencies** : SQL, HTTP, Redis, Azure services
- **Exceptions** : Stack traces, error messages
- **Page Views** : Client-side navigation
- **Custom Events** : Business metrics, user actions
- **Metrics** : Performance counters, custom metrics
- **Traces** : Logs applicatifs

**Requêtes KQL - Application Insights :**
```kusto
// Requests avec temps de réponse > 1s
requests
| where timestamp > ago(1h)
| where duration > 1000
| project timestamp, name, url, duration, resultCode
| order by duration desc

// Top 10 exceptions
exceptions
| where timestamp > ago(24h)
| summarize count() by type, outerMessage
| top 10 by count_ desc

// Dépendances SQL lentes
dependencies
| where timestamp > ago(1h)
| where type == "SQL"
| where duration > 500
| project timestamp, name, data, duration, success
| order by duration desc

// Availability (tests synthétiques)
availabilityResults
| where timestamp > ago(24h)
| summarize SuccessRate = 100.0 * countif(success == true) / count() by name
| order by SuccessRate asc
```

**Smart Detection - Alertes Automatiques :**
- **Failure anomalies** : Augmentation soudaine des échecs
- **Performance anomalies** : Dégradation temps de réponse
- **Memory leak detection** : Fuite mémoire détectée
- **Slow page load time** : Chargement page lent
- **Exception volume** : Volume d'exceptions anormal

**Application Map :**
```
[Client Browser]
    ↓
[App Service: myWebApp] → [SQL Database: myDB]
    ↓                        ↓
[Redis Cache]            [Slow queries detected]
    ↓
[Azure Storage]
```