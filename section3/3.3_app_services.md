### 3.3 App Services

#### Service Plans - Tiers Détaillés

**⚠️ Erreur Courante QCM : Capacités de scaling par tier**

**Comparaison Complète des Tiers :**

| Tier | SKUs | Max Instances | Autoscale | Deployment Slots | Custom Domain | SSL | Prix/mois* |
|------|------|---------------|-----------|------------------|---------------|-----|-----------|
| **Free** | F1 | 1 (partagé) | ❌ Non | ❌ Non | ❌ Non | ❌ Non | Gratuit |
| **Shared** | D1 | 1 (partagé) | ❌ Non | ❌ Non | ✅ Oui | ❌ Non | ~$10 |
| **Basic** | B1-B3 | 3 | ❌ Non | ❌ Non | ✅ Oui | ✅ Oui | ~$55-220 |
| **Standard** | S1-S3 | 10 | ✅ Oui | ✅ 5 slots | ✅ Oui | ✅ Oui | ~$70-280 |
| **Premium** | P1v2-P3v2 | 30 | ✅ Oui | ✅ 20 slots | ✅ Oui | ✅ Oui | ~$150-600 |
| **PremiumV3** | P1v3-P3v3 | 30 | ✅ Oui | ✅ 20 slots | ✅ Oui | ✅ Oui | ~$200-800 |
| **Isolated** | I1-I3 | 100 | ✅ Oui | ✅ 20 slots | ✅ Oui | ✅ Oui | ~$650+ |

**\*Prix indicatifs** : Prix approximatifs pour la région US East. Les tarifs varient selon les régions Azure et changent fréquemment. Consultez la [page officielle de tarification Azure App Service](https://azure.microsoft.com/pricing/details/app-service/) pour les prix actuels de votre région.

**Caractéristiques par Tier :**

**Free / Shared (Development) :**
- **Infrastructure** : Partagée avec autres clients
- **Limitations** : Quotas CPU (60 min/jour pour Free)
- **Downtime** : Possible si app inactive > 20 min
- **Use case** : Développement, POC uniquement
- ❌ **Production** : Non recommandé

**Basic (Small Production) :**
- **Infrastructure** : VMs dédiées
- **Scaling** : Manuel uniquement (1-3 instances)
- **Limitations** : Pas d'autoscale, pas de slots
- **Use case** : Petites apps production, budget limité
- **SLA** : 99.95%

**Standard (Production) :**
- **Infrastructure** : VMs dédiées
- **Scaling** : Manuel + Autoscale (1-10 instances)
- **Features** : Deployment slots (5), Traffic Manager
- **Use case** : Apps production standard
- **SLA** : 99.95%

**Premium (High Performance) :**
- **Infrastructure** : VMs dédiées plus puissantes
- **Scaling** : Manuel + Autoscale (1-30 instances)
- **Features** : Deployment slots (20), VNet integration
- **Use case** : Apps critiques, haute performance
- **SLA** : 99.95%

**Isolated (Enterprise) :**
- **Infrastructure** : App Service Environment (ASE) dédié
- **Isolation** : Réseau isolé, pas de partage
- **Scaling** : Jusqu'à 100 instances
- **Use case** : Conformité, sécurité maximale
- **SLA** : 99.95%

#### App Service Plan Scaling - Détaillé

**⚠️ Erreur Courante QCM : Scale Up vs Scale Out**

**Types de Scaling Disponibles :**

**1. Scale Up (Vertical Scaling) - Changer de Tier/SKU**

**Définition :** Augmenter les ressources (CPU, RAM, Storage) de chaque instance

**Quand utiliser :**
- Application nécessite plus de CPU/RAM
- Atteinte des limites de l'instance actuelle
- Besoin de nouvelles fonctionnalités (ex: deployment slots)

**Exemple - Azure CLI :**
```bash
# Upgrader de B1 vers S1
az appservice plan update \
  --name myAppServicePlan \
  --resource-group myRG \
  --sku S1

# Upgrader vers Premium
az appservice plan update \
  --name myAppServicePlan \
  --resource-group myRG \
  --sku P1V2
```

**Impact :**
- ⏱️ **Downtime** : Bref redémarrage (quelques secondes)
- 💰 **Coût** : Augmente selon le nouveau tier
- 🎯 **Performance** : Chaque instance plus puissante

**2. Scale Out (Horizontal Scaling) - Ajouter des Instances**

**Définition :** Augmenter le nombre d'instances (VMs) qui exécutent l'application

**Quand utiliser :**
- Trafic élevé, besoin de plus de capacité
- Haute disponibilité requise
- Distribution de charge

**Exemple - Azure CLI :**
```bash
# Scale Out manuel - Ajouter 5 instances
az appservice plan update \
  --name myAppServicePlan \
  --resource-group myRG \
  --number-of-workers 5
```

**Impact :**
- ⏱️ **Downtime** : ✅ Aucun
- 💰 **Coût** : Proportionnel au nombre d'instances
- 🎯 **Performance** : Capacité totale multipliée

**3. Autoscale (Automatic Horizontal Scaling)**

**Disponible à partir de :** Standard (S1) et supérieur

**Configuration Autoscale :**
```bash
# Créer une règle d'autoscale
az monitor autoscale create \
  --resource-group myRG \
  --resource myAppServicePlan \
  --resource-type Microsoft.Web/serverFarms \
  --name myAutoscaleRule \
  --min-count 2 \
  --max-count 10 \
  --count 2

# Règle basée sur CPU (Scale Out)
az monitor autoscale rule create \
  --resource-group myRG \
  --autoscale-name myAutoscaleRule \
  --condition "CpuPercentage > 75 avg 5m" \
  --scale out 1

# Règle basée sur CPU (Scale In)
az monitor autoscale rule create \
  --resource-group myRG \
  --autoscale-name myAutoscaleRule \
  --condition "CpuPercentage < 25 avg 5m" \
  --scale in 1
```

**Métriques disponibles pour Autoscale :**
- **CPU Percentage** : % utilisation CPU
- **Memory Percentage** : % utilisation RAM
- **Disk Queue Length** : File d'attente disque
- **Http Queue Length** : File d'attente requêtes HTTP
- **Data In/Out** : Bande passante réseau
- **Custom metrics** : Application Insights

**Configuration via Portal :**
```
App Service Plan → Scale out (App Service plan) → Autoscale
→ Add a rule → Metric (CPU Percentage > 70)
→ Operation (Increase count by 1)
→ Cool down (5 minutes)
```

**Best Practices Autoscale :**
- ✅ **Minimum 2 instances** pour haute disponibilité
- ✅ **Cool down period** : 5-10 minutes (éviter flapping)
- ✅ **Margins** : Scale out à 70%, scale in à 30%
- ⚠️ **Limites** : Définir max instances pour contrôler coûts

**Matrice de Décision - Scaling :**

| Symptôme | Solution | Commande |
|----------|----------|----------|
| **CPU/RAM saturé** sur instances | Scale Up | Change SKU (B1→S1) |
| **Trafic élevé**, instances saturées | Scale Out | Augmenter instances |
| **Trafic variable** (pics) | Autoscale | Règles basées métriques |
| **Besoin de deployment slots** | Scale Up | Upgrade vers S1+ |
| **Latence élevée** | Scale Out | Plus d'instances |
| **Coûts trop élevés** | Scale Down/In | Réduire tier ou instances |

**Limitations par Tier :**

| Tier | Scale Out Manuel | Autoscale | Max Instances |
|------|-----------------|-----------|---------------|
| Free/Shared | ❌ Non | ❌ Non | 1 (partagé) |
| Basic | ✅ Oui | ❌ Non | 3 |
| Standard | ✅ Oui | ✅ Oui | 10 |
| Premium | ✅ Oui | ✅ Oui | 30 |
| Isolated | ✅ Oui | ✅ Oui | 100 |

**Scénarios d'Examen :**

| Question | Réponse | Raison |
|----------|---------|--------|
| App nécessite plus de RAM | **Scale Up** | Augmenter ressources par instance |
| Trafic web élevé, pic de charge | **Scale Out** | Ajouter instances pour capacité |
| Besoin deployment slots | **Scale Up to Standard** | Slots disponibles à partir de S1 |
| Trafic variable jour/nuit | **Autoscale** | Ajustement automatique |
| Minimiser downtime pendant scaling | **Scale Out** | Pas de redémarrage |

**PowerShell - Gestion Complète :**
```powershell
# Scale Up
Set-AzAppServicePlan `
  -ResourceGroupName "myRG" `
  -Name "myAppServicePlan" `
  -Tier "Standard" `
  -WorkerSize "Medium"

# Scale Out
Set-AzAppServicePlan `
  -ResourceGroupName "myRG" `
  -Name "myAppServicePlan" `
  -NumberofWorkers 5

# Get current scale
Get-AzAppServicePlan `
  -ResourceGroupName "myRG" `
  -Name "myAppServicePlan" | 
  Select-Object Name, Sku, NumberOfWorkers
```

#### Runtime Stacks et OS
** Point clé identifié :** Un App Service = Un runtime
- Chaque App Service configuré pour **un seul runtime**
- Python OU Java OU C# - pas de mix possible
- Un Plan App Service peut héberger plusieurs App Services du même OS

#### Deployment Slots

** Workflow optimal identifié :**
1. **Deploy** → Déployer l'update sur staging slot
2. **Test** → Tester l'application sur staging
3. **Swap** → Basculer staging vers production

**Avantages du Slot Swapping :**
- **Zero downtime** : Aucune interruption
- **Warm-up automatique** : Instances préchauffées
- **Rollback instant** : Re-swap pour annuler
- **Configuration preservation** : Settings spécifiques aux slots

#### Authentication et Authorization

**⚠️ Erreur Courante QCM : Comprendre Anonymous Access**

**Anonymous Access n'est PAS une méthode d'authentification** - c'est l'**ABSENCE** d'authentification.

**Méthodes d'Authentification Disponibles :**
- ✅ **Microsoft Entra ID (Azure AD)** : Authentification Azure AD
- ✅ **Microsoft Account** : Comptes personnels Microsoft
- ✅ **Facebook** : Authentification via Facebook
- ✅ **Google** : Authentification via Google
- ✅ **Twitter** : Authentification via Twitter
- ❌ **Anonymous Access** : Pas d'authentification (accès public par défaut)

**Configuration - Désactiver l'Accès Anonyme :**

Par défaut, App Service permet l'accès anonyme (sans authentification). Pour sécuriser votre application :

```bash
# Configurer l'authentification avec Azure AD
az webapp auth update \
  --resource-group myRG \
  --name myWebApp \
  --enabled true \
  --action LoginWithAzureActiveDirectory \
  --aad-client-id {client-id}
```

**Via Azure Portal :**
```
App Service → Authentication/Authorization
→ App Service Authentication: On
→ Action when request is not authenticated: Log in with Azure Active Directory
→ Authentication Providers: Configure providers
```

**Actions Disponibles :**
- **Allow Anonymous requests (no action)** : Accès public autorisé
- **Log in with [Provider]** : Redirection vers authentification
- **Return 401 Unauthorized** : Rejeter les requêtes non authentifiées

