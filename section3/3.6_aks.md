### 3.6 Azure Kubernetes Service (AKS) - Basics

**⚠️ Concept Clé pour AZ-104 : AKS est le service managé Kubernetes d'Azure pour orchestrer des containers en production**

**Définition :**
- **Azure Kubernetes Service (AKS)** : Service managé Kubernetes pour déployer, gérer et scaler des applications containerisées
- **Kubernetes (K8s)** : Orchestrateur open-source pour automatiser le déploiement, scaling et gestion de containers
- **Managed Service** : Azure gère les masters (control plane), vous gérez les nodes (worker nodes)
- **Use Case** : Applications production nécessitant orchestration, auto-scaling, service discovery, load balancing

**Architecture AKS :**

```
┌─────────────────────────────────────────────────────┐
│         Azure Kubernetes Service (AKS)              │
├─────────────────────────────────────────────────────┤
│  Control Plane (Managed by Azure)                   │
│  ├── API Server                                     │
│  ├── etcd (state store)                             │
│  ├── Scheduler                                      │
│  └── Controller Manager                             │
├─────────────────────────────────────────────────────┤
│  Node Pool (Worker Nodes - Managed by You)          │
│  ├── Node 1 (VM)                                    │
│  │   ├── kubelet                                    │
│  │   ├── kube-proxy                                 │
│  │   └── Pods (containers)                          │
│  ├── Node 2 (VM)                                    │
│  │   ├── kubelet                                    │
│  │   ├── kube-proxy                                 │
│  │   └── Pods (containers)                          │
│  └── Node 3 (VM)                                    │
│      ├── kubelet                                    │
│      ├── kube-proxy                                 │                                
│      └── Pods (containers)                          │
└─────────────────────────────────────────────────────┘
```

**Composants Clés Kubernetes :**

**1. Control Plane (Managed by Azure)**
- **API Server** : Point d'entrée pour toutes les requêtes (kubectl, dashboard)
- **etcd** : Base de données distribuée pour état du cluster
- **Scheduler** : Détermine sur quel node placer les pods
- **Controller Manager** : Gère les controllers (replicas, deployments, etc.)
- **Coût** : Gratuit (Azure gère et facture uniquement les nodes)

**2. Nodes (Worker Nodes)**
- **kubelet** : Agent sur chaque node qui communique avec l'API server
- **kube-proxy** : Gère le networking et load balancing
- **Pods** : Plus petite unité déployable (1 ou plusieurs containers)
- **Coût** : Vous payez pour les VMs des nodes

**3. Concepts Kubernetes Essentiels :**

**Pods :**
- **Définition** : Plus petite unité déployable dans Kubernetes
- **Contenu** : 1 ou plusieurs containers (généralement 1)
- **Lifecycle** : Éphémère (peuvent être recréés)
- **Ressources partagées** : Pod partage réseau, storage, IP

**Deployments :**
- **Définition** : Gère le cycle de vie des pods (création, mise à jour, rollback)
- **Replicas** : Nombre de copies de pods à maintenir
- **Rolling Updates** : Mise à jour progressive sans downtime
- **Rollback** : Retour à version précédente en cas de problème

**Services :**
- **Définition** : Abstraction réseau pour exposer pods
- **Types** : ClusterIP (interne), LoadBalancer (externe), NodePort
- **Load Balancing** : Distribution du trafic entre pods

**Namespaces :**
- **Définition** : Isolation logique des ressources
- **Use Case** : Séparer dev/staging/prod, équipes
- **Default** : `default`, `kube-system`, `kube-public`

**Création d'un Cluster AKS :**

**Via Azure CLI :**
```bash
# Créer un cluster AKS basique
az aks create \
  --resource-group myRG \
  --name myAKSCluster \
  --node-count 3 \
  --node-vm-size Standard_D2s_v3 \
  --generate-ssh-keys \
  --location eastus

# Créer avec node pool spécifique
az aks create \
  --resource-group myRG \
  --name myAKSCluster \
  --node-count 3 \
  --node-vm-size Standard_D2s_v3 \
  --enable-managed-identity \
  --network-plugin azure \
  --network-policy azure \
  --location eastus

# Créer avec Azure AD integration (RBAC)
az aks create \
  --resource-group myRG \
  --name myAKSCluster \
  --node-count 3 \
  --enable-aad \
  --aad-admin-group-object-ids <group-id> \
  --location eastus
```

**Via Azure Portal :**
```
Kubernetes services → Create → Configure:
- Cluster name
- Resource group
- Region
- Kubernetes version
- Node pool (size, count)
- Authentication (Service Principal or Managed Identity)
- Networking (CNI or kubenet)
```

**Configuration kubectl :**

```bash
# Installer kubectl (si pas déjà fait)
az aks install-cli

# Se connecter au cluster AKS
az aks get-credentials \
  --resource-group myRG \
  --name myAKSCluster

# Vérifier la connexion
kubectl get nodes

# Afficher les pods
kubectl get pods --all-namespaces

# Afficher les services
kubectl get services
```

**Déploiement d'une Application :**

**1. Créer un Deployment :**

**Fichier deployment.yaml :**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
```

**Déployer :**
```bash
# Créer le deployment
kubectl apply -f deployment.yaml

# Vérifier le deployment
kubectl get deployments
kubectl get pods

# Afficher les détails
kubectl describe deployment nginx-deployment
```

**2. Exposer avec un Service :**

**Fichier service.yaml :**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
```

**Déployer :**
```bash
# Créer le service
kubectl apply -f service.yaml

# Obtenir l'IP externe
kubectl get service nginx-service

# Accéder à l'application via l'IP externe
```

**Types de Services :**

| Type | Description | Use Case |
|------|-------------|----------|
| **ClusterIP** (Default) | IP interne dans le cluster | Communication interne |
| **LoadBalancer** | IP publique Azure Load Balancer | Exposer application Internet |
| **NodePort** | Port exposé sur chaque node | Accès direct via node IP |
| **ExternalName** | CNAME vers service externe | Intégration services externes |

**Node Pools :**

**Définition :**
- **Node Pool** : Groupe de nodes avec même configuration (VM size, OS, etc.)
- **Multiple Pools** : Possibilité d'avoir plusieurs node pools (ex: CPU-intensive, GPU, Windows)

**Gestion des Node Pools :**
```bash
# Lister les node pools
az aks nodepool list \
  --resource-group myRG \
  --cluster-name myAKSCluster

# Ajouter un nouveau node pool
az aks nodepool add \
  --resource-group myRG \
  --cluster-name myAKSCluster \
  --name gpunodepool \
  --node-count 2 \
  --node-vm-size Standard_NC6s_v3 \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 5

# Mettre à jour un node pool (scaling)
az aks nodepool scale \
  --resource-group myRG \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --node-count 5

# Supprimer un node pool
az aks nodepool delete \
  --resource-group myRG \
  --cluster-name myAKSCluster \
  --name gpunodepool
```

**Auto-Scaling :**

**Cluster Autoscaler :**
- **Fonction** : Ajuste automatiquement le nombre de nodes selon la demande
- **Trigger** : Pods en attente (pending) = besoin de plus de nodes
- **Scale Down** : Nodes sous-utilisés = suppression automatique

```bash
# Activer Cluster Autoscaler
az aks update \
  --resource-group myRG \
  --name myAKSCluster \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 10

# Configurer sur un node pool spécifique
az aks nodepool update \
  --resource-group myRG \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --enable-cluster-autoscaler \
  --min-count 2 \
  --max-count 10
```

**Horizontal Pod Autoscaler (HPA) :**
- **Fonction** : Ajuste le nombre de replicas de pods selon métriques (CPU, mémoire)
- **Scope** : Au niveau deployment, pas au niveau cluster

```bash
# Créer un HPA
kubectl autoscale deployment nginx-deployment \
  --cpu-percent=70 \
  --min=2 \
  --max=10

# Vérifier le HPA
kubectl get hpa
```

**Networking AKS :**

**Deux Modes de Networking :**

**1. kubenet (Basic)**
- **Réseau** : Azure gère les routes
- **Limitation** : 400 nodes maximum par cluster
- **Use Case** : Clusters simples, développement

**2. Azure CNI (Advanced)**
- **Réseau** : Pods obtiennent des IPs du subnet VNet
- **Avantage** : Intégration native avec VNet Azure
- **Limitation** : Besoin de planifier l'espace IP
- **Use Case** : Production, intégration VNet

```bash
# Créer cluster avec Azure CNI
az aks create \
  --resource-group myRG \
  --name myAKSCluster \
  --network-plugin azure \
  --vnet-subnet-id /subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Network/virtualNetworks/myVNet/subnets/aks-subnet \
  --node-count 3
```

**Sécurité AKS :**

**1. Authentication et Authorization :**

**Azure AD Integration (RBAC) :**
```bash
# Créer cluster avec Azure AD
az aks create \
  --resource-group myRG \
  --name myAKSCluster \
  --enable-aad \
  --aad-admin-group-object-ids <group-id> \
  --node-count 3
```

**RBAC Kubernetes :**
- **Roles** : Permissions dans un namespace
- **ClusterRoles** : Permissions cluster-wide
- **RoleBindings** : Associe roles à utilisateurs/groups

**2. Secrets Management :**

**Kubernetes Secrets :**
```bash
# Créer un secret
kubectl create secret generic mysecret \
  --from-literal=username=admin \
  --from-literal=password=secret123

# Utiliser dans un pod
# (référencé dans deployment.yaml)
```

**Azure Key Vault Integration :**
- **Azure Key Vault Provider for Secrets Store CSI Driver**
- **Use Case** : Secrets depuis Key Vault dans pods

**3. Pod Security Policies / Pod Security Standards :**
- **Restrictions** : Limiter capabilities des pods
- **Use Case** : Sécurité renforcée, conformité

**Monitoring et Logging :**

**Azure Monitor pour Containers :**
```bash
# Activer Azure Monitor
az aks enable-addons \
  --resource-group myRG \
  --name myAKSCluster \
  --addons monitoring
```

**Logs :**
- **Container Insights** : Métriques et logs des pods
- **kube-audit** : Logs d'audit du cluster
- **kube-apiserver** : Logs de l'API server

**Commandes Utiles :**

```bash
# Afficher les nodes
kubectl get nodes

# Afficher les pods
kubectl get pods
kubectl get pods --all-namespaces

# Afficher les deployments
kubectl get deployments

# Afficher les services
kubectl get services

# Afficher les logs d'un pod
kubectl logs <pod-name>

# Exécuter une commande dans un pod
kubectl exec -it <pod-name> -- /bin/bash

# Décrire une ressource
kubectl describe pod <pod-name>

# Supprimer une ressource
kubectl delete deployment nginx-deployment
kubectl delete service nginx-service

# Mettre à jour un deployment
kubectl set image deployment/nginx-deployment nginx=nginx:1.22

# Rollback un deployment
kubectl rollout undo deployment/nginx-deployment
```

**Comparaison AKS vs ACI vs VMs :**

| Critère | AKS | ACI | VMs |
|---------|-----|-----|-----|
| **Orchestration** | Kubernetes complet | Non | Non |
| **Auto-scaling** | Pods + Nodes | Manuel | Manuel |
| **Service Discovery** | Natif | Non | Non |
| **Load Balancing** | Natif | Manuel | Load Balancer séparé |
| **Complexité** | Élevée | Faible | Moyenne |
| **Coût** | Nodes + Control Plane (gratuit) | Pay-per-second | Par heure |
| **Use Case** | Production, microservices | Jobs, burst, simple | Custom OS, legacy |
| **Démarrage** | Minutes (cluster) | Secondes | Minutes |

**Scénarios d'Examen AZ-104 :**

**Question Type 1 : Quand Utiliser AKS ?**
```
Scénario : Application microservices avec 10+ services, besoin auto-scaling
Question : Quelle solution Azure ?

Réponse : Azure Kubernetes Service (AKS)

Justification :
- Orchestration Kubernetes nécessaire
- Auto-scaling pods et nodes
- Service discovery natif
- Load balancing intégré
```

**Question Type 2 : AKS vs ACI**
```
Scénario : Application simple avec 2 containers, pas de scaling complexe
Question : AKS ou ACI ?

Réponse : ACI (si pas besoin orchestration)

Justification :
- ACI = Plus simple, moins de coût
- AKS = Overkill pour cas simple
- AKS = Nécessaire si besoin orchestration avancée
```

**Question Type 3 : Control Plane AKS**
```
Question : Qui gère le control plane AKS ?

Réponse : Azure

Justification :
- Control plane = Managed by Azure (gratuit)
- Vous gérez uniquement les worker nodes
- Azure gère : API Server, etcd, Scheduler, Controller Manager
```

**Limites et Quotas AKS :**

| Ressource | Limite | Notes |
|-----------|--------|-------|
| **Clusters par subscription** | 50 | Par défaut |
| **Nodes par cluster (kubenet)** | 400 | Maximum |
| **Nodes par cluster (Azure CNI)** | 1000 | Maximum |
| **Pods par node** | 30-250 | Dépend de la taille VM |
| **Node pools par cluster** | 100 | Maximum |
| **Services par cluster** | 5000 | Maximum |

**Best Practices AKS :**

**À FAIRE :**
- Utiliser **Managed Identity** au lieu de Service Principal
- Activer **Azure AD integration** pour RBAC
- Utiliser **Azure CNI** pour production (intégration VNet)
- Configurer **Cluster Autoscaler** pour optimiser coûts
- Activer **Azure Monitor** pour monitoring
- Utiliser **Azure Container Registry (ACR)** pour images
- Implémenter **Resource Quotas** et **Limit Ranges**
- Utiliser **Namespaces** pour isolation
- Configurer **Network Policies** pour sécurité réseau
- Utiliser **Secrets** ou **Key Vault** pour credentials

**À ÉVITER :**
- Utiliser AKS pour applications simples (préférer ACI ou App Service)
- Oublier de configurer auto-scaling (coûts élevés)
- Exposer services sensibles publiquement sans authentification
- Hardcoder secrets dans images ou YAML
- Ignorer les mises à jour de sécurité Kubernetes
- Utiliser kubenet pour clusters > 50 nodes (préférer Azure CNI)

**Points Clés pour l'Examen :**
- **Control Plane = Managed by Azure** (gratuit)
- **Worker Nodes = Votre responsabilité** (coût)
- **AKS = Orchestration complète** (vs ACI = simple)
- **Auto-scaling** : Cluster Autoscaler (nodes) + HPA (pods)
- **Networking** : kubenet (simple) vs Azure CNI (avancé)
- **Azure AD Integration** : RBAC pour sécurité
- **Use Case** : Production, microservices, orchestration complexe

---
