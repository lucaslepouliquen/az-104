### 3.1 Virtual Machines

#### VM Sizes et Families
- **General Purpose** (B, D, DC series) : Workloads équilibrés
- **Compute Optimized** (F series) : Applications CPU-intensive
- **Memory Optimized** (E, M, G series) : Bases de données, analytics
- **Storage Optimized** (L series) : Big data, SQL NoSQL
- **GPU** (N series) : IA, machine learning, rendering

#### Disques et Stockage

** Erreur fréquente identifiée :** Disques temporaires vs persistants

**Disque C: (OS Disk)**
- **Type** : Persistant (VHD dans Azure Storage)
- **Contenu** : OS, applications installées
- **Persistance** : Conservé lors redémarrages/arrêts
- **Usage** : Applications, données importantes

**Disque D: (Temporary Disk)**
- **Type** : Temporaire (SSD local hyperviseur)
- **Contenu** : Pagefile.sys par défaut
- **Persistance** : **PERDU** lors maintenances/redéploiements
- **Usage** : Cache, fichiers temporaires, TempDB

**Disques de Données (E:, F:, etc.)**
- **Type** : Persistants (Managed Disks)
- **Usage** : Données applicatives, bases de données

#### Types de Disques
- **Standard HDD** : Workloads peu fréquents, coût minimal
- **Standard SSD** : Workloads modérés, balance performance/coût
- **Premium SSD** : Workloads critiques, haute performance
- **Ultra Disk** : Workloads extrêmes, latence ultra-faible

#### Création de VM avec Data Disks

**⚠️ Erreur Courante QCM : Attacher plusieurs data disks dès la création**

**Scénario :** Créer une VM avec 3 disques de données (data disks) attachés dès la création.

**Solution : Azure CLI (Méthode la plus simple)**

```bash
# Créer une VM avec 3 data disks en une seule commande
az vm create \
  --resource-group myRG \
  --name myVM \
  --image UbuntuLTS \
  --size Standard_D2s_v3 \
  --admin-username azureuser \
  --generate-ssh-keys \
  --data-disk-sizes-gb 128 256 512
  # Créera automatiquement 3 disques: 128GB, 256GB et 512GB
```

**Paramètres clés :**
- `--data-disk-sizes-gb` : Liste des tailles de disques séparées par espaces
- Les disques sont créés automatiquement et attachés
- LUN (Logical Unit Number) assignés automatiquement : 0, 1, 2, etc.

**Concepts Importants :**

**LUN (Logical Unit Number) :**
- **Identifiant unique** pour chaque disque attaché à une VM
- **Numérotation** : Commence à 0 (LUN 0, LUN 1, LUN 2, etc.)
- **Maximum** : Dépend de la taille de VM (voir tableaux ci-dessous)

#### Tableau Récapitulatif - Max Data Disks par Famille VM (AZ-104)

**Famille D-Series (General Purpose) :**

| Taille VM | vCPUs | RAM (GB) | **Max Data Disks** | Stockage Temp (GB) | Premium Storage |
|-----------|-------|----------|---------------------|---------------------|-----------------|
| **Dv3-series (Standard Storage)** |
| Standard_D2_v3 | 2 | 8 | **4** | 50 | ❌ Non |
| Standard_D4_v3 | 4 | 16 | **8** | 100 | ❌ Non |
| Standard_D8_v3 | 8 | 32 | **16** | 200 | ❌ Non |
| Standard_D16_v3 | 16 | 64 | **32** | 400 | ❌ Non |
| Standard_D32_v3 | 32 | 128 | **32** | 800 | ❌ Non |
| Standard_D48_v3 | 48 | 192 | **32** | 1200 | ❌ Non |
| Standard_D64_v3 | 64 | 256 | **32** | 1600 | ❌ Non |
| **Dsv3-series (Premium Storage)** |
| Standard_D2s_v3 | 2 | 8 | **4** | 16 | ✅ Oui |
| Standard_D4s_v3 | 4 | 16 | **8** | 32 | ✅ Oui |
| Standard_D8s_v3 | 8 | 32 | **16** | 64 | ✅ Oui |
| Standard_D16s_v3 | 16 | 64 | **32** | 128 | ✅ Oui |
| Standard_D32s_v3 | 32 | 128 | **32** | 256 | ✅ Oui |
| Standard_D48s_v3 | 48 | 192 | **32** | 384 | ✅ Oui |
| Standard_D64s_v3 | 64 | 256 | **32** | 512 | ✅ Oui |

**Famille B-Series (Burstable - Economique) :**

| Taille VM | vCPUs | RAM (GB) | **Max Data Disks** | Stockage Temp (GB) | Premium Storage |
|-----------|-------|----------|---------------------|---------------------|-----------------|
| Standard_B1ls | 1 | 0.5 | **2** | 4 | ✅ Oui |
| Standard_B1s | 1 | 1 | **2** | 4 | ✅ Oui |
| Standard_B1ms | 1 | 2 | **2** | 4 | ✅ Oui |
| Standard_B2s | 2 | 4 | **4** | 8 | ✅ Oui |
| Standard_B2ms | 2 | 8 | **4** | 16 | ✅ Oui |
| Standard_B4ms | 4 | 16 | **8** | 32 | ✅ Oui |
| Standard_B8ms | 8 | 32 | **16** | 64 | ✅ Oui |
| Standard_B12ms | 12 | 48 | **16** | 96 | ✅ Oui |
| Standard_B16ms | 16 | 64 | **32** | 128 | ✅ Oui |
| Standard_B20ms | 20 | 80 | **32** | 160 | ✅ Oui |

**Famille F-Series (Compute Optimized) :**

| Taille VM | vCPUs | RAM (GB) | **Max Data Disks** | Stockage Temp (GB) | Premium Storage |
|-----------|-------|----------|---------------------|---------------------|-----------------|
| **Fsv2-series (Optimisé CPU)** |
| Standard_F2s_v2 | 2 | 4 | **4** | 16 | ✅ Oui |
| Standard_F4s_v2 | 4 | 8 | **8** | 32 | ✅ Oui |
| Standard_F8s_v2 | 8 | 16 | **16** | 64 | ✅ Oui |
| Standard_F16s_v2 | 16 | 32 | **32** | 128 | ✅ Oui |
| Standard_F32s_v2 | 32 | 64 | **32** | 256 | ✅ Oui |
| Standard_F48s_v2 | 48 | 96 | **32** | 384 | ✅ Oui |
| Standard_F64s_v2 | 64 | 128 | **32** | 512 | ✅ Oui |
| Standard_F72s_v2 | 72 | 144 | **32** | 576 | ✅ Oui |

**Famille E-Series (Memory Optimized) :**

| Taille VM | vCPUs | RAM (GB) | **Max Data Disks** | Stockage Temp (GB) | Premium Storage |
|-----------|-------|----------|---------------------|---------------------|-----------------|
| **Ev3-series (Standard Storage)** |
| Standard_E2_v3 | 2 | 16 | **4** | 50 | ❌ Non |
| Standard_E4_v3 | 4 | 32 | **8** | 100 | ❌ Non |
| Standard_E8_v3 | 8 | 64 | **16** | 200 | ❌ Non |
| Standard_E16_v3 | 16 | 128 | **32** | 400 | ❌ Non |
| Standard_E20_v3 | 20 | 160 | **32** | 500 | ❌ Non |
| Standard_E32_v3 | 32 | 256 | **32** | 800 | ❌ Non |
| Standard_E48_v3 | 48 | 384 | **32** | 1200 | ❌ Non |
| Standard_E64_v3 | 64 | 432 | **32** | 1600 | ❌ Non |
| **Esv3-series (Premium Storage)** |
| Standard_E2s_v3 | 2 | 16 | **4** | 32 | ✅ Oui |
| Standard_E4s_v3 | 4 | 32 | **8** | 64 | ✅ Oui |
| Standard_E8s_v3 | 8 | 64 | **16** | 128 | ✅ Oui |
| Standard_E16s_v3 | 16 | 128 | **32** | 256 | ✅ Oui |
| Standard_E20s_v3 | 20 | 160 | **32** | 320 | ✅ Oui |
| Standard_E32s_v3 | 32 | 256 | **32** | 512 | ✅ Oui |
| Standard_E48s_v3 | 48 | 384 | **32** | 768 | ✅ Oui |
| Standard_E64s_v3 | 64 | 432 | **32** | 864 | ✅ Oui |

**🎯 Règle Générale pour l'Examen AZ-104 :**

| vCPUs | Max Data Disks (Général) | Exceptions Notables |
|-------|---------------------------|---------------------|
| 1-2 vCPUs | **2-4 disks** | B1 series = 2 disks |
| 4 vCPUs | **8 disks** | Standard sur toutes familles |
| 8 vCPUs | **16 disks** | Standard sur toutes familles |
| 16+ vCPUs | **32 disks** | Maximum absolu Azure |

**⚠️ Important pour l'Examen :**
- **Maximum absolu** : **32 data disks** (aucune VM Azure ne supporte plus)
- **Pattern commun** : vCPUs x 2 = Max data disks (jusqu'à 32)
- **D2s_v3 = 4 disks** (pas 8 !) - Question piège fréquente
- **B-series** : Commence à 2 disks pour B1, puis suit le pattern standard

**Persistance des Data Disks :**
- ✅ **PERSISTANTS** : Les données sont conservées lors arrêts/redémarrages
- ✅ **Managed Disks** : Gestion automatique par Azure
- ✅ **Snapshots** : Possibilité de créer des snapshots pour backup
- ❌ **Différent du disque temporaire (D:)** qui est volatile

**Scénarios d'Examen :**

| Question | Réponse | Raison |
|----------|---------|--------|
| Créer VM avec 3 disques de données | `--data-disk-sizes-gb 128 256 512` | Azure CLI option la plus simple |
| Maximum de data disks sur Standard_D2s_v3 | **4 disks** | Limite de la taille VM |
| Maximum de data disks sur Standard_D4s_v3 | **8 disks** | Limite de la taille VM |
| Maximum de data disks sur Standard_B2ms | **4 disks** | B-series burstable |
| Maximum de data disks sur Standard_F8s_v2 | **16 disks** | F-series compute optimized |
| Maximum de data disks sur Standard_E16s_v3 | **32 disks** | E-series memory optimized |
| Maximum absolu Azure (toutes VMs) | **32 disks** | Limite plateforme Azure |
| Les data disks sont-ils persistants ? | Oui | Contrairement au disque temporaire D: |
| Identifier un data disk dans la VM | Par LUN (0, 1, 2...) | Logical Unit Number |

#### Accès Externe aux VMs

**⚠️ Erreur Courante QCM : Minimize Administrative Effort**

**Scénario :** Une VM est accessible uniquement depuis le réseau interne. Vous devez permettre l'accès depuis Internet avec **effort administratif minimal**.

**❌ FAUX :** Configurer un VPN Site-to-Site
**✅ CORRECT :** **Ajouter une adresse IP publique** à la VM

**Comparaison des Solutions :**

| Solution | Complexité | Coût* | Temps | Effort Admin |
|----------|------------|------|-------|--------------|
| **IP Publique** | ✅ Très faible | ~$3/mois | 2 min | ✅ Minimal |
| **Azure Bastion** | Moyenne | ~$150/mois | 15 min | Moyen |
| **VPN Site-to-Site** | ❌ Élevée | ~$25-150/mois | 1-2h | ❌ Élevé |

**\*Coûts indicatifs** : Prix approximatifs pour la région US East. Les tarifs varient selon les régions et changent fréquemment.

**Solution Recommandée - Ajouter une IP Publique :**

```bash
# 1. Créer une IP publique
az network public-ip create \
  --resource-group myRG \
  --name myVM-PublicIP \
  --sku Standard \
  --allocation-method Static

# 2. Associer l'IP publique à la NIC de la VM
az network nic ip-config update \
  --resource-group myRG \
  --nic-name myVM-NIC \
  --name ipconfig1 \
  --public-ip-address myVM-PublicIP
```

**⚠️ Sécurité - NSG Recommandé :**

```bash
# Limiter l'accès SSH/RDP à votre IP uniquement
az network nsg rule create \
  --resource-group myRG \
  --nsg-name myVM-NSG \
  --name Allow-SSH-MyIP \
  --priority 100 \
  --source-address-prefixes 203.0.113.50/32 \
  --destination-port-ranges 22 \
  --access Allow \
  --protocol Tcp
```

**Pourquoi PAS VPN Site-to-Site ?**
- ❌ **Complexe** : Local Network Gateway, Virtual Network Gateway, Connection
- ❌ **Temps** : 1-2 heures de configuration
- ❌ **Coût** : Gateway ~$25-150/mois
- ⚠️ **Use case** : Connectivité réseau entier, pas une seule VM

**Scénarios d'Examen :**
- **"Minimal administrative effort"** → Add Public IP
- **"Secure access without exposing ports"** → Azure Bastion
- **"Connect entire on-premises network"** → VPN Site-to-Site

#### High Availability

**Availability Sets**

**Définition :**
- **Groupement logique** de VMs pour assurer la haute disponibilité
- **Protection** contre pannes matérielles ET maintenances planifiées
- **Placement** : VMs distribuées sur plusieurs racks physiques
- **Scope** : Même datacenter (single region, single datacenter)
- **SLA** : 99.95% (au moins 1 VM disponible)
- **Gratuit** : Aucun coût supplémentaire pour l'availability set lui-même

**Composants Clés :**

**1. Fault Domains (FD) - Domaines de Défaillance**
- **Définition** : Représente un rack physique dans le datacenter
- **Contenu** : Serveurs, switch réseau, source d'alimentation partagés
- **Maximum** : 3 Fault Domains par availability set
- **Protection** : Panne matérielle (hardware failure, power outage, network switch failure)
- **Distribution** : Azure répartit automatiquement vos VMs sur les FDs

**Visualisation des Fault Domains :**
```
Datacenter Azure
├── Rack 1 (FD 0) - Alimentation A, Switch A
│   ├── VM1
│   └── VM4
├── Rack 2 (FD 1) - Alimentation B, Switch B
│   ├── VM2
│   └── VM5
└── Rack 3 (FD 2) - Alimentation C, Switch C
    ├── VM3
    └── VM6
```

**Scénario de panne FD :**
- **Problème** : Rack 1 perd l'alimentation électrique
- **Impact** : Seules VM1 et VM4 sont affectées
- **Résultat** : VM2, VM3, VM5, VM6 continuent de fonctionner
- **Disponibilité** : Au moins 2/3 des VMs restent disponibles

**2. Update Domains (UD) - Domaines de Mise à Jour**
- **Définition** : Groupe logique de VMs redémarrées ensemble lors de maintenances
- **Par défaut** : **5 Update Domains** (si non spécifié à la création)
- **Configurable** : De 1 à **20 Update Domains maximum**
- **Important** : Configuration définie à la création, **non modifiable après**
- **Protection** : Maintenance planifiée Azure (host OS updates, hardware maintenance)
- **Processus** : Azure redémarre un seul UD à la fois
- **Délai** : 30 minutes minimum entre chaque UD redémarré
- **⚠️ Note** : La valeur par défaut de 5 est suffisante pour la plupart des scénarios

**Visualisation des Update Domains :**
```
Update Domain 0: VM1, VM6
Update Domain 1: VM2, VM7
Update Domain 2: VM3, VM8
Update Domain 3: VM4, VM9
Update Domain 4: VM5, VM10

Maintenance planifiée :
Étape 1: Redémarre UD0 → VM1, VM6 offline, autres OK
[Attend 30 min]
Étape 2: Redémarre UD1 → VM2, VM7 offline, autres OK
[Attend 30 min]
Étape 3: Redémarre UD2 → VM3, VM8 offline, autres OK
...
```

**Scénario de maintenance UD :**
- **Événement** : Maintenance planifiée Azure
- **Processus** : Azure redémarre UD par UD (jamais simultanément)
- **Impact** : Maximum 1/5 (20%) des VMs offline à un moment donné
- **Garantie** : Au moins 80% de capacité maintenue

**3. Combinaison FD + UD - Protection Double**

**Matrice de Distribution (Exemple : 6 VMs, 3 FD, 3 UD) :**
```
              FD 0 (Rack 1)  FD 1 (Rack 2)  FD 2 (Rack 3)
UD 0            VM1             VM2             VM3
UD 1            VM4             VM5             VM6
UD 2            VM7             VM8             VM9
```

**Protection simultanée :**
- **Panne FD 1** : Perd VM2, VM5, VM8 → Garde VM1,3,4,6,7,9
- **Maintenance UD 0** : Redémarre VM1, VM2, VM3 → Garde VM4,5,6,7,8,9
- **Combiné** : Jamais plus d'un FD ET un UD affecté en même temps

**Configuration et Contraintes :**

**Création :**
- **Moment** : Doit être configuré AVANT ou PENDANT la création de la VM
- **Modification** : IMPOSSIBLE de changer l'availability set d'une VM existante
- **Solution** : Recréer la VM si changement nécessaire

**Limitations importantes :**
- **Zone géographique** : Limité à un seul datacenter
- **Maximum VMs** : Limite technique de **200 VMs par availability set**
- **Famille de VM** : Toutes les VMs doivent être de tailles compatibles
- **Managed Disks** : Fortement recommandé (Aligned ou non)
- **Incompatibilité** : Ne peut PAS combiner avec Availability Zones

**Configuration PowerShell :**
```powershell
# Créer l'Availability Set
New-AzAvailabilitySet `
  -ResourceGroupName "myRG" `
  -Name "myAvailabilitySet" `
  -Location "East US" `
  -PlatformFaultDomainCount 3 `
  -PlatformUpdateDomainCount 5 `
  -Sku Aligned

# Créer VM dans l'Availability Set
New-AzVM `
  -ResourceGroupName "myRG" `
  -Name "myVM" `
  -AvailabilitySetName "myAvailabilitySet" `
  ...
```

**Configuration Azure CLI :**
```bash
# Créer l'Availability Set
az vm availability-set create \
  --resource-group myRG \
  --name myAvailabilitySet \
  --platform-fault-domain-count 3 \
  --platform-update-domain-count 5

# Créer VM dans l'Availability Set
az vm create \
  --resource-group myRG \
  --name myVM \
  --availability-set myAvailabilitySet \
  ...
```

**Best Practices :**

1. **Minimum 2 VMs par tier** : Pour bénéficier du SLA 99.95%
2. **Utiliser Managed Disks** : Meilleure résilience (Storage Fault Domains)
3. **Load Balancer** : Combiner avec Azure Load Balancer pour distribution trafic
4. **Même fonction** : Regrouper uniquement VMs ayant le même rôle
5. **Planification** : Configurer dès la création, impossible à modifier après

**Cas d'usage typiques :**
- **Web tier** : Serveurs web dans un availability set
- **App tier** : Serveurs applicatifs dans un autre availability set
- **Data tier** : Serveurs de base de données dans un troisième availability set
- **Séparation** : Un availability set différent par tier applicatif

**Comparaison rapide :**
| Caractéristique | Availability Sets | Availability Zones |
|-----------------|-------------------|-------------------|
| **Protection** | Rack failure | Datacenter failure |
| **Fault Domains** | Max 3 | 3 zones |
| **Scope** | Single datacenter | Multiple datacenters |
| **SLA** | 99.95% | 99.99% |
| **Latence** | Minimale | Légèrement plus élevée |
| **Coût** | Gratuit | Frais de transfert inter-zones |

**Availability Zones**
- **Protection** : Datacenters physiquement séparés
- **SLA** : 99.99%
- **Scope** : Région Azure

** Prérequis identifiés pour Availability Zones :**
- **Managed Disks** : Obligatoire
- **Availability Options** : Doit être configuré à la création

#### Accès Externe aux VMs
** Cas d'usage identifié :** Accès externe avec effort administratif minimal
- **Scénario** : VM interne accessible uniquement depuis le réseau interne, besoin d'accès externe
- **Solution optimale** : Ajouter une adresse IP publique à la VM
- **Avantage** : Configuration simple et directe, effort administratif minimal

** Erreur fréquente identifiée :** Complexité inutile pour accès externe simple
- ** Erreur** : Configurer un VPN Site-to-Site pour un accès externe simple
- ** Correct** : Utiliser une adresse IP publique pour minimiser l'effort administratif
- **Raison** : VPN S2S = Configuration complexe (Local Network Gateway, Connection, etc.)
- **Alternative** : IP publique = Configuration simple et directe

#### VM Extensions (⚠️ Important pour l'Examen)

**Définition :**
- **VM Extensions** : Applications post-déploiement qui automatisent la configuration des VMs
- **Moment d'exécution** : Après la création de la VM, durant le provisioning ou après
- **Use Cases** : Installation logiciels, configuration système, monitoring, security

**Extensions Courantes :**

**1. Custom Script Extension (⚠️ Le Plus Important pour l'Examen)**

Exécute des scripts PowerShell (Windows) ou Bash (Linux) sur la VM.

**Windows - Custom Script Extension :**
```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScriptExtension \
  --publisher Microsoft.Compute \
  --version 1.10 \
  --settings '{"fileUris": ["https://raw.githubusercontent.com/user/repo/main/install.ps1"], "commandToExecute": "powershell.exe -ExecutionPolicy Unrestricted -File install.ps1"}'
```

**Linux - Custom Script Extension :**
```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScript \
  --publisher Microsoft.Azure.Extensions \
  --version 2.1 \
  --settings '{"fileUris": ["https://raw.githubusercontent.com/user/repo/main/install.sh"], "commandToExecute": "./install.sh"}'
```

**Exemple script install.sh (Linux) :**
```bash
#!/bin/bash
apt-get update
apt-get install -y nginx
systemctl start nginx
systemctl enable nginx
echo "nginx installed successfully" > /tmp/install.log
```

**2. Azure Monitor Agent (AMA)**

Collecte logs et métriques pour Azure Monitor.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name AzureMonitorLinuxAgent \
  --publisher Microsoft.Azure.Monitor \
  --enable-auto-upgrade true
```

**3. Azure Diagnostics Extension**

Collecte diagnostics et métriques détaillées.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name LinuxDiagnostic \
  --publisher Microsoft.Azure.Diagnostics \
  --version 4.0
```

**4. Desired State Configuration (DSC) - Windows**

Gestion de configuration déclarative pour Windows.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name DSC \
  --publisher Microsoft.Powershell \
  --version 2.83 \
  --settings '{"configuration": {"url": "https://storage/config.zip", "script": "config.ps1", "function": "WebServerConfig"}}'
```

**5. Azure Key Vault Extension**

Synchronise certificats depuis Key Vault vers la VM.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name KeyVaultForLinux \
  --publisher Microsoft.Azure.KeyVault \
  --version 3.0 \
  --settings '{"secretsManagementSettings": {"pollingIntervalInS": "3600", "certificateStoreLocation": "/var/lib/waagent/Microsoft.Azure.KeyVault"}}'
```

**6. Azure AD Login Extension**

Authentification Azure AD pour SSH (Linux) ou RDP (Windows).

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name AADSSHLoginForLinux \
  --publisher Microsoft.Azure.ActiveDirectory
```

**Gestion des Extensions :**

```bash
# Lister les extensions installées
az vm extension list \
  --resource-group myRG \
  --vm-name myVM \
  --output table

# Afficher détails d'une extension
az vm extension show \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScriptExtension

# Supprimer une extension
az vm extension delete \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScriptExtension
```

**Scénarios d'Examen - Extensions :**

| Question | Extension | Raison |
|----------|-----------|--------|
| **Installer nginx automatiquement** | Custom Script Extension | Script bash/PowerShell |
| **Collecter logs vers Azure Monitor** | Azure Monitor Agent | Monitoring |
| **Authentification Azure AD** | AAD Login Extension | SSO avec Azure AD |
| **Synchroniser certificats SSL** | Key Vault Extension | Sécurité centralisée |
| **Configuration Windows automatique** | DSC Extension | Gestion état désiré |

#### Azure Hybrid Benefit (⚠️ Économies Importantes)

**Définition :**
- **Azure Hybrid Benefit** : Utiliser vos licences Windows Server/SQL Server on-premises dans Azure
- **Économies** : Jusqu'à **40% sur les coûts VM** Windows et 55% sur SQL Server
- **Prérequis** : Licences Windows Server avec Software Assurance active

**Licences Éligibles :**
- ✅ **Windows Server** : Standard ou Datacenter avec Software Assurance
- ✅ **SQL Server** : Enterprise ou Standard avec Software Assurance
- ✅ **Red Hat Enterprise Linux (RHEL)** : Abonnements RHEL actifs
- ✅ **SUSE Linux Enterprise Server (SLES)** : Abonnements SLES actifs

**Activation pour une VM Existante :**

```bash
# Activer Hybrid Benefit sur VM existante (Windows)
az vm update \
  --resource-group myRG \
  --name myVM \
  --license-type Windows_Server

# Activer pour SQL Server
az vm update \
  --resource-group myRG \
  --name myVM \
  --license-type RHEL_BYOS  # ou SLES_BYOS pour Linux
```

**Création VM avec Hybrid Benefit :**

```bash
az vm create \
  --resource-group myRG \
  --name myVM \
  --image Win2022Datacenter \
  --license-type Windows_Server \
  --size Standard_D2s_v3 \
  --admin-username azureuser \
  --admin-password 'P@ssw0rd123!'
```

**Calcul Économies (Exemple) :**

| VM Size | Sans Hybrid Benefit | Avec Hybrid Benefit | Économie |
|---------|---------------------|---------------------|----------|
| **D2s_v3 Windows** | $96.36/mois | ~$58/mois | **~40%** |
| **D4s_v3 Windows** | $192.72/mois | ~$116/mois | **~40%** |
| **SQL Server Enterprise** | $500+/mois | ~$225/mois | **~55%** |

**Compliance :**
- ✅ Vous devez avoir **licences valides** avec Software Assurance
- ✅ Maximum **2 VMs Azure** par licence on-premises (pendant 180 jours pour migration)
- ⚠️ **Audit** : Microsoft peut vérifier la conformité

**Vérifier le Statut :**
```bash
az vm show \
  --resource-group myRG \
  --name myVM \
  --query "licenseType"
```

#### Spot VMs (⚠️ Économies pour Workloads Interruptibles)

**Définition :**
- **Spot VMs** : VMs à **prix réduit** (jusqu'à 90%) utilisant la capacité inutilisée Azure
- **Risque** : Azure peut **récupérer la VM** avec préavis de 30 secondes si capacité nécessaire
- **Use Case** : Workloads tolérants aux interruptions (batch, dev/test, CI/CD)

**Caractéristiques :**
- 💰 **Prix** : Jusqu'à 90% moins cher que VMs standard
- ⚠️ **Eviction** : Azure peut arrêter la VM avec 30 sec de préavis
- ✅ **Eviction Policy** : Deallocate (arrêt) ou Delete (suppression)
- 📊 **Max Price** : Prix maximum que vous acceptez de payer

**Création Spot VM :**

```bash
az vm create \
  --resource-group myRG \
  --name mySpotVM \
  --image UbuntuLTS \
  --size Standard_D2s_v3 \
  --priority Spot \
  --max-price -1 \
  --eviction-policy Deallocate \
  --admin-username azureuser \
  --generate-ssh-keys
```

**Paramètres Importants :**
- **--priority Spot** : Active le mode Spot
- **--max-price -1** : Payer jusqu'au prix standard (jamais évincé pour prix)
- **--max-price 0.05** : Prix max de $0.05/heure (évincé si prix dépasse)
- **--eviction-policy** : `Deallocate` (arrêt) ou `Delete` (suppression)

**Eviction Policy :**

| Policy | Comportement | Use Case |
|--------|--------------|----------|
| **Deallocate** | VM arrêtée, disques conservés | Workload peut reprendre |
| **Delete** | VM et disques supprimés | Workload jetable (batch) |

**Cas d'Usage Adaptés :**
- ✅ **Batch processing** : Jobs traitement par lots
- ✅ **CI/CD agents** : Agents de build temporaires
- ✅ **Dev/Test** : Environnements de développement
- ✅ **Simulations** : Calculs scientifiques interruptibles
- ✅ **Rendering** : Rendu 3D/vidéo distribué
- ❌ **Production 24/7** : Applications critiques nécessitant disponibilité continue
- ❌ **Databases** : Bases de données production

**Notifications Eviction :**

Azure envoie une notification 30 secondes avant l'eviction via Azure Metadata Service.

**Script détection eviction (Linux) :**
```bash
#!/bin/bash
while true; do
  response=$(curl -H Metadata:true "http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01")
  if echo "$response" | grep -q "Preempt"; then
    echo "Eviction detected! Saving state..."
    # Sauvegarder état, fermer connexions, etc.
    systemctl stop myapp
    exit 0
  fi
  sleep 5
done
```

**Comparaison Pricing (Exemple) :**

| VM Type | Prix Standard | Prix Spot | Économie |
|---------|---------------|-----------|----------|
| **D2s_v3 Linux** | $70/mois | ~$7-20/mois | **70-90%** |
| **D4s_v3 Linux** | $140/mois | ~$14-40/mois | **70-90%** |
| **F4s_v2** | $150/mois | ~$15-45/mois | **70-90%** |

**⚠️ Note** : Prix Spot fluctuent selon la demande, pas de garantie de prix fixe.

**Vérifier Disponibilité et Prix Spot :**
```bash
# Voir prix Spot actuel pour une région
az vm list-skus \
  --location eastus \
  --size Standard_D2s_v3 \
  --output table
```

#### Proximity Placement Groups (⚠️ Latence Minimale)

**Définition :**
- **Proximity Placement Groups (PPG)** : Contrainte de placement pour grouper VMs physiquement proches
- **Objectif** : **Minimiser la latence réseau** entre VMs (< 1ms)
- **Use Case** : Applications haute performance (HPC, gaming, trading)

**Caractéristiques :**
- 🚀 **Latence** : < 1ms entre VMs du même PPG
- 📍 **Colocation** : VMs dans même datacenter (parfois même rack)
- ⚠️ **Limitation** : Capacité limitée (peut échouer si datacenter plein)

**Création Proximity Placement Group :**

```bash
# Créer un PPG
az ppg create \
  --resource-group myRG \
  --name myPPG \
  --location eastus \
  --type Standard

# Créer VM dans le PPG
az vm create \
  --resource-group myRG \
  --name myVM1 \
  --image UbuntuLTS \
  --size Standard_D4s_v3 \
  --proximity-placement-group myPPG \
  --admin-username azureuser \
  --generate-ssh-keys

# Ajouter VM existante au PPG (nécessite arrêt/redémarrage)
az vm update \
  --resource-group myRG \
  --name myVM2 \
  --set proximityPlacementGroup.id=/subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/proximityPlacementGroups/myPPG
```

**Cas d'Usage :**
- ✅ **HPC (High Performance Computing)** : Clusters calcul scientifique
- ✅ **Gaming servers** : Serveurs jeu multijoueur
- ✅ **SAP HANA** : Bases de données in-memory
- ✅ **Trading platforms** : Applications latence-critique
- ✅ **Distributed databases** : Cassandra, MongoDB clusters

**Combinaison avec Availability Sets :**

Vous pouvez combiner PPG avec Availability Sets pour latence faible + high availability.

```bash
# Créer Availability Set dans PPG
az vm availability-set create \
  --resource-group myRG \
  --name myAvSet \
  --proximity-placement-group myPPG \
  --platform-fault-domain-count 2 \
  --platform-update-domain-count 5

# Créer VMs dans l'Availability Set + PPG
az vm create \
  --resource-group myRG \
  --name myVM1 \
  --availability-set myAvSet \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys
```

**⚠️ Limitations :**
- ❌ **Incompatible avec Availability Zones** : Choisir entre PPG (latence) ou Zones (résilience)
- ⚠️ **Capacité limitée** : Échec possible si datacenter saturé
- ⚠️ **Redéploiement** : Ajouter VM existante nécessite arrêt

**Matrice de Décision - Placement VMs :**

| Besoin | Solution | Trade-off |
|--------|----------|-----------|
| **Latence minimale** | Proximity Placement Group | Résilience réduite |
| **Haute disponibilité** | Availability Zones | Latence plus élevée |
| **Balance latence/HA** | Availability Sets + PPG | Complexité accrue |
| **Disaster Recovery** | Availability Zones | Latence inter-zones |

#### Scénarios d'Examen - Récapitulatif Complet

| Question Type | Réponse | Justification |
|---------------|---------|---------------|
| **Installer logiciel automatiquement** | Custom Script Extension | Post-deployment automation |
| **Réduire coûts VMs Windows** | Azure Hybrid Benefit | 40% économie avec licences |
| **Workload batch interruptible** | Spot VMs | 70-90% économie |
| **Latence < 1ms entre VMs** | Proximity Placement Group | Colocation physique |
| **Attacher 3 disques dès création** | `--data-disk-sizes-gb 128 256 512` | Azure CLI option simple |
| **Garantir HA datacenter failure** | Availability Zones | 99.99% SLA |
| **Garantir HA rack failure** | Availability Sets | 99.95% SLA |
| **Accès externe minimal effort** | Ajouter IP publique | Configuration simple |
| **Collecter logs vers Monitor** | Azure Monitor Agent | Monitoring natif |