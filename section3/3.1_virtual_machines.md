### 3.1 Virtual Machines

#### VM Sizes et Families
- **General Purpose** (B, D, DC series) : Workloads √©quilibr√©s
- **Compute Optimized** (F series) : Applications CPU-intensive
- **Memory Optimized** (E, M, G series) : Bases de donn√©es, analytics
- **Storage Optimized** (L series) : Big data, SQL NoSQL
- **GPU** (N series) : IA, machine learning, rendering

#### Disques et Stockage

** Erreur fr√©quente identifi√©e :** Disques temporaires vs persistants

**Disque C: (OS Disk)**
- **Type** : Persistant (VHD dans Azure Storage)
- **Contenu** : OS, applications install√©es
- **Persistance** : Conserv√© lors red√©marrages/arr√™ts
- **Usage** : Applications, donn√©es importantes

**Disque D: (Temporary Disk)**
- **Type** : Temporaire (SSD local hyperviseur)
- **Contenu** : Pagefile.sys par d√©faut
- **Persistance** : **PERDU** lors maintenances/red√©ploiements
- **Usage** : Cache, fichiers temporaires, TempDB

**Disques de Donn√©es (E:, F:, etc.)**
- **Type** : Persistants (Managed Disks)
- **Usage** : Donn√©es applicatives, bases de donn√©es

#### Types de Disques
- **Standard HDD** : Workloads peu fr√©quents, co√ªt minimal
- **Standard SSD** : Workloads mod√©r√©s, balance performance/co√ªt
- **Premium SSD** : Workloads critiques, haute performance
- **Ultra Disk** : Workloads extr√™mes, latence ultra-faible

#### Cr√©ation de VM avec Data Disks

**‚ö†Ô∏è Erreur Courante QCM : Attacher plusieurs data disks d√®s la cr√©ation**

**Sc√©nario :** Cr√©er une VM avec 3 disques de donn√©es (data disks) attach√©s d√®s la cr√©ation.

**Solution : Azure CLI (M√©thode la plus simple)**

```bash
# Cr√©er une VM avec 3 data disks en une seule commande
az vm create \
  --resource-group myRG \
  --name myVM \
  --image UbuntuLTS \
  --size Standard_D2s_v3 \
  --admin-username azureuser \
  --generate-ssh-keys \
  --data-disk-sizes-gb 128 256 512
  # Cr√©era automatiquement 3 disques: 128GB, 256GB et 512GB
```

**Param√®tres cl√©s :**
- `--data-disk-sizes-gb` : Liste des tailles de disques s√©par√©es par espaces
- Les disques sont cr√©√©s automatiquement et attach√©s
- LUN (Logical Unit Number) assign√©s automatiquement : 0, 1, 2, etc.

**Concepts Importants :**

**LUN (Logical Unit Number) :**
- **Identifiant unique** pour chaque disque attach√© √† une VM
- **Num√©rotation** : Commence √† 0 (LUN 0, LUN 1, LUN 2, etc.)
- **Maximum** : D√©pend de la taille de VM
  - Standard_D2s_v3 : Max 8 data disks (LUN 0-7)
  - Standard_D16s_v3 : Max 32 data disks (LUN 0-31)

**Persistance des Data Disks :**
- ‚úÖ **PERSISTANTS** : Les donn√©es sont conserv√©es lors arr√™ts/red√©marrages
- ‚úÖ **Managed Disks** : Gestion automatique par Azure
- ‚úÖ **Snapshots** : Possibilit√© de cr√©er des snapshots pour backup
- ‚ùå **Diff√©rent du disque temporaire (D:)** qui est volatile

**Sc√©narios d'Examen :**

| Question | R√©ponse | Raison |
|----------|---------|--------|
| Cr√©er VM avec 3 disques de donn√©es | `--data-disk-sizes-gb 128 256 512` | Azure CLI option la plus simple |
| Maximum de data disks sur Standard_D2s_v3 | 8 disks | D√©pend de la taille de VM |
| Les data disks sont-ils persistants ? | Oui | Contrairement au disque temporaire D: |
| Identifier un data disk dans la VM | Par LUN (0, 1, 2...) | Logical Unit Number |

#### Acc√®s Externe aux VMs

**‚ö†Ô∏è Erreur Courante QCM : Minimize Administrative Effort**

**Sc√©nario :** Une VM est accessible uniquement depuis le r√©seau interne. Vous devez permettre l'acc√®s depuis Internet avec **effort administratif minimal**.

**‚ùå FAUX :** Configurer un VPN Site-to-Site
**‚úÖ CORRECT :** **Ajouter une adresse IP publique** √† la VM

**Comparaison des Solutions :**

| Solution | Complexit√© | Co√ªt* | Temps | Effort Admin |
|----------|------------|------|-------|--------------|
| **IP Publique** | ‚úÖ Tr√®s faible | ~$3/mois | 2 min | ‚úÖ Minimal |
| **Azure Bastion** | Moyenne | ~$150/mois | 15 min | Moyen |
| **VPN Site-to-Site** | ‚ùå √âlev√©e | ~$25-150/mois | 1-2h | ‚ùå √âlev√© |

**\*Co√ªts indicatifs** : Prix approximatifs pour la r√©gion US East. Les tarifs varient selon les r√©gions et changent fr√©quemment.

**Solution Recommand√©e - Ajouter une IP Publique :**

```bash
# 1. Cr√©er une IP publique
az network public-ip create \
  --resource-group myRG \
  --name myVM-PublicIP \
  --sku Standard \
  --allocation-method Static

# 2. Associer l'IP publique √† la NIC de la VM
az network nic ip-config update \
  --resource-group myRG \
  --nic-name myVM-NIC \
  --name ipconfig1 \
  --public-ip-address myVM-PublicIP
```

**‚ö†Ô∏è S√©curit√© - NSG Recommand√© :**

```bash
# Limiter l'acc√®s SSH/RDP √† votre IP uniquement
az network nsg rule create \
  --resource-group myRG \
  --nsg-name myVM-NSG \
  --name Allow-SSH-MyIP \
  --priority 100 \
  --source-address-prefixes 203.0.113.50/32 \
  --destination-port-ranges 22 \
  --access Allow \
  --protocol Tcp
```

**Pourquoi PAS VPN Site-to-Site ?**
- ‚ùå **Complexe** : Local Network Gateway, Virtual Network Gateway, Connection
- ‚ùå **Temps** : 1-2 heures de configuration
- ‚ùå **Co√ªt** : Gateway ~$25-150/mois
- ‚ö†Ô∏è **Use case** : Connectivit√© r√©seau entier, pas une seule VM

**Sc√©narios d'Examen :**
- **"Minimal administrative effort"** ‚Üí Add Public IP
- **"Secure access without exposing ports"** ‚Üí Azure Bastion
- **"Connect entire on-premises network"** ‚Üí VPN Site-to-Site

#### High Availability

**Availability Sets**

**D√©finition :**
- **Groupement logique** de VMs pour assurer la haute disponibilit√©
- **Protection** contre pannes mat√©rielles ET maintenances planifi√©es
- **Placement** : VMs distribu√©es sur plusieurs racks physiques
- **Scope** : M√™me datacenter (single region, single datacenter)
- **SLA** : 99.95% (au moins 1 VM disponible)
- **Gratuit** : Aucun co√ªt suppl√©mentaire pour l'availability set lui-m√™me

**Composants Cl√©s :**

**1. Fault Domains (FD) - Domaines de D√©faillance**
- **D√©finition** : Repr√©sente un rack physique dans le datacenter
- **Contenu** : Serveurs, switch r√©seau, source d'alimentation partag√©s
- **Maximum** : 3 Fault Domains par availability set
- **Protection** : Panne mat√©rielle (hardware failure, power outage, network switch failure)
- **Distribution** : Azure r√©partit automatiquement vos VMs sur les FDs

**Visualisation des Fault Domains :**
```
Datacenter Azure
‚îú‚îÄ‚îÄ Rack 1 (FD 0) - Alimentation A, Switch A
‚îÇ   ‚îú‚îÄ‚îÄ VM1
‚îÇ   ‚îî‚îÄ‚îÄ VM4
‚îú‚îÄ‚îÄ Rack 2 (FD 1) - Alimentation B, Switch B
‚îÇ   ‚îú‚îÄ‚îÄ VM2
‚îÇ   ‚îî‚îÄ‚îÄ VM5
‚îî‚îÄ‚îÄ Rack 3 (FD 2) - Alimentation C, Switch C
    ‚îú‚îÄ‚îÄ VM3
    ‚îî‚îÄ‚îÄ VM6
```

**Sc√©nario de panne FD :**
- **Probl√®me** : Rack 1 perd l'alimentation √©lectrique
- **Impact** : Seules VM1 et VM4 sont affect√©es
- **R√©sultat** : VM2, VM3, VM5, VM6 continuent de fonctionner
- **Disponibilit√©** : Au moins 2/3 des VMs restent disponibles

**2. Update Domains (UD) - Domaines de Mise √† Jour**
- **D√©finition** : Groupe logique de VMs red√©marr√©es ensemble lors de maintenances
- **Par d√©faut** : **5 Update Domains** (si non sp√©cifi√© √† la cr√©ation)
- **Configurable** : De 1 √† **20 Update Domains maximum**
- **Important** : Configuration d√©finie √† la cr√©ation, **non modifiable apr√®s**
- **Protection** : Maintenance planifi√©e Azure (host OS updates, hardware maintenance)
- **Processus** : Azure red√©marre un seul UD √† la fois
- **D√©lai** : 30 minutes minimum entre chaque UD red√©marr√©
- **‚ö†Ô∏è Note** : La valeur par d√©faut de 5 est suffisante pour la plupart des sc√©narios

**Visualisation des Update Domains :**
```
Update Domain 0: VM1, VM6
Update Domain 1: VM2, VM7
Update Domain 2: VM3, VM8
Update Domain 3: VM4, VM9
Update Domain 4: VM5, VM10

Maintenance planifi√©e :
√âtape 1: Red√©marre UD0 ‚Üí VM1, VM6 offline, autres OK
[Attend 30 min]
√âtape 2: Red√©marre UD1 ‚Üí VM2, VM7 offline, autres OK
[Attend 30 min]
√âtape 3: Red√©marre UD2 ‚Üí VM3, VM8 offline, autres OK
...
```

**Sc√©nario de maintenance UD :**
- **√âv√©nement** : Maintenance planifi√©e Azure
- **Processus** : Azure red√©marre UD par UD (jamais simultan√©ment)
- **Impact** : Maximum 1/5 (20%) des VMs offline √† un moment donn√©
- **Garantie** : Au moins 80% de capacit√© maintenue

**3. Combinaison FD + UD - Protection Double**

**Matrice de Distribution (Exemple : 6 VMs, 3 FD, 3 UD) :**
```
              FD 0 (Rack 1)  FD 1 (Rack 2)  FD 2 (Rack 3)
UD 0            VM1             VM2             VM3
UD 1            VM4             VM5             VM6
UD 2            VM7             VM8             VM9
```

**Protection simultan√©e :**
- **Panne FD 1** : Perd VM2, VM5, VM8 ‚Üí Garde VM1,3,4,6,7,9
- **Maintenance UD 0** : Red√©marre VM1, VM2, VM3 ‚Üí Garde VM4,5,6,7,8,9
- **Combin√©** : Jamais plus d'un FD ET un UD affect√© en m√™me temps

**Configuration et Contraintes :**

**Cr√©ation :**
- **Moment** : Doit √™tre configur√© AVANT ou PENDANT la cr√©ation de la VM
- **Modification** : IMPOSSIBLE de changer l'availability set d'une VM existante
- **Solution** : Recr√©er la VM si changement n√©cessaire

**Limitations importantes :**
- **Zone g√©ographique** : Limit√© √† un seul datacenter
- **Maximum VMs** : Limite technique de **200 VMs par availability set**
- **Famille de VM** : Toutes les VMs doivent √™tre de tailles compatibles
- **Managed Disks** : Fortement recommand√© (Aligned ou non)
- **Incompatibilit√©** : Ne peut PAS combiner avec Availability Zones

**Configuration PowerShell :**
```powershell
# Cr√©er l'Availability Set
New-AzAvailabilitySet `
  -ResourceGroupName "myRG" `
  -Name "myAvailabilitySet" `
  -Location "East US" `
  -PlatformFaultDomainCount 3 `
  -PlatformUpdateDomainCount 5 `
  -Sku Aligned

# Cr√©er VM dans l'Availability Set
New-AzVM `
  -ResourceGroupName "myRG" `
  -Name "myVM" `
  -AvailabilitySetName "myAvailabilitySet" `
  ...
```

**Configuration Azure CLI :**
```bash
# Cr√©er l'Availability Set
az vm availability-set create \
  --resource-group myRG \
  --name myAvailabilitySet \
  --platform-fault-domain-count 3 \
  --platform-update-domain-count 5

# Cr√©er VM dans l'Availability Set
az vm create \
  --resource-group myRG \
  --name myVM \
  --availability-set myAvailabilitySet \
  ...
```

**Best Practices :**

1. **Minimum 2 VMs par tier** : Pour b√©n√©ficier du SLA 99.95%
2. **Utiliser Managed Disks** : Meilleure r√©silience (Storage Fault Domains)
3. **Load Balancer** : Combiner avec Azure Load Balancer pour distribution trafic
4. **M√™me fonction** : Regrouper uniquement VMs ayant le m√™me r√¥le
5. **Planification** : Configurer d√®s la cr√©ation, impossible √† modifier apr√®s

**Cas d'usage typiques :**
- **Web tier** : Serveurs web dans un availability set
- **App tier** : Serveurs applicatifs dans un autre availability set
- **Data tier** : Serveurs de base de donn√©es dans un troisi√®me availability set
- **S√©paration** : Un availability set diff√©rent par tier applicatif

**Comparaison rapide :**
| Caract√©ristique | Availability Sets | Availability Zones |
|-----------------|-------------------|-------------------|
| **Protection** | Rack failure | Datacenter failure |
| **Fault Domains** | Max 3 | 3 zones |
| **Scope** | Single datacenter | Multiple datacenters |
| **SLA** | 99.95% | 99.99% |
| **Latence** | Minimale | L√©g√®rement plus √©lev√©e |
| **Co√ªt** | Gratuit | Frais de transfert inter-zones |

**Availability Zones**
- **Protection** : Datacenters physiquement s√©par√©s
- **SLA** : 99.99%
- **Scope** : R√©gion Azure

** Pr√©requis identifi√©s pour Availability Zones :**
- **Managed Disks** : Obligatoire
- **Availability Options** : Doit √™tre configur√© √† la cr√©ation

#### Acc√®s Externe aux VMs
** Cas d'usage identifi√© :** Acc√®s externe avec effort administratif minimal
- **Sc√©nario** : VM interne accessible uniquement depuis le r√©seau interne, besoin d'acc√®s externe
- **Solution optimale** : Ajouter une adresse IP publique √† la VM
- **Avantage** : Configuration simple et directe, effort administratif minimal

** Erreur fr√©quente identifi√©e :** Complexit√© inutile pour acc√®s externe simple
- ** Erreur** : Configurer un VPN Site-to-Site pour un acc√®s externe simple
- ** Correct** : Utiliser une adresse IP publique pour minimiser l'effort administratif
- **Raison** : VPN S2S = Configuration complexe (Local Network Gateway, Connection, etc.)
- **Alternative** : IP publique = Configuration simple et directe

#### VM Extensions (‚ö†Ô∏è Important pour l'Examen)

**D√©finition :**
- **VM Extensions** : Applications post-d√©ploiement qui automatisent la configuration des VMs
- **Moment d'ex√©cution** : Apr√®s la cr√©ation de la VM, durant le provisioning ou apr√®s
- **Use Cases** : Installation logiciels, configuration syst√®me, monitoring, security

**Extensions Courantes :**

**1. Custom Script Extension (‚ö†Ô∏è Le Plus Important pour l'Examen)**

Ex√©cute des scripts PowerShell (Windows) ou Bash (Linux) sur la VM.

**Windows - Custom Script Extension :**
```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScriptExtension \
  --publisher Microsoft.Compute \
  --version 1.10 \
  --settings '{"fileUris": ["https://raw.githubusercontent.com/user/repo/main/install.ps1"], "commandToExecute": "powershell.exe -ExecutionPolicy Unrestricted -File install.ps1"}'
```

**Linux - Custom Script Extension :**
```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScript \
  --publisher Microsoft.Azure.Extensions \
  --version 2.1 \
  --settings '{"fileUris": ["https://raw.githubusercontent.com/user/repo/main/install.sh"], "commandToExecute": "./install.sh"}'
```

**Exemple script install.sh (Linux) :**
```bash
#!/bin/bash
apt-get update
apt-get install -y nginx
systemctl start nginx
systemctl enable nginx
echo "nginx installed successfully" > /tmp/install.log
```

**2. Azure Monitor Agent (AMA)**

Collecte logs et m√©triques pour Azure Monitor.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name AzureMonitorLinuxAgent \
  --publisher Microsoft.Azure.Monitor \
  --enable-auto-upgrade true
```

**3. Azure Diagnostics Extension**

Collecte diagnostics et m√©triques d√©taill√©es.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name LinuxDiagnostic \
  --publisher Microsoft.Azure.Diagnostics \
  --version 4.0
```

**4. Desired State Configuration (DSC) - Windows**

Gestion de configuration d√©clarative pour Windows.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name DSC \
  --publisher Microsoft.Powershell \
  --version 2.83 \
  --settings '{"configuration": {"url": "https://storage/config.zip", "script": "config.ps1", "function": "WebServerConfig"}}'
```

**5. Azure Key Vault Extension**

Synchronise certificats depuis Key Vault vers la VM.

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name KeyVaultForLinux \
  --publisher Microsoft.Azure.KeyVault \
  --version 3.0 \
  --settings '{"secretsManagementSettings": {"pollingIntervalInS": "3600", "certificateStoreLocation": "/var/lib/waagent/Microsoft.Azure.KeyVault"}}'
```

**6. Azure AD Login Extension**

Authentification Azure AD pour SSH (Linux) ou RDP (Windows).

```bash
az vm extension set \
  --resource-group myRG \
  --vm-name myVM \
  --name AADSSHLoginForLinux \
  --publisher Microsoft.Azure.ActiveDirectory
```

**Gestion des Extensions :**

```bash
# Lister les extensions install√©es
az vm extension list \
  --resource-group myRG \
  --vm-name myVM \
  --output table

# Afficher d√©tails d'une extension
az vm extension show \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScriptExtension

# Supprimer une extension
az vm extension delete \
  --resource-group myRG \
  --vm-name myVM \
  --name CustomScriptExtension
```

**Sc√©narios d'Examen - Extensions :**

| Question | Extension | Raison |
|----------|-----------|--------|
| **Installer nginx automatiquement** | Custom Script Extension | Script bash/PowerShell |
| **Collecter logs vers Azure Monitor** | Azure Monitor Agent | Monitoring |
| **Authentification Azure AD** | AAD Login Extension | SSO avec Azure AD |
| **Synchroniser certificats SSL** | Key Vault Extension | S√©curit√© centralis√©e |
| **Configuration Windows automatique** | DSC Extension | Gestion √©tat d√©sir√© |

#### Azure Hybrid Benefit (‚ö†Ô∏è √âconomies Importantes)

**D√©finition :**
- **Azure Hybrid Benefit** : Utiliser vos licences Windows Server/SQL Server on-premises dans Azure
- **√âconomies** : Jusqu'√† **40% sur les co√ªts VM** Windows et 55% sur SQL Server
- **Pr√©requis** : Licences Windows Server avec Software Assurance active

**Licences √âligibles :**
- ‚úÖ **Windows Server** : Standard ou Datacenter avec Software Assurance
- ‚úÖ **SQL Server** : Enterprise ou Standard avec Software Assurance
- ‚úÖ **Red Hat Enterprise Linux (RHEL)** : Abonnements RHEL actifs
- ‚úÖ **SUSE Linux Enterprise Server (SLES)** : Abonnements SLES actifs

**Activation pour une VM Existante :**

```bash
# Activer Hybrid Benefit sur VM existante (Windows)
az vm update \
  --resource-group myRG \
  --name myVM \
  --license-type Windows_Server

# Activer pour SQL Server
az vm update \
  --resource-group myRG \
  --name myVM \
  --license-type RHEL_BYOS  # ou SLES_BYOS pour Linux
```

**Cr√©ation VM avec Hybrid Benefit :**

```bash
az vm create \
  --resource-group myRG \
  --name myVM \
  --image Win2022Datacenter \
  --license-type Windows_Server \
  --size Standard_D2s_v3 \
  --admin-username azureuser \
  --admin-password 'P@ssw0rd123!'
```

**Calcul √âconomies (Exemple) :**

| VM Size | Sans Hybrid Benefit | Avec Hybrid Benefit | √âconomie |
|---------|---------------------|---------------------|----------|
| **D2s_v3 Windows** | $96.36/mois | ~$58/mois | **~40%** |
| **D4s_v3 Windows** | $192.72/mois | ~$116/mois | **~40%** |
| **SQL Server Enterprise** | $500+/mois | ~$225/mois | **~55%** |

**Compliance :**
- ‚úÖ Vous devez avoir **licences valides** avec Software Assurance
- ‚úÖ Maximum **2 VMs Azure** par licence on-premises (pendant 180 jours pour migration)
- ‚ö†Ô∏è **Audit** : Microsoft peut v√©rifier la conformit√©

**V√©rifier le Statut :**
```bash
az vm show \
  --resource-group myRG \
  --name myVM \
  --query "licenseType"
```

#### Spot VMs (‚ö†Ô∏è √âconomies pour Workloads Interruptibles)

**D√©finition :**
- **Spot VMs** : VMs √† **prix r√©duit** (jusqu'√† 90%) utilisant la capacit√© inutilis√©e Azure
- **Risque** : Azure peut **r√©cup√©rer la VM** avec pr√©avis de 30 secondes si capacit√© n√©cessaire
- **Use Case** : Workloads tol√©rants aux interruptions (batch, dev/test, CI/CD)

**Caract√©ristiques :**
- üí∞ **Prix** : Jusqu'√† 90% moins cher que VMs standard
- ‚ö†Ô∏è **Eviction** : Azure peut arr√™ter la VM avec 30 sec de pr√©avis
- ‚úÖ **Eviction Policy** : Deallocate (arr√™t) ou Delete (suppression)
- üìä **Max Price** : Prix maximum que vous acceptez de payer

**Cr√©ation Spot VM :**

```bash
az vm create \
  --resource-group myRG \
  --name mySpotVM \
  --image UbuntuLTS \
  --size Standard_D2s_v3 \
  --priority Spot \
  --max-price -1 \
  --eviction-policy Deallocate \
  --admin-username azureuser \
  --generate-ssh-keys
```

**Param√®tres Importants :**
- **--priority Spot** : Active le mode Spot
- **--max-price -1** : Payer jusqu'au prix standard (jamais √©vinc√© pour prix)
- **--max-price 0.05** : Prix max de $0.05/heure (√©vinc√© si prix d√©passe)
- **--eviction-policy** : `Deallocate` (arr√™t) ou `Delete` (suppression)

**Eviction Policy :**

| Policy | Comportement | Use Case |
|--------|--------------|----------|
| **Deallocate** | VM arr√™t√©e, disques conserv√©s | Workload peut reprendre |
| **Delete** | VM et disques supprim√©s | Workload jetable (batch) |

**Cas d'Usage Adapt√©s :**
- ‚úÖ **Batch processing** : Jobs traitement par lots
- ‚úÖ **CI/CD agents** : Agents de build temporaires
- ‚úÖ **Dev/Test** : Environnements de d√©veloppement
- ‚úÖ **Simulations** : Calculs scientifiques interruptibles
- ‚úÖ **Rendering** : Rendu 3D/vid√©o distribu√©
- ‚ùå **Production 24/7** : Applications critiques n√©cessitant disponibilit√© continue
- ‚ùå **Databases** : Bases de donn√©es production

**Notifications Eviction :**

Azure envoie une notification 30 secondes avant l'eviction via Azure Metadata Service.

**Script d√©tection eviction (Linux) :**
```bash
#!/bin/bash
while true; do
  response=$(curl -H Metadata:true "http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01")
  if echo "$response" | grep -q "Preempt"; then
    echo "Eviction detected! Saving state..."
    # Sauvegarder √©tat, fermer connexions, etc.
    systemctl stop myapp
    exit 0
  fi
  sleep 5
done
```

**Comparaison Pricing (Exemple) :**

| VM Type | Prix Standard | Prix Spot | √âconomie |
|---------|---------------|-----------|----------|
| **D2s_v3 Linux** | $70/mois | ~$7-20/mois | **70-90%** |
| **D4s_v3 Linux** | $140/mois | ~$14-40/mois | **70-90%** |
| **F4s_v2** | $150/mois | ~$15-45/mois | **70-90%** |

**‚ö†Ô∏è Note** : Prix Spot fluctuent selon la demande, pas de garantie de prix fixe.

**V√©rifier Disponibilit√© et Prix Spot :**
```bash
# Voir prix Spot actuel pour une r√©gion
az vm list-skus \
  --location eastus \
  --size Standard_D2s_v3 \
  --output table
```

#### Proximity Placement Groups (‚ö†Ô∏è Latence Minimale)

**D√©finition :**
- **Proximity Placement Groups (PPG)** : Contrainte de placement pour grouper VMs physiquement proches
- **Objectif** : **Minimiser la latence r√©seau** entre VMs (< 1ms)
- **Use Case** : Applications haute performance (HPC, gaming, trading)

**Caract√©ristiques :**
- üöÄ **Latence** : < 1ms entre VMs du m√™me PPG
- üìç **Colocation** : VMs dans m√™me datacenter (parfois m√™me rack)
- ‚ö†Ô∏è **Limitation** : Capacit√© limit√©e (peut √©chouer si datacenter plein)

**Cr√©ation Proximity Placement Group :**

```bash
# Cr√©er un PPG
az ppg create \
  --resource-group myRG \
  --name myPPG \
  --location eastus \
  --type Standard

# Cr√©er VM dans le PPG
az vm create \
  --resource-group myRG \
  --name myVM1 \
  --image UbuntuLTS \
  --size Standard_D4s_v3 \
  --proximity-placement-group myPPG \
  --admin-username azureuser \
  --generate-ssh-keys

# Ajouter VM existante au PPG (n√©cessite arr√™t/red√©marrage)
az vm update \
  --resource-group myRG \
  --name myVM2 \
  --set proximityPlacementGroup.id=/subscriptions/{sub-id}/resourceGroups/myRG/providers/Microsoft.Compute/proximityPlacementGroups/myPPG
```

**Cas d'Usage :**
- ‚úÖ **HPC (High Performance Computing)** : Clusters calcul scientifique
- ‚úÖ **Gaming servers** : Serveurs jeu multijoueur
- ‚úÖ **SAP HANA** : Bases de donn√©es in-memory
- ‚úÖ **Trading platforms** : Applications latence-critique
- ‚úÖ **Distributed databases** : Cassandra, MongoDB clusters

**Combinaison avec Availability Sets :**

Vous pouvez combiner PPG avec Availability Sets pour latence faible + high availability.

```bash
# Cr√©er Availability Set dans PPG
az vm availability-set create \
  --resource-group myRG \
  --name myAvSet \
  --proximity-placement-group myPPG \
  --platform-fault-domain-count 2 \
  --platform-update-domain-count 5

# Cr√©er VMs dans l'Availability Set + PPG
az vm create \
  --resource-group myRG \
  --name myVM1 \
  --availability-set myAvSet \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys
```

**‚ö†Ô∏è Limitations :**
- ‚ùå **Incompatible avec Availability Zones** : Choisir entre PPG (latence) ou Zones (r√©silience)
- ‚ö†Ô∏è **Capacit√© limit√©e** : √âchec possible si datacenter satur√©
- ‚ö†Ô∏è **Red√©ploiement** : Ajouter VM existante n√©cessite arr√™t

**Matrice de D√©cision - Placement VMs :**

| Besoin | Solution | Trade-off |
|--------|----------|-----------|
| **Latence minimale** | Proximity Placement Group | R√©silience r√©duite |
| **Haute disponibilit√©** | Availability Zones | Latence plus √©lev√©e |
| **Balance latence/HA** | Availability Sets + PPG | Complexit√© accrue |
| **Disaster Recovery** | Availability Zones | Latence inter-zones |

#### Sc√©narios d'Examen - R√©capitulatif Complet

| Question Type | R√©ponse | Justification |
|---------------|---------|---------------|
| **Installer logiciel automatiquement** | Custom Script Extension | Post-deployment automation |
| **R√©duire co√ªts VMs Windows** | Azure Hybrid Benefit | 40% √©conomie avec licences |
| **Workload batch interruptible** | Spot VMs | 70-90% √©conomie |
| **Latence < 1ms entre VMs** | Proximity Placement Group | Colocation physique |
| **Attacher 3 disques d√®s cr√©ation** | `--data-disk-sizes-gb 128 256 512` | Azure CLI option simple |
| **Garantir HA datacenter failure** | Availability Zones | 99.99% SLA |
| **Garantir HA rack failure** | Availability Sets | 99.95% SLA |
| **Acc√®s externe minimal effort** | Ajouter IP publique | Configuration simple |
| **Collecter logs vers Monitor** | Azure Monitor Agent | Monitoring natif |