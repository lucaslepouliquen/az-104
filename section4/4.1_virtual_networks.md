### 4.1 Virtual Networks (VNet)

#### Concepts Fondamentaux
- **Address Space** : Plage CIDR privée 10.0.0.0/8 (16M d'adresses), 172.16.0.0/12 (1M d'adresses), 192.168.0.0/16 (65k adresses) 
- **Subnets** : Subdivision du VNet
- **Network Security Groups** : Firewalls au niveau subnet/NIC

#### VNet Peering - Configuration Détaillée

**⚠️ Erreur Courante QCM : Configuration bidirectionnelle obligatoire**

**Vue d'ensemble :**
VNet Peering établit une connexion privée entre deux réseaux virtuels Azure, permettant aux ressources de communiquer comme si elles étaient sur le même réseau.

**Types de Peering :**

| Type | Portée | Latence | Coût | Use Case |
|------|--------|---------|------|----------|
| **Regional VNet Peering** | Même région Azure | Ultra-faible | $0.01/GB (ingress + egress) | Apps multi-tier, partage de ressources |
| **Global VNet Peering** | Régions différentes | Faible | $0.035/GB (ingress + egress) | Multi-région, DR, geo-distribution |

**Caractéristiques Clés :**
- **Traffic** : 100% privé, transit par backbone Azure (pas d'Internet)
- **Bande passante** : Identique à celle d'un VNet unique
- **Latence** : Minimale, équivalente à un VNet local
- **Sécurité** : Trafic chiffré par défaut sur le réseau Azure
- **Gateway Transit** : Partage de VPN/ExpressRoute Gateways possible

**Configuration Obligatoire - Bidirectionnelle**

**⚠️ POINT CRITIQUE pour l'EXAMEN :**
- **Peering = 2 opérations distinctes**
- VNet1 → VNet2 (créer peering depuis VNet1)
- VNet2 → VNet1 (créer peering depuis VNet2)
- **Les deux doivent être configurés** pour établir la communication

**Visualisation :**
```
VNet1 (10.0.0.0/16)          VNet2 (172.16.0.0/16)
       │                             │
       │ ─────── Peering 1 ────────> │
       │                             │
       │ <────── Peering 2 ───────── │
       │                             │
    ✅ Communication établie
```

**Sans configuration bidirectionnelle :**
```
VNet1 (10.0.0.0/16)          VNet2 (172.16.0.0/16)
       │                             │
       │ ─────── Peering 1 ────────> │
       │                             │
       │         (pas de retour)     │
       │                             │
    ❌ Communication IMPOSSIBLE
```

**1. Règle d'Or : Plages d'adresses non-chevauchantes**

**⚠️ Prérequis OBLIGATOIRE :**
- **Principe** : Les plages d'adresses (CIDR) des deux VNets ne peuvent PAS se chevaucher
- **Vérification Azure** : Azure refuse automatiquement le peering si chevauchement détecté

**Exemples de Compatibilité :**

| VNet1 Address Space | VNet2 Address Space | Peering Possible ? | Raison |
|---------------------|---------------------|-------------------|--------|
| 10.0.0.0/16 | 172.16.0.0/16 | ✅ **OUI** | Plages complètement différentes |
| 10.0.0.0/16 | 10.1.0.0/16 | ✅ **OUI** | Pas de chevauchement |
| 192.168.0.0/24 | 192.168.1.0/24 | ✅ **OUI** | Sous-réseaux différents |
| 192.168.0.0/24 | 192.168.0.0/16 | ❌ **NON** | /24 inclus dans /16 |
| 10.0.0.0/16 | 10.0.0.0/24 | ❌ **NON** | /24 inclus dans /16 |
| 172.16.0.0/16 | 172.16.0.0/12 | ❌ **NON** | /16 inclus dans /12 |

**Erreur Fréquente en Examen :**
- **Question** : VNet1 (192.168.0.0/24) peut-il être peeré avec VNet3 (192.168.0.0/16) ?
- **Réponse correcte** : ❌ **NON**
- **Raison** : La plage 192.168.0.0/24 est **entièrement incluse** dans 192.168.0.0/16
- **Solution** : Utiliser des plages complètement distinctes (ex: 10.0.0.0/16 et 172.16.0.0/16)

**2. Configuration via Azure CLI - Étape par Étape**

**Étape 1 : Obtenir les Resource IDs**
```bash
# VNet1 ID
vnet1Id=$(az network vnet show \
  --resource-group RG1 \
  --name VNet1 \
  --query id --out tsv)

# VNet2 ID
vnet2Id=$(az network vnet show \
  --resource-group RG2 \
  --name VNet2 \
  --query id --out tsv)
```

**Étape 2 : Créer Peering VNet1 → VNet2**
```bash
az network vnet peering create \
  --name VNet1-to-VNet2 \
  --resource-group RG1 \
  --vnet-name VNet1 \
  --remote-vnet $vnet2Id \
  --allow-vnet-access
```

**Étape 3 : Créer Peering VNet2 → VNet1 (Obligatoire !)**
```bash
az network vnet peering create \
  --name VNet2-to-VNet1 \
  --resource-group RG2 \
  --vnet-name VNet2 \
  --remote-vnet $vnet1Id \
  --allow-vnet-access
```

**Étape 4 : Vérifier l'état du Peering**
```bash
# Vérifier depuis VNet1
az network vnet peering show \
  --resource-group RG1 \
  --vnet-name VNet1 \
  --name VNet1-to-VNet2 \
  --query peeringState

# Résultat attendu: "Connected"
```

**3. Configuration via PowerShell**

```powershell
# Créer Peering VNet1 → VNet2
Add-AzVirtualNetworkPeering `
  -Name "VNet1-to-VNet2" `
  -VirtualNetwork (Get-AzVirtualNetwork -Name "VNet1" -ResourceGroupName "RG1") `
  -RemoteVirtualNetworkId "/subscriptions/{sub-id}/resourceGroups/RG2/providers/Microsoft.Network/virtualNetworks/VNet2"

# Créer Peering VNet2 → VNet1 (Obligatoire !)
Add-AzVirtualNetworkPeering `
  -Name "VNet2-to-VNet1" `
  -VirtualNetwork (Get-AzVirtualNetwork -Name "VNet2" -ResourceGroupName "RG2") `
  -RemoteVirtualNetworkId "/subscriptions/{sub-id}/resourceGroups/RG1/providers/Microsoft.Network/virtualNetworks/VNet1"

# Vérifier l'état
Get-AzVirtualNetworkPeering `
  -ResourceGroupName "RG1" `
  -VirtualNetworkName "VNet1" | 
  Select-Object Name, PeeringState
```

**4. Options de Configuration Avancées**

**Options Disponibles :**

| Option | Description | Use Case |
|--------|-------------|----------|
| **allow-vnet-access** | Autoriser trafic entre VNets | Par défaut, toujours activé |
| **allow-forwarded-traffic** | Autoriser trafic transitif via NVA | Hub-spoke avec firewall |
| **allow-gateway-transit** | Partager VPN/ExpressRoute Gateway | VNet hub avec gateway |
| **use-remote-gateways** | Utiliser gateway du VNet distant | VNet spoke sans gateway |

**Exemple - Configuration Hub-Spoke :**
```bash
# Hub VNet (avec VPN Gateway)
az network vnet peering create \
  --name Hub-to-Spoke \
  --resource-group HubRG \
  --vnet-name HubVNet \
  --remote-vnet $spokeVnetId \
  --allow-vnet-access \
  --allow-gateway-transit

# Spoke VNet (utilise gateway du Hub)
az network vnet peering create \
  --name Spoke-to-Hub \
  --resource-group SpokeRG \
  --vnet-name SpokeVNet \
  --remote-vnet $hubVnetId \
  --allow-vnet-access \
  --use-remote-gateways
```

**5. Caractéristiques Non-Transitives**

**⚠️ Important pour l'Examen :**
VNet Peering est **NON-TRANSITIF** par défaut

**Scénario :**
```
VNet A ←→ VNet B ←→ VNet C
```
- VNet A peut communiquer avec VNet B ✅
- VNet B peut communiquer avec VNet C ✅
- VNet A **NE PEUT PAS** communiquer avec VNet C ❌

**Solution pour rendre transitif :**
- Créer un peering direct A ←→ C
- OU utiliser une architecture Hub-Spoke avec **allow-forwarded-traffic** et une appliance réseau (NVA) dans le hub

**6. Performance et Latence**
- **Bande passante** : Identique à celle d'un VNet local (pas de limite imposée par le peering)
- **Latence** : Ultra-faible (< 1ms en regional, quelques ms en global)
- **Throughput** : Dépend uniquement des VM sizes
- **Coût Regional** : $0.01/GB pour ingress et egress
- **Coût Global** : $0.035/GB pour ingress et egress (selon zones)

**7. Troubleshooting VNet Peering**

**Problèmes Courants :**

| Problème | Cause | Solution |
|----------|-------|----------|
| Peering en état "Initiated" | Peering bidirectionnel incomplet | Créer le peering retour |
| Communication impossible | NSG bloque le trafic | Vérifier règles NSG avec IP Flow Verify |
| Peering refusé | Adresses IP chevauchantes | Modifier les plages d'adresses |
| Gateway transit ne fonctionne pas | Options mal configurées | Vérifier allow-gateway-transit et use-remote-gateways |

**Commandes de Diagnostic :**
```bash
# Vérifier l'état du peering
az network vnet peering list \
  --resource-group myRG \
  --vnet-name myVNet \
  --output table

# Vérifier les plages d'adresses
az network vnet show \
  --resource-group myRG \
  --name myVNet \
  --query addressSpace.addressPrefixes

# Tester la connectivité (depuis une VM)
ping <private-ip-remote-vm>
```

**8. Configuration dans le Portail Azure**
- **Navigation** : Virtual Network → Peerings → + Add
- **Bidirectionnel** : Cocher "Configure peering settings on both VNets"
- **Validation automatique** : Azure vérifie la compatibilité des plages
- **État** : Doit afficher "Connected" des deux côtés

**9. Best Practices**

✅ **À FAIRE :**
- Planifier les plages d'adresses dès le début (éviter chevauchements)
- Toujours configurer le peering dans les deux sens
- Utiliser des conventions de nommage claires (VNet1-to-VNet2)
- Documenter la topologie réseau
- Tester la connectivité après création

❌ **À ÉVITER :**
- Utiliser des plages d'adresses chevauchantes
- Oublier le peering bidirectionnel
- Compter sur la transitivité par défaut
- Ignorer les NSG qui peuvent bloquer le trafic

#### DNS Resolution

** Point identifié :** DNS interne Azure
- **Format automatique** : `vm-name.internal.cloudapp.net`
- **Usage** : Résolution entre VMs dans VNet
- **Custom DNS** : Possibilité d'utiliser ses propres serveurs

### 4.1.1 Azure Private DNS Zones

#### Concepts et Fonctionnalités

**Azure Private DNS Zone**
- **Usage** : Résolution DNS privée pour ressources Azure dans un VNet
- **Avantages** : 
  - Noms personnalisés pour ressources internes
  - Résolution entre VNets connectés
  - Pas besoin de serveurs DNS personnalisés
- **Domaines** : Domaines personnalisés (ex: contoso.internal)

#### Virtual Network Links

**Processus d'association identifié :**
Pour associer un VNet à une Private DNS Zone, vous devez :
1. **Créer un Virtual Network Link** dans la zone DNS privée
2. **Sélectionner le VNet** à associer
3. **Configurer l'auto-registration** (optionnel)
4. **Valider** l'association

**Caractéristiques des Virtual Network Links :**
- **Fonction** : Lie un VNet à une zone DNS privée
- **Résolution** : Les VMs du VNet peuvent résoudre les enregistrements de la zone
- **Auto-registration** : Enregistrement automatique des VMs dans la zone DNS
- **Bi-directionnel** : Un VNet peut être lié à plusieurs zones DNS

#### Azure DNS Private Resolver

**Rôle et Utilisation :**
- **Fonction principale** : Proxy pour requêtes DNS entre environnements on-premises et Azure DNS
- **Scénario** : Connectivité hybride (on-premises <--> Azure)
- **Avantages** :
  - Résolution DNS bidirectionnelle
  - Intégration transparente avec Private DNS Zones
  - Pas de gestion de serveurs DNS
- **Architecture** : Service géré déployé dans un VNet

**Comparaison des Solutions DNS :**

**Virtual Network Link (Recommandé pour Azure-only)**
- **Usage** : Association VNet --> Private DNS Zone
- **Scope** : Azure uniquement
- **Configuration** : Simple, intégré
- **Coût** : Inclus avec Private DNS

**Azure DNS Private Resolver (Hybride)**
- **Usage** : Proxy DNS on-premises <--> Azure
- **Scope** : Environnements hybrides
- **Configuration** : Déploiement dans VNet requis
- **Coût** : Service facturé séparément

**Custom DNS Server (Non recommandé pour Private DNS)**
- **Usage** : Serveurs DNS personnalisés (VM ou appliance)
- **Limitation** : Configuration complexe, ne fonctionne pas nativement avec Private DNS Zones
- **Maintenance** : Gestion manuelle requise
- **Coût** : Infrastructure + maintenance

#### User-Defined Routes (UDR)
** Cas d'usage identifié :** Redirection de trafic vers appliances réseau
- **Objectif** : Forcer le trafic à passer par des appliances spécifiques (firewalls, appliances d'inspection)
- **Mécanisme** : Azure crée automatiquement une table de routage pour chaque sous-réseau avec des routes système par défaut
- **Override** : Les UDR permettent de remplacer certaines routes système Azure
- **Application** : Le trafic sortant d'un sous-réseau suit les routes de la table de routage du sous-réseau

** Erreur fréquente identifiée :** Confusion entre routes système et UDR
- ** Erreur** : Essayer de modifier les routes système par défaut
- ** Correct** : Créer des User-Defined Routes pour rediriger le trafic
- **Principe** : Les routes système sont gérées par Azure, les UDR permettent de surcharger le comportement

