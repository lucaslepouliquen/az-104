```markdown
### 4.2 Network Security Groups (NSG)
Can be used with subnet or NIC

#### Règles de Sécurité
- **Priority** : 100-4096, plus bas = plus prioritaire
- **Direction** : Inbound, Outbound
- **Action** : Allow, Deny

#### Architecture et Association
**Optimisation identifiée :**
- **Un NSG peut être associé à plusieurs ressources**
- **5 VMs avec mêmes règles = 5 NICs + 1 NSG**
- Partage possible entre subnets et NICs

**Limites par NSG :**
- **Max 1 NSG par subnet**
- **Max 1 NSG par NIC**
- **Max 1000 règles par NSG** (par défaut 200, augmentable via quota)
- **Évaluation séquentielle** : dès qu'une règle match, l'évaluation s'arrête

---

## Tips Critiques pour AZ-104

### 1. Système de Priorités NSG
- **Règle fondamentale** : Plus le numéro de priorité est bas, plus la règle est prioritaire
- **Exemple critique** : Priority 100 > Priority 200 (100 est PLUS prioritaire)
- **Impact** : Une règle Deny avec priorité 100 bloque une règle Allow avec priorité 200
- **Évaluation séquentielle** : Dès qu'une règle correspond (match), l'évaluation s'arrête
  - Si Priority 100 = Allow → le trafic passe (règles 200-4096 ignorées)
  - Si Priority 100 = Deny → le trafic est bloqué (règles 200-4096 ignorées)

### 2. Ordre d'Évaluation : Direction du Trafic = Critique ⚠️

**TRAFIC ENTRANT (Inbound) :**
```
Internet/External → NSG Subnet → NSG NIC → VM
                     (1er)        (2ème)
```
- Le NSG du subnet est évalué EN PREMIER
- Puis le NSG de la NIC est évalué
- Les DEUX doivent autoriser le trafic pour qu'il passe

**TRAFIC SORTANT (Outbound) :**
```
VM → NSG NIC → NSG Subnet → Internet/External
     (1er)      (2ème)
```
- Le NSG de la NIC est évalué EN PREMIER
- Puis le NSG du subnet est évalué
- Les DEUX doivent autoriser le trafic pour qu'il passe

**Principe clé :** Un seul Deny à n'importe quel niveau bloque tout le trafic

**Exemple pratique :**
- **Inbound** : NSG Subnet Allow port 443 + NSG NIC Deny port 443 = **Trafic bloqué**
- **Outbound** : NSG NIC Allow Internet + NSG Subnet Deny Internet = **Trafic bloqué**

### 3. Caractère Stateful des NSG

**Important pour l'exam :**
- Les NSG sont **stateful** : une fois qu'un flux est autorisé dans une direction, le trafic de retour est automatiquement autorisé
- **Pas besoin de règle explicite pour le trafic de retour**
- Exemple : Si vous autorisez l'inbound port 443, la réponse outbound est automatique

**Différence avec les pare-feu traditionnels :**
- Pare-feu stateless : nécessite des règles explicites dans les 2 directions
- NSG (stateful) : une seule règle suffit pour le flux bidirectionnel

### 4. Stratégies de Résolution de Problèmes

**Méthodologie de diagnostic :**
1. **Identifier la direction** : Inbound ou Outbound ?
2. **Vérifier l'ordre d'évaluation** :
   - Inbound : Subnet → NIC
   - Outbound : NIC → Subnet
3. **Examiner les priorités** : Identifier les règles conflictuelles par numéro
4. **Vérifier les actions** : Allow vs Deny aux deux niveaux
5. **Tester** : Utiliser **Network Watcher** → **IP Flow Verify** pour valider

**Solutions courantes :**
- Modifier la priorité de la règle conflictuelle
- Changer l'action (Allow/Deny)
- Ajouter une règle plus prioritaire (numéro plus bas)
- Supprimer la règle au niveau NIC ou Subnet (si redondante)

---

## Default Rules (Règles par Défaut)

**⚠️ Ces règles NE PEUVENT PAS être supprimées, seulement surchargées avec Priority < 65000**

### Inbound Default Rules
| Nom | Priority | Source | Destination | Port | Action |
|-----|----------|--------|-------------|------|--------|
| AllowVNetInBound | 65000 | VirtualNetwork | VirtualNetwork | Any | Allow |
| AllowAzureLoadBalancerInBound | 65001 | AzureLoadBalancer | Any | Any | Allow |
| DenyAllInBound | 65500 | Any | Any | Any | Deny |

### Outbound Default Rules
| Nom | Priority | Source | Destination | Port | Action |
|-----|----------|--------|-------------|------|--------|
| AllowVNetOutBound | 65000 | VirtualNetwork | VirtualNetwork | Any | Allow |
| AllowInternetOutBound | 65001 | Any | Internet | Any | Allow |
| DenyAllOutBound | 65500 | Any | Any | Any | Deny |

**Comportement par défaut :**
- ✅ Trafic VNet-to-VNet autorisé (dans les deux directions)
- ✅ Trafic depuis Azure Load Balancer autorisé (inbound)
- ✅ Trafic vers Internet autorisé (outbound)
- ❌ Tout autre trafic inbound bloqué par défaut

---

## Fonctionnalités Avancées (AZ-104)

### Service Tags
**Définition :** Représentent un groupe d'adresses IP pour un service Azure

**Avantages :**
- Pas besoin de connaître les plages IP
- Mises à jour automatiques par Microsoft
- Simplifient la maintenance des règles

**Service Tags courants :**
- `VirtualNetwork` : Tout le réseau virtuel (y compris on-premises via VPN/ExpressRoute)
- `AzureLoadBalancer` : Infrastructure Azure Load Balancer
- `Internet` : Tout l'espace IP public Internet
- `Storage` : Service Azure Storage
- `Sql` : Azure SQL Database
- `AzureActiveDirectory` : Azure AD
- `AzureKeyVault` : Azure Key Vault
- `Storage.WestEurope` : Storage dans une région spécifique

**Utilisation dans les règles :**
```
Source: Service Tag = "Storage"
Destination: VirtualNetwork
Port: 443
Action: Allow
```

### Application Security Groups (ASG)

**Définition :** Groupes logiques de VMs utilisables dans les règles NSG

**Avantages :**
- Organisation par rôle/fonction (ex: WebServers, DatabaseServers)
- Pas de gestion d'adresses IP individuelles
- Ajout/suppression de VMs sans modifier les règles NSG

**Exemple d'architecture :**
```
ASG "WebServers" → VM1, VM2, VM3
ASG "DatabaseServers" → VM4, VM5

Règle NSG:
Source: ASG "WebServers"
Destination: ASG "DatabaseServers"
Port: 1433
Action: Allow
```

**Utilisation :**
1. Créer les ASG : `WebServers`, `DatabaseServers`
2. Associer les NICs des VMs aux ASG
3. Créer des règles NSG utilisant les ASG comme source/destination

### Augmented Rules (Règles Augmentées)

**Définition :** Possibilité de spécifier plusieurs valeurs dans une seule règle

**Syntaxe :**
- **Ports multiples** : `80,443,8080`
- **Plages de ports** : `3000-4000`
- **Adresses IP multiples** : `10.0.0.4,10.0.1.5`
- **Préfixes CIDR multiples** : `10.0.0.0/24,10.1.0.0/24`

**Avantage :**
- Réduction du nombre de règles (important pour la limite de 1000)
- Meilleure lisibilité
- Gestion simplifiée

**Exemple :**
```
Au lieu de :
- Règle 1 : Source 10.0.0.4 → Port 80
- Règle 2 : Source 10.0.0.5 → Port 80
- Règle 3 : Source 10.0.0.4 → Port 443

Une seule règle :
Source: 10.0.0.4,10.0.0.5
Destination: Any
Ports: 80,443
Action: Allow
```

---

## Scénarios d'Exam AZ-104

### Scénario 1 : Blocage inattendu
**Situation :**
- NSG Subnet : Allow port 443, Priority 100
- NSG NIC : Deny port 443, Priority 100
- **Résultat** : Trafic HTTPS bloqué

**Explication :** Pour l'inbound, le subnet autorise mais la NIC bloque → trafic bloqué

**Solution :** 
- Supprimer la règle Deny sur la NIC
- OU changer en Allow sur la NIC
- OU ne pas associer de NSG à la NIC (hériter du subnet uniquement)

### Scénario 2 : Règles conflictuelles
**Situation :**
- Priority 100 : Deny port 22 (SSH)
- Priority 200 : Allow port 22 (SSH)
- **Résultat** : SSH bloqué

**Explication :** Priority 100 est évaluée en premier et bloque → Priority 200 jamais atteinte

**Solution :**
- Inverser les priorités (Allow = 100, Deny = 200)
- OU supprimer la règle Deny 100
- OU modifier l'action de la Priority 100 en Allow

### Scénario 3 : Communication inter-VMs
**Situation :**
- 2 VMs dans le même VNet, subnets différents
- Communication bloquée

**Diagnostic :**
1. Vérifier la règle par défaut `AllowVNetInBound` (Priority 65000)
2. Chercher des règles custom avec Priority < 65000 qui bloquent
3. Vérifier les NSG aux deux niveaux (subnet ET NIC)

**Solution typique :** Supprimer ou modifier la règle custom qui bloque le trafic VNet

### Scénario 4 : Trafic sortant vers Internet
**Situation :**
- VM ne peut pas accéder à Internet
- Règle par défaut `AllowInternetOutBound` existe (Priority 65001)

**Diagnostic :**
1. Vérifier le NSG de la NIC (évalué EN PREMIER pour outbound)
2. Vérifier le NSG du subnet (évalué EN SECOND pour outbound)
3. Chercher une règle Deny avec Priority < 65001

**Solution typique :**
- Ajouter une règle Allow Internet avec Priority < 65001
- OU supprimer la règle Deny qui bloque

---

## Best Practices pour AZ-104

### Organisation
1. **Convention de nommage** : `nsg-<environment>-<role>-<region>`
   - Exemple : `nsg-prod-web-westeurope`

2. **Réutilisation** : 
   - Créer des NSG par rôle (web, database, management)
   - Associer le même NSG à plusieurs ressources identiques

3. **Documentation** :
   - Commenter les règles avec le champ "Description"
   - Documenter le business case de chaque règle

### Sécurité
1. **Principe du moindre privilège** :
   - Bloquer tout par défaut
   - Autoriser uniquement le strict nécessaire
   - Utiliser des règles spécifiques (éviter "Any")

2. **Gestion des priorités** :
   - Réserver 100-199 pour les règles critiques (Deny)
   - Utiliser 200-299 pour les règles d'application (Allow)
   - Garder 300+ pour les règles temporaires/tests

3. **Audit régulier** :
   - Utiliser **Network Watcher** → **NSG Diagnostics**
   - Activer **NSG Flow Logs** pour l'analyse du trafic
   - Revoir les règles inutilisées tous les trimestres

### Performance
1. **Optimiser le nombre de règles** :
   - Utiliser les Augmented Rules (ports multiples)
   - Utiliser les Service Tags
   - Utiliser les ASG pour grouper les VMs

2. **Placement optimal** :
   - NSG au niveau subnet pour règles communes
   - NSG au niveau NIC pour règles spécifiques à une VM
   - Éviter la duplication entre subnet et NIC

---

## Outils de Diagnostic Azure

### Network Watcher - IP Flow Verify
**Usage :** Tester si un paquet serait autorisé ou bloqué

**Paramètres :**
- VM source/destination
- Direction (Inbound/Outbound)
- Protocole (TCP/UDP)
- Port local/distant
- Adresse IP locale/distante

**Résultat :**
- Access: Allowed/Denied
- Règle NSG responsable (nom, priorité, action)

### Network Watcher - NSG Diagnostics
**Usage :** Vue complète des règles NSG appliquées à une NIC

**Informations fournies :**
- Toutes les règles effective (subnet + NIC)
- Ordre d'évaluation
- Règles par défaut visibles

### NSG Flow Logs
**Usage :** Logs détaillés de tout le trafic traversant un NSG

**Informations capturées :**
- Source/Destination IP et ports
- Protocole
- Décision (Allow/Deny)
- Règle NSG appliquée
- Nombre de paquets/bytes

**Stockage :** Azure Storage Account (analyse avec Traffic Analytics)

---

## Checklist AZ-104 : NSG

✅ **Comprendre l'ordre d'évaluation** :
   - Inbound : Subnet → NIC
   - Outbound : NIC → Subnet

✅ **Maîtriser le système de priorités** :
   - 100-4096 (plus bas = plus prioritaire)
   - Évaluation séquentielle (première correspondance = décision finale)

✅ **Connaître les règles par défaut** :
   - Priorités 65000-65500
   - Non supprimables, surchargeable avec Priority < 65000

✅ **Savoir utiliser** :
   - Service Tags (Storage, Sql, VirtualNetwork...)
   - ASG pour grouper les VMs logiquement
   - Augmented Rules pour optimiser

✅ **Diagnostiquer avec Network Watcher** :
   - IP Flow Verify pour tester un flux spécifique
   - NSG Diagnostics pour voir toutes les règles effectives

✅ **Connaître les limites** :
   - 1 NSG max par subnet
   - 1 NSG max par NIC
   - 1000 règles max par NSG

✅ **Comprendre le caractère stateful** :
   - Pas besoin de règle de retour explicite
   - Le flux retour est automatiquement autorisé

---

## Erreurs Courantes à Éviter

❌ **Confondre l'ordre d'évaluation Inbound/Outbound**
   - Inbound ≠ Outbound dans l'ordre NSG Subnet/NIC

❌ **Oublier qu'une règle Deny prioritaire bloque tout**
   - Une Deny en Priority 100 rend inutile une Allow en Priority 200

❌ **Ne pas utiliser Network Watcher pour diagnostiquer**
   - IP Flow Verify donne la réponse exacte en quelques clics

❌ **Dupliquer les règles entre Subnet et NIC**
   - Surcharge inutile et confusion dans le troubleshooting

❌ **Oublier que les Default Rules existent toujours**
   - Elles sont là même si invisibles dans la liste des règles custom

❌ **Utiliser "Any" partout**
   - Compromet la sécurité et rend le diagnostic difficile

❌ **Ne pas documenter les règles**
   - 6 mois plus tard, personne ne sait pourquoi une règle existe

---

## Pour Aller Plus Loin

**Documentation Microsoft :**
- [NSG Overview](https://learn.microsoft.com/azure/virtual-network/network-security-groups-overview)
- [Network Watcher](https://learn.microsoft.com/azure/network-watcher/)
- [Service Tags](https://learn.microsoft.com/azure/virtual-network/service-tags-overview)
- [Application Security Groups](https://learn.microsoft.com/azure/virtual-network/application-security-groups)

**Labs pratiques recommandés :**
1. Créer un NSG multi-tiers (Web/App/Database)
2. Tester l'ordre d'évaluation Inbound/Outbound avec IP Flow Verify
3. Configurer des ASG et tester la communication inter-groupes
4. Activer NSG Flow Logs et analyser le trafic

```