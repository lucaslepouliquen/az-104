### 4.4 Network Watcher - Outils de Diagnostic Réseau

**⚠️ Erreur Courante QCM : Choisir le bon outil Network Watcher**

#### Vue d'ensemble et Outils
**Azure Network Watcher** est un service central de monitoring et diagnostic réseau qui fournit des outils pour :
- **Monitoring** : Surveillance continue des ressources réseau
- **Diagnostics** : Identification et résolution de problèmes de connectivité
- **Métriques** : Visualisation des performances réseau
- **Logging** : Activation/désactivation des logs pour ressources Azure VNet

**Disponibilité :**
- **Activation** : Automatique lors de la création d'un VNet
- **Scope** : Par région (un Network Watcher par région)
- **Gestion** : Network Watcher → Région → Outils disponibles

**Outils Network Watcher - Vue d'ensemble :**

| Outil | Use Case Principal | Sortie | Rapidité | Complexité |
|-------|-------------------|--------|----------|------------|
| **IP Flow Verify** | Vérifier si NSG bloque | Allow/Deny + Règle NSG | Immédiat | Faible |
| **Connection Troubleshoot** | Tester connectivité VM → VM | Reachable/Unreachable | Rapide | Faible |
| **Next Hop** | Vérifier routage | Type de hop suivant | Immédiat | Faible |
| **Topology** | Visualiser architecture | Diagramme réseau | Rapide | Faible |
| **Packet Capture** | Analyser trafic détaillé | Fichier .cap | Long | Élevée |
| **NSG Flow Logs** | Analyser historique trafic | Logs JSON | Délai analyse | Élevée |
| **Connection Monitor** | Surveiller latence continue | Métriques temps réel | Continu | Moyenne |

#### 1. IP Flow Verify - Diagnostic NSG (⭐ Outil Principal pour NSG)

**⚠️ Scénario d'Examen Typique :**
- **Question** : "Une VM ne peut pas se connecter à une autre VM. Quel outil utiliser pour identifier la règle NSG bloquante ?"
- **Réponse correcte** : **IP Flow Verify**

**Fonctionnalités principales :**
- **Spécification complète** : Source/destination IPv4, port, protocole (TCP/UDP), direction (inbound/outbound)
- **Identification précise** : Identifie le **NSG spécifique** et la **règle exacte** qui bloque
- **Résultat immédiat** : Allow ou Deny avec détails de la règle
- **Cas d'usage** : Troubleshooting rapide des problèmes de connectivité NSG

**Configuration via Azure CLI :**
```bash
# Vérifier si le trafic est autorisé
az network watcher test-ip-flow \
  --resource-group myRG \
  --vm myVM \
  --direction Outbound \
  --protocol TCP \
  --local 10.0.0.4:80 \
  --remote 10.1.0.4:3389

# Résultat exemple :
# Access: Deny
# Rule Name: UserRule_DenyRDP
# NSG: myNSG
```

**Configuration via PowerShell :**
```powershell
Test-AzNetworkWatcherIPFlow `
  -NetworkWatcher $nw `
  -TargetVirtualMachineId $vm.Id `
  -Direction Outbound `
  -Protocol TCP `
  -LocalIPAddress "10.0.0.4" `
  -LocalPort "80" `
  -RemoteIPAddress "10.1.0.4" `
  -RemotePort "3389"
```

**Sortie Détaillée :**
```json
{
  "access": "Deny",
  "ruleName": "SecurityRule_DenyAll",
  "networkSecurityGroup": "/subscriptions/.../networkSecurityGroups/myNSG"
}
```

**Avantages :**
- ✅ **Identification directe** du NSG bloquant
- ✅ **Configuration minimale**, test immédiat
- ✅ **Résultat précis** : règle NSG exacte responsable du blocage
- ✅ **Usage** : Diagnostic rapide et précis

#### 2. Connection Troubleshoot - Test de Connectivité End-to-End

**Use Case :**
- Tester la connectivité entre deux ressources Azure
- Identifier si la communication est possible (reachable/unreachable)
- Détecter les problèmes de routage, NSG, firewall

**Sources supportées :**
- Virtual Machines
- VM Scale Sets
- Application Gateway
- Azure Bastion

**Destinations supportées :**
- VM (IP privée)
- URI (HTTP/HTTPS)
- FQDN (nom de domaine)
- IPv4 publique ou privée

**Configuration via Azure CLI :**
```bash
# Tester connectivité VM → VM
az network watcher test-connectivity \
  --resource-group myRG \
  --source-resource myVM1 \
  --dest-resource myVM2 \
  --protocol TCP \
  --dest-port 443

# Tester connectivité VM → URL
az network watcher test-connectivity \
  --resource-group myRG \
  --source-resource myVM1 \
  --dest-address www.microsoft.com \
  --protocol TCP \
  --dest-port 443
```

**Sortie Exemple :**
```json
{
  "connectionStatus": "Reachable",
  "avgLatencyInMs": 4,
  "minLatencyInMs": 2,
  "maxLatencyInMs": 8,
  "probesSent": 10,
  "probesFailed": 0
}
```

**Cas d'échec - Diagnostics :**
```json
{
  "connectionStatus": "Unreachable",
  "hops": [
    {
      "type": "Source",
      "id": "myVM1",
      "issues": []
    },
    {
      "type": "VirtualNetwork",
      "issues": []
    },
    {
      "type": "NetworkSecurityGroup",
      "id": "myNSG",
      "issues": [
        {
          "type": "NetworkSecurityRule",
          "context": ["Rule 'DenyHTTPS' blocked the connection"]
        }
      ]
    }
  ]
}
```

#### 3. Next Hop - Vérification du Routage

**Use Case :**
- Déterminer comment le trafic est routé depuis une VM
- Identifier le prochain saut (next hop) pour une destination
- Diagnostiquer problèmes de routage (UDR, routes système)

**Types de Next Hop :**
- **Internet** : Trafic vers Internet
- **VirtualAppliance** : Via une appliance réseau (NVA)
- **VirtualNetworkGateway** : Via VPN ou ExpressRoute Gateway
- **VnetLocal** : Destination dans le même VNet
- **VNetPeering** : Destination via VNet Peering
- **None** : Aucun routage (trafic bloqué)

**Configuration via Azure CLI :**
```bash
az network watcher show-next-hop \
  --resource-group myRG \
  --vm myVM \
  --source-ip 10.0.0.4 \
  --dest-ip 10.1.0.4

# Résultat :
# NextHopType: VNetPeering
# NextHopIpAddress: 10.1.0.4
# RouteTableId: System Route
```

**Scénario d'Examen :**
| Question | Next Hop Type | Raison |
|----------|---------------|--------|
| Trafic vers 8.8.8.8 | **Internet** | Destination publique |
| Trafic vers 10.1.0.4 (VNet peeré) | **VNetPeering** | Via peering |
| Trafic via NVA Firewall | **VirtualAppliance** | UDR configuré |
| Trafic vers on-premises via VPN | **VirtualNetworkGateway** | Via VPN Gateway |

#### 4. Topology - Visualisation du Réseau

**Use Case :**
- Visualiser l'architecture réseau d'un Resource Group
- Comprendre les interconnexions entre ressources
- Identifier rapidement la topologie globale

**Éléments affichés :**
- VNets et Subnets
- VMs et NICs
- Load Balancers
- Application Gateways
- VNet Peerings
- VPN Gateways
- NSGs associés

**Configuration via Azure CLI :**
```bash
az network watcher show-topology \
  --resource-group myRG \
  --output json > topology.json
```

**Utilisation Portal :**
```
Network Watcher → Topology → Sélectionner Resource Group
```

#### 5. Packet Capture - Analyse de Paquets Réseau

**Use Case :**
- Capture détaillée du trafic réseau pour analyse approfondie
- Debugging de problèmes applicatifs (HTTP, SQL, etc.)
- Analyse de sécurité (détection d'intrusions)

**Configuration :**
```bash
# Démarrer une capture
az network watcher packet-capture create \
  --resource-group myRG \
  --vm myVM \
  --name myCapture \
  --storage-account mystorageaccount \
  --time-limit 60

# Arrêter la capture
az network watcher packet-capture stop \
  --resource-group myRG \
  --name myCapture \
  --location eastus

# Télécharger et analyser avec Wireshark
```

**Limitations :**
- Nécessite l'extension VM Network Watcher
- Capture limitée en durée (max 5 heures)
- Impact potentiel sur les performances VM
- Fichiers .cap volumineux

**⚠️ Important :** Ne convient PAS pour identifier rapidement un NSG bloquant (utiliser IP Flow Verify)

#### 6. NSG Flow Logs - Analyse Historique du Trafic

**Use Case :**
- Analyser le trafic IP à travers les NSG sur une période prolongée
- Auditer et tracer les connexions réseau
- Détecter anomalies et patterns de trafic
- Conformité et forensic

**Configuration :**
```bash
# Activer NSG Flow Logs
az network watcher flow-log create \
  --resource-group myRG \
  --nsg myNSG \
  --storage-account mystorageaccount \
  --enabled true \
  --retention 90 \
  --format JSON \
  --log-version 2

# Activer Traffic Analytics (optionnel)
az network watcher flow-log configure \
  --nsg myNSG \
  --enabled true \
  --storage-account mystorageaccount \
  --workspace myLogAnalyticsWorkspace \
  --traffic-analytics true
```

**Format des Logs (Version 2) :**
```json
{
  "time": "2025-10-27T10:00:00Z",
  "systemId": "xxx",
  "macAddress": "00-0D-3A-...",
  "category": "NetworkSecurityGroupFlowEvent",
  "resourceId": "/subscriptions/.../networkSecurityGroups/myNSG",
  "operationName": "NetworkSecurityGroupFlowEvents",
  "properties": {
    "Version": 2,
    "flows": [
      {
        "rule": "Allow-HTTP",
        "flows": [
          {
            "mac": "00-0D-3A-...",
            "flowTuples": [
              "1698393600,10.0.0.4,10.1.0.4,80,3389,T,I,A,C,1024,512,10,5"
            ]
          }
        ]
      }
    ]
  }
}
```

**Tuple Format :**
```
timestamp,source_ip,dest_ip,source_port,dest_port,protocol,flow_direction,flow_state,encryption,bytes_sent,bytes_received,packets_sent,packets_received
```

**Traffic Analytics :**
- **Visualisation** : Dashboards dans Azure Monitor
- **Insights** : Top talkers, blocked traffic, geo-distribution
- **Alerting** : Alertes sur anomalies détectées

**Limitations :**
- ❌ Configuration complexe (Storage Account + Log Analytics requis)
- ❌ Analyse manuelle des logs JSON
- ❌ Délai d'ingestion (5-10 minutes)
- ❌ Ne pointe pas directement le NSG problématique en temps réel

#### 7. Connection Monitor - Surveillance Continue de Latence

**Use Case :**
- Mesurer la latence (RTT - Round Trip Time) entre VMs en continu
- Surveiller la disponibilité des endpoints
- Détecter dégradations de performance réseau
- Monitoring proactif

**Caractéristiques :**
- **Granularité** : Métriques par minute
- **Targets** : VM, FQDN, URI, IPv4 privée/publique
- **Protocols** : TCP, HTTP, HTTPS, ICMP
- **Monitoring** : 24/7 avec historique

**Configuration via Azure CLI :**
```bash
# Créer un Connection Monitor
az network watcher connection-monitor create \
  --name myConnectionMonitor \
  --location eastus \
  --endpoint-source-name VM1 \
  --endpoint-source-resource-id $vm1Id \
  --endpoint-dest-name VM2 \
  --endpoint-dest-resource-id $vm2Id \
  --test-config-name HTTPTest \
  --protocol HTTP \
  --http-port 80 \
  --test-frequency 60

# Voir les résultats
az network watcher connection-monitor show \
  --name myConnectionMonitor \
  --location eastus
```

**Métriques collectées :**
- **RTT (Round Trip Time)** : Latence moyenne, min, max
- **Probes Sent/Failed** : Taux de succès
- **Checks Failed Percent** : Pourcentage d'échec

**Alertes :**
```bash
# Créer une alerte si RTT > 100ms
az monitor metrics alert create \
  --name HighLatencyAlert \
  --resource-group myRG \
  --scopes $connectionMonitorId \
  --condition "avg RoundTripTimeMs > 100" \
  --description "Alert when RTT exceeds 100ms"
```

#### Matrice de Décision - Quel Outil Utiliser ?

| Symptôme / Question | Outil Recommandé | Raison |
|---------------------|-----------------|--------|
| **VM ne peut pas communiquer avec une autre VM** | IP Flow Verify | Identifie NSG bloquant + règle exacte |
| **Identifier quelle règle NSG bloque le trafic** | IP Flow Verify | Diagnostic NSG en temps réel |
| **Tester si une VM peut atteindre une URL** | Connection Troubleshoot | Test end-to-end avec diagnostics |
| **Comprendre le routage du trafic** | Next Hop | Montre le prochain saut |
| **Visualiser l'architecture réseau** | Topology | Diagramme de toutes les ressources |
| **Analyser trafic détaillé (debugging app)** | Packet Capture | Capture complète pour Wireshark |
| **Auditer historique de trafic NSG** | NSG Flow Logs | Logs détaillés sur période longue |
| **Surveiller latence en continu** | Connection Monitor | Monitoring proactif 24/7 |

#### Comparaison Détaillée - Scénarios d'Examen

**Scénario 1 : Communication VM bloquée - Diagnostic rapide**
- **Besoin** : Identifier pourquoi une VM ne peut pas communiquer
- **Solution** : **IP Flow Verify** ✅
- **Raison** : Identification immédiate du NSG et de la règle bloquante
- **Alternative (mauvaise)** : NSG Flow Logs ❌ (trop long, analyse manuelle)

**Scénario 2 : Vérifier connectivité à un service externe**
- **Besoin** : Tester si une VM peut atteindre https://api.example.com
- **Solution** : **Connection Troubleshoot** ✅
- **Raison** : Test direct avec indication reachable/unreachable

**Scénario 3 : Comprendre pourquoi le trafic passe par un NVA**
- **Besoin** : Déterminer le routage du trafic
- **Solution** : **Next Hop** ✅
- **Raison** : Montre le type de routage (VirtualAppliance) et l'IP du NVA

**Scénario 4 : Analyser un problème applicatif HTTP complexe**
- **Besoin** : Voir les requêtes/réponses HTTP détaillées
- **Solution** : **Packet Capture** ✅
- **Raison** : Capture complète pour analyse Wireshark

**Scénario 5 : Conformité - Audit des connexions sur 6 mois**
- **Besoin** : Tracer toutes les connexions pour audit
- **Solution** : **NSG Flow Logs** + Traffic Analytics ✅
- **Raison** : Historique complet avec rétention longue durée

#### Best Practices Network Watcher

✅ **À FAIRE :**
- Utiliser **IP Flow Verify** en premier pour problèmes NSG
- Activer **NSG Flow Logs** pour audit et conformité
- Configurer **Connection Monitor** pour services critiques
- Utiliser **Topology** pour comprendre l'architecture

❌ **À ÉVITER :**
- Utiliser Packet Capture pour identifier un NSG bloquant (trop complexe)
- Analyser manuellement NSG Flow Logs sans Traffic Analytics
- Oublier d'activer Network Watcher dans les nouvelles régions

** Stratégie de diagnostic identifiée :**
1. **Premier choix** : IP Flow Verify pour identifier rapidement le NSG
2. **Deuxième choix** : NSG Flow Logs pour analyse historique
3. **Dernier recours** : Packet Capture pour investigation approfondie

** Tips critiques identifiés :**

**1. Commandes de Diagnostic Spécialisées**
- **`netstat -an`** : Diagnostic des ports d'écoute (essentiel pour troubleshooting)
  - **Linux/moderne** : `ss -tuln` (recommandé, plus rapide et moderne)
  - **Legacy** : `netstat -an` (compatible mais plus lent)
- **`Test-NetConnection`** : Tests de connectivité modernes (remplace ping)
- **`nbtstat -c`** : Diagnostic NetBIOS (legacy, moins fréquent)
- **`Get-AzVirtualNetworkUsageList`** : PowerShell Azure (pas de diagnostic réseau)

**2. Stratégie de Diagnostic par Couche**
- **Couche Application** : `netstat -an` pour ports d'écoute
- **Couche Transport** : `Test-NetConnection` pour tests TCP/UDP
- **Couche Réseau** : `ping` ou `Test-NetConnection` pour ICMP
- **Couche Application** : `nslookup` pour résolution DNS

**3. Outils Azure vs Outils Système**
- **Azure PowerShell** : `Get-Az*` pour gestion des ressources Azure
- **Outils Windows** : `netstat`, `Test-NetConnection` pour diagnostic réseau
- **Outils Legacy** : `nbtstat`, `ping` pour compatibilité
- **Règle** : Diagnostic réseau = outils système, pas PowerShell Azure

#### Traffic Analytics
** Ressources requises identifiées :**
1. **Log Analytics Workspace** : Analyse et stockage
2. **Storage Account** : Stockage NSG Flow Logs
3. **NSG Flow Logs** : Source de données activée

**Prérequis :** Même région pour tous les composants

#### Other Features
- **IP Flow Verify** : Tester règles NSG
- **Next Hop** : Routing troubleshooting
- **Packet Capture** : Capture de paquets sur VMs

